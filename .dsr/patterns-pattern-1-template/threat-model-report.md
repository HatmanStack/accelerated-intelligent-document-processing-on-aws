# CloudFormation Threat Model Report

**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-54  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **8** medium, and **0** low severity findings.

## Priority Actions

### 2. Use AWS Secrets Manager or Parameter Store for sensitive values instead of environment variables. Enable AWS Lambda environment variable encryption. Review logging practices to ensure environment variables are not being logged.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-001  
**Business Impact:** Potential exposure of configuration values or other sensitive information that could be used to further compromise the system.

### 2. Scope down the CloudWatch PutMetricData permissions to specific metric namespaces used by the function, rather than using a wildcard resource.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-002  
**Business Impact:** Potential for metric manipulation, misleading monitoring data, and possible denial of service through metric flooding.

### 2. Set 'IncludeExecutionData: false' unless full execution data logging is specifically required. Implement data filtering to redact sensitive information before it's passed between states.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-004  
**Business Impact:** Exposure of potentially sensitive document data, including any personally identifiable information (PII) that might be contained in processed documents.

### 2. Restrict S3 write permissions to specific prefixes or paths within the bucket that the function actually needs to access. Consider using dynamic policy conditions to limit access based on request context.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-006  
**Business Impact:** Data integrity issues, potential for serving malicious content to downstream consumers, or overwriting legitimate processing results.

### 2. Add input validation as the first step in the state machine workflow. Implement schema validation for all inputs and between state transitions. Consider implementing a 'validator' Lambda function at the beginning of the workflow.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-008  
**Business Impact:** Processing inconsistencies, potential for injection attacks in downstream systems, or workflow errors leading to service disruption.

### 2. Implement source validation for all inputs. Add input sanitization before sending to Bedrock models. Consider restricting Bedrock permissions to specific model IDs rather than using wildcards. Implement guardrails for all model interactions.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-009  
**Business Impact:** Potential for prompt injection attacks, model manipulation, or generation of harmful content through the AI processing pipeline.

### 3. Consider implementing provisioned capacity with auto-scaling for more predictable performance. Set up CloudWatch alarms to detect and respond to unusual traffic patterns.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-003  
**Business Impact:** Service disruption, performance degradation, or unexpectedly high AWS costs.

### 3. Implement a dead letter queue monitoring and cleanup process. Consider implementing message sanitization before messages are sent to the DLQ. Set up alerts for messages arriving in the DLQ to ensure they are promptly addressed.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-005  
**Business Impact:** Potential exposure of document contents, extracted data, or system configuration information.

### 3. Configure reserved or provisioned concurrency for critical Lambda functions. Implement throttling at the API level. Set up monitoring and alerts for unusual invocation patterns.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-007  
**Business Impact:** Service disruption for other Lambda functions in the account, processing delays, and potential failure of document processing workflows.

### 3. Enhance logging for HITL processes to capture reviewer identity, timestamp, and specific changes made. Consider implementing approval workflows for sensitive documents or changes above certain thresholds.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-010  
**Business Impact:** Inability to fully audit human review actions, potential compliance issues for regulated industries, and difficulty investigating security incidents.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-002: Overly Permissive CloudWatch PutMetricData Permission

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `InvokeBDAFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
The InvokeBDAFunction has permission to call cloudwatch:PutMetricData on all resources ('*'), which grants broader permissions than necessary. This violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could use these permissions to create misleading metrics or potentially cause CloudWatch throttling issues.

#### Potential Impact
Potential for metric manipulation, misleading monitoring data, and possible denial of service through metric flooding.

#### Remediation
Scope down the CloudWatch PutMetricData permissions to specific metric namespaces used by the function, rather than using a wildcard resource.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/iam-access-control-overview-cw.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-006: Overly Permissive S3 Write Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `HITLProcessLambdaRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
HITLProcessLambdaRole has broad write permissions (s3:PutObject) to the entire output bucket, allowing it to write to any location within the bucket.

#### Attack Vector
If the Lambda function is compromised, an attacker could overwrite existing files or add malicious content to the output bucket.

#### Potential Impact
Data integrity issues, potential for serving malicious content to downstream consumers, or overwriting legitimate processing results.

#### Remediation
Restrict S3 write permissions to specific prefixes or paths within the bucket that the function actually needs to access. Consider using dynamic policy conditions to limit access based on request context.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-001: Environment Variables May Contain Sensitive Information

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Lambda::Function)  
**CWE ID:** CWE-527

#### Issue
Lambda functions contain environment variables that could potentially store sensitive information. While there's no evidence of secrets in the current environment variables, they could be added in the future and might be exposed through function configuration or logs.

#### Attack Vector
An attacker with Lambda read permissions could view environment variables. Additionally, if logging is verbose, environment variables might be inadvertently logged.

#### Potential Impact
Potential exposure of configuration values or other sensitive information that could be used to further compromise the system.

#### Remediation
Use AWS Secrets Manager or Parameter Store for sensitive values instead of environment variables. Enable AWS Lambda environment variable encryption. Review logging practices to ensure environment variables are not being logged.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html#configuration-envvars-encryption

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-003: DynamoDB Table Missing Auto-Scaling Configuration

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAMetadataTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-400

#### Issue
The BDAMetadataTable is using PAY_PER_REQUEST billing mode without any capacity planning or auto-scaling configuration. This could lead to throttling during high demand or unexpected costs.

#### Attack Vector
An attacker could potentially cause a denial of service or excessive billing by generating high volumes of requests to the table.

#### Potential Impact
Service disruption, performance degradation, or unexpectedly high AWS costs.

#### Remediation
Consider implementing provisioned capacity with auto-scaling for more predictable performance. Set up CloudWatch alarms to detect and respond to unusual traffic patterns.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/AutoScaling.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-004: State Machine Logging Exposes Execution Data

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-532

#### Issue
The DocumentProcessingStateMachine has logging configured with 'IncludeExecutionData: true', which means all input and output data for each state transition is logged. This could potentially include sensitive information processed by the workflow.

#### Attack Vector
An attacker with access to CloudWatch logs could extract sensitive information from document processing tasks.

#### Potential Impact
Exposure of potentially sensitive document data, including any personally identifiable information (PII) that might be contained in processed documents.

#### Remediation
Set 'IncludeExecutionData: false' unless full execution data logging is specifically required. Implement data filtering to redact sensitive information before it's passed between states.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-logs.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-005: DLQ Messages Could Contain Sensitive Information

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BDACompletionFunctionDLQ` (AWS::SQS::Queue)  
**CWE ID:** CWE-200

#### Issue
The BDACompletionFunctionDLQ may store failed messages that contain sensitive document processing information. If these messages aren't properly secured or monitored, they could lead to information disclosure.

#### Attack Vector
An attacker with SQS access could read failed processing messages containing sensitive document content or extraction results.

#### Potential Impact
Potential exposure of document contents, extracted data, or system configuration information.

#### Remediation
Implement a dead letter queue monitoring and cleanup process. Consider implementing message sanitization before messages are sent to the DLQ. Set up alerts for messages arriving in the DLQ to ensure they are promptly addressed.

**References:**
- https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-007: Missing Concurrency Controls on Lambda Functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
Lambda functions in this template don't have reserved or provisioned concurrency settings, which means they could consume all available account concurrency during high load or in case of recursive invocation.

#### Attack Vector
An attacker could trigger excessive function invocations, potentially exhausting the account's Lambda concurrency limit and affecting other functions.

#### Potential Impact
Service disruption for other Lambda functions in the account, processing delays, and potential failure of document processing workflows.

#### Remediation
Configure reserved or provisioned concurrency for critical Lambda functions. Implement throttling at the API level. Set up monitoring and alerts for unusual invocation patterns.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-008: State Machine Input Validation Missing

**STRIDE Category:** Tampering  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-20

#### Issue
The state machine doesn't appear to have explicit input validation, potentially allowing malformed or malicious inputs to flow through the workflow.

#### Attack Vector
An attacker could inject unexpected data formats or values that might be processed differently by different components, potentially causing unexpected behavior.

#### Potential Impact
Processing inconsistencies, potential for injection attacks in downstream systems, or workflow errors leading to service disruption.

#### Remediation
Add input validation as the first step in the state machine workflow. Implement schema validation for all inputs and between state transitions. Consider implementing a 'validator' Lambda function at the beginning of the workflow.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/concepts-input-output-filtering.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-009: Bedrock Model Access Without Source Validation

**STRIDE Category:** Spoofing  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-345

#### Issue
The SummarizationFunction has permissions to invoke any Bedrock model without restrictions, and there's no apparent validation of input sources before processing with AI models.

#### Attack Vector
An attacker who gains access to input channels could potentially submit manipulated documents or prompts designed to extract sensitive information or produce harmful outputs from AI models.

#### Potential Impact
Potential for prompt injection attacks, model manipulation, or generation of harmful content through the AI processing pipeline.

#### Remediation
Implement source validation for all inputs. Add input sanitization before sending to Bedrock models. Consider restricting Bedrock permissions to specific model IDs rather than using wildcards. Implement guardrails for all model interactions.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-iam.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-010: Incomplete Audit Trail for Human Review Actions

**STRIDE Category:** Repudiation  
**Affected Resource:** `HITLEventRule` (AWS::Events::Rule)  
**CWE ID:** CWE-778

#### Issue
The Human-In-The-Loop (HITL) process captures completion events but may not capture sufficient details about who performed the review and what specific changes they made.

#### Attack Vector
A malicious reviewer could make unauthorized changes to documents without sufficient traceability.

#### Potential Impact
Inability to fully audit human review actions, potential compliance issues for regulated industries, and difficulty investigating security incidents.

#### Remediation
Enhance logging for HITL processes to capture reviewer identity, timestamp, and specific changes made. Consider implementing approval workflows for sensitive documents or changes above certain thresholds.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/a2i-permissions-security.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*