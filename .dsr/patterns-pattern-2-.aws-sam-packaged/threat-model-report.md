# CloudFormation Threat Model Report

**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-42  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **8** medium, and **0** low severity findings.

## Priority Actions

### 1. Implement robust data filtering and sanitization before sending content to AI models. Use guardrails consistently across all Bedrock interactions (currently only conditionally applied). Consider implementing prompt templates that explicitly define what data can be included.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-008  
**Business Impact:** Disclosure of sensitive business data, PII, or confidential information to third-party AI model providers.

### 1. Implement strong input validation for all configuration updates. Create a configuration approval process. Consider implementing a change detection mechanism that alerts on suspicious configuration changes.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-009  
**Business Impact:** System compromise, data exfiltration, or manipulation of document processing results.

### 2. Implement log scrubbing/filtering mechanisms in Lambda functions to sanitize sensitive data before logging. Consider implementing a centralized logging middleware that handles sanitization consistently.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-001  
**Business Impact:** Unauthorized disclosure of PII or sensitive business data, potentially leading to regulatory compliance violations.

### 2. Review each Lambda function and restrict S3 permissions to only those actions necessary for its operation (e.g., GetObject, PutObject). Avoid using S3CrudPolicy and create more granular policies.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-002  
**Business Impact:** Unauthorized modification or deletion of document data, potentially leading to data loss or tampering.

### 2. Implement dependency scanning in the CI/CD pipeline. Use Amazon CodeGuru or similar tools to scan Lambda code for vulnerabilities. Consider using Lambda layers for vetted, shared libraries.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-004  
**Business Impact:** Unauthorized access to sensitive document data or potential system compromise.

### 3. Restrict Bedrock model invocation permissions to only the specific models and regions required for each function. Replace wildcard (*) resources with explicit ARNs for the required models.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-003  
**Business Impact:** Potential for excessive usage costs, unexpected model behavior, or data processing in unintended regions.

### 3. Implement checksums or digital signatures for documents at each processing stage. Validate integrity before processing. Consider storing hash values in the tracking table to detect modifications.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-005  
**Business Impact:** Incorrect document classification, extraction of manipulated data, or processing of unauthorized content.

### 3. Implement comprehensive audit logging that includes the identity of requesters, document metadata, and processing results. Store audit logs in a tamper-evident system. Consider implementing AWS CloudTrail for API activity logging.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-006  
**Business Impact:** Lack of accountability for document processing activities, difficulty in forensic analysis after a security incident.

### 3. Configure appropriate reserved and maximum concurrency limits for each Lambda function based on expected usage patterns. Implement throttling or queuing mechanisms for document processing requests during high load.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-007  
**Business Impact:** Processing delays, failures due to throttling, or potential downstream resource exhaustion.

### 3. While Textract doesn't support resource-level permissions for these operations, implement additional controls such as request validation, monitoring unusual usage patterns, and setting up AWS Budgets alerts for unexpected costs.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-010  
**Business Impact:** Unauthorized use of AWS services, potential cost implications, and processing of unauthorized documents.



## Detailed Threat Analysis

## High Severity Threats

### PATTERN2-THREAT-008: Potential data leakage through Bedrock model prompts

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-200

#### Issue
Document content is sent to external AI models via Bedrock without clear controls on what data can be included in prompts. Sensitive information could be inadvertently included in prompts sent to foundation models.

#### Attack Vector
Sensitive data from documents could be sent as part of prompts to external AI models, potentially being stored, used for model training, or leaked through model responses.

#### Potential Impact
Disclosure of sensitive business data, PII, or confidential information to third-party AI model providers.

#### Remediation
Implement robust data filtering and sanitization before sending content to AI models. Use guardrails consistently across all Bedrock interactions (currently only conditionally applied). Consider implementing prompt templates that explicitly define what data can be included.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails.html

---

### PATTERN2-THREAT-009: Configuration tampering risk via custom resources

**STRIDE Category:** Tampering  
**Affected Resource:** `UpdateSchemaConfig, UpdateDefaultConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-642

#### Issue
Custom resources are used to update configuration, but there are no explicit validation controls to prevent malicious configuration changes that could alter system behavior.

#### Attack Vector
An attacker with access to the configuration could inject malicious prompts, redirect data flow, or manipulate extraction logic by modifying configuration values.

#### Potential Impact
System compromise, data exfiltration, or manipulation of document processing results.

#### Remediation
Implement strong input validation for all configuration updates. Create a configuration approval process. Consider implementing a change detection mechanism that alerts on suspicious configuration changes.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-lambda-function-code-cfnresponsemodule.html

---

## Medium Severity Threats

### PATTERN2-THREAT-001: Sensitive data may be logged without proper sanitization

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunctionLogGroup, ClassificationFunctionLogGroup, ExtractionFunctionLogGroup, AssessmentFunctionLogGroup, ProcessResultsFunctionLogGroup, SummarizationFunctionLogGroup, StateMachineLogGroup` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-532

#### Issue
Lambda functions processing document content may log sensitive information that gets stored in CloudWatch Logs. While logs are encrypted with a customer-managed KMS key, there's no explicit mechanism to sanitize or filter out PII or sensitive data before logging.

#### Attack Vector
An attacker with access to CloudWatch Logs or the KMS key could potentially view sensitive document data that was inadvertently logged during processing.

#### Potential Impact
Unauthorized disclosure of PII or sensitive business data, potentially leading to regulatory compliance violations.

#### Remediation
Implement log scrubbing/filtering mechanisms in Lambda functions to sanitize sensitive data before logging. Consider implementing a centralized logging middleware that handles sanitization consistently.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/nodejs-logging.html

---

### PATTERN2-THREAT-002: Overly permissive S3 permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
Several Lambda functions have full CRUD permissions (S3CrudPolicy) to buckets when they may only need read or write permissions. This violates the principle of least privilege.

#### Attack Vector
If a Lambda function is compromised, an attacker could potentially delete or overwrite important data in S3 buckets.

#### Potential Impact
Unauthorized modification or deletion of document data, potentially leading to data loss or tampering.

#### Remediation
Review each Lambda function and restrict S3 permissions to only those actions necessary for its operation (e.g., GetObject, PutObject). Avoid using S3CrudPolicy and create more granular policies.

**References:**
- https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-policy-templates.html

---

### PATTERN2-THREAT-003: Overly permissive Bedrock model invocation permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
Lambda functions have permissions to invoke any foundation model in Amazon Bedrock across all regions (arn:aws:bedrock:*::foundation-model/*), rather than restricting to specific models needed.

#### Attack Vector
If a Lambda function is compromised, an attacker could potentially use more expensive models or invoke models in different regions, leading to unexpected costs or data exfiltration.

#### Potential Impact
Potential for excessive usage costs, unexpected model behavior, or data processing in unintended regions.

#### Remediation
Restrict Bedrock model invocation permissions to only the specific models and regions required for each function. Replace wildcard (*) resources with explicit ARNs for the required models.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-iam.html

---

### PATTERN2-THREAT-004: Potential data exfiltration via third-party dependencies

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-1104

#### Issue
Lambda functions may use external dependencies that could be compromised or contain vulnerabilities. There's no explicit mechanism for scanning or validating dependencies before deployment.

#### Attack Vector
An attacker could exploit a vulnerable third-party package used by one of the Lambda functions to exfiltrate document data or gain unauthorized access.

#### Potential Impact
Unauthorized access to sensitive document data or potential system compromise.

#### Remediation
Implement dependency scanning in the CI/CD pipeline. Use Amazon CodeGuru or similar tools to scan Lambda code for vulnerabilities. Consider using Lambda layers for vetted, shared libraries.

**References:**
- https://docs.aws.amazon.com/codeguru/latest/reviewer-ug/welcome.html

---

### PATTERN2-THREAT-005: No integrity validation for document processing pipeline

**STRIDE Category:** Tampering  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-345

#### Issue
The document processing workflow doesn't appear to implement integrity checks to ensure documents haven't been tampered with between processing stages.

#### Attack Vector
An attacker with partial access to the system could potentially modify document content or metadata between processing stages, leading to incorrect extraction results or data manipulation.

#### Potential Impact
Incorrect document classification, extraction of manipulated data, or processing of unauthorized content.

#### Remediation
Implement checksums or digital signatures for documents at each processing stage. Validate integrity before processing. Consider storing hash values in the tracking table to detect modifications.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingMetadata.html

---

### PATTERN2-THREAT-006: Insufficient audit trail for document processing lifecycle

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::StepFunctions::StateMachine)  
**CWE ID:** CWE-778

#### Issue
While the state machine logs execution data, there's no comprehensive audit trail that tracks who initiated document processing, what changes were made, and what extraction results were produced.

#### Attack Vector
Without proper audit trails, an insider or attacker who gains access could process unauthorized documents or modify extraction results without accountability.

#### Potential Impact
Lack of accountability for document processing activities, difficulty in forensic analysis after a security incident.

#### Remediation
Implement comprehensive audit logging that includes the identity of requesters, document metadata, and processing results. Store audit logs in a tamper-evident system. Consider implementing AWS CloudTrail for API activity logging.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudtrail.html

---

### PATTERN2-THREAT-007: No concurrency limits on Lambda functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-400

#### Issue
Lambda functions don't have reserved or maximum concurrency limits configured, potentially allowing resource exhaustion or throttling during high load.

#### Attack Vector
An attacker could trigger multiple large document processing jobs simultaneously, causing the system to exhaust resources or hit service quotas, resulting in denial of service for legitimate requests.

#### Potential Impact
Processing delays, failures due to throttling, or potential downstream resource exhaustion.

#### Remediation
Configure appropriate reserved and maximum concurrency limits for each Lambda function based on expected usage patterns. Implement throttling or queuing mechanisms for document processing requests during high load.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### PATTERN2-THREAT-010: Overly permissive Textract permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has permissions to call Textract APIs (DetectDocumentText, AnalyzeDocument) on all resources without restrictions, violating the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could use Textract services to process unauthorized documents or perform actions at the expense of the account owner.

#### Potential Impact
Unauthorized use of AWS services, potential cost implications, and processing of unauthorized documents.

#### Remediation
While Textract doesn't support resource-level permissions for these operations, implement additional controls such as request validation, monitoring unusual usage patterns, and setting up AWS Budgets alerts for unexpected costs.

**References:**
- https://docs.aws.amazon.com/textract/latest/dg/security_iam_service-with-iam.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*