# CloudFormation Threat Model Report

**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-53  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **6** medium, and **2** low severity findings.

## Priority Actions

### 1. Restrict access to OpenSearch Serverless resources to specific VPC endpoints or IP ranges instead of allowing public access. Implement strong authentication mechanisms for all OpenSearch Serverless access.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-002  
**Business Impact:** Potential exposure of sensitive data indexed in the OpenSearch Serverless collection or unauthorized access to search capabilities.

### 1. Restrict the bedrock:InvokeModel permission to only the specific embedding model required by the Knowledge Base by specifying the exact model ARN instead of using wildcards.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-005  
**Business Impact:** Potential for cost escalation through unauthorized model usage, data exfiltration through model responses, or abuse of AI capabilities.

### 2. Scope down IAM permissions by restricting S3 access to specific buckets and objects relevant to the function's operation. Limit OpenSearch Serverless API actions to specific collections using ARNs where possible instead of using '*' resource specifiers.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-001  
**Business Impact:** Potential unauthorized access to S3 data outside the intended scope and ability to manipulate OpenSearch Serverless collections beyond what's necessary for the function's operation.

### 2. Implement CloudWatch logging for Bedrock resources. Consider enabling AWS CloudTrail with appropriate log retention for API activity. Set up alarms for suspicious activity patterns.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-004  
**Business Impact:** Limited visibility into resource usage, potential security incidents, and compliance violations. Difficulty in forensic analysis if a breach occurs.

### 2. Consider packaging Lambda code directly within the CloudFormation template or use a secure CI/CD pipeline with code signing. Ensure the S3 bucket has appropriate access controls and versioning enabled. Implement integrity checks for Lambda code.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-008  
**Business Impact:** Potential execution of unauthorized code within the AWS account, which could lead to data exfiltration, credential theft, or further privilege escalation.

### 3. Consider using a customer-managed KMS key for OpenSearch Serverless encryption, especially for sensitive or regulated data. Modify the OSSEncryptionPolicy to use customer-managed keys by specifying a KMS key ARN.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-003  
**Business Impact:** Reduced control over encryption key lifecycle and potential compliance issues with regulations requiring customer-managed encryption.

### 3. Implement input validation in Lambda function code to ensure parameters meet expected formats and ranges. Consider adding error handling to gracefully handle invalid inputs.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-006  
**Business Impact:** Potential for function misuse, unexpected errors, or resource manipulation if custom resources are exploited.

### 3. Scope down the bedrock:StartIngestionJob permission to specifically reference the knowledge base created in this template by using the specific ARN rather than a wildcard in the resource element.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-009  
**Business Impact:** Potential disruption of other knowledge bases in the account, possible data contamination or resource exhaustion.

### 4. Consider setting a more conservative rate limit for the web crawler. Implement progressive crawling patterns and respect robots.txt files. Monitor crawler behavior to ensure it doesn't cause disruption.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-007  
**Business Impact:** Potential for inadvertent DoS against crawled websites, damaged business relationships, or IP address blocking by target sites.

### 4. Consider implementing additional authentication mechanisms for critical scheduled operations. Monitor for unusual patterns in scheduled job execution. Implement alerting for job failures or unexpected execution patterns.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-010  
**Business Impact:** Potential for unauthorized triggering of resource-intensive operations leading to increased costs or service disruption.



## Detailed Threat Analysis

## High Severity Threats

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-002: Public Access to OpenSearch Serverless Collections

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OSSNetworkPolicy` (AWS::OpenSearchServerless::SecurityPolicy)  
**CWE ID:** CWE-668

#### Issue
The OSSNetworkPolicy allows public access to OpenSearch Serverless collections and dashboards by setting 'AllowFromPublic: true'

#### Attack Vector
Unauthorized users may attempt to access the OpenSearch Serverless dashboard or collection endpoints from the public internet, potentially leading to unauthorized data access if authentication is misconfigured.

#### Potential Impact
Potential exposure of sensitive data indexed in the OpenSearch Serverless collection or unauthorized access to search capabilities.

#### Remediation
Restrict access to OpenSearch Serverless resources to specific VPC endpoints or IP ranges instead of allowing public access. Implement strong authentication mechanisms for all OpenSearch Serverless access.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-security.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-005: Overly Permissive bedrock:InvokeModel Permission

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `KnowledgeBaseServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The KnowledgeBaseServiceRole has permission to invoke any Bedrock foundation model with the wildcard resource 'arn:aws:bedrock:${AWS::Region}::foundation-model/*'

#### Attack Vector
If the role is compromised, an attacker could invoke any Bedrock model, potentially using expensive models or extracting sensitive information through crafted prompts.

#### Potential Impact
Potential for cost escalation through unauthorized model usage, data exfiltration through model responses, or abuse of AI capabilities.

#### Remediation
Restrict the bedrock:InvokeModel permission to only the specific embedding model required by the Knowledge Base by specifying the exact model ARN instead of using wildcards.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_service-with-iam.html

---

## Medium Severity Threats

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-001: Overly Permissive IAM Policies

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has multiple policies with broad permissions including 'Resource: *' wildcards in several statements, particularly for S3 operations and OpenSearch Serverless API actions.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these broad permissions to access unintended S3 buckets or perform unauthorized actions on OpenSearch Serverless resources.

#### Potential Impact
Potential unauthorized access to S3 data outside the intended scope and ability to manipulate OpenSearch Serverless collections beyond what's necessary for the function's operation.

#### Remediation
Scope down IAM permissions by restricting S3 access to specific buckets and objects relevant to the function's operation. Limit OpenSearch Serverless API actions to specific collections using ARNs where possible instead of using '*' resource specifiers.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-003: Default AWS-Owned Encryption Key Used

**STRIDE Category:** Tampering  
**Affected Resource:** `OSSEncryptionPolicy` (AWS::OpenSearchServerless::SecurityPolicy)  
**CWE ID:** CWE-311

#### Issue
The OpenSearch Serverless collection is configured to use AWS-owned encryption keys ('AWSOwnedKey': true) rather than customer-managed keys, potentially reducing control over data encryption.

#### Attack Vector
In case of a compromise of AWS-managed keys or if regulatory requirements demand customer control of encryption keys, this configuration could expose data to unauthorized access.

#### Potential Impact
Reduced control over encryption key lifecycle and potential compliance issues with regulations requiring customer-managed encryption.

#### Remediation
Consider using a customer-managed KMS key for OpenSearch Serverless encryption, especially for sensitive or regulated data. Modify the OSSEncryptionPolicy to use customer-managed keys by specifying a KMS key ARN.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-encryption.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-004: Missing Monitoring and Logging Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `KnowledgeBase` (AWS::Bedrock::KnowledgeBase)  
**CWE ID:** CWE-778

#### Issue
The template does not define CloudWatch logging or monitoring for Bedrock Knowledge Base operations, making it difficult to track access, usage, and potential misuse.

#### Attack Vector
Without proper logging, attackers could abuse the Bedrock Knowledge Base and associated resources without leaving an audit trail, making incident investigation difficult.

#### Potential Impact
Limited visibility into resource usage, potential security incidents, and compliance violations. Difficulty in forensic analysis if a breach occurs.

#### Remediation
Implement CloudWatch logging for Bedrock resources. Consider enabling AWS CloudTrail with appropriate log retention for API activity. Set up alarms for suspicious activity patterns.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/monitoring.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-006: Lambda Functions Without Input Validation

**STRIDE Category:** Tampering  
**Affected Resource:** `GetAdjustedStackNameFunction, GetSeedUrlsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
The inline Lambda functions for GetAdjustedStackName and GetSeedUrls do not implement proper input validation for the data they process, potentially allowing injection attacks or unexpected behavior.

#### Attack Vector
Malicious input could potentially cause unexpected behavior if the Lambda functions process untrusted data without proper validation.

#### Potential Impact
Potential for function misuse, unexpected errors, or resource manipulation if custom resources are exploited.

#### Remediation
Implement input validation in Lambda function code to ensure parameters meet expected formats and ranges. Consider adding error handling to gracefully handle invalid inputs.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/lambda-security.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-008: Lambda Code from External S3 Bucket

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `StartIngestionJobFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-494

#### Issue
The StartIngestionJobFunction code is sourced from an S3 bucket ('bobs-artifacts-us-west-2') which may present supply chain risks if the bucket is compromised or the code is altered without verification.

#### Attack Vector
If the source S3 bucket is compromised, malicious code could be injected into the Lambda function, potentially allowing attackers to execute arbitrary code within the AWS environment.

#### Potential Impact
Potential execution of unauthorized code within the AWS account, which could lead to data exfiltration, credential theft, or further privilege escalation.

#### Remediation
Consider packaging Lambda code directly within the CloudFormation template or use a secure CI/CD pipeline with code signing. Ensure the S3 bucket has appropriate access controls and versioning enabled. Implement integrity checks for Lambda code.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/lambda-security.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-009: Limited Scope in Scheduler Role Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `DataSourceSchedulerRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The DataSourceSchedulerRole has permissions to start ingestion jobs on any knowledge base within the account, not just the specific knowledge base created by this template.

#### Attack Vector
If the scheduler role is compromised, an attacker could potentially trigger ingestion jobs for other knowledge bases in the account.

#### Potential Impact
Potential disruption of other knowledge bases in the account, possible data contamination or resource exhaustion.

#### Remediation
Scope down the bedrock:StartIngestionJob permission to specifically reference the knowledge base created in this template by using the specific ARN rather than a wildcard in the resource element.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Low Severity Threats

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-007: Web Crawler Rate Limits Could Be Exploited

**STRIDE Category:** Denial of Service  
**Affected Resource:** `WebDataSource` (AWS::Bedrock::DataSource)  
**CWE ID:** CWE-400

#### Issue
The WebDataSource crawler is configured with a relatively high rate limit of 300, which could potentially be used for DoS attacks against target websites if misconfigured.

#### Attack Vector
A misconfigured crawler with high rate limits could overwhelm target websites or trigger anti-scraping measures, disrupting service for legitimate users.

#### Potential Impact
Potential for inadvertent DoS against crawled websites, damaged business relationships, or IP address blocking by target sites.

#### Remediation
Consider setting a more conservative rate limit for the web crawler. Implement progressive crawling patterns and respect robots.txt files. Monitor crawler behavior to ensure it doesn't cause disruption.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-crawlers.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-010: Missing Authentication for Scheduled Job Triggers

**STRIDE Category:** Spoofing  
**Affected Resource:** `S3DataSourceScheduler, WebDataSourceScheduler` (AWS::Scheduler::Schedule)  
**CWE ID:** CWE-306

#### Issue
The scheduled jobs for S3 and Web data source synchronization do not have additional authentication mechanisms beyond the IAM role, potentially allowing anyone who can assume the role to trigger ingestion jobs.

#### Attack Vector
If the scheduler role credentials are obtained, an attacker could trigger ingestion jobs at will, potentially causing resource consumption or service disruption.

#### Potential Impact
Potential for unauthorized triggering of resource-intensive operations leading to increased costs or service disruption.

#### Remediation
Consider implementing additional authentication mechanisms for critical scheduled operations. Monitor for unusual patterns in scheduled job execution. Implement alerting for job failures or unexpected execution patterns.

**References:**
- https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-security.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*