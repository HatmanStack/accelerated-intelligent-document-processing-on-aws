# .aws-sam-build-BDASAMPLEPROJECT-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-16  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **6** security threats. The analysis reveals **0** critical, **1** high, **3** medium, and **2** low severity findings.

## Priority Actions

### 1. Scope down the IAM policy to specific resources by replacing the wildcard (*) with specific ARNs for the resources the Lambda needs to access. For example, use project-specific ARNs for the Bedrock resources.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001  
**Business Impact:** Potential unauthorized access to all Bedrock resources in the account, possible data exfiltration, and violation of least privilege security principle.

### 2. Implement code signing for Lambda functions using AWS Signer and validate the code signatures during deployment. Additionally, consider using versioned S3 objects with object lock to prevent tampering with the Lambda package.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002  
**Business Impact:** Execution of unauthorized code that could manipulate Bedrock Data Automation projects and potentially access sensitive financial documents being processed.

### 2. Enable AWS CloudTrail data events for Bedrock API calls. Implement additional application-level logging within the Lambda function that captures detailed information about all Bedrock operations and their outcomes.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003  
**Business Impact:** Difficulty in detecting malicious activities, investigating security incidents, and maintaining compliance with financial regulations for document processing systems.

### 2. Implement encryption for data at rest and in transit for all Bedrock resources. Add resource policies to restrict access to processed documents. Implement data classification and access controls specific to document types being processed. Consider implementing DLP (Data Loss Prevention) mechanisms.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005  
**Business Impact:** Potential exposure of personally identifiable information (PII) and financial data, violating privacy regulations and potentially causing financial harm to customers.

### 3. Implement reserved concurrency limits on the Lambda function to ensure it only uses a reasonable portion of the account's total concurrency. Monitor Lambda throttling metrics to detect abnormal invocation patterns.

**Effort:** Low  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004  
**Business Impact:** Potential disruption to other Lambda functions in the account, affecting availability of related services.

### 3. Consider deploying the Lambda function within a VPC with appropriate security groups and NACLs to restrict outbound traffic to only what's necessary. Use VPC endpoints for AWS services the function needs to access.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-006  
**Business Impact:** Increased attack surface and potential for data exfiltration if the function is compromised.



## Detailed Threat Analysis

## High Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001: Overly Permissive IAM Role Policy

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `LambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The LambdaExecutionRole policy grants wildcard (*) resource access to multiple Bedrock actions, violating the principle of least privilege. This allows the Lambda function to access any Bedrock project or blueprint in the account, not just those it needs.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these broad permissions to access, modify, or delete any Bedrock Data Automation project or blueprint in the account.

#### Potential Impact
Potential unauthorized access to all Bedrock resources in the account, possible data exfiltration, and violation of least privilege security principle.

#### Remediation
Scope down the IAM policy to specific resources by replacing the wildcard (*) with specific ARNs for the resources the Lambda needs to access. For example, use project-specific ARNs for the Bedrock resources.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Medium Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002: Lambda Function Using Pre-Built Package Without Integrity Verification

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-345

#### Issue
The Lambda function uses a pre-built package from an S3 bucket without any apparent integrity verification mechanism. The package could potentially be tampered with if the S3 bucket is compromised.

#### Attack Vector
If an attacker gains access to the S3 bucket containing the Lambda code package, they could modify it to include malicious code that would execute with the permissions of the Lambda role.

#### Potential Impact
Execution of unauthorized code that could manipulate Bedrock Data Automation projects and potentially access sensitive financial documents being processed.

#### Remediation
Implement code signing for Lambda functions using AWS Signer and validate the code signatures during deployment. Additionally, consider using versioned S3 objects with object lock to prevent tampering with the Lambda package.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-codesigning.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003: Insufficient Audit Trail for Bedrock Operations

**STRIDE Category:** Repudiation  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
While the Lambda has basic execution role logging, there's no explicit configuration for detailed auditing of Bedrock Data Automation operations performed by the custom resource.

#### Attack Vector
An attacker who compromises the Lambda function could perform unauthorized actions on Bedrock resources without leaving sufficient audit trails to trace their activities.

#### Potential Impact
Difficulty in detecting malicious activities, investigating security incidents, and maintaining compliance with financial regulations for document processing systems.

#### Remediation
Enable AWS CloudTrail data events for Bedrock API calls. Implement additional application-level logging within the Lambda function that captures detailed information about all Bedrock operations and their outcomes.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-logging-and-monitoring.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005: Sensitive Document Processing Without Explicit Security Controls

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BDAProject` (Custom::BDAProject)  
**CWE ID:** CWE-312

#### Issue
The template creates a Bedrock Data Automation project that processes sensitive financial documents (Bank Statements, Payslips, Driver Licenses, etc.) but doesn't explicitly define security controls for data protection during processing.

#### Attack Vector
If the Bedrock Data Automation infrastructure is misconfigured or compromised, sensitive personal and financial information from processed documents could be exposed.

#### Potential Impact
Potential exposure of personally identifiable information (PII) and financial data, violating privacy regulations and potentially causing financial harm to customers.

#### Remediation
Implement encryption for data at rest and in transit for all Bedrock resources. Add resource policies to restrict access to processed documents. Implement data classification and access controls specific to document types being processed. Consider implementing DLP (Data Loss Prevention) mechanisms.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security.html

---

## Low Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004: Missing Concurrency Limits on Lambda Function

**STRIDE Category:** Denial of Service  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-400

#### Issue
The BDAProjectLambda function explicitly suppresses the W92 warning about missing concurrency limits. Without these limits, the function could potentially consume all available Lambda concurrency in the account during a deployment spike or if triggered repeatedly.

#### Attack Vector
An attacker could repeatedly invoke the function (if they gain access to trigger it) to deplete account Lambda concurrency limits, affecting other services in the account.

#### Potential Impact
Potential disruption to other Lambda functions in the account, affecting availability of related services.

#### Remediation
Implement reserved concurrency limits on the Lambda function to ensure it only uses a reasonable portion of the account's total concurrency. Monitor Lambda throttling metrics to detect abnormal invocation patterns.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-006: Lambda Function Without VPC Isolation

**STRIDE Category:** Spoofing  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-284

#### Issue
The BDAProjectLambda function explicitly suppresses the W89 warning about not requiring VPC access. This means the function runs outside a VPC, potentially increasing its attack surface and accessibility.

#### Attack Vector
While the function only interacts with AWS APIs, running outside a VPC means that if the function were compromised, an attacker would have direct internet access from the function execution environment.

#### Potential Impact
Increased attack surface and potential for data exfiltration if the function is compromised.

#### Remediation
Consider deploying the Lambda function within a VPC with appropriate security groups and NACLs to restrict outbound traffic to only what's necessary. Use VPC endpoints for AWS services the function needs to access.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# .aws-sam-build-DOCUMENTBEDROCKKB-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-53  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **6** medium, and **2** low severity findings.

## Priority Actions

### 1. Restrict access to OpenSearch Serverless resources to specific VPC endpoints or IP ranges instead of allowing public access. Implement strong authentication mechanisms for all OpenSearch Serverless access.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-002  
**Business Impact:** Potential exposure of sensitive data indexed in the OpenSearch Serverless collection or unauthorized access to search capabilities.

### 1. Restrict the bedrock:InvokeModel permission to only the specific embedding model required by the Knowledge Base by specifying the exact model ARN instead of using wildcards.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-005  
**Business Impact:** Potential for cost escalation through unauthorized model usage, data exfiltration through model responses, or abuse of AI capabilities.

### 2. Scope down IAM permissions by restricting S3 access to specific buckets and objects relevant to the function's operation. Limit OpenSearch Serverless API actions to specific collections using ARNs where possible instead of using '*' resource specifiers.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-001  
**Business Impact:** Potential unauthorized access to S3 data outside the intended scope and ability to manipulate OpenSearch Serverless collections beyond what's necessary for the function's operation.

### 2. Implement CloudWatch logging for Bedrock resources. Consider enabling AWS CloudTrail with appropriate log retention for API activity. Set up alarms for suspicious activity patterns.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-004  
**Business Impact:** Limited visibility into resource usage, potential security incidents, and compliance violations. Difficulty in forensic analysis if a breach occurs.

### 2. Consider packaging Lambda code directly within the CloudFormation template or use a secure CI/CD pipeline with code signing. Ensure the S3 bucket has appropriate access controls and versioning enabled. Implement integrity checks for Lambda code.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-008  
**Business Impact:** Potential execution of unauthorized code within the AWS account, which could lead to data exfiltration, credential theft, or further privilege escalation.

### 3. Consider using a customer-managed KMS key for OpenSearch Serverless encryption, especially for sensitive or regulated data. Modify the OSSEncryptionPolicy to use customer-managed keys by specifying a KMS key ARN.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-003  
**Business Impact:** Reduced control over encryption key lifecycle and potential compliance issues with regulations requiring customer-managed encryption.

### 3. Implement input validation in Lambda function code to ensure parameters meet expected formats and ranges. Consider adding error handling to gracefully handle invalid inputs.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-006  
**Business Impact:** Potential for function misuse, unexpected errors, or resource manipulation if custom resources are exploited.

### 3. Scope down the bedrock:StartIngestionJob permission to specifically reference the knowledge base created in this template by using the specific ARN rather than a wildcard in the resource element.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-009  
**Business Impact:** Potential disruption of other knowledge bases in the account, possible data contamination or resource exhaustion.

### 4. Consider setting a more conservative rate limit for the web crawler. Implement progressive crawling patterns and respect robots.txt files. Monitor crawler behavior to ensure it doesn't cause disruption.

**Effort:** Low  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-007  
**Business Impact:** Potential for inadvertent DoS against crawled websites, damaged business relationships, or IP address blocking by target sites.

### 4. Consider implementing additional authentication mechanisms for critical scheduled operations. Monitor for unusual patterns in scheduled job execution. Implement alerting for job failures or unexpected execution patterns.

**Effort:** Medium  
**Related Threats:** AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-010  
**Business Impact:** Potential for unauthorized triggering of resource-intensive operations leading to increased costs or service disruption.



## Detailed Threat Analysis

## High Severity Threats

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-002: Public Access to OpenSearch Serverless Collections

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OSSNetworkPolicy` (AWS::OpenSearchServerless::SecurityPolicy)  
**CWE ID:** CWE-668

#### Issue
The OSSNetworkPolicy allows public access to OpenSearch Serverless collections and dashboards by setting 'AllowFromPublic: true'

#### Attack Vector
Unauthorized users may attempt to access the OpenSearch Serverless dashboard or collection endpoints from the public internet, potentially leading to unauthorized data access if authentication is misconfigured.

#### Potential Impact
Potential exposure of sensitive data indexed in the OpenSearch Serverless collection or unauthorized access to search capabilities.

#### Remediation
Restrict access to OpenSearch Serverless resources to specific VPC endpoints or IP ranges instead of allowing public access. Implement strong authentication mechanisms for all OpenSearch Serverless access.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-security.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-005: Overly Permissive bedrock:InvokeModel Permission

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `KnowledgeBaseServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The KnowledgeBaseServiceRole has permission to invoke any Bedrock foundation model with the wildcard resource 'arn:aws:bedrock:${AWS::Region}::foundation-model/*'

#### Attack Vector
If the role is compromised, an attacker could invoke any Bedrock model, potentially using expensive models or extracting sensitive information through crafted prompts.

#### Potential Impact
Potential for cost escalation through unauthorized model usage, data exfiltration through model responses, or abuse of AI capabilities.

#### Remediation
Restrict the bedrock:InvokeModel permission to only the specific embedding model required by the Knowledge Base by specifying the exact model ARN instead of using wildcards.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_service-with-iam.html

---

## Medium Severity Threats

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-001: Overly Permissive IAM Policies

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has multiple policies with broad permissions including 'Resource: *' wildcards in several statements, particularly for S3 operations and OpenSearch Serverless API actions.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these broad permissions to access unintended S3 buckets or perform unauthorized actions on OpenSearch Serverless resources.

#### Potential Impact
Potential unauthorized access to S3 data outside the intended scope and ability to manipulate OpenSearch Serverless collections beyond what's necessary for the function's operation.

#### Remediation
Scope down IAM permissions by restricting S3 access to specific buckets and objects relevant to the function's operation. Limit OpenSearch Serverless API actions to specific collections using ARNs where possible instead of using '*' resource specifiers.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-003: Default AWS-Owned Encryption Key Used

**STRIDE Category:** Tampering  
**Affected Resource:** `OSSEncryptionPolicy` (AWS::OpenSearchServerless::SecurityPolicy)  
**CWE ID:** CWE-311

#### Issue
The OpenSearch Serverless collection is configured to use AWS-owned encryption keys ('AWSOwnedKey': true) rather than customer-managed keys, potentially reducing control over data encryption.

#### Attack Vector
In case of a compromise of AWS-managed keys or if regulatory requirements demand customer control of encryption keys, this configuration could expose data to unauthorized access.

#### Potential Impact
Reduced control over encryption key lifecycle and potential compliance issues with regulations requiring customer-managed encryption.

#### Remediation
Consider using a customer-managed KMS key for OpenSearch Serverless encryption, especially for sensitive or regulated data. Modify the OSSEncryptionPolicy to use customer-managed keys by specifying a KMS key ARN.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-encryption.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-004: Missing Monitoring and Logging Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `KnowledgeBase` (AWS::Bedrock::KnowledgeBase)  
**CWE ID:** CWE-778

#### Issue
The template does not define CloudWatch logging or monitoring for Bedrock Knowledge Base operations, making it difficult to track access, usage, and potential misuse.

#### Attack Vector
Without proper logging, attackers could abuse the Bedrock Knowledge Base and associated resources without leaving an audit trail, making incident investigation difficult.

#### Potential Impact
Limited visibility into resource usage, potential security incidents, and compliance violations. Difficulty in forensic analysis if a breach occurs.

#### Remediation
Implement CloudWatch logging for Bedrock resources. Consider enabling AWS CloudTrail with appropriate log retention for API activity. Set up alarms for suspicious activity patterns.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/monitoring.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-006: Lambda Functions Without Input Validation

**STRIDE Category:** Tampering  
**Affected Resource:** `GetAdjustedStackNameFunction, GetSeedUrlsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
The inline Lambda functions for GetAdjustedStackName and GetSeedUrls do not implement proper input validation for the data they process, potentially allowing injection attacks or unexpected behavior.

#### Attack Vector
Malicious input could potentially cause unexpected behavior if the Lambda functions process untrusted data without proper validation.

#### Potential Impact
Potential for function misuse, unexpected errors, or resource manipulation if custom resources are exploited.

#### Remediation
Implement input validation in Lambda function code to ensure parameters meet expected formats and ranges. Consider adding error handling to gracefully handle invalid inputs.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/lambda-security.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-008: Lambda Code from External S3 Bucket

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `StartIngestionJobFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-494

#### Issue
The StartIngestionJobFunction code is sourced from an S3 bucket ('bobs-artifacts-us-west-2') which may present supply chain risks if the bucket is compromised or the code is altered without verification.

#### Attack Vector
If the source S3 bucket is compromised, malicious code could be injected into the Lambda function, potentially allowing attackers to execute arbitrary code within the AWS environment.

#### Potential Impact
Potential execution of unauthorized code within the AWS account, which could lead to data exfiltration, credential theft, or further privilege escalation.

#### Remediation
Consider packaging Lambda code directly within the CloudFormation template or use a secure CI/CD pipeline with code signing. Ensure the S3 bucket has appropriate access controls and versioning enabled. Implement integrity checks for Lambda code.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/lambda-security.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-009: Limited Scope in Scheduler Role Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `DataSourceSchedulerRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The DataSourceSchedulerRole has permissions to start ingestion jobs on any knowledge base within the account, not just the specific knowledge base created by this template.

#### Attack Vector
If the scheduler role is compromised, an attacker could potentially trigger ingestion jobs for other knowledge bases in the account.

#### Potential Impact
Potential disruption of other knowledge bases in the account, possible data contamination or resource exhaustion.

#### Remediation
Scope down the bedrock:StartIngestionJob permission to specifically reference the knowledge base created in this template by using the specific ARN rather than a wildcard in the resource element.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Low Severity Threats

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-007: Web Crawler Rate Limits Could Be Exploited

**STRIDE Category:** Denial of Service  
**Affected Resource:** `WebDataSource` (AWS::Bedrock::DataSource)  
**CWE ID:** CWE-400

#### Issue
The WebDataSource crawler is configured with a relatively high rate limit of 300, which could potentially be used for DoS attacks against target websites if misconfigured.

#### Attack Vector
A misconfigured crawler with high rate limits could overwhelm target websites or trigger anti-scraping measures, disrupting service for legitimate users.

#### Potential Impact
Potential for inadvertent DoS against crawled websites, damaged business relationships, or IP address blocking by target sites.

#### Remediation
Consider setting a more conservative rate limit for the web crawler. Implement progressive crawling patterns and respect robots.txt files. Monitor crawler behavior to ensure it doesn't cause disruption.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-crawlers.html

---

### AWS_GENAI_IDP_ACCELERATOR_BEDROCK_KNOWLEDGE_BASE_SETUP-THREAT-010: Missing Authentication for Scheduled Job Triggers

**STRIDE Category:** Spoofing  
**Affected Resource:** `S3DataSourceScheduler, WebDataSourceScheduler` (AWS::Scheduler::Schedule)  
**CWE ID:** CWE-306

#### Issue
The scheduled jobs for S3 and Web data source synchronization do not have additional authentication mechanisms beyond the IAM role, potentially allowing anyone who can assume the role to trigger ingestion jobs.

#### Attack Vector
If the scheduler role credentials are obtained, an attacker could trigger ingestion jobs at will, potentially causing resource consumption or service disruption.

#### Potential Impact
Potential for unauthorized triggering of resource-intensive operations leading to increased costs or service disruption.

#### Remediation
Consider implementing additional authentication mechanisms for critical scheduled operations. Monitor for unusual patterns in scheduled job execution. Implement alerting for job failures or unexpected execution patterns.

**References:**
- https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-security.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# .aws-sam-build-PATTERN1STACK-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-10  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **1** low severity findings.

## Priority Actions

### 2. Restrict KMS permissions to only what's necessary for the function's operation. For example, if the function only needs to read encrypted data, limit to kms:Decrypt.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-001  
**Business Impact:** Potential unauthorized access to encrypted data or ability to manipulate encryption keys, leading to data confidentiality breaches.

### 2. Scope down the SSM Parameter permissions to specific parameter paths used by the application. Use a resource pattern like 'arn:aws:ssm:*:*:parameter/idp/*' to limit access to a specific path prefix.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-002  
**Business Impact:** Potential exposure of sensitive configuration data or credentials stored in Parameter Store across the entire AWS account.

### 2. Restrict Bedrock model access to only the specific models needed for the application. Replace the wildcard with specific model ARNs like 'arn:aws:bedrock:us-west-2::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0'.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-005  
**Business Impact:** Potential for unauthorized model access, cost escalation through usage of expensive models, or generation of harmful content through higher capability models.

### 3. Enhance the CloudWatch dashboard to include security-focused metrics and logs, including IAM access denied events, unusual API call patterns, and authentication failures.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-003  
**Business Impact:** Delayed detection of security incidents, potentially leading to longer exposure times during a breach or attack.

### 3. Implement CloudWatch alarms on the ApproximateNumberOfMessagesVisible metric for the DLQ with appropriate thresholds and notifications to alert when messages start accumulating.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-004  
**Business Impact:** Potential service degradation or processing failures without timely notification, leading to operational issues or incomplete document processing.

### 3. Configure AWS Backup or implement a scheduled backup solution for the DynamoDB table to ensure regular backups are taken in addition to Point-in-Time Recovery.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-006  
**Business Impact:** Risk of data loss or extended recovery times if the DynamoDB table data is corrupted or accidentally modified.

### 3. Implement centralized logging by configuring log exports to S3, setting up CloudWatch Logs Insights queries for security events, or integrating with a SIEM solution.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-007  
**Business Impact:** Reduced visibility into security events across the system, leading to longer investigation times and potential missed security signals.

### 3. Restrict the AppSync GraphQL access to only the specific mutations needed by the function by specifying the exact field names in the resource pattern rather than using a wildcard.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-008  
**Business Impact:** Unauthorized modification of data through the AppSync API, potentially affecting document processing status integrity.

### 3. Implement appropriate reserved concurrency limits on key Lambda functions to prevent excessive scaling and potential resource exhaustion.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-010  
**Business Impact:** Potential service disruption due to resource exhaustion or cost implications from unexpected Lambda scaling.

### 4. Set IncludeExecutionData to false and implement more granular logging that excludes sensitive document content while still providing necessary operational visibility.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-009  
**Business Impact:** Potential exposure of sensitive document information in CloudWatch Logs, accessible to anyone with logs access permissions.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-001: Overly Permissive Lambda IAM Permissions for KMS

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `InvokeBDAFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-250

#### Issue
The Lambda function has been granted broad permissions on the KMS key including Encrypt, Decrypt, ReEncrypt*, GenerateDataKey*, and DescribeKey. This exceeds the principle of least privilege as the function may only need specific operations like Decrypt.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these permissions to encrypt/decrypt data beyond what's needed for the function's intended purpose.

#### Potential Impact
Potential unauthorized access to encrypted data or ability to manipulate encryption keys, leading to data confidentiality breaches.

#### Remediation
Restrict KMS permissions to only what's necessary for the function's operation. For example, if the function only needs to read encrypted data, limit to kms:Decrypt.

**References:**
- https://docs.aws.amazon.com/kms/latest/developerguide/kms-api-permissions-reference.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-005: Overly Permissive Bedrock Model Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
The SummarizationFunction has broad permissions to invoke any foundation model in Amazon Bedrock with the resource pattern 'arn:aws:bedrock:*::foundation-model/*'.

#### Attack Vector
If compromised, an attacker could use the function to access any Bedrock model, potentially increasing costs dramatically or accessing more capable models to generate malicious content.

#### Potential Impact
Potential for unauthorized model access, cost escalation through usage of expensive models, or generation of harmful content through higher capability models.

#### Remediation
Restrict Bedrock model access to only the specific models needed for the application. Replace the wildcard with specific model ARNs like 'arn:aws:bedrock:us-west-2::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0'.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-iam.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-002: Excessive SSM Parameter Access

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-732

#### Issue
The ProcessResultsFunction has broad permissions to read and write any SSM parameter in the account (ssm:GetParameter, ssm:PutParameter, ssm:GetParametersByPath) with a resource pattern of '*'.

#### Attack Vector
A compromised function could access or modify sensitive parameters stored in Parameter Store that may contain credentials, API keys, or other sensitive configuration data unrelated to this application.

#### Potential Impact
Potential exposure of sensitive configuration data or credentials stored in Parameter Store across the entire AWS account.

#### Remediation
Scope down the SSM Parameter permissions to specific parameter paths used by the application. Use a resource pattern like 'arn:aws:ssm:*:*:parameter/idp/*' to limit access to a specific path prefix.

**References:**
- https://docs.aws.amazon.com/systems-manager/latest/userguide/security_iam_id-based-policy-examples.html#example-permissions-delegated-set

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-003: Insufficient Monitoring for Security Events

**STRIDE Category:** Repudiation  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-778

#### Issue
While the solution includes comprehensive operational dashboards for performance and errors, it lacks specific monitoring for security-related events such as authentication failures, permission denied errors, or suspicious API calls.

#### Attack Vector
Security incidents or unauthorized access attempts might go undetected without specific monitoring for security events.

#### Potential Impact
Delayed detection of security incidents, potentially leading to longer exposure times during a breach or attack.

#### Remediation
Enhance the CloudWatch dashboard to include security-focused metrics and logs, including IAM access denied events, unusual API call patterns, and authentication failures.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards_Security_Monitoring.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-004: Missing DLQ Monitoring and Alerting

**STRIDE Category:** Denial of Service  
**Affected Resource:** `BDACompletionFunctionDLQ` (AWS::SQS::Queue)  
**CWE ID:** CWE-778

#### Issue
The BDACompletionFunctionDLQ is configured as a dead letter queue for failed Lambda invocations, but there's no monitoring or alerting configured to notify when messages are sent to this queue.

#### Attack Vector
Failed processing may go undetected if messages accumulate in the DLQ without alerts, potentially causing workflow disruptions or data processing failures.

#### Potential Impact
Potential service degradation or processing failures without timely notification, leading to operational issues or incomplete document processing.

#### Remediation
Implement CloudWatch alarms on the ApproximateNumberOfMessagesVisible metric for the DLQ with appropriate thresholds and notifications to alert when messages start accumulating.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-sqs-queue.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-006: No DynamoDB Table Backup Configuration

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAMetadataTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-693

#### Issue
The BDAMetadataTable has Point-in-Time Recovery enabled, but no regular backup schedule is defined. This could lead to potential data loss if corruption occurs.

#### Attack Vector
In case of accidental or malicious data corruption, the recovery options may be limited without regular backups.

#### Potential Impact
Risk of data loss or extended recovery times if the DynamoDB table data is corrupted or accidentally modified.

#### Remediation
Configure AWS Backup or implement a scheduled backup solution for the DynamoDB table to ensure regular backups are taken in addition to Point-in-Time Recovery.

**References:**
- https://docs.aws.amazon.com/aws-backup/latest/devguide/dynamo-db-backup.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-007: Centralized Logging Configuration Missing

**STRIDE Category:** Repudiation  
**Affected Resource:** `Multiple Log Groups` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-778

#### Issue
While CloudWatch Log Groups are defined for individual Lambda functions, there's no centralized logging solution configured (like CloudWatch Logs Insights queries, Log Groups exporting to S3, or integration with security monitoring tools).

#### Attack Vector
Distributed logs make security incident investigation more difficult, potentially allowing attackers' actions to go undetected across multiple components.

#### Potential Impact
Reduced visibility into security events across the system, leading to longer investigation times and potential missed security signals.

#### Remediation
Implement centralized logging by configuring log exports to S3, setting up CloudWatch Logs Insights queries for security events, or integrating with a SIEM solution.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-008: Unrestricted AppSync GraphQL API Access

**STRIDE Category:** Spoofing  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-284

#### Issue
The ProcessResultsFunction has access to execute any mutation on the AppSync GraphQL API without specific operation restrictions.

#### Attack Vector
If compromised, the function could be used to execute unintended mutations on the GraphQL API, potentially manipulating document status data.

#### Potential Impact
Unauthorized modification of data through the AppSync API, potentially affecting document processing status integrity.

#### Remediation
Restrict the AppSync GraphQL access to only the specific mutations needed by the function by specifying the exact field names in the resource pattern rather than using a wildcard.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security-authz.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-010: Missing Lambda Concurrency Limits

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
None of the Lambda functions have concurrency limits defined, which could lead to resource exhaustion if there's an unexpected spike in invocations.

#### Attack Vector
An attacker could trigger excessive Lambda invocations that might impact other services or exceed Bedrock API limits.

#### Potential Impact
Potential service disruption due to resource exhaustion or cost implications from unexpected Lambda scaling.

#### Remediation
Implement appropriate reserved concurrency limits on key Lambda functions to prevent excessive scaling and potential resource exhaustion.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

## Low Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-009: Step Functions Execution Data Logging Enabled

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-532

#### Issue
The DocumentProcessingStateMachine has IncludeExecutionData set to true, which logs the entire content of state machine executions, potentially including sensitive document data.

#### Attack Vector
Anyone with access to CloudWatch Logs could view potentially sensitive information from documents being processed.

#### Potential Impact
Potential exposure of sensitive document information in CloudWatch Logs, accessible to anyone with logs access permissions.

#### Remediation
Set IncludeExecutionData to false and implement more granular logging that excludes sensitive document content while still providing necessary operational visibility.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-logs.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# .aws-sam-build-PATTERN2STACK-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-02  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **1** low severity findings.

## Priority Actions

### 1. Set IncludeExecutionData to false for the state machine logging configuration, and implement specific, controlled logging at the individual Lambda function level with proper data filtering.

**Effort:** Low  
**Related Threats:** PATTERN2-SUBSET-THREAT-001  
**Business Impact:** Unauthorized exposure of sensitive document data which could lead to data leakage, privacy violations, or regulatory non-compliance.

### 1. Restrict Textract permissions to only those APIs actually needed (DetectDocumentText and AnalyzeDocument) and implement resource-based constraints where possible.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-002  
**Business Impact:** Potential for privilege escalation, allowing attackers to perform unauthorized Textract operations on any document in the account.

### 2. Restrict Bedrock permissions to only the specific models needed by each function. Replace 'arn:aws:bedrock:*::foundation-model/*' with specific model ARNs.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-003  
**Business Impact:** Potential for unauthorized access to sensitive AI models, excessive cost generation, or using more powerful models for data extraction than intended.

### 2. Implement prefix-based access controls for S3 buckets, giving each Lambda function access only to the specific prefixes (folders) it needs to operate.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-004  
**Business Impact:** Data integrity issues, potential for denial of service by removing working files, or insertion of malicious content into the document processing pipeline.

### 2. Set appropriate maximum concurrency limits for each Lambda function to prevent resource exhaustion, and consider implementing throttling at the workflow entry point.

**Effort:** Low  
**Related Threats:** PATTERN2-SUBSET-THREAT-007  
**Business Impact:** Potential denial of service for other applications sharing the same AWS account, or excessive costs from unbounded Lambda execution.

### 2. Store sensitive configuration in AWS Secrets Manager or Parameter Store with encryption, and retrieve them at runtime. Consider implementing environment variable encryption for Lambda.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-008  
**Business Impact:** Exposure of internal system architecture, API endpoints, and configuration that could facilitate further attacks.

### 2. Ensure the UpdateConfigurationFunction implements strict input validation for all schema inputs and handles them as data, not executable code.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-009  
**Business Impact:** Potential execution of unauthorized code within the context of the custom resource's Lambda function.

### 3. Add a constraint to the LogRetentionDays parameter with a minimum value that meets compliance requirements, and ensure a reasonable default value is set.

**Effort:** Low  
**Related Threats:** PATTERN2-SUBSET-THREAT-005  
**Business Impact:** Potential loss of audit trails, hampering incident investigation and creating compliance violations for required log retention periods.

### 3. Implement proper IAM restrictions for dashboard access and ensure error logs shown in the dashboard don't include sensitive document content.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-006  
**Business Impact:** Unauthorized exposure of document content, processing metadata, or system configuration that could aid in further attacks.

### 3. Implement checksums or digital signatures for intermediate processing artifacts and validate them before finalizing results.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-010  
**Business Impact:** Tampering with document processing results could lead to incorrect data extraction, potentially impacting business decisions based on this data.



## Detailed Threat Analysis

## High Severity Threats

### PATTERN2-SUBSET-THREAT-002: Overly Permissive IAM Policies in OCR Lambda Function

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has a policy statement that grants permissions to all Textract APIs with a wildcard resource ('*'). This violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these permissions to access Textract services across all regions and accounts where the credentials are valid.

#### Potential Impact
Potential for privilege escalation, allowing attackers to perform unauthorized Textract operations on any document in the account.

#### Remediation
Restrict Textract permissions to only those APIs actually needed (DetectDocumentText and AnalyzeDocument) and implement resource-based constraints where possible.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### PATTERN2-SUBSET-THREAT-008: Potential Data Leakage in Lambda Environment Variables

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-527

#### Issue
Multiple Lambda functions contain sensitive configuration parameters in environment variables, including API URLs and service configurations that could be exposed if the Lambda runtime is compromised.

#### Attack Vector
An attacker who can execute code in the Lambda environment (through dependency injection or similar) could access environment variables containing sensitive configuration data.

#### Potential Impact
Exposure of internal system architecture, API endpoints, and configuration that could facilitate further attacks.

#### Remediation
Store sensitive configuration in AWS Secrets Manager or Parameter Store with encryption, and retrieve them at runtime. Consider implementing environment variable encryption for Lambda.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html#configuration-envvars-encryption

---

## Medium Severity Threats

### PATTERN2-SUBSET-THREAT-001: Sensitive Document Data Exposure Through State Machine Execution History

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-200

#### Issue
The DocumentProcessingStateMachine has logging configured with IncludeExecutionData set to true, which logs all input/output data. This may include sensitive information from processed documents.

#### Attack Vector
An attacker with access to CloudWatch logs could view potentially sensitive document content that was passed between steps in the workflow.

#### Potential Impact
Unauthorized exposure of sensitive document data which could lead to data leakage, privacy violations, or regulatory non-compliance.

#### Remediation
Set IncludeExecutionData to false for the state machine logging configuration, and implement specific, controlled logging at the individual Lambda function level with proper data filtering.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-log-level.html

---

### PATTERN2-SUBSET-THREAT-003: Excessive Bedrock Model Access Across Lambda Functions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
Multiple Lambda functions (OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction) have broad access to all Bedrock foundation models and inference profiles through wildcard resources.

#### Attack Vector
If any of these functions were compromised, an attacker could potentially use credentials to access any Bedrock model available in the account, possibly incurring high costs or accessing more powerful models than intended.

#### Potential Impact
Potential for unauthorized access to sensitive AI models, excessive cost generation, or using more powerful models for data extraction than intended.

#### Remediation
Restrict Bedrock permissions to only the specific models needed by each function. Replace 'arn:aws:bedrock:*::foundation-model/*' with specific model ARNs.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### PATTERN2-SUBSET-THREAT-004: Cross-Lambda Bucket Access Without Resource Isolation

**STRIDE Category:** Tampering  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-284

#### Issue
Multiple Lambda functions have full read/write access to the same S3 buckets (WorkingBucket, OutputBucket) without proper resource-level isolation, which could allow one compromised function to tamper with data from other functions.

#### Attack Vector
A compromised Lambda could modify or delete files created by other Lambdas in the workflow, potentially corrupting document processing results.

#### Potential Impact
Data integrity issues, potential for denial of service by removing working files, or insertion of malicious content into the document processing pipeline.

#### Remediation
Implement prefix-based access controls for S3 buckets, giving each Lambda function access only to the specific prefixes (folders) it needs to operate.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_s3_rw-bucket-prefix.html

---

### PATTERN2-SUBSET-THREAT-005: Insufficient CloudWatch Logs Retention Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `Multiple Log Groups` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-778

#### Issue
While CloudWatch log groups are configured with a retention period via the LogRetentionDays parameter, there's no validation or default setting to ensure compliance with data retention requirements.

#### Attack Vector
An attacker who gains access to CloudFormation could set a very short retention period, causing logs to be deleted quickly and eliminating evidence of malicious activity.

#### Potential Impact
Potential loss of audit trails, hampering incident investigation and creating compliance violations for required log retention periods.

#### Remediation
Add a constraint to the LogRetentionDays parameter with a minimum value that meets compliance requirements, and ensure a reasonable default value is set.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html

---

### PATTERN2-SUBSET-THREAT-006: Sensitive Information Exposure in CloudWatch Dashboard

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-200

#### Issue
The CloudWatch Dashboard may display error logs containing sensitive information from document processing, and lacks access controls to restrict who can view this dashboard.

#### Attack Vector
Users with CloudWatch access could view the dashboard and see potentially sensitive information from document errors or processing details.

#### Potential Impact
Unauthorized exposure of document content, processing metadata, or system configuration that could aid in further attacks.

#### Remediation
Implement proper IAM restrictions for dashboard access and ensure error logs shown in the dashboard don't include sensitive document content.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch-dashboard-access-control.html

---

### PATTERN2-SUBSET-THREAT-007: Missing Concurrency Limits on Document Processing Lambda Functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
Lambda functions in the document processing workflow don't have reserved or maximum concurrency settings, which could lead to resource exhaustion under high load.

#### Attack Vector
An attacker could submit a large number of documents for processing simultaneously, causing the system to consume all available Lambda concurrency in the account.

#### Potential Impact
Potential denial of service for other applications sharing the same AWS account, or excessive costs from unbounded Lambda execution.

#### Remediation
Set appropriate maximum concurrency limits for each Lambda function to prevent resource exhaustion, and consider implementing throttling at the workflow entry point.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### PATTERN2-SUBSET-THREAT-009: Potential Code Injection in Custom Resource Configuration

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `UpdateSchemaConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-94

#### Issue
The UpdateSchemaConfig custom resource contains complex JSON schema definitions that are processed by a custom resource. This could potentially be vulnerable to code injection if not properly validated.

#### Attack Vector
An attacker with access to CloudFormation could attempt to inject malicious code or commands into the schema definitions that might be evaluated during template processing.

#### Potential Impact
Potential execution of unauthorized code within the context of the custom resource's Lambda function.

#### Remediation
Ensure the UpdateConfigurationFunction implements strict input validation for all schema inputs and handles them as data, not executable code.

**References:**
- https://owasp.org/www-community/attacks/Code_Injection

---

## Low Severity Threats

### PATTERN2-SUBSET-THREAT-010: Missing Integrity Validation in Document Processing Results

**STRIDE Category:** Tampering  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-354

#### Issue
The ProcessResultsFunction doesn't appear to include mechanisms to validate the integrity of processed document data before storing final results.

#### Attack Vector
An attacker who gains access to the working S3 bucket could potentially modify intermediate processing results before they're finalized.

#### Potential Impact
Tampering with document processing results could lead to incorrect data extraction, potentially impacting business decisions based on this data.

#### Remediation
Implement checksums or digital signatures for intermediate processing artifacts and validate them before finalizing results.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# .aws-sam-build-PATTERN3STACK-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-09  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **3** high, **6** medium, and **1** low severity findings.

## Priority Actions

### 1. Restrict IAM policies to only the specific resources needed. Where APIs don't support resource-level permissions, consider using IAM policy conditions to limit scope (e.g., by specifying allowed metric namespaces for CloudWatch).

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-002  
**Business Impact:** Potential unauthorized access to AWS resources, escalation of privileges, and ability to perform actions outside the intended scope of the function.

### 1. Implement bucket policies restricting access to authorized principals only. Enable S3 access logging and versioning. Configure default encryption for all objects. Consider implementing S3 Object Lock for immutable storage of processed documents.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-008  
**Business Impact:** Unauthorized access to sensitive documents, potential data loss or modification, and lack of audit trail for document access or changes.

### 2. Implement log filtering to prevent sensitive data from being logged. Add resource-based policies to the CloudWatch Log groups to restrict access to authorized personnel only. Consider implementing AWS CloudWatch Logs Filter Subscriptions to filter sensitive information.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-001  
**Business Impact:** Unauthorized access to sensitive document content, extraction results, or possibly credentials that might be logged during processing.

### 2. Deploy Lambda functions within a VPC with appropriate subnet configuration and security groups. Use VPC endpoints for AWS services to maintain private communications. Implement a NAT gateway only if external connectivity is required.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-004  
**Business Impact:** Increased risk of data exfiltration, unnecessary network exposure, and potential for compromised functions to communicate with unauthorized external endpoints.

### 2. Implement comprehensive input validation for all document inputs. Validate file formats, sizes, and content before processing. Consider adding content scanning for malicious patterns. Use safe parsing libraries that are resistant to common attacks.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-005  
**Business Impact:** Potential code injection, application crashes, or unexpected behavior that could lead to data leakage or resource consumption attacks.

### 2. Ensure all configuration data is encrypted both at rest and in transit. Implement strict IAM permissions for configuration access. Consider storing sensitive configuration elements in AWS Secrets Manager instead of directly in CloudFormation.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-007  
**Business Impact:** Exposure of sensitive business rules, document classification patterns, or extraction logic that could be used to craft evasive documents or understand the organization's document handling procedures.

### 2. Implement robust prompt engineering practices with input sanitization. Use Bedrock guardrails (already partially implemented) more extensively. Add content filtering before sending to AI models. Monitor AI responses for anomalous patterns that might indicate prompt injection.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-009  
**Business Impact:** Data leakage, inaccurate document classification or extraction, and potential exposure of system details or processing logic.

### 3. Implement additional logging focused on security-relevant events. Configure CloudTrail data events for relevant S3 buckets. Add explicit audit logging within Lambda functions for sensitive operations with details about who performed what action on which document.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-003  
**Business Impact:** Difficulty in forensic analysis after a security incident, challenges in compliance auditing, and inability to detect unauthorized document access patterns.

### 3. Configure appropriate reserved concurrency limits for each Lambda function. Implement request throttling at the API layer. Consider implementing a queue-based architecture to control the processing rate of documents.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-006  
**Business Impact:** Service disruption, increased costs, and potential impact on other applications sharing the same AWS account resources.

### 4. Add security-focused metrics and alarms to the dashboard. Configure CloudWatch Alarms for unusual activity patterns. Consider implementing GuardDuty or Security Hub integration. Add metrics specifically for authentication failures, access denials, and other security events.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-010  
**Business Impact:** Delayed detection of security incidents, inability to identify unusual patterns of behavior that might indicate compromise, and lack of visibility into security-relevant events.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-002: Overly permissive IAM policies with wildcard resources

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction, ClassificationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
Several Lambda functions have IAM policies with wildcard resources for Textract and CloudWatch PutMetricData APIs, granting broader access than necessary and violating the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could exploit these broad permissions to access other resources or services beyond what's required for the function's operation.

#### Potential Impact
Potential unauthorized access to AWS resources, escalation of privileges, and ability to perform actions outside the intended scope of the function.

#### Remediation
Restrict IAM policies to only the specific resources needed. Where APIs don't support resource-level permissions, consider using IAM policy conditions to limit scope (e.g., by specifying allowed metric namespaces for CloudWatch).

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-007: Potential sensitive configuration data exposure

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UpdateSchemaConfig, UpdateDefaultConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-200

#### Issue
The template uses custom resources to update schema and default configurations, potentially exposing sensitive configuration data if not properly secured. This configuration likely includes document processing rules that could reveal business logic or confidential information processing patterns.

#### Attack Vector
An attacker with access to the CloudFormation stack or configuration data could gather intelligence about document processing rules, potentially discovering ways to bypass security controls.

#### Potential Impact
Exposure of sensitive business rules, document classification patterns, or extraction logic that could be used to craft evasive documents or understand the organization's document handling procedures.

#### Remediation
Ensure all configuration data is encrypted both at rest and in transit. Implement strict IAM permissions for configuration access. Consider storing sensitive configuration elements in AWS Secrets Manager instead of directly in CloudFormation.

**References:**
- https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-008: Missing S3 bucket security configurations

**STRIDE Category:** Tampering  
**Affected Resource:** `InputBucket, OutputBucket, ConfigurationBucket, WorkingBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-284

#### Issue
The CloudFormation template references S3 buckets but doesn't define or enforce security configurations such as bucket policies, access logging, versioning, or object-level encryption requirements. This could leave documents vulnerable to unauthorized access or tampering.

#### Attack Vector
An attacker could potentially access or modify documents if bucket permissions are misconfigured. Without versioning, tampered or deleted documents couldn't be recovered.

#### Potential Impact
Unauthorized access to sensitive documents, potential data loss or modification, and lack of audit trail for document access or changes.

#### Remediation
Implement bucket policies restricting access to authorized principals only. Enable S3 access logging and versioning. Configure default encryption for all objects. Consider implementing S3 Object Lock for immutable storage of processed documents.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-001: Potential log data exposure through CloudWatch Logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-532

#### Issue
Lambda functions are configured to log to CloudWatch Logs, which may include sensitive document content, extraction results, or credentials if not properly filtered. These logs lack specific access restrictions beyond the default KMS encryption.

#### Attack Vector
An attacker with CloudWatch Logs access permissions could view potentially sensitive document data processed by the Lambda functions.

#### Potential Impact
Unauthorized access to sensitive document content, extraction results, or possibly credentials that might be logged during processing.

#### Remediation
Implement log filtering to prevent sensitive data from being logged. Add resource-based policies to the CloudWatch Log groups to restrict access to authorized personnel only. Consider implementing AWS CloudWatch Logs Filter Subscriptions to filter sensitive information.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-003: Potential for insufficient auditing of document processing

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-778

#### Issue
While the state machine has logging enabled, there's no explicit configuration for capturing detailed execution data for specific sensitive operations or for monitoring specific transitions that may indicate security-relevant events.

#### Attack Vector
An insider or attacker with access to the system could perform unauthorized actions on documents without sufficient audit trail to identify the specific actor or actions taken.

#### Potential Impact
Difficulty in forensic analysis after a security incident, challenges in compliance auditing, and inability to detect unauthorized document access patterns.

#### Remediation
Implement additional logging focused on security-relevant events. Configure CloudTrail data events for relevant S3 buckets. Add explicit audit logging within Lambda functions for sensitive operations with details about who performed what action on which document.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-logs.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-004: Lack of VPC isolation for Lambda functions

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-668

#### Issue
Lambda functions are not configured to run within a VPC, which could expose them to unnecessary network access and reduce isolation. Functions processing potentially sensitive documents would benefit from additional network isolation.

#### Attack Vector
Without VPC isolation, Lambda functions have direct internet access, increasing attack surface and potentially allowing data exfiltration if compromised.

#### Potential Impact
Increased risk of data exfiltration, unnecessary network exposure, and potential for compromised functions to communicate with unauthorized external endpoints.

#### Remediation
Deploy Lambda functions within a VPC with appropriate subnet configuration and security groups. Use VPC endpoints for AWS services to maintain private communications. Implement a NAT gateway only if external connectivity is required.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-005: No explicit input validation for document processing

**STRIDE Category:** Tampering  
**Affected Resource:** `All Lambda functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
The CloudFormation template doesn't indicate implementation of robust input validation for documents being processed. Without proper validation, malicious documents could potentially trigger vulnerabilities in the processing pipeline.

#### Attack Vector
An attacker could submit specially crafted documents designed to exploit vulnerabilities in the processing libraries or to trigger unexpected behaviors in the Lambda functions.

#### Potential Impact
Potential code injection, application crashes, or unexpected behavior that could lead to data leakage or resource consumption attacks.

#### Remediation
Implement comprehensive input validation for all document inputs. Validate file formats, sizes, and content before processing. Consider adding content scanning for malicious patterns. Use safe parsing libraries that are resistant to common attacks.

**References:**
- https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-006: Missing concurrent execution limits on Lambda functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `All Lambda functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
Lambda functions don't have concurrent execution limits defined, which could lead to resource exhaustion if many documents are processed simultaneously, either legitimately or as part of a DoS attack.

#### Attack Vector
An attacker could trigger many simultaneous document processing requests, potentially exhausting available Lambda concurrency or downstream resources like Bedrock or Textract.

#### Potential Impact
Service disruption, increased costs, and potential impact on other applications sharing the same AWS account resources.

#### Remediation
Configure appropriate reserved concurrency limits for each Lambda function. Implement request throttling at the API layer. Consider implementing a queue-based architecture to control the processing rate of documents.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-009: Potential prompt injection vulnerabilities

**STRIDE Category:** Spoofing  
**Affected Resource:** `ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-74

#### Issue
Functions that use AI models (Bedrock) are processing user-supplied content that could be vulnerable to prompt injection attacks, where carefully crafted document content could manipulate the AI model's behavior.

#### Attack Vector
An attacker could submit documents with specially crafted content designed to manipulate the AI model's behavior, potentially extracting unauthorized information or bypassing security controls.

#### Potential Impact
Data leakage, inaccurate document classification or extraction, and potential exposure of system details or processing logic.

#### Remediation
Implement robust prompt engineering practices with input sanitization. Use Bedrock guardrails (already partially implemented) more extensively. Add content filtering before sending to AI models. Monitor AI responses for anomalous patterns that might indicate prompt injection.

**References:**
- https://www.amazon.com/Guardrails-User-Guide/dp/B0CYS1JMXS

---

## Low Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-010: Insufficient security metrics and alerting

**STRIDE Category:** Repudiation  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-223

#### Issue
The CloudWatch dashboard focuses primarily on performance metrics rather than security-related metrics, potentially missing important security events or patterns that could indicate compromise.

#### Attack Vector
An attacker exploiting the system might not trigger alerts if the monitoring is focused only on performance and not security-relevant events.

#### Potential Impact
Delayed detection of security incidents, inability to identify unusual patterns of behavior that might indicate compromise, and lack of visibility into security-relevant events.

#### Remediation
Add security-focused metrics and alarms to the dashboard. Configure CloudWatch Alarms for unusual activity patterns. Consider implementing GuardDuty or Security Hub integration. Add metrics specifically for authentication failures, access denials, and other security events.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# .aws-sam-build-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-57  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **20** security threats. The analysis reveals **1** critical, **6** high, **12** medium, and **1** low severity findings.

## Priority Actions

### 1. Enable MFA for the Cognito UserPool by adding MfaConfiguration set to 'ON' or 'OPTIONAL' and configuring appropriate MFA options. Consider enforcing MFA for all users, especially administrators.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-003  
**Business Impact:** Increased risk of unauthorized access to the system, potentially leading to data breaches or compromise of the IDP processing pipeline.

### 1. Refine IAM policies to scope down permissions to specific resources rather than using wildcards. For each Lambda function or resource, create specific permission statements with exact ARNs rather than using broader resource patterns.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-004  
**Business Impact:** Potential for lateral movement within the AWS environment, accessing sensitive data or performing unauthorized operations across multiple services.

### 1. Modify the IAM policy to restrict permissions to specific resources by replacing '*' wildcards with specific ARNs for the Cognito user pools and SageMaker workteams that this role needs to access.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-008  
**Business Impact:** Potential unauthorized modifications to authentication systems or access to sensitive workteam information across the entire AWS account.

### 1. Implement template validation using AWS CloudFormation Guard or similar tools. Add integrity checks for nested templates. Consider using AWS CloudFormation registry for storing validated templates. Ensure all template sources are from trusted, secure locations with appropriate access controls.

**Effort:** High  
**Related Threats:** GENAI-IDP-THREAT-016  
**Business Impact:** Potential for complete compromise of the AWS account, unauthorized data access, and persistent backdoor installation.

### 1. Restrict bedrock:InvokeModel permissions to specific models that are required. Always implement guardrails for AI model access, particularly when user input may influence prompts. Add Bedrock guardrails to all model invocations and restrict output handling.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-017  
**Business Impact:** Potential for data exfiltration, generation of harmful content, or bypassing of business logic through AI model manipulation.

### 2. Use a custom SSL certificate with AWS Certificate Manager (ACM) and configure a custom domain name for the CloudFront distribution. Update the ViewerCertificate configuration to use ACM certificate instead of the default certificate.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-001  
**Business Impact:** Users may be more vulnerable to phishing attacks, potentially leading to credential theft and unauthorized access to the system.

### 2. Remove the condition that disables WAF when the IP range is set to '0.0.0.0/0'. Instead, always enable WAF with appropriate rule sets, and offer IP restriction as an additional layer of security rather than a replacement for WAF.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-002  
**Business Impact:** Increased risk of API abuse, data scraping, or exploitation of any API vulnerabilities, which could lead to unauthorized access to sensitive document processing data.

### 2. Implement query complexity analysis and depth limiting for the GraphQL API. Consider using AWS WAF rate limiting rules specifically for the AppSync endpoint to prevent abuse.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-005  
**Business Impact:** Potential for API performance degradation or complete unavailability, affecting the entire document processing pipeline and user experience.

### 2. Consider always setting field-level logging to ALL regardless of the general logging level to ensure comprehensive audit trails for security monitoring. Create separate log filters for operational purposes if log volume is a concern.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-006  
**Business Impact:** Reduced ability to detect, investigate, and respond to security incidents, potentially allowing malicious activities to go unnoticed.

### 2. Scope down the permissions to specific resource ARNs rather than using wildcards. Limit the lambda:AddPermission and lambda:RemovePermission actions to only the specific Lambda functions that need these permissions modified.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-010  
**Business Impact:** Potential for privilege escalation and unauthorized configuration changes that could lead to persistent access or service disruption.



## Detailed Threat Analysis

## Critical Severity Threats

### GENAI-IDP-THREAT-016: Potential Code Injection in Nested CloudFormation Templates

**STRIDE Category:** Tampering  
**Affected Resource:** `Pattern1STACK, Pattern2STACK, Pattern3STACK` (Multiple Lambda Functions)  
**CWE ID:** CWE-94

#### Issue
The template uses multiple nested CloudFormation stacks (PATTERN1STACK, PATTERN2STACK, PATTERN3STACK) without validating the integrity of these templates. If these template sources are compromised, they could contain malicious code that would be executed with the permissions of the IAM roles created.

#### Attack Vector
If an attacker can modify the source of the nested templates or if the source repository is compromised, they could inject malicious code that would be executed with the permissions granted to the various IAM roles.

#### Potential Impact
Potential for complete compromise of the AWS account, unauthorized data access, and persistent backdoor installation.

#### Remediation
Implement template validation using AWS CloudFormation Guard or similar tools. Add integrity checks for nested templates. Consider using AWS CloudFormation registry for storing validated templates. Ensure all template sources are from trusted, secure locations with appropriate access controls.

**References:**
- https://docs.aws.amazon.com/cloudformation-cli/latest/userguide/resource-type-schema.html

---

## High Severity Threats

### GENAI-IDP-THREAT-001: CloudFront Distribution Uses Default SSL Certificate

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `CloudFrontDistribution` (AWS::CloudFront::Distribution)  
**CWE ID:** CWE-295

#### Issue
The CloudFront distribution is configured with CloudFrontDefaultCertificate set to true, which means it's using the default *.cloudfront.net domain and certificate. This can make the application susceptible to phishing attacks as users have no way to verify the authenticity of the domain.

#### Attack Vector
An attacker could create a similarly named domain with a valid SSL certificate to trick users into providing their credentials or sensitive information.

#### Potential Impact
Users may be more vulnerable to phishing attacks, potentially leading to credential theft and unauthorized access to the system.

#### Remediation
Use a custom SSL certificate with AWS Certificate Manager (ACM) and configure a custom domain name for the CloudFront distribution. Update the ViewerCertificate configuration to use ACM certificate instead of the default certificate.

**References:**
- https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https-alternate-domain-names.html

---

### GENAI-IDP-THREAT-003: Cognito User Pool MFA Not Enabled

**STRIDE Category:** Tampering  
**Affected Resource:** `UserPool` (AWS::Cognito::UserPool)  
**CWE ID:** CWE-308

#### Issue
The Cognito UserPool is configured without Multi-Factor Authentication (MFA). MFA is not required or enforced for users, which significantly reduces the security of user authentication.

#### Attack Vector
An attacker who compromises user credentials would be able to access the system without needing to bypass an additional authentication factor.

#### Potential Impact
Increased risk of unauthorized access to the system, potentially leading to data breaches or compromise of the IDP processing pipeline.

#### Remediation
Enable MFA for the Cognito UserPool by adding MfaConfiguration set to 'ON' or 'OPTIONAL' and configuring appropriate MFA options. Consider enforcing MFA for all users, especially administrators.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html

---

### GENAI-IDP-THREAT-004: Over-Privileged AppSync Service Role

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `AppSyncServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The AppSyncServiceRole has broad permissions with wildcard resources for various actions, including access to KMS keys and Lambda functions. This violates the principle of least privilege and could allow unintended access across services.

#### Attack Vector
If the AppSync service is compromised, an attacker could leverage the excessive permissions to access multiple resources or escalate privileges further within the AWS account.

#### Potential Impact
Potential for lateral movement within the AWS environment, accessing sensitive data or performing unauthorized operations across multiple services.

#### Remediation
Refine IAM policies to scope down permissions to specific resources rather than using wildcards. For each Lambda function or resource, create specific permission statements with exact ARNs rather than using broader resource patterns.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-008: IAM Role with Broad Permissions and Resource Wildcards

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `CognitoClientUpdaterRole` (AWS::IAM::Role)  
**CWE ID:** CWE-269

#### Issue
The CognitoClientUpdaterRole has permissions with wildcard resource specifiers for critical operations like 'cognito-idp:UpdateUserPoolClient' and 'sagemaker:DescribeWorkteam'. This violates the principle of least privilege by allowing access to all resources of these types.

#### Attack Vector
If compromised, an attacker could use this role to modify any Cognito user pool client in the account or access information about any SageMaker workteam.

#### Potential Impact
Potential unauthorized modifications to authentication systems or access to sensitive workteam information across the entire AWS account.

#### Remediation
Modify the IAM policy to restrict permissions to specific resources by replacing '*' wildcards with specific ARNs for the Cognito user pools and SageMaker workteams that this role needs to access.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-014: Default Email Configuration May Use Unverified Sender Addresses

**STRIDE Category:** Tampering  
**Affected Resource:** `UserPool` (AWS::Cognito::UserPool)  
**CWE ID:** CWE-290

#### Issue
The UserPool uses the default Cognito email configuration (EmailSendingAccount: COGNITO_DEFAULT) without specifying custom verified email addresses. This can lead to emails being sent from generic AWS addresses, which may look suspicious and increase phishing risks.

#### Attack Vector
Attackers could send phishing emails that mimic the generic AWS Cognito emails, making it harder for users to distinguish legitimate communications from phishing attempts.

#### Potential Impact
Increased risk of successful phishing attacks against users, potentially leading to credential theft and unauthorized system access.

#### Remediation
Configure a custom email sender with SES by setting EmailSendingAccount to DEVELOPER and providing verified SES email configuration, including customized FROM and REPLY-TO addresses that match your organization's domain.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-email.html

---

### GENAI-IDP-THREAT-017: AI Model Access Without Guardrails

**STRIDE Category:** Tampering  
**Affected Resource:** `AnalyticsProcessorFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-20

#### Issue
The AnalyticsProcessorFunction and several other functions have permissions to invoke any foundation model in Amazon Bedrock with 'bedrock:InvokeModel' permissions on 'arn:aws:bedrock:*::foundation-model/*'. This broad access could lead to prompt injection vulnerabilities or uncontrolled AI outputs.

#### Attack Vector
An attacker who can control input to these functions could potentially craft prompts that bypass intended guardrails or extract sensitive information through carefully crafted prompts.

#### Potential Impact
Potential for data exfiltration, generation of harmful content, or bypassing of business logic through AI model manipulation.

#### Remediation
Restrict bedrock:InvokeModel permissions to specific models that are required. Always implement guardrails for AI model access, particularly when user input may influence prompts. Add Bedrock guardrails to all model invocations and restrict output handling.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_id-based-policy-examples.html

---

## Medium Severity Threats

### GENAI-IDP-THREAT-002: AppSync API Accessible Without WAF When WAF Is Disabled

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `GraphQLApi` (AWS::AppSync::GraphQLApi)  
**CWE ID:** CWE-306

#### Issue
The AppSync GraphQL API has conditional WAF protection based on the WAFAllowedIPv4Ranges parameter. When set to '0.0.0.0/0', WAF is disabled. This means the API could be accessible from anywhere on the internet without IP restrictions.

#### Attack Vector
Without WAF protection, attackers can freely access and potentially exploit the GraphQL API from any source IP address, potentially leading to data exposure or unauthorized operations.

#### Potential Impact
Increased risk of API abuse, data scraping, or exploitation of any API vulnerabilities, which could lead to unauthorized access to sensitive document processing data.

#### Remediation
Remove the condition that disables WAF when the IP range is set to '0.0.0.0/0'. Instead, always enable WAF with appropriate rule sets, and offer IP restriction as an additional layer of security rather than a replacement for WAF.

**References:**
- https://docs.aws.amazon.com/waf/latest/developerguide/waf-chapter.html

---

### GENAI-IDP-THREAT-005: Missing Query Depth and Complexity Limits on GraphQL API

**STRIDE Category:** Denial of Service  
**Affected Resource:** `GraphQLApi` (AWS::AppSync::GraphQLApi)  
**CWE ID:** CWE-400

#### Issue
The GraphQL API does not have defined query depth limits or complexity analysis, which could allow attackers to craft resource-intensive queries that could overwhelm the service.

#### Attack Vector
An attacker could send deeply nested or highly complex GraphQL queries that consume excessive server resources, potentially causing service degradation or denial of service.

#### Potential Impact
Potential for API performance degradation or complete unavailability, affecting the entire document processing pipeline and user experience.

#### Remediation
Implement query complexity analysis and depth limiting for the GraphQL API. Consider using AWS WAF rate limiting rules specifically for the AppSync endpoint to prevent abuse.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security.html

---

### GENAI-IDP-THREAT-006: GraphQL API Field-Level Logging Not Always Set to ALL

**STRIDE Category:** Repudiation  
**Affected Resource:** `GraphQLApi` (AWS::AppSync::GraphQLApi)  
**CWE ID:** CWE-778

#### Issue
The GraphQL API field-level logging is conditionally set based on the LogLevel parameter. When set to WARN, ERROR, or CRITICAL, the field-level logging is set to ERROR only, which means some operations may not be fully logged.

#### Attack Vector
An attacker performing reconnaissance or initial probing might not generate ERROR-level logs, making their activities harder to detect when the system is configured with WARN or higher log levels.

#### Potential Impact
Reduced ability to detect, investigate, and respond to security incidents, potentially allowing malicious activities to go unnoticed.

#### Remediation
Consider always setting field-level logging to ALL regardless of the general logging level to ensure comprehensive audit trails for security monitoring. Create separate log filters for operational purposes if log volume is a concern.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/monitoring.html

---

### GENAI-IDP-THREAT-007: SQS Queue Could Be More Restrictive

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DocumentQueue` (AWS::SQS::Queue)  
**CWE ID:** CWE-732

#### Issue
The DocumentQueue and other SQS queues have policies that only enforce SSL/TLS connections but do not implement strict resource-based policies to limit which principals can interact with the queues.

#### Attack Vector
If an IAM role or user has overly permissive SQS permissions, they could potentially read messages from or send messages to these queues, even if that wasn't intended.

#### Potential Impact
Potential unauthorized access to document processing pipeline, which could lead to information disclosure or pipeline manipulation.

#### Remediation
Enhance SQS queue policies to explicitly limit access to only the specific IAM roles and services that require it. Add explicit Deny statements for principals not in the allowed list.

**References:**
- https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-security-best-practices.html

---

### GENAI-IDP-THREAT-009: Short-lived Cognito Token Refresh Window

**STRIDE Category:** Spoofing  
**Affected Resource:** `UserPoolClient` (AWS::Cognito::UserPoolClient)  
**CWE ID:** CWE-613

#### Issue
The Cognito UserPoolClient has RefreshTokenValidity set to 30 days, but AccessTokenValidity and IdTokenValidity are both set to only 1 hour. This short validity window could lead to frequent re-authentication needs and potential session handling issues.

#### Attack Vector
If the application doesn't properly handle token refresh, users might be prompted to re-authenticate frequently, potentially leading to authentication fatigue where users choose weaker passwords or become more susceptible to phishing.

#### Potential Impact
Increased user frustration and potential for phishing attacks targeting users who are frequently asked to re-authenticate.

#### Remediation
Consider increasing the AccessTokenValidity and IdTokenValidity to a more reasonable duration (e.g., 1 day) while ensuring the application properly handles token refresh before expiration.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-with-identity-providers.html

---

### GENAI-IDP-THREAT-010: Lambda Role with Permissions to Modify Event Rules and Lambda Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `StartUICodeBuildExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-269

#### Issue
The StartUICodeBuildExecutionRole has permissions to create and delete EventBridge rules and add/remove Lambda permissions for any Lambda function. These powerful permissions could be abused for privilege escalation.

#### Attack Vector
If this Lambda function is compromised, an attacker could create event rules that trigger other functions or add permissions allowing external services to invoke Lambda functions.

#### Potential Impact
Potential for privilege escalation and unauthorized configuration changes that could lead to persistent access or service disruption.

#### Remediation
Scope down the permissions to specific resource ARNs rather than using wildcards. Limit the lambda:AddPermission and lambda:RemovePermission actions to only the specific Lambda functions that need these permissions modified.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-011: CORs Configuration Allows localhost Development Access

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `InputBucket, OutputBucket, ConfigurationBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-346

#### Issue
The CORS configuration for several S3 buckets includes 'http://localhost:3000' as an allowed origin. While useful for development, this should not be present in production deployments as it may facilitate cross-origin attacks.

#### Attack Vector
An attacker who can trick a user into accessing a malicious site on their localhost could potentially access resources from these buckets through the browser, bypassing same-origin policies.

#### Potential Impact
Potential for cross-origin attacks that could expose sensitive data from S3 buckets when users have local applications running.

#### Remediation
Remove 'http://localhost:3000' from the AllowedOrigins list in production deployments. Consider using a parameter to conditionally include this only in development environments.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html

---

### GENAI-IDP-THREAT-012: Log Retention Period May Be Too Short for Compliance

**STRIDE Category:** Repudiation  
**Affected Resource:** `Multiple LogGroups` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-778

#### Issue
The LogRetentionDays parameter allows setting log retention as low as 1 day, which may be insufficient for security investigation and compliance requirements. Many regulatory frameworks require logs to be kept for much longer periods.

#### Attack Vector
Attackers who compromise the system could evade detection if logs are rotated quickly, as evidence of their activities would be deleted.

#### Potential Impact
Reduced ability to investigate security incidents after they occur and potential non-compliance with regulatory requirements for log retention.

#### Remediation
Set a higher minimum value for the LogRetentionDays parameter (e.g., at least 90 days) to ensure sufficient time for security investigations. Consider archiving logs to more cost-effective storage for longer retention.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html

---

### GENAI-IDP-THREAT-013: SQS Queue Vulnerable to Message Flooding

**STRIDE Category:** Denial of Service  
**Affected Resource:** `DocumentQueue` (AWS::SQS::Queue)  
**CWE ID:** CWE-400

#### Issue
The DocumentQueue has no specific protection against message flooding. While SQS has built-in throttling, additional safeguards like queue quotas or throttling at the application level are not implemented.

#### Attack Vector
An attacker with permissions to send messages to SQS could flood the queue with messages, potentially causing processing delays, increased costs, or resource exhaustion.

#### Potential Impact
Potential degradation of document processing service, delayed processing, and increased AWS costs.

#### Remediation
Implement a throttling mechanism before messages are sent to SQS, such as a Lambda concurrency limit or API Gateway throttling. Consider adding CloudWatch alarms for queue metrics to detect unusual patterns.

**References:**
- https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/quotas-messages.html

---

### GENAI-IDP-THREAT-015: GraphQL Schema Introspection Enabled

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `GraphQLSchema` (AWS::AppSync::GraphQLSchema)  
**CWE ID:** CWE-306

#### Issue
While IntrospectionConfig is set to DISABLED, which is good, the template references an external schema file that may not have proper field-level authorization controls. Without examining the actual schema, there's a risk that certain fields might be accessible without proper authorization.

#### Attack Vector
An attacker with limited permissions could potentially query fields or mutations they shouldn't have access to if the schema doesn't implement proper authorization directives.

#### Potential Impact
Potential exposure of sensitive data or operations to users who shouldn't have access to them.

#### Remediation
Review the GraphQL schema to ensure all sensitive fields and operations have proper @auth directives or resolver-level authorization checks. Consider implementing a security review process for schema changes.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security.html

---

### GENAI-IDP-THREAT-019: Extensive Permissions for Code Interpreter

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `AnalyticsProcessorFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-94

#### Issue
The AnalyticsProcessorFunction is granted extensive permissions to start and use Bedrock's code interpreter functionality with minimal restrictions. This could be abused if the function's input is compromised.

#### Attack Vector
If an attacker can control the input to the analytics processor function, they might be able to execute arbitrary code through the code interpreter, potentially accessing or modifying resources beyond intended boundaries.

#### Potential Impact
Potential for code execution that could lead to data access, policy manipulation, or other unauthorized actions within the boundaries of the function's IAM permissions.

#### Remediation
Implement strict input validation for all user-provided content that might influence code interpreter execution. Consider implementing additional sandboxing or approval workflows for code interpreter operations.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/model-parameters.html

---

### GENAI-IDP-THREAT-020: Unprotected Settings Storage in SSM Parameter Store

**STRIDE Category:** Tampering  
**Affected Resource:** `UpdateSettingsValues` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-732

#### Issue
The template stores application settings in an SSM Parameter Store parameter that is readable by the CognitoAuthorizedRole. This means any authenticated user could potentially read these settings, which might contain sensitive configuration values.

#### Attack Vector
Any authenticated user with the CognitoAuthorizedRole could read the SSM parameter and potentially discover sensitive configuration details that might aid in further attacks.

#### Potential Impact
Exposure of internal configuration details that could assist attackers in understanding the system architecture and identifying additional attack vectors.

#### Remediation
Store sensitive configuration in SecureString parameters and restrict access to only the services that require them. Consider separating configuration values based on sensitivity and implementing different access controls for each category.

**References:**
- https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-securing-parameters.html

---

## Low Severity Threats

### GENAI-IDP-THREAT-018: Potential Secret Exposure in Logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `CognitoClientCustomResource` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-532

#### Issue
The CognitoClientUpdaterFunction and other custom resource handlers may log sensitive information during execution. The template doesn't explicitly implement log filtering or sanitization for these custom resources.

#### Attack Vector
An attacker with access to CloudWatch logs could potentially extract sensitive information like Cognito client secrets or other credentials that may be logged during function execution.

#### Potential Impact
Potential exposure of credentials or sensitive configuration data that could be used for unauthorized access.

#### Remediation
Ensure all custom resource handlers implement proper log filtering to prevent logging of sensitive values. Consider implementing a centralized logging solution with automated sensitive data detection and redaction.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# .aws-sam-idp-main


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-28  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **15** security threats. The analysis reveals **0** critical, **4** high, **9** medium, and **2** low severity findings.

## Priority Actions

### 1. Refine IAM policies to limit permissions to only the specific actions required by each service integration, and scope resource ARNs more narrowly where possible.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-002  
**Business Impact:** Violation of least privilege principle could lead to unauthorized access across multiple services in the account.

### 1. Refine IAM policies to scope permissions to specific resources where possible, and limit actions to only what is required.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-015  
**Business Impact:** Potential unauthorized access to resources within the AWS account.

### 2. Modify the WebUIBucket to use the same CustomerManagedEncryptionKey as other buckets in the stack by changing the SSEAlgorithm from AES256 to aws:kms and adding the KMSMasterKeyID.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-001  
**Business Impact:** Lower security posture for web UI assets, potential compliance violations for organizations requiring customer-managed keys for all storage.

### 2. Set a minimum value for LogRetentionDays parameter that meets organizational compliance requirements (typically 90 days minimum) and ensure this is communicated in parameter descriptions.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-003  
**Business Impact:** Limited ability to investigate security incidents, potential compliance violations for organizations with specific log retention requirements.

### 2. Enable MFA for the Cognito User Pool, preferably using TOTP or SMS verification as a second factor.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-006  
**Business Impact:** Higher risk of unauthorized access to sensitive data processing capabilities, potentially leading to data breaches or misuse of AI services.

### 2. Scope down the permissions to specific resources where possible, limiting the role to only the specific Cognito User Pool and SageMaker workteams that need to be accessed.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-007  
**Business Impact:** Potential unauthorized access to user authentication mechanisms or machine learning resources.

### 2. Add security-specific CloudWatch metrics and alerts, such as monitoring for unauthorized API calls, permission changes, or unusual access patterns. Consider integrating with AWS Security Hub or GuardDuty for enhanced security monitoring.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-008  
**Business Impact:** Delayed detection of security incidents, potential for unauthorized activities to continue for longer periods.

### 2. Change the DefaultAction to DENY and use more granular authorization patterns such as @auth directives in the GraphQL schema to explicitly grant access to specific types and fields based on user groups or claims.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-010  
**Business Impact:** Potential unauthorized access to data or operations within the GraphQL API.

### 3. Use a custom SSL certificate with AWS Certificate Manager for the CloudFront distribution to provide a domain name that matches organizational branding.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-004  
**Business Impact:** Users might not trust the site, potential for successful phishing attacks against users.

### 3. Consider switching to PROVISIONED capacity mode with auto-scaling for critical tables or implementing application-level throttling and retry mechanisms.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-005  
**Business Impact:** Service disruption under high load, unpredictable costs, degraded user experience.



## Detailed Threat Analysis

## High Severity Threats

### GENAI-IDP-THREAT-001: Missing encryption for web UI S3 bucket

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `WebUIBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-311

#### Issue
The WebUIBucket uses AES256 server-side encryption instead of AWS KMS which is used for other buckets in the stack. This inconsistent approach to encryption could lead to data protection gaps.

#### Attack Vector
Attackers who gain access to the S3 bucket data through other means (e.g., misconfigured permissions) would have access to unencrypted data or data encrypted with AWS-managed keys rather than customer-managed keys.

#### Potential Impact
Lower security posture for web UI assets, potential compliance violations for organizations requiring customer-managed keys for all storage.

#### Remediation
Modify the WebUIBucket to use the same CustomerManagedEncryptionKey as other buckets in the stack by changing the SSEAlgorithm from AES256 to aws:kms and adding the KMSMasterKeyID.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingKMSEncryption.html

---

### GENAI-IDP-THREAT-002: Overly permissive IAM role policies

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `AppSyncServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The AppSyncServiceRole has access to multiple Lambda functions and other services without scoping permissions to specific actions or resources where possible.

#### Attack Vector
If the AppSync service is compromised, an attacker could leverage the role to access multiple Lambda functions and potentially pivot to other services.

#### Potential Impact
Violation of least privilege principle could lead to unauthorized access across multiple services in the account.

#### Remediation
Refine IAM policies to limit permissions to only the specific actions required by each service integration, and scope resource ARNs more narrowly where possible.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-007: IAM role with broad permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `CognitoClientUpdaterRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The CognitoClientUpdaterRole has a policy with resource: '*' for several Cognito and SageMaker actions, which violates the principle of least privilege.

#### Attack Vector
If the associated Lambda function is compromised, an attacker could use these broad permissions to access or modify Cognito and SageMaker resources beyond the intended scope.

#### Potential Impact
Potential unauthorized access to user authentication mechanisms or machine learning resources.

#### Remediation
Scope down the permissions to specific resources where possible, limiting the role to only the specific Cognito User Pool and SageMaker workteams that need to be accessed.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-015: IAM roles with wildcard resource permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `A2IHumanTaskUILambdaRole, DashboardMergerFunction` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
Several IAM roles in the template use wildcard (*) resource permissions for various AWS services, which violates the principle of least privilege.

#### Attack Vector
If a Lambda function using these roles is compromised, an attacker could access or modify resources beyond the intended scope.

#### Potential Impact
Potential unauthorized access to resources within the AWS account.

#### Remediation
Refine IAM policies to scope permissions to specific resources where possible, and limit actions to only what is required.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Medium Severity Threats

### GENAI-IDP-THREAT-003: Variable log retention periods

**STRIDE Category:** Repudiation  
**Affected Resource:** `Multiple Log Groups` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-778

#### Issue
While log groups have encryption enabled with KMS, the retention period is parameterized and could be set too low (as little as 1 day) which might not meet compliance requirements for log retention.

#### Attack Vector
Attackers' activities might not be discoverable if logs are purged too quickly, preventing proper forensic analysis after a security incident.

#### Potential Impact
Limited ability to investigate security incidents, potential compliance violations for organizations with specific log retention requirements.

#### Remediation
Set a minimum value for LogRetentionDays parameter that meets organizational compliance requirements (typically 90 days minimum) and ensure this is communicated in parameter descriptions.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html

---

### GENAI-IDP-THREAT-004: CloudFront using default certificate

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `CloudFrontDistribution` (AWS::CloudFront::Distribution)  
**CWE ID:** CWE-295

#### Issue
The CloudFront distribution is using the default CloudFront certificate rather than a custom certificate, which could make it harder for users to verify the authenticity of the website.

#### Attack Vector
Phishing attacks could be mounted by creating similar-looking distributions that users might not easily distinguish from the legitimate application.

#### Potential Impact
Users might not trust the site, potential for successful phishing attacks against users.

#### Remediation
Use a custom SSL certificate with AWS Certificate Manager for the CloudFront distribution to provide a domain name that matches organizational branding.

**References:**
- https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https-alternate-domain-names.html

---

### GENAI-IDP-THREAT-005: No read/write capacity units specified

**STRIDE Category:** Denial of Service  
**Affected Resource:** `TrackingTable, ConfigurationTable, AnalyticsTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-400

#### Issue
DynamoDB tables are configured with PAY_PER_REQUEST billing mode without any capacity planning, which could lead to throttling during high load and potential DoS.

#### Attack Vector
If an attacker generates a large volume of requests, they could cause the application to be throttled by DynamoDB, affecting legitimate users.

#### Potential Impact
Service disruption under high load, unpredictable costs, degraded user experience.

#### Remediation
Consider switching to PROVISIONED capacity mode with auto-scaling for critical tables or implementing application-level throttling and retry mechanisms.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html

---

### GENAI-IDP-THREAT-006: No MFA required for Cognito User Pool

**STRIDE Category:** Tampering  
**Affected Resource:** `UserPool` (AWS::Cognito::UserPool)  
**CWE ID:** CWE-308

#### Issue
The Cognito User Pool does not require MFA, which increases the risk of unauthorized access if user credentials are compromised.

#### Attack Vector
Attackers who obtain user credentials through phishing or other means could directly access the application without an additional authentication factor.

#### Potential Impact
Higher risk of unauthorized access to sensitive data processing capabilities, potentially leading to data breaches or misuse of AI services.

#### Remediation
Enable MFA for the Cognito User Pool, preferably using TOTP or SMS verification as a second factor.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html

---

### GENAI-IDP-THREAT-008: Insufficient security metrics and alerting

**STRIDE Category:** Repudiation  
**Affected Resource:** `MainTemplateSubsetDashboard, MergedDashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-778

#### Issue
While there are metrics for workflow errors and execution time, there are insufficient security-specific metrics and alerts for potential security incidents (such as unusual access patterns, permission changes, or configuration modifications).

#### Attack Vector
Attackers could perform actions that don't trigger the existing alerts but still compromise security, and these actions might go undetected.

#### Potential Impact
Delayed detection of security incidents, potential for unauthorized activities to continue for longer periods.

#### Remediation
Add security-specific CloudWatch metrics and alerts, such as monitoring for unauthorized API calls, permission changes, or unusual access patterns. Consider integrating with AWS Security Hub or GuardDuty for enhanced security monitoring.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards.html

---

### GENAI-IDP-THREAT-009: Long-lived refresh tokens in Cognito User Pool Client

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UserPoolClient` (AWS::Cognito::UserPoolClient)  
**CWE ID:** CWE-613

#### Issue
The UserPoolClient has a RefreshTokenValidity of 30 days, which means compromised refresh tokens could be used for up to a month.

#### Attack Vector
If a refresh token is stolen, an attacker could continue to generate new access tokens for up to 30 days without needing the original user credentials.

#### Potential Impact
Extended window of unauthorized access if refresh tokens are compromised.

#### Remediation
Reduce the RefreshTokenValidity to a shorter period (e.g., 1-7 days) based on the application's security requirements, and implement proper token revocation mechanisms.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-with-identity-providers.html

---

### GENAI-IDP-THREAT-010: Default ALLOW action in AppSync API authorization

**STRIDE Category:** Tampering  
**Affected Resource:** `GraphQLApi` (AWS::AppSync::GraphQLApi)  
**CWE ID:** CWE-284

#### Issue
The GraphQL API is configured with DefaultAction: ALLOW for Cognito user pools, which means all authenticated users can access any GraphQL operation by default unless explicitly denied.

#### Attack Vector
Authenticated users could potentially access GraphQL operations that they shouldn't have permission for if proper fine-grained access controls aren't implemented.

#### Potential Impact
Potential unauthorized access to data or operations within the GraphQL API.

#### Remediation
Change the DefaultAction to DENY and use more granular authorization patterns such as @auth directives in the GraphQL schema to explicitly grant access to specific types and fields based on user groups or claims.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security-authz.html

---

### GENAI-IDP-THREAT-012: No reserved concurrency for critical Lambda functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Lambda::Function)  
**CWE ID:** CWE-400

#### Issue
Critical Lambda functions like QueueProcessor, WorkflowTracker, and AnalyticsProcessorFunction don't have reserved concurrency configured, which could lead to resource exhaustion during high load.

#### Attack Vector
An attacker could trigger many simultaneous Lambda invocations, potentially consuming the account's Lambda concurrency limit and affecting other functions.

#### Potential Impact
Potential service degradation or unavailability during high traffic periods or DoS attacks.

#### Remediation
Configure reserved concurrency for critical Lambda functions to ensure they always have resources available, and set provisioned concurrency for functions that need consistent performance.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### GENAI-IDP-THREAT-013: No advanced security features for Cognito User Pool

**STRIDE Category:** Spoofing  
**Affected Resource:** `UserPool` (AWS::Cognito::UserPool)  
**CWE ID:** CWE-307

#### Issue
The Cognito User Pool does not have advanced security features enabled, such as risk-based adaptive authentication or compromised credentials checking.

#### Attack Vector
Attackers could use credential stuffing or brute force attacks without triggering additional security measures beyond basic password policies.

#### Potential Impact
Higher risk of unauthorized access through compromised credentials or automated attacks.

#### Remediation
Enable Cognito Advanced Security features, including risk-based authentication and compromised credentials checking.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pool-settings-advanced-security.html

---

## Low Severity Threats

### GENAI-IDP-THREAT-011: Sensitive settings stored in SSM Parameter Store with default encryption

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UpdateSettingsValues` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-311

#### Issue
The template stores settings in SSM Parameter Store, but doesn't explicitly configure the parameter with a customer-managed KMS key for encryption.

#### Attack Vector
If an attacker gains access to SSM parameters, they might be able to access sensitive configuration information protected only by AWS-managed keys.

#### Potential Impact
Potential exposure of configuration information that could aid in further attacks.

#### Remediation
Modify the SSM Parameter Store resource to use the CustomerManagedEncryptionKey for parameter encryption.

**References:**
- https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-advanced-parameters.html

---

### GENAI-IDP-THREAT-014: Nested stacks pass sensitive parameters

**STRIDE Category:** Tampering  
**Affected Resource:** `PATTERN1STACK, PATTERN2STACK, PATTERN3STACK` (AWS::CloudFormation::Stack)  
**CWE ID:** CWE-312

#### Issue
Sensitive parameters like KMS key ARNs, bucket names, and role ARNs are passed to nested stacks as plaintext parameters, which could expose this information in CloudFormation events and logs.

#### Attack Vector
Attackers with access to CloudFormation event logs or deployment history could access sensitive configuration details.

#### Potential Impact
Exposure of internal resource identifiers that could aid in planning further attacks.

#### Remediation
Consider using AWS Secrets Manager or SSM Parameter Store for passing sensitive values to nested stacks, or implement NoEcho properties on sensitive parameters.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html#parameters-section-structure-properties

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# .aws-sam-packaged


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-19  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **15** security threats. The analysis reveals **0** critical, **2** high, **11** medium, and **2** low severity findings.

## Priority Actions

### 1. Restrict SageMaker permissions to specific resources required by the function, using explicit ARNs instead of wildcard (*) resources.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-008  
**Business Impact:** Unauthorized access to or modification of SageMaker resources not related to this application.

### 2. Enable and enforce MFA for the Cognito User Pool by adding 'MfaConfiguration: ON' and configuring appropriate MFA options.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-001  
**Business Impact:** Unauthorized access to the application and potentially sensitive document processing capabilities and data.

### 2. Add a CloudTrail trail configuration to capture all management events, including read and write operations, with log file validation enabled and logs encrypted using the CustomerManagedEncryptionKey.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-004  
**Business Impact:** Reduced ability to detect, investigate, and respond to security incidents or malicious activities.

### 2. Restrict CloudWatch Logs permissions to specific log groups required by the function, using explicit ARNs instead of wildcard (*) resources.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-005  
**Business Impact:** Increased blast radius in case of role compromise, potentially leading to unauthorized access to sensitive log data across the account.

### 2. Deploy sensitive Lambda functions within a VPC with appropriate security groups and network ACLs to control traffic flow.

**Effort:** High  
**Related Threats:** GENAI-IDP-THREAT-010  
**Business Impact:** Increased attack surface and potential data exfiltration paths if a function is compromised.

### 2. Enable AWS CloudTrail data events for DynamoDB tables containing sensitive information to capture detailed read and write operations.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-012  
**Business Impact:** Reduced ability to detect and investigate potential data breaches or unauthorized data access.

### 2. Restrict S3 bucket listing permissions to specific prefixes that users should have access to, rather than the entire bucket.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-015  
**Business Impact:** Potential information leakage about bucket contents that could aid in further attacks.

### 3. Configure the LoggingBucket to use KMS encryption similar to other buckets in the template, using the CustomerManagedEncryptionKey.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-002  
**Business Impact:** Reduced control over encryption key management for potentially sensitive log data.

### 3. Implement WAF rate limiting rules for the GraphQL API and consider using AWS AppSync throttling settings to limit the rate of requests per user or IP.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-006  
**Business Impact:** Potential service disruption, poor performance for legitimate users, or unexpected cost increases due to high request volumes.

### 3. Use a custom domain with an ACM certificate for the CloudFront distribution to enhance trust and security posture.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-007  
**Business Impact:** Reduced user trust and potential for successful phishing attacks mimicking the application interface.



## Detailed Threat Analysis

## High Severity Threats

### GENAI-IDP-THREAT-005: Overly Permissive CloudWatch Logs Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `StartUICodeBuildExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The StartUICodeBuildExecutionRole has '*' resource permissions for CloudWatch Logs which violates the principle of least privilege.

#### Attack Vector
If this role is compromised, an attacker could access logs from other applications or services, potentially exposing sensitive information.

#### Potential Impact
Increased blast radius in case of role compromise, potentially leading to unauthorized access to sensitive log data across the account.

#### Remediation
Restrict CloudWatch Logs permissions to specific log groups required by the function, using explicit ARNs instead of wildcard (*) resources.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-008: Overly Permissive IAM Role for SageMaker A2I

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `A2IHumanTaskUILambdaRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The A2IHumanTaskUILambdaRole has wildcard (*) resource permissions for multiple SageMaker actions, violating the principle of least privilege.

#### Attack Vector
If this role is compromised, an attacker could potentially access or manipulate other SageMaker resources in the account beyond those needed for the application.

#### Potential Impact
Unauthorized access to or modification of SageMaker resources not related to this application.

#### Remediation
Restrict SageMaker permissions to specific resources required by the function, using explicit ARNs instead of wildcard (*) resources.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Medium Severity Threats

### GENAI-IDP-THREAT-001: Cognito User Pool MFA Not Enforced

**STRIDE Category:** Spoofing  
**Affected Resource:** `UserPool` (AWS::Cognito::UserPool)  
**CWE ID:** CWE-308

#### Issue
The Cognito User Pool does not enforce Multi-Factor Authentication, which could allow attackers to authenticate with just a username and password if credentials are compromised.

#### Attack Vector
An attacker who obtains user credentials through phishing, credential stuffing, or other means could access the system without being challenged for a second factor.

#### Potential Impact
Unauthorized access to the application and potentially sensitive document processing capabilities and data.

#### Remediation
Enable and enforce MFA for the Cognito User Pool by adding 'MfaConfiguration: ON' and configuring appropriate MFA options.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html

---

### GENAI-IDP-THREAT-002: S3 Logging Bucket Server-Side Encryption Using Default AES256

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `LoggingBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-311

#### Issue
The logging bucket uses AES256 encryption instead of KMS, which provides less control over key management and rotation policies.

#### Attack Vector
If logs contain sensitive information, and AWS-managed keys are compromised or access to them is obtained, an attacker could potentially decrypt log contents.

#### Potential Impact
Reduced control over encryption key management for potentially sensitive log data.

#### Remediation
Configure the LoggingBucket to use KMS encryption similar to other buckets in the template, using the CustomerManagedEncryptionKey.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-encryption.html

---

### GENAI-IDP-THREAT-004: No CloudTrail Trail Defined for API and Management Events

**STRIDE Category:** Repudiation  
**Affected Resource:** `Missing CloudTrail Configuration` (AWS::CloudTrail::Trail)  
**CWE ID:** CWE-778

#### Issue
The template does not define a CloudTrail trail to capture API and management events, which could hinder investigation of security incidents and create accountability gaps.

#### Attack Vector
Without proper API logging, an attacker's actions might go undetected or be difficult to trace during or after a security incident.

#### Potential Impact
Reduced ability to detect, investigate, and respond to security incidents or malicious activities.

#### Remediation
Add a CloudTrail trail configuration to capture all management events, including read and write operations, with log file validation enabled and logs encrypted using the CustomerManagedEncryptionKey.

**References:**
- https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-and-update-a-trail.html

---

### GENAI-IDP-THREAT-006: No Rate Limiting on GraphQL API

**STRIDE Category:** Denial of Service  
**Affected Resource:** `GraphQLApi` (AWS::AppSync::GraphQLApi)  
**CWE ID:** CWE-770

#### Issue
The GraphQL API does not have explicit rate limiting configured, which could allow for abuse through API flooding.

#### Attack Vector
An attacker could flood the GraphQL API with requests, potentially causing service degradation or increased costs.

#### Potential Impact
Potential service disruption, poor performance for legitimate users, or unexpected cost increases due to high request volumes.

#### Remediation
Implement WAF rate limiting rules for the GraphQL API and consider using AWS AppSync throttling settings to limit the rate of requests per user or IP.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security-authz.html

---

### GENAI-IDP-THREAT-007: CloudFront Distribution Using Default Certificate

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `CloudFrontDistribution` (AWS::CloudFront::Distribution)  
**CWE ID:** CWE-295

#### Issue
The CloudFront Distribution is using the default CloudFront certificate (CloudFrontDefaultCertificate: true) instead of a custom certificate, which may not meet security requirements for production deployments.

#### Attack Vector
While HTTPS is enforced, users may be less likely to notice phishing sites using similar domains since the application uses the generic CloudFront domain rather than a custom branded domain with proper TLS certificates.

#### Potential Impact
Reduced user trust and potential for successful phishing attacks mimicking the application interface.

#### Remediation
Use a custom domain with an ACM certificate for the CloudFront distribution to enhance trust and security posture.

**References:**
- https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cnames-https-dedicated-ip-or-sni.html

---

### GENAI-IDP-THREAT-009: Email Verification Subject and Message Not Using HTTPS Links

**STRIDE Category:** Tampering  
**Affected Resource:** `UserPool` (AWS::Cognito::UserPool)  
**CWE ID:** CWE-319

#### Issue
The email verification template does not explicitly use HTTPS links, which could potentially lead to insecure communication if users click on HTTP links in verification emails.

#### Attack Vector
If verification emails contain HTTP links, users might be directed to non-encrypted connections, potentially exposing verification codes or session information.

#### Potential Impact
Potential exposure of verification codes or session information during the user verification process.

#### Remediation
Ensure all links in email templates use HTTPS explicitly, and consider implementing email templates with proper security messaging.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pool-settings-message-customizations.html

---

### GENAI-IDP-THREAT-010: Lambda Functions Without VPC Configuration

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-668

#### Issue
Most Lambda functions in the template are deployed outside a VPC, which could expose them to direct internet access and increase the attack surface.

#### Attack Vector
Without VPC isolation, Lambda functions have potential internet connectivity, which could allow for data exfiltration if the function is compromised.

#### Potential Impact
Increased attack surface and potential data exfiltration paths if a function is compromised.

#### Remediation
Deploy sensitive Lambda functions within a VPC with appropriate security groups and network ACLs to control traffic flow.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html

---

### GENAI-IDP-THREAT-011: Unrestricted Bedrock Model Access

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `EvaluationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-250

#### Issue
The EvaluationFunction has permissions to invoke any foundation model in Bedrock (arn:aws:bedrock:*::foundation-model/*), which is more permissive than necessary.

#### Attack Vector
If the function is compromised, an attacker could utilize any Bedrock model, potentially leading to unexpected costs or access to more powerful models than intended.

#### Potential Impact
Potential for cost increases, or unintended model access if function is compromised.

#### Remediation
Restrict Bedrock model access to only the specific models required for the application instead of using wildcard permissions.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-iam.html

---

### GENAI-IDP-THREAT-012: Missing DynamoDB Table Data Access Logging

**STRIDE Category:** Repudiation  
**Affected Resource:** `TrackingTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-778

#### Issue
The template does not configure detailed data access logging or auditing for DynamoDB tables that may contain sensitive tracking information.

#### Attack Vector
Without detailed access logging, unauthorized access or modifications to data may go undetected.

#### Potential Impact
Reduced ability to detect and investigate potential data breaches or unauthorized data access.

#### Remediation
Enable AWS CloudTrail data events for DynamoDB tables containing sensitive information to capture detailed read and write operations.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/monitoring-cloudtrail.html

---

### GENAI-IDP-THREAT-014: No Explicit Timeout Configuration for GraphQL Resolvers

**STRIDE Category:** Denial of Service  
**Affected Resource:** `GraphQLApi` (AWS::AppSync::GraphQLApi)  
**CWE ID:** CWE-400

#### Issue
The template does not specify timeout configurations for GraphQL resolvers, potentially allowing for long-running operations that could consume excessive resources.

#### Attack Vector
An attacker could craft complex GraphQL queries designed to run for extended periods, consuming resources and potentially causing service degradation.

#### Potential Impact
Potential resource exhaustion leading to degraded service performance or increased costs.

#### Remediation
Configure appropriate timeouts for all GraphQL resolvers to limit the duration of any single operation.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/resolver-reference-overview-js.html

---

### GENAI-IDP-THREAT-015: Overly Broad S3 Access for Authenticated Users

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `CognitoAuthorizedRole` (AWS::IAM::Role)  
**CWE ID:** CWE-732

#### Issue
The CognitoAuthorizedRole grants authenticated users ListBucket permissions on the entire S3 buckets, which may be more access than necessary for normal application operation.

#### Attack Vector
Any authenticated user could list all objects in the buckets, potentially discovering sensitive files or information not directly related to their authorized use cases.

#### Potential Impact
Potential information leakage about bucket contents that could aid in further attacks.

#### Remediation
Restrict S3 bucket listing permissions to specific prefixes that users should have access to, rather than the entire bucket.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_examples.html

---

## Low Severity Threats

### GENAI-IDP-THREAT-003: AppSync GraphQL API Introspection Disabled But No Query Depth Limiting

**STRIDE Category:** Tampering  
**Affected Resource:** `GraphQLApi` (AWS::ApiGateway::Method)  
**CWE ID:** CWE-400

#### Issue
While GraphQL introspection is disabled, which is good security practice, there are no query depth limitations defined that could prevent resource exhaustion or complex query attacks.

#### Attack Vector
An attacker could craft highly nested, complex GraphQL queries that could lead to excessive resource consumption.

#### Potential Impact
Potential DoS condition or increased costs due to excessive resource usage processing complex queries.

#### Remediation
Implement query depth limiting and complexity analysis for the AppSync API. This can be done by using AWS AppSync resolvers with appropriate field validation and limits.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security-authorization-use-cases.html

---

### GENAI-IDP-THREAT-013: Object Lock Not Configured for S3 Buckets

**STRIDE Category:** Tampering  
**Affected Resource:** `All S3 Buckets` (AWS::S3::Bucket)  
**CWE ID:** CWE-345

#### Issue
S3 buckets in the template do not have Object Lock enabled, which could allow for deletion or modification of critical data even with appropriate IAM controls.

#### Attack Vector
An attacker with appropriate permissions or a compromised account could delete or modify critical data in the buckets.

#### Potential Impact
Potential data loss or tampering with sensitive documents and processing results.

#### Remediation
Consider enabling S3 Object Lock with appropriate retention configurations for buckets containing critical data that should be immutable.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# notebooks-misc-bda-cfn-bda-project


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-13  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **6** security threats. The analysis reveals **0** critical, **2** high, **3** medium, and **1** low severity findings.

## Priority Actions

### 1. Implement server-side encryption for the Bedrock service using AWS KMS with a customer-managed key (CMK) and ensure appropriate key management policies are in place.

**Effort:** Medium  
**Related Threats:** BEDROCK-DATA-AUTOMATION-THREAT-002  
**Business Impact:** Potential exposure of protected health information (PHI), resulting in compliance violations, regulatory fines, and loss of patient trust.

### 1. Define specific IAM roles with least privilege permissions for accessing and managing the Bedrock resources. Implement resource-based policies and consider using AWS Organizations SCPs to further restrict access.

**Effort:** Medium  
**Related Threats:** BEDROCK-DATA-AUTOMATION-THREAT-003  
**Business Impact:** Unauthorized access to PHI could lead to data breaches, compliance violations, and potential misuse of sensitive patient information.

### 2. Add CloudTrail configuration to the template to ensure comprehensive logging of all API calls to Bedrock services, and consider sending logs to a protected, dedicated S3 bucket with appropriate retention policies.

**Effort:** Low  
**Related Threats:** BEDROCK-DATA-AUTOMATION-THREAT-001  
**Business Impact:** Inability to trace user actions, detect unauthorized access, or conduct forensic analysis after a security incident involving medical data.

### 2. Implement resource protection using AWS CloudFormation stack policies or AWS Organizations service control policies. Consider implementing a CI/CD pipeline with proper approval gates for changes to the blueprint schema.

**Effort:** Medium  
**Related Threats:** BEDROCK-DATA-AUTOMATION-THREAT-004  
**Business Impact:** Unauthorized changes to data extraction logic could lead to data corruption, loss of integrity, or extraction of sensitive information in unexpected ways.

### 2. Implement CloudWatch alarms and metrics for the Bedrock services. Configure GuardDuty for threat detection and Security Hub for compliance monitoring. Set up automated notification systems for suspicious activities.

**Effort:** Medium  
**Related Threats:** BEDROCK-DATA-AUTOMATION-THREAT-006  
**Business Impact:** Delayed detection of security incidents or compliance violations involving PHI, potentially increasing the scope and impact of breaches.

### 3. Implement appropriate service quotas and request throttling for the Bedrock services. Configure CloudWatch alarms to detect abnormal usage patterns and automate responses.

**Effort:** Low  
**Related Threats:** BEDROCK-DATA-AUTOMATION-THREAT-005  
**Business Impact:** Potential service unavailability for legitimate users and increased costs due to excessive resource consumption.



## Detailed Threat Analysis

## High Severity Threats

### BEDROCK-DATA-AUTOMATION-THREAT-002: No Encryption Configuration for Sensitive Medical Data

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BedrockBlueprint` (AWS::Bedrock::Blueprint)  
**CWE ID:** CWE-311

#### Issue
The template does not specify encryption configurations for the Bedrock Blueprint that will process sensitive medical discharge information including patient names, IDs, and medical history.

#### Attack Vector
If data is not properly encrypted, unauthorized users with access to the AWS account could potentially view sensitive patient data in violation of healthcare privacy regulations.

#### Potential Impact
Potential exposure of protected health information (PHI), resulting in compliance violations, regulatory fines, and loss of patient trust.

#### Remediation
Implement server-side encryption for the Bedrock service using AWS KMS with a customer-managed key (CMK) and ensure appropriate key management policies are in place.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security.html

---

### BEDROCK-DATA-AUTOMATION-THREAT-003: Missing IAM Access Controls for Bedrock Resources

**STRIDE Category:** Authorization  
**Affected Resource:** `BedRockDataAutomationProject` (AWS::Bedrock::DataAutomationProject)  
**CWE ID:** CWE-284

#### Issue
The template does not define IAM roles or policies to restrict access to the Bedrock Data Automation Project and Blueprint containing sensitive medical information.

#### Attack Vector
Without proper IAM controls, any user with access to the AWS account could potentially access, modify, or delete the medical data processing resources.

#### Potential Impact
Unauthorized access to PHI could lead to data breaches, compliance violations, and potential misuse of sensitive patient information.

#### Remediation
Define specific IAM roles with least privilege permissions for accessing and managing the Bedrock resources. Implement resource-based policies and consider using AWS Organizations SCPs to further restrict access.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_id-based-policy-examples.html

---

## Medium Severity Threats

### BEDROCK-DATA-AUTOMATION-THREAT-001: Missing CloudTrail Logging for Bedrock Operations

**STRIDE Category:** Repudiation  
**Affected Resource:** `BedRockDataAutomationProject` (AWS::Bedrock::DataAutomationProject)  
**CWE ID:** CWE-778

#### Issue
The template does not configure CloudTrail logging for Bedrock operations, which could result in a lack of audit trail for actions performed on sensitive medical data.

#### Attack Vector
An attacker with access to the environment could perform unauthorized actions on the medical data processing pipeline without leaving traceable evidence.

#### Potential Impact
Inability to trace user actions, detect unauthorized access, or conduct forensic analysis after a security incident involving medical data.

#### Remediation
Add CloudTrail configuration to the template to ensure comprehensive logging of all API calls to Bedrock services, and consider sending logs to a protected, dedicated S3 bucket with appropriate retention policies.

**References:**
- https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-a-trail-using-the-console-first-time.html

---

### BEDROCK-DATA-AUTOMATION-THREAT-004: No Version Control or Change Protection for Blueprint Schema

**STRIDE Category:** Tampering  
**Affected Resource:** `BedrockBlueprint` (AWS::Bedrock::Blueprint)  
**CWE ID:** CWE-642

#### Issue
The template does not implement versioning or change protection mechanisms for the Bedrock Blueprint that defines the medical discharge data schema.

#### Attack Vector
An attacker with appropriate permissions could modify the blueprint schema to extract additional unauthorized data or change data extraction logic without detection.

#### Potential Impact
Unauthorized changes to data extraction logic could lead to data corruption, loss of integrity, or extraction of sensitive information in unexpected ways.

#### Remediation
Implement resource protection using AWS CloudFormation stack policies or AWS Organizations service control policies. Consider implementing a CI/CD pipeline with proper approval gates for changes to the blueprint schema.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html

---

### BEDROCK-DATA-AUTOMATION-THREAT-006: Insufficient Monitoring and Alerting for Data Processing Activities

**STRIDE Category:** Repudiation  
**Affected Resource:** `BedRockDataAutomationProject` (AWS::Bedrock::DataAutomationProject)  
**CWE ID:** CWE-778

#### Issue
The template lacks monitoring and alerting configurations for the Bedrock Data Automation Project handling sensitive medical information.

#### Attack Vector
Suspicious or unauthorized activities involving sensitive medical data could occur without timely detection or alerting.

#### Potential Impact
Delayed detection of security incidents or compliance violations involving PHI, potentially increasing the scope and impact of breaches.

#### Remediation
Implement CloudWatch alarms and metrics for the Bedrock services. Configure GuardDuty for threat detection and Security Hub for compliance monitoring. Set up automated notification systems for suspicious activities.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html

---

## Low Severity Threats

### BEDROCK-DATA-AUTOMATION-THREAT-005: No Resource Quotas or Throttling Controls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `BedRockDataAutomationProject` (AWS::Bedrock::DataAutomationProject)  
**CWE ID:** CWE-770

#### Issue
The template does not define resource limits or throttling controls for the Bedrock Data Automation Project, potentially allowing resource exhaustion.

#### Attack Vector
An attacker or misconfigured application could submit an excessive number of processing requests, consuming all available resources and potentially causing service disruption.

#### Potential Impact
Potential service unavailability for legitimate users and increased costs due to excessive resource consumption.

#### Remediation
Implement appropriate service quotas and request throttling for the Bedrock services. Configure CloudWatch alarms to detect abnormal usage patterns and automate responses.

**References:**
- https://docs.aws.amazon.com/servicequotas/latest/userguide/intro.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# options-bda-lending-project-.aws-sam-build-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-22  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **7** security threats. The analysis reveals **0** critical, **1** high, **4** medium, and **2** low severity findings.

## Priority Actions

### 1. Scope down the IAM policy to restrict access to only the specific Bedrock Data Automation resources needed by this project. Replace the wildcard resource with specific ARN patterns for the project resources being created.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001  
**Business Impact:** Unauthorized access to or manipulation of all Bedrock Data Automation projects in the account, potentially leading to data exposure or service disruption.

### 2. Implement CloudTrail data events for Bedrock API calls, configure CloudWatch Logs for detailed Lambda execution logs, and consider implementing custom logging for critical operations that captures who, what, when, and how resources are being accessed or modified.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002  
**Business Impact:** Inability to effectively monitor, audit, or investigate security incidents related to Bedrock Data Automation operations.

### 2. Add IAM condition keys to the policy to restrict access based on source IP, require MFA for sensitive operations, implement time-based constraints, and add aws:PrincipalArn conditions to limit which entities can assume the role.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-006  
**Business Impact:** Increased blast radius of compromised credentials with no additional security layers beyond the credentials themselves.

### 3. Deploy the Lambda function within a VPC and use VPC endpoints for AWS services to ensure traffic remains within the AWS network. Configure appropriate security groups to restrict access.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003  
**Business Impact:** Potential exposure of sensitive information in transit, including any data exchanged with Bedrock services.

### 3. Implement strong input validation in the BDAProjectLambda handler function to verify all parameters meet expected formats and constraints before passing them to AWS APIs.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005  
**Business Impact:** Potential manipulation of Bedrock Data Automation resources or injection attacks through malicious input parameters.

### 4. Implement reserved concurrency limits on the Lambda function to cap the maximum number of concurrent executions and prevent excessive resource consumption.

**Effort:** Low  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004  
**Business Impact:** Potential service disruption or unexpected AWS billing charges due to unbounded Lambda function execution.

### 4. Implement proper versioning for blueprints and project configurations. Use AWS tags to track metadata about resources including creation date, owner, and purpose. Consider implementing a change management process for blueprint updates.

**Effort:** Low  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-007  
**Business Impact:** Inability to track who made changes to blueprints or project configurations, or to roll back to previous stable versions after undesired changes.



## Detailed Threat Analysis

## High Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001: Overly Permissive Bedrock Data Automation Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `LambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The IAM policy grants wildcard (*) resource access for multiple Bedrock Data Automation actions, allowing the role to access all BDA resources within the account rather than limiting access to specific project resources.

#### Attack Vector
If the Lambda function is compromised, an attacker could manipulate any Bedrock Data Automation project in the account, potentially accessing sensitive data or disrupting other projects.

#### Potential Impact
Unauthorized access to or manipulation of all Bedrock Data Automation projects in the account, potentially leading to data exposure or service disruption.

#### Remediation
Scope down the IAM policy to restrict access to only the specific Bedrock Data Automation resources needed by this project. Replace the wildcard resource with specific ARN patterns for the project resources being created.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Medium Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002: Insufficient Logging and Monitoring

**STRIDE Category:** Repudiation  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
While the Lambda function has a configurable LOG_LEVEL parameter, there are no explicit audit trails or monitoring for the Bedrock Data Automation operations performed by the Lambda function.

#### Attack Vector
An attacker who gains access could perform unauthorized actions on Bedrock Data Automation resources without detection or attribution.

#### Potential Impact
Inability to effectively monitor, audit, or investigate security incidents related to Bedrock Data Automation operations.

#### Remediation
Implement CloudTrail data events for Bedrock API calls, configure CloudWatch Logs for detailed Lambda execution logs, and consider implementing custom logging for critical operations that captures who, what, when, and how resources are being accessed or modified.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003: Lambda Function Lacks VPC Integration

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-319

#### Issue
The BDAProjectLambda function is explicitly configured to avoid VPC deployment as noted in the cfn_nag suppression, which means it operates directly on the public AWS API endpoint rather than through VPC endpoints.

#### Attack Vector
Network traffic between the Lambda function and AWS services traverses the public internet, potentially exposing API calls and sensitive data to network monitoring or interception.

#### Potential Impact
Potential exposure of sensitive information in transit, including any data exchanged with Bedrock services.

#### Remediation
Deploy the Lambda function within a VPC and use VPC endpoints for AWS services to ensure traffic remains within the AWS network. Configure appropriate security groups to restrict access.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005: No Data Validation for Custom Resource Properties

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAProject` (Custom::BDAProject)  
**CWE ID:** CWE-20

#### Issue
The BDAProject custom resource doesn't appear to have input validation for project properties like BlueprintNames, which are provided as parameters to the Bedrock API calls.

#### Attack Vector
If an attacker can influence these parameters (through CloudFormation stack updates), they could potentially inject malicious values or perform injection attacks against the Bedrock API.

#### Potential Impact
Potential manipulation of Bedrock Data Automation resources or injection attacks through malicious input parameters.

#### Remediation
Implement strong input validation in the BDAProjectLambda handler function to verify all parameters meet expected formats and constraints before passing them to AWS APIs.

**References:**
- https://owasp.org/www-project-top-ten/2017/A1_2017-Injection

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-006: Missing Condition Keys in IAM Policies

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `LambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The IAM policy for LambdaExecutionRole grants broad Bedrock permissions without conditional constraints such as source IP restrictions, time-of-day limitations, or MFA requirements.

#### Attack Vector
If the Lambda function is compromised or credentials are leaked, an attacker could use the permissions from any location without additional verification requirements.

#### Potential Impact
Increased blast radius of compromised credentials with no additional security layers beyond the credentials themselves.

#### Remediation
Add IAM condition keys to the policy to restrict access based on source IP, require MFA for sensitive operations, implement time-based constraints, and add aws:PrincipalArn conditions to limit which entities can assume the role.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html

---

## Low Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004: Missing Concurrency Limits on Lambda Function

**STRIDE Category:** Denial of Service  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
The Lambda function has explicitly suppressed the W92 cfn_nag warning for missing concurrency limits, which could allow unbounded scaling during high traffic or in a DoS scenario.

#### Attack Vector
An attacker could trigger many simultaneous invocations of the function, potentially causing resource exhaustion or high costs.

#### Potential Impact
Potential service disruption or unexpected AWS billing charges due to unbounded Lambda function execution.

#### Remediation
Implement reserved concurrency limits on the Lambda function to cap the maximum number of concurrent executions and prevent excessive resource consumption.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-007: Missing Version Control for Blueprint Changes

**STRIDE Category:** Repudiation  
**Affected Resource:** `BDAProject` (Custom::BDAProject)  
**CWE ID:** CWE-778

#### Issue
The template includes a hardcoded Version parameter ('04-04-2025') but doesn't implement proper versioning for blueprints or project configurations, making it difficult to track or roll back changes.

#### Attack Vector
Malicious changes to blueprints or configurations could be difficult to detect or attribute without proper versioning and change tracking.

#### Potential Impact
Inability to track who made changes to blueprints or project configurations, or to roll back to previous stable versions after undesired changes.

#### Remediation
Implement proper versioning for blueprints and project configurations. Use AWS tags to track metadata about resources including creation date, owner, and purpose. Consider implementing a change management process for blueprint updates.

**References:**
- https://docs.aws.amazon.com/whitepapers/latest/tagging-best-practices/tagging-best-practices.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# options-bda-lending-project-.aws-sam-packaged


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-29  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **7** security threats. The analysis reveals **0** critical, **2** high, **4** medium, and **1** low severity findings.

## Priority Actions

### 1. Scope down the IAM policy to specific resources where possible. Replace the wildcard '*' with specific ARNs for the projects and blueprints this function needs to manage. If wildcard is absolutely necessary for some operations, consider using condition keys to limit the scope (e.g., by project name or tag).

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001  
**Business Impact:** Unauthorized access to Bedrock resources could lead to data leakage, resource manipulation, or creation of unauthorized resources resulting in security breaches or unexpected costs.

### 1. Ensure the S3 bucket has appropriate access controls with bucket policies that restrict access. Implement server-side encryption for the S3 bucket. Consider using AWS Secrets Manager or Parameter Store for any sensitive values instead of embedding them in code. Implement automated code scanning to detect and prevent secrets from being committed.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-006  
**Business Impact:** Exposure of proprietary code, potential disclosure of embedded secrets or configuration, and increased risk of targeted attacks based on knowledge of internal systems.

### 2. Enhance the logging configuration by implementing comprehensive CloudTrail logging for all Bedrock API calls. Consider implementing custom application-level logging that captures detailed information about all administrative actions performed by the Lambda function, including who initiated them and what changes were made.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002  
**Business Impact:** Reduced ability to detect unauthorized changes, troubleshoot issues, or perform forensic analysis after security incidents.

### 2. Implement appropriate concurrency limits on the Lambda function using the ReservedConcurrentExecutions property. Consider implementing appropriate throttling mechanisms and exponential backoff retry strategies in the function code.

**Effort:** Low  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003  
**Business Impact:** Potential service disruption, increased costs, and degraded performance for other applications sharing the same account resources.

### 2. Deploy the Lambda function within a VPC with appropriate security groups and use VPC endpoints for AWS services to keep traffic private. If internet access is required, implement a NAT Gateway with appropriate routing and security controls.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004  
**Business Impact:** Increased risk of data exfiltration and potential for compromised functions to communicate with external malicious servers.

### 2. Implement additional detective controls such as AWS Config rules or CloudWatch Events to monitor and alert on unauthorized changes to the Bedrock Data Automation project. Consider implementing infrastructure as code deployment pipelines with appropriate approval processes for any changes.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005  
**Business Impact:** Potential for sensitive document data to be compromised or for the document processing workflow to be manipulated in ways that could lead to security breaches or incorrect processing results.

### 3. Implement standard semantic versioning practices (e.g., 1.0.0) rather than using dates as version identifiers, especially future dates. Consider using AWS resource tagging with standardized version tags to maintain version information.

**Effort:** Low  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-007  
**Business Impact:** Potential for confusion in resource management, difficulties in determining which version of resources are deployed, and possible operational errors.



## Detailed Threat Analysis

## High Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001: Overly Permissive IAM Policy with Wildcard Resource

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `LambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The LambdaExecutionRole contains a policy that grants access to Bedrock Data Automation services using wildcard ('*') resource specifier. This violates the principle of least privilege by potentially allowing access to all Bedrock resources rather than limiting to specific resources needed.

#### Attack Vector
If the Lambda function or its credentials are compromised, an attacker could use these permissions to access, modify, or delete any Bedrock Data Automation resources in the account, including those not related to this specific project.

#### Potential Impact
Unauthorized access to Bedrock resources could lead to data leakage, resource manipulation, or creation of unauthorized resources resulting in security breaches or unexpected costs.

#### Remediation
Scope down the IAM policy to specific resources where possible. Replace the wildcard '*' with specific ARNs for the projects and blueprints this function needs to manage. If wildcard is absolutely necessary for some operations, consider using condition keys to limit the scope (e.g., by project name or tag).

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-006: S3 CodeUri with Potential Data Exposure Risk

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-200

#### Issue
The Lambda function references code stored in an S3 bucket ('bobs-artifacts-us-west-2') with a specific path that might be accessible to unauthorized users if the bucket has improper access controls. This could expose proprietary code or potentially sensitive information embedded in the code.

#### Attack Vector
If the S3 bucket has misconfigured permissions or if an attacker gains access to the bucket, they could access the Lambda function code, potentially discovering hardcoded secrets, internal logic, or other sensitive information.

#### Potential Impact
Exposure of proprietary code, potential disclosure of embedded secrets or configuration, and increased risk of targeted attacks based on knowledge of internal systems.

#### Remediation
Ensure the S3 bucket has appropriate access controls with bucket policies that restrict access. Implement server-side encryption for the S3 bucket. Consider using AWS Secrets Manager or Parameter Store for any sensitive values instead of embedding them in code. Implement automated code scanning to detect and prevent secrets from being committed.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-policies.html

---

## Medium Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002: Insufficient Logging for Administrative Actions

**STRIDE Category:** Repudiation  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
While the Lambda function has basic logging enabled via AWSLambdaBasicExecutionRole, there's no evidence of comprehensive logging for the administrative actions performed by the function on Bedrock Data Automation resources. This could lead to difficulty in tracing actions and changes.

#### Attack Vector
Without proper logging, malicious actions or mistakes made using the function's permissions may not be properly tracked, making forensic analysis difficult in case of a security incident.

#### Potential Impact
Reduced ability to detect unauthorized changes, troubleshoot issues, or perform forensic analysis after security incidents.

#### Remediation
Enhance the logging configuration by implementing comprehensive CloudTrail logging for all Bedrock API calls. Consider implementing custom application-level logging that captures detailed information about all administrative actions performed by the Lambda function, including who initiated them and what changes were made.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003: Missing Concurrency Limits and Rate Controls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
The Lambda function does not specify any concurrency limits or throttling controls, which could lead to resource exhaustion under high load or in case of a recursive invocation scenario. The cfn_nag suppression explicitly states that no concurrent execution limits are implemented.

#### Attack Vector
An attacker could potentially trigger numerous concurrent executions of the Lambda function, causing resource exhaustion or unexpected costs. This could also impact other services and applications that rely on the same resources.

#### Potential Impact
Potential service disruption, increased costs, and degraded performance for other applications sharing the same account resources.

#### Remediation
Implement appropriate concurrency limits on the Lambda function using the ReservedConcurrentExecutions property. Consider implementing appropriate throttling mechanisms and exponential backoff retry strategies in the function code.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004: Lambda Function Without VPC Configuration

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-668

#### Issue
The Lambda function is deployed without a VPC configuration as indicated by the cfn_nag suppression comment. This means the function operates directly on the public AWS API endpoints rather than through private VPC endpoints, potentially increasing the attack surface.

#### Attack Vector
If the Lambda function is compromised, an attacker would have direct internet access from the function's execution environment, which could be used for data exfiltration or communication with malicious command and control servers.

#### Potential Impact
Increased risk of data exfiltration and potential for compromised functions to communicate with external malicious servers.

#### Remediation
Deploy the Lambda function within a VPC with appropriate security groups and use VPC endpoints for AWS services to keep traffic private. If internet access is required, implement a NAT Gateway with appropriate routing and security controls.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005: No Immutability Controls for Bedrock Data Automation Project

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAProject` (Custom::BDAProject)  
**CWE ID:** CWE-642

#### Issue
The template creates a Bedrock Data Automation project with blueprints for processing potentially sensitive documents (bank statements, payslips, driver's licenses) but lacks controls to prevent unauthorized modifications to the project configuration after deployment.

#### Attack Vector
An attacker with appropriate IAM permissions could modify the project configuration or blueprints to exfiltrate sensitive data processed by the system or introduce malicious behavior.

#### Potential Impact
Potential for sensitive document data to be compromised or for the document processing workflow to be manipulated in ways that could lead to security breaches or incorrect processing results.

#### Remediation
Implement additional detective controls such as AWS Config rules or CloudWatch Events to monitor and alert on unauthorized changes to the Bedrock Data Automation project. Consider implementing infrastructure as code deployment pipelines with appropriate approval processes for any changes.

**References:**
- https://docs.aws.amazon.com/config/latest/developerguide/operational-best-practices-for-pci-dss.html

---

## Low Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-007: Potential Version Control Issue in Custom Resource

**STRIDE Category:** Spoofing  
**Affected Resource:** `BDAProject` (Custom::BDAProject)  
**CWE ID:** CWE-1288

#### Issue
The BDAProject custom resource includes a 'Version' property with a future date value ('04-04-2025'), which could be a mistake or an attempt at version control. This unusual versioning approach could lead to confusion or errors in resource management.

#### Attack Vector
While not directly exploitable, this unusual versioning practice could create confusion that might be leveraged in social engineering attacks or lead to operational errors that create security vulnerabilities.

#### Potential Impact
Potential for confusion in resource management, difficulties in determining which version of resources are deployed, and possible operational errors.

#### Remediation
Implement standard semantic versioning practices (e.g., 1.0.0) rather than using dates as version identifiers, especially future dates. Consider using AWS resource tagging with standardized version tags to maintain version information.

**References:**
- https://semver.org/

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# options-bda-lending-project-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-17  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **5** security threats. The analysis reveals **0** critical, **1** high, **3** medium, and **1** low severity findings.

## Priority Actions

### 1. Scope down the IAM policy to specific resources where possible. Replace the wildcard resource with specific ARNs of the Bedrock resources this Lambda function needs to access. If resource-level permissions are not supported for specific actions, implement additional guardrails such as tagging strategies or conditions in the policy.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001  
**Business Impact:** Unauthorized access to Bedrock resources could lead to data exfiltration, resource manipulation, or disruption of other services using Bedrock in the organization.

### 2. Enhance the Lambda function code to implement detailed audit logging that captures all significant administrative actions, including who performed them, when, and what was changed. Consider implementing a dedicated audit trail storage mechanism separate from operational logs. Enable AWS CloudTrail data events for relevant Bedrock API calls.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002  
**Business Impact:** Reduced ability to detect unauthorized activities, troubleshoot issues, or meet compliance requirements that mandate comprehensive audit trails for administrative actions.

### 2. Implement explicit security controls for data processing: 1) Ensure encryption in transit and at rest for all document data, 2) Define clear access boundaries and permissions for processed documents, 3) Implement data lifecycle policies to ensure data is retained only as long as necessary, 4) Consider adding resource policies that restrict which principals can access the processed data.

**Effort:** High  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003  
**Business Impact:** Potential exposure of personally identifiable information (PII) and financial data could lead to regulatory violations, privacy breaches, and damage to customer trust.

### 2. Implement integrity verification mechanisms: 1) Use checksums or digital signatures to validate blueprint integrity, 2) Implement a formal change management process for blueprints, 3) Consider using AWS CodePipeline with approval gates for blueprint deployment, 4) Add regular automated scanning of blueprints for malicious patterns.

**Effort:** Medium  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005  
**Business Impact:** Data processing logic could be compromised, potentially leading to data leakage, incorrect document classification, or insertion of malicious logic into the document processing workflow.

### 3. Consider implementing appropriate concurrency controls: 1) Set reserved concurrency to guarantee execution capacity for this function, 2) Set maximum concurrency limits to prevent resource exhaustion, 3) Implement throttling or queuing mechanisms for high-volume scenarios.

**Effort:** Low  
**Related Threats:** GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004  
**Business Impact:** Potential service degradation or unavailability of other Lambda functions in the same AWS account, leading to broader application disruption.



## Detailed Threat Analysis

## High Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-001: Overly Permissive IAM Policy

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `LambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The LambdaExecutionRole contains a policy with wildcard (*) resources for Bedrock actions, violating the principle of least privilege. This allows the Lambda function to access potentially all Bedrock resources in the account.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these excessive permissions to access, modify, or delete any Bedrock data automation project or blueprint in the account, including those unrelated to this specific application.

#### Potential Impact
Unauthorized access to Bedrock resources could lead to data exfiltration, resource manipulation, or disruption of other services using Bedrock in the organization.

#### Remediation
Scope down the IAM policy to specific resources where possible. Replace the wildcard resource with specific ARNs of the Bedrock resources this Lambda function needs to access. If resource-level permissions are not supported for specific actions, implement additional guardrails such as tagging strategies or conditions in the policy.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Medium Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-002: Insufficient Logging for Administrative Actions

**STRIDE Category:** Repudiation  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
The Lambda function responsible for creating and managing Bedrock Data Automation resources has basic CloudWatch logging but lacks comprehensive audit logging for sensitive administrative actions. While LOG_LEVEL is configurable, there's no explicit configuration for capturing detailed audit trails of resource creation, modification, or deletion events.

#### Attack Vector
Without proper audit logs, unauthorized changes to Bedrock resources could be made without adequate traceability, making it difficult to investigate security incidents or prove compliance.

#### Potential Impact
Reduced ability to detect unauthorized activities, troubleshoot issues, or meet compliance requirements that mandate comprehensive audit trails for administrative actions.

#### Remediation
Enhance the Lambda function code to implement detailed audit logging that captures all significant administrative actions, including who performed them, when, and what was changed. Consider implementing a dedicated audit trail storage mechanism separate from operational logs. Enable AWS CloudTrail data events for relevant Bedrock API calls.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/lambda-monitoring.html
- https://docs.aws.amazon.com/bedrock/latest/userguide/logging-using-cloudtrail.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-003: Sensitive Data Processing Without Explicit Security Controls

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BDAProject` (Custom::BDAProject)  
**CWE ID:** CWE-311

#### Issue
The template processes potentially sensitive lending documents (bank statements, payslips, driver's licenses, etc.) using Bedrock Data Automation, but does not explicitly define security controls for data protection such as encryption requirements, access restrictions, or data handling policies.

#### Attack Vector
Without proper security controls, sensitive personal and financial information contained in these documents could be exposed during processing, storage, or transmission within the Bedrock service.

#### Potential Impact
Potential exposure of personally identifiable information (PII) and financial data could lead to regulatory violations, privacy breaches, and damage to customer trust.

#### Remediation
Implement explicit security controls for data processing: 1) Ensure encryption in transit and at rest for all document data, 2) Define clear access boundaries and permissions for processed documents, 3) Implement data lifecycle policies to ensure data is retained only as long as necessary, 4) Consider adding resource policies that restrict which principals can access the processed data.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security.html

---

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-005: Missing Version Control and Integrity Verification

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAProject` (Custom::BDAProject)  
**CWE ID:** CWE-345

#### Issue
While the template specifies a 'Version' property for the BDA project, there's no mechanism to validate the integrity of blueprints or ensure they haven't been tampered with. The deployment process doesn't include checksum verification or source control integration for the blueprints being used.

#### Attack Vector
An attacker with sufficient access could potentially modify blueprint definitions or swap them with malicious versions that could extract or manipulate sensitive data being processed.

#### Potential Impact
Data processing logic could be compromised, potentially leading to data leakage, incorrect document classification, or insertion of malicious logic into the document processing workflow.

#### Remediation
Implement integrity verification mechanisms: 1) Use checksums or digital signatures to validate blueprint integrity, 2) Implement a formal change management process for blueprints, 3) Consider using AWS CodePipeline with approval gates for blueprint deployment, 4) Add regular automated scanning of blueprints for malicious patterns.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-dataprotection.html

---

## Low Severity Threats

### GENAIIDP-SAMPLE-LENDING-PROJECT-THREAT-004: Missing Concurrency Controls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `BDAProjectLambda` (AWS::Serverless::Function)  
**CWE ID:** CWE-400

#### Issue
The BDAProjectLambda function does not have reserved concurrency or concurrency limits defined. The template explicitly skips this control (CKV_AWS_115). While this may be an intentional design choice, it leaves the function vulnerable to potential resource exhaustion.

#### Attack Vector
In a high-traffic environment or during a spike in requests, the Lambda function could consume all available execution capacity in the AWS account, potentially affecting other functions and services.

#### Potential Impact
Potential service degradation or unavailability of other Lambda functions in the same AWS account, leading to broader application disruption.

#### Remediation
Consider implementing appropriate concurrency controls: 1) Set reserved concurrency to guarantee execution capacity for this function, 2) Set maximum concurrency limits to prevent resource exhaustion, 3) Implement throttling or queuing mechanisms for high-volume scenarios.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# options-bedrockkb-.aws-sam-build-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-53  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **1** high, **5** medium, and **4** low severity findings.

## Priority Actions

### 1. Implement least privilege by restricting S3 permissions to specific buckets and actions needed. Scope down the OpenSearch Serverless permissions to specific collections and actions required.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-003  
**Business Impact:** Potential data exfiltration, unauthorized access to S3 objects, or manipulation of OpenSearch collections and indices.

### 1. Restrict the bedrock:InvokeModel permission to only the specific embedding model ARNs required for the Knowledge Base functionality rather than allowing access to all foundation models.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-005  
**Business Impact:** Potential misuse of AI capabilities, unauthorized model access, and possible generation of harmful content through unrestricted model invocation.

### 2. Modify the OSSNetworkPolicy to restrict access using VPC endpoints or IP-based restrictions instead of allowing public access. If public access is required, ensure proper authentication and authorization are strictly enforced.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-001  
**Business Impact:** Potential unauthorized access to the vector database containing knowledge base data, which could lead to data exposure or information leakage.

### 2. Deploy Lambda functions within a VPC with appropriate subnet and security group configurations to restrict network access and enhance security posture.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-006  
**Business Impact:** Increased attack surface for sensitive functions that handle data transformations or have permissions to access other AWS resources.

### 2. Implement additional validation and filtering for web crawler content, such as content classifiers to identify and exclude sensitive information. Consider adding policies to respect robots.txt and implement ethical crawling practices.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-010  
**Business Impact:** Potential leakage of sensitive information, copyright violations, or unauthorized data collection through the web crawler mechanism.

### 3. Modify the OSSEncryptionPolicy to use customer-managed KMS keys instead of AWS-owned keys by setting 'AWSOwnedKey' to false and specifying a KMS key.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-002  
**Business Impact:** Reduced control over encryption key management and potential challenges meeting strict compliance requirements that mandate customer control of encryption keys.

### 3. Configure explicit log retention periods for Lambda functions using AWS::Logs::LogGroup resources with appropriate RetentionInDays values. Consider encrypting logs with KMS for sensitive workloads.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-004  
**Business Impact:** Difficulty investigating security incidents, potential non-compliance with regulatory requirements for log retention, and challenges with non-repudiation.

### 3. Either modify the template to create a new bucket with proper security configurations or validate the security settings of the existing bucket. Consider adding conditional checks to ensure the bucket has appropriate security controls.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-008  
**Business Impact:** Potential data integrity issues, inability to recover from accidental or malicious changes, and lack of audit trails for bucket access.

### 4. Configure ReservedConcurrentExecutions for critical Lambda functions to ensure they have guaranteed capacity even during high-load situations.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-007  
**Business Impact:** Potential service disruptions, failures in index creation, or delays in processing Knowledge Base operations during peak usage periods.

### 4. Consider adding additional authentication mechanisms to the EventBridge Scheduler configuration if available, or implement tighter restrictions on the scheduler role's permissions.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-009  
**Business Impact:** If the scheduler role is compromised, an attacker could trigger unauthorized ingestion jobs, potentially causing resource consumption or service disruptions.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-005: Broad Bedrock Model Invocation Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `KnowledgeBaseServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The KnowledgeBaseServiceRole includes permission to invoke any foundation model in Bedrock (bedrock:InvokeModel on resource '*') rather than restricting to specific models needed.

#### Attack Vector
If the Knowledge Base service is compromised, an attacker could leverage this role to invoke any Bedrock model, potentially bypassing guardrails or restrictions on specific models.

#### Potential Impact
Potential misuse of AI capabilities, unauthorized model access, and possible generation of harmful content through unrestricted model invocation.

#### Remediation
Restrict the bedrock:InvokeModel permission to only the specific embedding model ARNs required for the Knowledge Base functionality rather than allowing access to all foundation models.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_service-with-iam.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-001: Public Access to OpenSearch Serverless Collection

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OSSNetworkPolicy` (AWS::OpenSearchServerless::SecurityPolicy)  
**CWE ID:** CWE-668

#### Issue
The OSSNetworkPolicy security policy allows public access to the OpenSearch Serverless collection dashboard and API endpoints with 'AllowFromPublic' set to true.

#### Attack Vector
An attacker could attempt to access the OpenSearch dashboard or API endpoints if authentication controls are misconfigured or compromised.

#### Potential Impact
Potential unauthorized access to the vector database containing knowledge base data, which could lead to data exposure or information leakage.

#### Remediation
Modify the OSSNetworkPolicy to restrict access using VPC endpoints or IP-based restrictions instead of allowing public access. If public access is required, ensure proper authentication and authorization are strictly enforced.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-network.html

---

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-002: Default AWS-Owned Key Used for OpenSearch Encryption

**STRIDE Category:** Tampering  
**Affected Resource:** `OSSEncryptionPolicy` (AWS::OpenSearchServerless::SecurityPolicy)  
**CWE ID:** CWE-320

#### Issue
The template uses AWS-owned encryption keys for the OpenSearch Serverless collection rather than customer-managed KMS keys.

#### Attack Vector
While AWS-owned keys provide encryption, they don't give customers full control over the key lifecycle or access management.

#### Potential Impact
Reduced control over encryption key management and potential challenges meeting strict compliance requirements that mandate customer control of encryption keys.

#### Remediation
Modify the OSSEncryptionPolicy to use customer-managed KMS keys instead of AWS-owned keys by setting 'AWSOwnedKey' to false and specifying a KMS key.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-encryption.html

---

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-003: Overly Permissive IAM Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole includes broad permissions like 's3:*Object*' on all S3 buckets and 'aoss:APIAccessAll' on all resources.

#### Attack Vector
If the Lambda function is compromised, an attacker could use these broad permissions to access data in any S3 bucket or perform unauthorized actions in OpenSearch Serverless.

#### Potential Impact
Potential data exfiltration, unauthorized access to S3 objects, or manipulation of OpenSearch collections and indices.

#### Remediation
Implement least privilege by restricting S3 permissions to specific buckets and actions needed. Scope down the OpenSearch Serverless permissions to specific collections and actions required.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-006: Lambda Functions Without VPC Configuration

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `GetAdjustedStackNameFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-668

#### Issue
Lambda functions are deployed without VPC configurations, exposing them to the public internet rather than restricting them within a private network.

#### Attack Vector
While protected by IAM, Lambda functions could potentially be accessed from the public internet, increasing the attack surface.

#### Potential Impact
Increased attack surface for sensitive functions that handle data transformations or have permissions to access other AWS resources.

#### Remediation
Deploy Lambda functions within a VPC with appropriate subnet and security group configurations to restrict network access and enhance security posture.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html

---

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-010: Web Crawler Data Source Security Risk

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `WebDataSource` (AWS::Bedrock::DataSource)  
**CWE ID:** CWE-212

#### Issue
The web crawler configuration can ingest content from public websites but doesn't include security controls to prevent crawling or ingestion of sensitive information.

#### Attack Vector
The web crawler could potentially scrape sensitive or restricted information from websites and store it in the Knowledge Base, where it could be exposed through queries.

#### Potential Impact
Potential leakage of sensitive information, copyright violations, or unauthorized data collection through the web crawler mechanism.

#### Remediation
Implement additional validation and filtering for web crawler content, such as content classifiers to identify and exclude sensitive information. Consider adding policies to respect robots.txt and implement ethical crawling practices.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-web.html

---

## Low Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-004: Missing CloudWatch Logs Configurations for Lambda Functions

**STRIDE Category:** Repudiation  
**Affected Resource:** `CreateOSSIndexLambdaFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
Lambda functions in the template don't explicitly define log retention periods or log access controls, which could lead to insufficient audit trails.

#### Attack Vector
In the event of a security incident, logs might be missing, inadequate, or might have been automatically deleted if the default retention period was too short.

#### Potential Impact
Difficulty investigating security incidents, potential non-compliance with regulatory requirements for log retention, and challenges with non-repudiation.

#### Remediation
Configure explicit log retention periods for Lambda functions using AWS::Logs::LogGroup resources with appropriate RetentionInDays values. Consider encrypting logs with KMS for sensitive workloads.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html

---

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-007: Missing Lambda Concurrency Controls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `CreateOSSIndexLambdaFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-400

#### Issue
Lambda functions don't have reserved concurrency configurations, which could lead to resource exhaustion during high traffic periods.

#### Attack Vector
In a multi-tenant environment, other applications could consume all available Lambda concurrency, causing throttling and denial of service for the Knowledge Base components.

#### Potential Impact
Potential service disruptions, failures in index creation, or delays in processing Knowledge Base operations during peak usage periods.

#### Remediation
Configure ReservedConcurrentExecutions for critical Lambda functions to ensure they have guaranteed capacity even during high-load situations.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-008: Missing S3 Bucket Security Configurations

**STRIDE Category:** Tampering  
**Affected Resource:** `pKnowledgeBaseBucketName` (AWS::S3::Bucket)  
**CWE ID:** CWE-693

#### Issue
The template references an existing S3 bucket but doesn't enforce security configurations like versioning, encryption, or access logging on that bucket.

#### Attack Vector
If the referenced bucket doesn't have proper security controls, documents stored in it could be vulnerable to unauthorized modifications or deletions.

#### Potential Impact
Potential data integrity issues, inability to recover from accidental or malicious changes, and lack of audit trails for bucket access.

#### Remediation
Either modify the template to create a new bucket with proper security configurations or validate the security settings of the existing bucket. Consider adding conditional checks to ensure the bucket has appropriate security controls.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html

---

### AWS-GENAI-IDP-ACCELERATOR-BEDROCK-KNOWLEDGE-BASE-SETUP-THREAT-009: Scheduler Without Request Authentication

**STRIDE Category:** Spoofing  
**Affected Resource:** `S3DataSourceScheduler` (AWS::Scheduler::Schedule)  
**CWE ID:** CWE-306

#### Issue
The EventBridge Scheduler configurations don't include authentication settings when invoking the Bedrock API.

#### Attack Vector
While protected by IAM, the lack of additional authentication mechanisms could potentially be exploited if the scheduler role is compromised.

#### Potential Impact
If the scheduler role is compromised, an attacker could trigger unauthorized ingestion jobs, potentially causing resource consumption or service disruptions.

#### Remediation
Consider adding additional authentication mechanisms to the EventBridge Scheduler configuration if available, or implement tighter restrictions on the scheduler role's permissions.

**References:**
- https://docs.aws.amazon.com/scheduler/latest/UserGuide/managing-security.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# options-bedrockkb-.aws-sam-packaged


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-51  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **11** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **2** low severity findings.

## Priority Actions

### 1. Restrict S3 permissions to specific buckets required for the application functionality. Update the S3 resource scope from 'arn:aws:s3:::*' to the specific buckets needed.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-001  
**Business Impact:** Potential unauthorized access to all S3 buckets in the account, resulting in data loss, modification, or exfiltration beyond the scope needed for the application.

### 1. Restrict access to the OpenSearch Serverless collection to specific VPC endpoints, IP ranges, or AWS services instead of allowing public access. Set 'AllowFromPublic: false' and implement a more restrictive access policy.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-003  
**Business Impact:** Potential unauthorized access to indexed data, including sensitive information stored in the knowledge base.

### 2. Scope down permissions to specific OpenSearch Serverless collections and actions required for the application functionality. Replace wildcard resource patterns with specific ARNs.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-002  
**Business Impact:** Potential for unauthorized creation or modification of OpenSearch Serverless resources leading to data exposure or service disruption.

### 2. Use a customer-managed KMS key for encrypting the OpenSearch Serverless collection to gain better control and auditability. Update the encryption policy to specify a customer-managed KMS key ARN instead of using AWS owned keys.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-004  
**Business Impact:** Reduced control over data encryption and inability to implement custom key management strategies (rotation, revocation) for sensitive data.

### 2. Enable CloudTrail data events for Bedrock services and implement additional application-level logging for all knowledge base interactions. Consider implementing an audit solution that captures all interactions with the knowledge base.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-005  
**Business Impact:** Inability to detect, investigate, or respond to suspicious activities or unauthorized access to the knowledge base.

### 2. Restrict the bedrock:InvokeModel permission to only the specific embedding model being used (pEmbedModel parameter) rather than allowing access to all foundation models.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-006  
**Business Impact:** Potential for unauthorized usage of any Bedrock model, leading to increased costs or potential data leakage through carefully crafted prompts.

### 2. Enable versioning on the S3 bucket used as a data source. While the template uses an existing bucket, it should either validate that versioning is enabled or provide guidance to enable it.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-008  
**Business Impact:** Potential for undetected tampering with knowledge base source data, leading to misinformation or data loss without a recovery path.

### 3. Implement a more conservative rate limit for the web crawler and consider implementing progressive back-off strategies. Evaluate the actual needs of the application and reduce the rate limit to a more reasonable value.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-007  
**Business Impact:** Target websites might block the crawler's IP address, resulting in incomplete data collection and potential service disruption for both the crawler and target websites.

### 3. Use code signing for Lambda functions to ensure the integrity of the deployed code. Additionally, ensure the S3 bucket has appropriate access controls and versioning enabled.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-009  
**Business Impact:** Potential execution of unauthorized code with the permissions of the Lambda function's role.

### 3. Implement log filtering for sensitive information and ensure CloudWatch Logs are encrypted. Consider using AWS Secrets Manager for storing sensitive configuration values.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-010  
**Business Impact:** Potential disclosure of sensitive configuration information that could aid in targeting the knowledge base infrastructure.



## Detailed Threat Analysis

## High Severity Threats

### BEDROCKKNOWLEDGEBASE-THREAT-001: Overly permissive IAM permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has overly broad permissions for S3 access, allowing actions like PutObject*, GetObject*, and DeleteObject* on all S3 buckets in the account ('arn:aws:s3:::*') rather than limiting to specific buckets needed for the application.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these permissions to access, modify, or delete objects in any S3 bucket in the account.

#### Potential Impact
Potential unauthorized access to all S3 buckets in the account, resulting in data loss, modification, or exfiltration beyond the scope needed for the application.

#### Remediation
Restrict S3 permissions to specific buckets required for the application functionality. Update the S3 resource scope from 'arn:aws:s3:::*' to the specific buckets needed.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCKKNOWLEDGEBASE-THREAT-003: Public access enabled for OpenSearch Serverless collection

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OSSNetworkPolicy` (AWS::OpenSearchServerless::NetworkPolicy)  
**CWE ID:** CWE-284

#### Issue
The OpenSearch Serverless network policy allows public access to both the collection and its dashboard with 'AllowFromPublic: true', creating potential exposure of sensitive data.

#### Attack Vector
Unauthorized users from the internet could potentially access the OpenSearch collection or dashboard if authentication mechanisms are compromised or misconfigured.

#### Potential Impact
Potential unauthorized access to indexed data, including sensitive information stored in the knowledge base.

#### Remediation
Restrict access to the OpenSearch Serverless collection to specific VPC endpoints, IP ranges, or AWS services instead of allowing public access. Set 'AllowFromPublic: false' and implement a more restrictive access policy.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-network.html

---

## Medium Severity Threats

### BEDROCKKNOWLEDGEBASE-THREAT-002: Broad permissions for OpenSearch Serverless actions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has broad permissions for OpenSearch Serverless administration actions (create, list, update policies) on all resources (*) rather than being limited to specific collections.

#### Attack Vector
If the Lambda function is compromised, an attacker could create or modify OpenSearch collections and security policies across the account.

#### Potential Impact
Potential for unauthorized creation or modification of OpenSearch Serverless resources leading to data exposure or service disruption.

#### Remediation
Scope down permissions to specific OpenSearch Serverless collections and actions required for the application functionality. Replace wildcard resource patterns with specific ARNs.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCKKNOWLEDGEBASE-THREAT-004: Default encryption with AWS owned keys

**STRIDE Category:** Tampering  
**Affected Resource:** `OSSCollection` (AWS::OpenSearchServerless::Collection)  
**CWE ID:** CWE-321

#### Issue
The OpenSearch Serverless collection uses AWS owned keys for encryption (AWSOwnedKey: true) rather than customer managed keys, reducing control over encryption and key rotation.

#### Attack Vector
In case of a compromise of AWS managed keys, the customer has no visibility or control over the encryption and cannot immediately revoke access.

#### Potential Impact
Reduced control over data encryption and inability to implement custom key management strategies (rotation, revocation) for sensitive data.

#### Remediation
Use a customer-managed KMS key for encrypting the OpenSearch Serverless collection to gain better control and auditability. Update the encryption policy to specify a customer-managed KMS key ARN instead of using AWS owned keys.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-encryption.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-005: Insufficient logging for Bedrock Knowledge Base access

**STRIDE Category:** Repudiation  
**Affected Resource:** `KnowledgeBase` (AWS::Bedrock::KnowledgeBase)  
**CWE ID:** CWE-778

#### Issue
No CloudTrail logs or custom logging is explicitly configured to monitor access and usage patterns of the Bedrock Knowledge Base, limiting auditability and investigation capabilities.

#### Attack Vector
Unauthorized access or abuse of the Knowledge Base might go undetected without proper logging and monitoring.

#### Potential Impact
Inability to detect, investigate, or respond to suspicious activities or unauthorized access to the knowledge base.

#### Remediation
Enable CloudTrail data events for Bedrock services and implement additional application-level logging for all knowledge base interactions. Consider implementing an audit solution that captures all interactions with the knowledge base.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/monitoring.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-006: Broad permission to invoke any Bedrock foundation model

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `KnowledgeBaseServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The KnowledgeBaseServiceRole has permission to invoke any foundation model in Bedrock (bedrock:InvokeModel on arn:aws:bedrock:${AWS::Region}::foundation-model/*) rather than being limited to specific required models.

#### Attack Vector
If the service role is compromised, an attacker could invoke any Bedrock model, potentially leading to unexpected costs or data leakage through prompt engineering.

#### Potential Impact
Potential for unauthorized usage of any Bedrock model, leading to increased costs or potential data leakage through carefully crafted prompts.

#### Remediation
Restrict the bedrock:InvokeModel permission to only the specific embedding model being used (pEmbedModel parameter) rather than allowing access to all foundation models.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCKKNOWLEDGEBASE-THREAT-007: Web crawler rate limit potentially too high

**STRIDE Category:** Denial of Service  
**Affected Resource:** `WebDataSource` (AWS::Bedrock::DataSource)  
**CWE ID:** CWE-770

#### Issue
The web crawler is configured with a rate limit of 300 requests, which could potentially cause excessive load on target websites leading to IP blocking or service disruption.

#### Attack Vector
The crawler could unintentionally create a denial of service condition on target websites by sending too many requests in a short period.

#### Potential Impact
Target websites might block the crawler's IP address, resulting in incomplete data collection and potential service disruption for both the crawler and target websites.

#### Remediation
Implement a more conservative rate limit for the web crawler and consider implementing progressive back-off strategies. Evaluate the actual needs of the application and reduce the rate limit to a more reasonable value.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-crawling.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-008: Lack of versioning for S3 data source

**STRIDE Category:** Tampering  
**Affected Resource:** `S3DataSource` (AWS::Bedrock::DataSource)  
**CWE ID:** CWE-693

#### Issue
The template does not ensure versioning is enabled on the S3 bucket used as a data source, creating risk of data tampering without an audit trail or recovery mechanism.

#### Attack Vector
An attacker with access to the S3 bucket could modify or delete source documents without any ability to recover previous versions or detect changes.

#### Potential Impact
Potential for undetected tampering with knowledge base source data, leading to misinformation or data loss without a recovery path.

#### Remediation
Enable versioning on the S3 bucket used as a data source. While the template uses an existing bucket, it should either validate that versioning is enabled or provide guidance to enable it.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-010: Sensitive information in custom resource properties

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `InvokeCreateOSSIndexLambdaFunction` (Custom::InvokeCreateOSSIndexLambdaFunction)  
**CWE ID:** CWE-532

#### Issue
The custom resource properties include sensitive information like collection endpoints and embedding model IDs that might be logged in CloudWatch Logs without appropriate protection.

#### Attack Vector
An attacker with access to CloudWatch Logs could potentially extract sensitive configuration details that could be used to target the OpenSearch collection.

#### Potential Impact
Potential disclosure of sensitive configuration information that could aid in targeting the knowledge base infrastructure.

#### Remediation
Implement log filtering for sensitive information and ensure CloudWatch Logs are encrypted. Consider using AWS Secrets Manager for storing sensitive configuration values.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/encrypt-log-data-kms.html

---

## Low Severity Threats

### BEDROCKKNOWLEDGEBASE-THREAT-009: Lambda function using hardcoded S3 code location

**STRIDE Category:** Spoofing  
**Affected Resource:** `CreateOSSIndexLambdaFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-494

#### Issue
The Lambda function uses a hardcoded S3 bucket and path for the code, which could be redirected or spoofed if the S3 object is replaced.

#### Attack Vector
If an attacker gains access to the S3 bucket containing the Lambda code, they could replace the code with malicious content that would be executed with the Lambda's permissions.

#### Potential Impact
Potential execution of unauthorized code with the permissions of the Lambda function's role.

#### Remediation
Use code signing for Lambda functions to ensure the integrity of the deployed code. Additionally, ensure the S3 bucket has appropriate access controls and versioning enabled.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-codesigning.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-011: Potential URL information disclosure in logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `GetSeedUrlsFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-532

#### Issue
The GetSeedUrlsFunction logs the entire event object with 'logger.info(event)', which may include sensitive URLs in CloudWatch Logs that could reveal internal systems or crawling targets.

#### Attack Vector
An attacker with access to CloudWatch Logs could gather information about what websites and internal systems are being crawled, potentially using this for reconnaissance.

#### Potential Impact
Disclosure of targeted URLs and crawling patterns that could reveal business intelligence or crawling strategy.

#### Remediation
Implement selective logging that avoids recording the full URLs or sensitive parameters. Filter or mask sensitive parts of URLs before logging.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# options-bedrockkb-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-38  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **4** high, **4** medium, and **2** low severity findings.

## Priority Actions

### 1. Scope S3 permissions to only the specific buckets required for function operation. Replace 'arn:aws:s3:::*' with specific bucket ARNs needed by the Lambda function

**Effort:** Low  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-001  
**Business Impact:** Unauthorized access to sensitive data across all S3 buckets in the account, potential data exfiltration or corruption

### 1. Set 'AllowFromPublic: false' and implement more restrictive access controls such as VPC endpoints, IP-based restrictions, or IAM-based access

**Effort:** Medium  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-004  
**Business Impact:** Potential unauthorized access to sensitive data, increased attack surface, and violation of security best practices for internal analytics services

### 2. Review and restrict the X-Ray permissions to only what is necessary for the function's operation. While X-Ray actions often require wildcard resources, ensure the policy follows least privilege principles

**Effort:** Low  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-002  
**Business Impact:** Potential for privilege escalation and exploitation of compromised credentials across AWS services

### 2. Scope down OpenSearch Serverless permissions to only the specific collections needed and only the specific actions required by the function

**Effort:** Medium  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-003  
**Business Impact:** Unauthorized access to sensitive data in OpenSearch collections, potential for data exfiltration or tampering

### 3. Enhance logging by implementing structured logging with AWS Lambda Powertools or similar frameworks, ensure all administrative actions are logged, and consider implementing centralized log management

**Effort:** Medium  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-005  
**Business Impact:** Inability to effectively investigate security incidents, potential compliance violations regarding audit trails

### 3. Use customer-managed KMS keys (CMK) for encryption by setting AWSOwnedKey to false and providing a KMS key ARN

**Effort:** Medium  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-006  
**Business Impact:** Reduced security control over encryption keys, inability to immediately revoke key access in case of compromise, and potential compliance issues for sensitive data

### 3. Configure a Dead Letter Queue (SQS or SNS) for each Lambda function to capture failed executions and implement proper error handling and recovery mechanisms

**Effort:** Low  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-007  
**Business Impact:** Potential service disruptions, loss of operations data, and inability to diagnose and recover from failures

### 3. Restrict bedrock:InvokeModel permissions to only the specific models needed by specifying exact model ARNs rather than using wildcards

**Effort:** Low  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-008  
**Business Impact:** Potential abuse of foundation model access, increased costs, and possible regulatory or compliance issues depending on model outputs

### 4. Set Lambda function timeout to the minimum required duration for its operation, typically starting with 30 seconds and increasing only if needed based on observed execution times

**Effort:** Low  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-009  
**Business Impact:** Increased resource consumption, higher AWS costs, and extended time window for potential exploitation

### 4. Implement mechanisms to ensure only one ingestion job runs at a time, such as using DynamoDB for distributed locking or implementing state checks before starting new jobs

**Effort:** Medium  
**Related Threats:** BEDROCK-KNOWLEDGE-BASE-THREAT-010  
**Business Impact:** Potential service disruption, increased API rate limiting, and higher costs due to concurrent resource usage



## Detailed Threat Analysis

## High Severity Threats

### BEDROCK-KNOWLEDGE-BASE-THREAT-001: Overly Permissive IAM Role Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has overly broad S3 permissions (s3:PutObject*, s3:GetObject*, s3:DeleteObject*) on all S3 buckets (arn:aws:s3:::*)

#### Attack Vector
An attacker who compromises the Lambda function could access or modify data in any S3 bucket in the account, beyond what's needed for the function's operation

#### Potential Impact
Unauthorized access to sensitive data across all S3 buckets in the account, potential data exfiltration or corruption

#### Remediation
Scope S3 permissions to only the specific buckets required for function operation. Replace 'arn:aws:s3:::*' with specific bucket ARNs needed by the Lambda function

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCK-KNOWLEDGE-BASE-THREAT-002: Wildcard Resource Permissions for AWS X-Ray

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The X-Ray permissions in the OpenSearchLambdaExecutionRole policy use a wildcard resource ('*') which grants excessive permissions

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these permissions to gain broader access to AWS resources or perform reconnaissance activities

#### Potential Impact
Potential for privilege escalation and exploitation of compromised credentials across AWS services

#### Remediation
Review and restrict the X-Ray permissions to only what is necessary for the function's operation. While X-Ray actions often require wildcard resources, ensure the policy follows least privilege principles

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCK-KNOWLEDGE-BASE-THREAT-003: Excessive OpenSearch Serverless Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has broad permissions on OpenSearch Serverless APIs with wildcard resources, exceeding what's likely needed for index management

#### Attack Vector
An attacker who compromises the Lambda function could manipulate or access any OpenSearch Serverless collection in the account

#### Potential Impact
Unauthorized access to sensitive data in OpenSearch collections, potential for data exfiltration or tampering

#### Remediation
Scope down OpenSearch Serverless permissions to only the specific collections needed and only the specific actions required by the function

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCK-KNOWLEDGE-BASE-THREAT-004: OpenSearch Serverless Dashboard Publicly Accessible

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OSSNetworkPolicy` (AWS::OpenSearchServerless::SecurityPolicy)  
**CWE ID:** CWE-284

#### Issue
The OpenSearch Serverless network policy is configured with 'AllowFromPublic: true', making the dashboard publicly accessible from the internet

#### Attack Vector
Anyone on the internet can access the OpenSearch dashboard, which could expose sensitive data or administrative interfaces if authentication is compromised

#### Potential Impact
Potential unauthorized access to sensitive data, increased attack surface, and violation of security best practices for internal analytics services

#### Remediation
Set 'AllowFromPublic: false' and implement more restrictive access controls such as VPC endpoints, IP-based restrictions, or IAM-based access

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/security-iam-serverless.html

---

## Medium Severity Threats

### BEDROCK-KNOWLEDGE-BASE-THREAT-005: Insufficient Logging Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `GetAdjustedStackNameFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
Lambda functions have minimal logging configuration and don't implement comprehensive audit trails for actions performed by the functions

#### Attack Vector
If a security incident occurs, there may be insufficient logs to identify the source, nature, and impact of the incident

#### Potential Impact
Inability to effectively investigate security incidents, potential compliance violations regarding audit trails

#### Remediation
Enhance logging by implementing structured logging with AWS Lambda Powertools or similar frameworks, ensure all administrative actions are logged, and consider implementing centralized log management

**References:**
- https://docs.aws.amazon.com/prescriptive-guidance/latest/lambda-powertools/introduction.html

---

### BEDROCK-KNOWLEDGE-BASE-THREAT-006: Default AWS Owned Encryption Key for OpenSearch Collection

**STRIDE Category:** Tampering  
**Affected Resource:** `OSSCollection` (AWS::OpenSearchServerless::Collection)  
**CWE ID:** CWE-311

#### Issue
The OpenSearch Serverless collection uses AWS-owned keys (AWSOwnedKey: true) rather than customer-managed keys for encryption

#### Attack Vector
If AWS account credentials are compromised, the attacker would have access to both the data and the encryption keys

#### Potential Impact
Reduced security control over encryption keys, inability to immediately revoke key access in case of compromise, and potential compliance issues for sensitive data

#### Remediation
Use customer-managed KMS keys (CMK) for encryption by setting AWSOwnedKey to false and providing a KMS key ARN

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/encryption-at-rest.html

---

### BEDROCK-KNOWLEDGE-BASE-THREAT-007: Missing Dead Letter Queue for Lambda Functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `CreateOSSIndexLambdaFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-755

#### Issue
Lambda functions lack Dead Letter Queue (DLQ) configuration for handling failed function executions

#### Attack Vector
In case of function failures, especially during critical operations like index creation, there is no mechanism to capture and recover from these failures

#### Potential Impact
Potential service disruptions, loss of operations data, and inability to diagnose and recover from failures

#### Remediation
Configure a Dead Letter Queue (SQS or SNS) for each Lambda function to capture failed executions and implement proper error handling and recovery mechanisms

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html#dlq

---

### BEDROCK-KNOWLEDGE-BASE-THREAT-008: Broad BedrockInvokeModel Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `KnowledgeBaseServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The KnowledgeBaseServiceRole has permissions to invoke any foundation model in Bedrock (bedrock:InvokeModel on arn:aws:bedrock:${AWS::Region}::foundation-model/*)

#### Attack Vector
If compromised, an attacker could potentially use any Bedrock model, including those with more capabilities or higher costs than required for the application

#### Potential Impact
Potential abuse of foundation model access, increased costs, and possible regulatory or compliance issues depending on model outputs

#### Remediation
Restrict bedrock:InvokeModel permissions to only the specific models needed by specifying exact model ARNs rather than using wildcards

**References:**
- https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazonbedrock.html

---

## Low Severity Threats

### BEDROCK-KNOWLEDGE-BASE-THREAT-009: Excessive Lambda Function Timeout

**STRIDE Category:** Tampering  
**Affected Resource:** `StartIngestionJobFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-770

#### Issue
The StartIngestionJobFunction has a timeout of 600 seconds (10 minutes), which is significantly higher than likely needed for its task

#### Attack Vector
A compromised function could run for an extended period, potentially allowing an attacker more time to execute malicious activities or cause denial of service by consuming resources

#### Potential Impact
Increased resource consumption, higher AWS costs, and extended time window for potential exploitation

#### Remediation
Set Lambda function timeout to the minimum required duration for its operation, typically starting with 30 seconds and increasing only if needed based on observed execution times

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html

---

### BEDROCK-KNOWLEDGE-BASE-THREAT-010: Missing Concurrency Controls for Scheduled Jobs

**STRIDE Category:** Denial of Service  
**Affected Resource:** `S3DataSourceScheduler` (AWS::Scheduler::Schedule)  
**CWE ID:** CWE-770

#### Issue
The EventBridge schedulers for data sources lack concurrency controls, which could lead to multiple concurrent ingestion jobs being triggered

#### Attack Vector
If multiple ingestion jobs run concurrently, they could consume excessive resources, leading to throttling, increased costs, or service degradation

#### Potential Impact
Potential service disruption, increased API rate limiting, and higher costs due to concurrent resource usage

#### Remediation
Implement mechanisms to ensure only one ingestion job runs at a time, such as using DynamoDB for distributed locking or implementing state checks before starting new jobs

**References:**
- https://docs.aws.amazon.com/scheduler/latest/UserGuide/schedule-types.html#rate-based

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-1-.aws-sam-build-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-59  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **1** low severity findings.

## Priority Actions

### 1. Implement content filtering to remove sensitive information before sending to Bedrock models. Restrict Bedrock model access to specific approved models only. Consider implementing PII detection and redaction before summarization.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-006  
**Business Impact:** Exposure of confidential business information, PII, or regulated data to external AI services, potentially violating compliance requirements and data privacy regulations.

### 1. Apply the principle of least privilege by restricting permissions to only those operations needed (likely Get, Query, Scan, and potentially PutItem). Remove unnecessary DeleteItem, DeleteTable permissions.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-007  
**Business Impact:** Potential data loss, workflow disruption, and inability to process documents properly if DynamoDB records are deleted.

### 2. Configure log export to S3 or other centralized log storage solution for all log groups. Consider using CloudWatch Logs Subscription Filters to send logs to a central account or SIEM solution.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-001  
**Business Impact:** Limited ability to perform post-incident forensic analysis and potential compliance violations for log retention requirements.

### 2. Implement more restrictive IAM policies following the principle of least privilege. Limit S3 permissions to specific prefixes and operations needed, and restrict DynamoDB actions to only those required for function operation.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-003  
**Business Impact:** Potential unauthorized access to data in S3 buckets and DynamoDB tables, allowing data theft or tampering.

### 2. Implement integrity checks like checksums or digital signatures at each processing stage to verify documents haven't been modified. Store these checksums in a secured DynamoDB table.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-004  
**Business Impact:** Compromised data integrity leading to incorrect document processing results and potentially biased or malicious output.

### 3. Implement a mechanism to export and archive state machine execution histories to a long-term storage solution like S3 with appropriate lifecycle policies.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-002  
**Business Impact:** Limited ability to audit historical state machine executions for security incidents beyond the default retention period.

### 3. Configure reserved concurrency limits for critical Lambda functions to ensure they have dedicated resources. Implement throttling or rate limiting at the API level.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-005  
**Business Impact:** Service disruption affecting document processing capabilities and potentially other Lambda functions in the same AWS account.

### 3. Add additional event pattern matching criteria to verify the source identity, such as account-specific fields or additional detail attributes that would be difficult to spoof.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-008  
**Business Impact:** Processing of fraudulent events, potentially leading to incorrect document processing or HITL workflow manipulation.

### 3. Enable CloudWatch Contributor Insights for the DynamoDB table to track access patterns. Consider implementing advanced features like DynamoDB streams with Lambda to log changes to a secure audit log.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-010  
**Business Impact:** Reduced ability to perform forensic analysis and detect unusual access patterns, potentially allowing malicious activity to go undetected.

### 4. Implement an SQS access policy that restricts who can receive, delete, or purge messages from the queue. Consider implementing notification on message arrival to alert operations teams.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-009  
**Business Impact:** Loss of failed execution data that could be important for troubleshooting or security analysis.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-006: Potential Sensitive Data Exposure via Bedrock Models

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-200

#### Issue
The SummarizationFunction has permissions to invoke any Bedrock foundation model and might send sensitive document contents to external AI models without proper data filtering.

#### Attack Vector
Sensitive or confidential information in processed documents could be sent to foundation models, potentially leading to data leakage or exposure.

#### Potential Impact
Exposure of confidential business information, PII, or regulated data to external AI services, potentially violating compliance requirements and data privacy regulations.

#### Remediation
Implement content filtering to remove sensitive information before sending to Bedrock models. Restrict Bedrock model access to specific approved models only. Consider implementing PII detection and redaction before summarization.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-data.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-007: Overly Permissive DynamoDB Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `HITLProcessLambdaRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The HITLProcessLambdaRole has broad permissions on DynamoDB tables, including Delete operations that may not be necessary for its function.

#### Attack Vector
If compromised, an attacker could delete records from the DynamoDB tables, causing data loss or disrupting the document processing workflow.

#### Potential Impact
Potential data loss, workflow disruption, and inability to process documents properly if DynamoDB records are deleted.

#### Remediation
Apply the principle of least privilege by restricting permissions to only those operations needed (likely Get, Query, Scan, and potentially PutItem). Remove unnecessary DeleteItem, DeleteTable permissions.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/specifying-conditions.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-001: Log Groups Not Configured with Log Export

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All LogGroups` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-778

#### Issue
Log groups are properly encrypted but not configured to export logs to a centralized location for long-term retention and security analysis.

#### Attack Vector
After a security incident, logs may not be available for forensic analysis if they remain only in CloudWatch and not exported to a durable location.

#### Potential Impact
Limited ability to perform post-incident forensic analysis and potential compliance violations for log retention requirements.

#### Remediation
Configure log export to S3 or other centralized log storage solution for all log groups. Consider using CloudWatch Logs Subscription Filters to send logs to a central account or SIEM solution.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/S3Export.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-002: Limited State Machine Execution History

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::StepFunctions::StateMachine)  
**CWE ID:** CWE-223

#### Issue
While the state machine has logging configured, there's no configuration for extended retention of execution history beyond the default period.

#### Attack Vector
Attackers could perform malicious actions and, after the default retention period, evidence of these actions would be purged.

#### Potential Impact
Limited ability to audit historical state machine executions for security incidents beyond the default retention period.

#### Remediation
Implement a mechanism to export and archive state machine execution histories to a long-term storage solution like S3 with appropriate lifecycle policies.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cw-logs.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-003: Lambda Functions with Broad Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `InvokeBDAFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
Several Lambda functions have broad permissions for S3 buckets (S3CrudPolicy) and DynamoDB tables, which could allow for privilege escalation if the function is compromised.

#### Attack Vector
If a function is compromised (e.g., through dependency injection or code execution), an attacker could leverage the broad permissions to access or modify data they shouldn't have access to.

#### Potential Impact
Potential unauthorized access to data in S3 buckets and DynamoDB tables, allowing data theft or tampering.

#### Remediation
Implement more restrictive IAM policies following the principle of least privilege. Limit S3 permissions to specific prefixes and operations needed, and restrict DynamoDB actions to only those required for function operation.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/lambda-permissions.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-004: Potential Data Integrity Risk in Document Processing Workflow

**STRIDE Category:** Tampering  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-345

#### Issue
The state machine handles document processing but lacks integrity verification steps to ensure documents haven't been tampered with between processing stages.

#### Attack Vector
An attacker with access to the S3 bucket could modify documents between processing steps, potentially affecting analysis results.

#### Potential Impact
Compromised data integrity leading to incorrect document processing results and potentially biased or malicious output.

#### Remediation
Implement integrity checks like checksums or digital signatures at each processing stage to verify documents haven't been modified. Store these checksums in a secured DynamoDB table.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/checking-object-integrity.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-005: No Reserved Concurrency for Lambda Functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-400

#### Issue
Lambda functions don't have reserved concurrency configured, which could lead to resource exhaustion during high demand or potential DoS scenarios.

#### Attack Vector
An attacker could trigger numerous simultaneous requests, potentially exhausting the account's Lambda concurrency limit and affecting other systems.

#### Potential Impact
Service disruption affecting document processing capabilities and potentially other Lambda functions in the same AWS account.

#### Remediation
Configure reserved concurrency limits for critical Lambda functions to ensure they have dedicated resources. Implement throttling or rate limiting at the API level.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-008: Missing Source Identity Verification for EventBridge Rules

**STRIDE Category:** Spoofing  
**Affected Resource:** `HITLEventRule, BDAEventRule` (AWS::Events::Rule)  
**CWE ID:** CWE-290

#### Issue
EventBridge rules for HITL and BDA events don't verify the source identity beyond the source field, which could allow spoofed events.

#### Attack Vector
An attacker with appropriate permissions could potentially spoof events that match the pattern to trigger Lambda functions with false information.

#### Potential Impact
Processing of fraudulent events, potentially leading to incorrect document processing or HITL workflow manipulation.

#### Remediation
Add additional event pattern matching criteria to verify the source identity, such as account-specific fields or additional detail attributes that would be difficult to spoof.

**References:**
- https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-event-patterns.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-010: Missing DynamoDB Contributor Insights

**STRIDE Category:** Repudiation  
**Affected Resource:** `BDAMetadataTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-778

#### Issue
The BDAMetadataTable doesn't have CloudWatch Contributor Insights enabled, making it difficult to track who made what changes to data.

#### Attack Vector
An attacker could modify data in the table, and it would be difficult to trace back to specific principals or identify unusual access patterns.

#### Potential Impact
Reduced ability to perform forensic analysis and detect unusual access patterns, potentially allowing malicious activity to go undetected.

#### Remediation
Enable CloudWatch Contributor Insights for the DynamoDB table to track access patterns. Consider implementing advanced features like DynamoDB streams with Lambda to log changes to a secure audit log.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/contributorinsights.html

---

## Low Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-009: Dead Letter Queue Without Access Policy

**STRIDE Category:** Tampering  
**Affected Resource:** `BDACompletionFunctionDLQ` (AWS::SQS::Queue)  
**CWE ID:** CWE-284

#### Issue
The BDACompletionFunctionDLQ has encryption but no explicit access policy to restrict who can receive or delete messages from the queue.

#### Attack Vector
An attacker with appropriate IAM permissions could purge or consume messages from the DLQ, potentially hiding failed execution evidence.

#### Potential Impact
Loss of failed execution data that could be important for troubleshooting or security analysis.

#### Remediation
Implement an SQS access policy that restricts who can receive, delete, or purge messages from the queue. Consider implementing notification on message arrival to alert operations teams.

**References:**
- https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-authentication-and-access-control.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-1-.aws-sam-packaged


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-55  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **1** low severity findings.

## Priority Actions

### 1. Implement strict input validation and sanitization for all document content before sending to LLMs. Use guardrails and implement prompt engineering best practices to reduce the risk of injection attacks.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-THREAT-007  
**Business Impact:** Successful prompt injection could lead to data leakage, incorrect document processing, or manipulation of the document classification/extraction process.

### 1. Make guardrails mandatory for production deployments. Implement a default guardrail with appropriate security controls if custom guardrails aren't specified.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-009  
**Business Impact:** Potential data leakage, PII exposure, or manipulation of the document processing workflow through crafted inputs.

### 2. Review the log queries in the dashboard to ensure they filter out sensitive information. Consider implementing log field redaction for sensitive data using CloudWatch Logs pattern filtering.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-002  
**Business Impact:** Unauthorized exposure of document contents or metadata to users with dashboard access but who shouldn't have access to document content.

### 2. Restrict S3 access to specific prefixes or paths that the function needs, rather than granting access to the entire bucket. Use more specific resource ARNs in the IAM policy.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-THREAT-003  
**Business Impact:** Unauthorized access to sensitive documents stored in S3 buckets, violating the principle of least privilege.

### 2. Add CloudWatch Alarms for critical metrics such as error rates, duration, throttling events, and invocation counts. Configure alerting to notify operations personnel of potential issues.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-005  
**Business Impact:** Delayed detection of attacks or failures in the document processing workflow, potentially allowing data loss or corruption without timely intervention.

### 2. Implement DynamoDB condition expressions in application code to ensure proper version checking. Consider implementing a change history mechanism for critical metadata changes.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-006  
**Business Impact:** Data integrity issues in the metadata table could lead to incorrect processing of documents, bypassing controls, or manipulation of processing results.

### 2. Implement client-side throttling, backoff mechanisms, and concurrency controls for Bedrock API calls. Consider implementing a queue-based architecture to smooth out request spikes.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-008  
**Business Impact:** Service degradation or outage of document processing capabilities, leading to business process disruption and potential SLA violations.

### 2. Implement comprehensive input validation for all incoming documents, including file type validation, size limits, content scanning, and structural validation before processing.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-010  
**Business Impact:** Potential for code injection, system crashes, or other unexpected behaviors in the document processing pipeline.

### 3. Consider reducing the logging level to ERROR or other appropriate level for production use. Set 'IncludeExecutionData' to false unless the full execution data is required for debugging.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-THREAT-001  
**Business Impact:** Potential exposure of sensitive information contained in processed documents to anyone with CloudWatch logs access permissions.

### 3. Add a Dead Letter Queue (SQS or SNS) to capture failed invocations and enable proper handling of failed document processing attempts.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-THREAT-004  
**Business Impact:** Failed processing events would be lost without notification, potentially leading to documents being stalled in processing pipelines and business process disruption.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-THREAT-007: Potential LLM Prompt Injection Risk

**STRIDE Category:** Spoofing  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-74

#### Issue
The ProcessResultsFunction appears to process input documents and send them to LLMs via Bedrock. Without proper input sanitization, this creates a risk of prompt injection attacks where malicious content in documents could manipulate the LLM behavior.

#### Attack Vector
An attacker could submit documents with specially crafted content that overrides or manipulates prompt instructions, potentially causing the LLM to execute unwanted actions or expose information.

#### Potential Impact
Successful prompt injection could lead to data leakage, incorrect document processing, or manipulation of the document classification/extraction process.

#### Remediation
Implement strict input validation and sanitization for all document content before sending to LLMs. Use guardrails and implement prompt engineering best practices to reduce the risk of injection attacks.

**References:**
- https://owasp.org/www-project-top-10-for-large-language-model-applications/

---

### AWS-GENAI-IDP-THREAT-009: Optional Guardrail Configuration for LLM Interactions

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-284

#### Issue
The BedrockGuardrailId and BedrockGuardrailVersion parameters are optional, allowing deployment without guardrails for LLM interactions. This could lead to data leakage or other LLM vulnerabilities if not properly configured.

#### Attack Vector
Without guardrails, an attacker could craft documents with content designed to extract information, bypass restrictions, or cause other unintended behaviors from the LLM.

#### Potential Impact
Potential data leakage, PII exposure, or manipulation of the document processing workflow through crafted inputs.

#### Remediation
Make guardrails mandatory for production deployments. Implement a default guardrail with appropriate security controls if custom guardrails aren't specified.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-THREAT-002: Potential Sensitive Data Exposure in CloudWatch Dashboards

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-209

#### Issue
The CloudWatch dashboard includes log widgets that display error messages and request data. These logs might contain sensitive information from processed documents that could be visible to anyone with dashboard access.

#### Attack Vector
An attacker with access to the CloudWatch dashboard could view potentially sensitive document information in error logs or request data.

#### Potential Impact
Unauthorized exposure of document contents or metadata to users with dashboard access but who shouldn't have access to document content.

#### Remediation
Review the log queries in the dashboard to ensure they filter out sensitive information. Consider implementing log field redaction for sensitive data using CloudWatch Logs pattern filtering.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---

### AWS-GENAI-IDP-THREAT-003: Overly Permissive S3 Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `HITLProcessLambdaRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The HITLProcessLambdaRole has GetObject permissions on the entire input and working buckets, which may provide excessive access beyond what's needed for the specific function.

#### Attack Vector
If the Lambda function is compromised, an attacker could access all objects in the input and working buckets, potentially exposing sensitive documents beyond the scope of what the function needs.

#### Potential Impact
Unauthorized access to sensitive documents stored in S3 buckets, violating the principle of least privilege.

#### Remediation
Restrict S3 access to specific prefixes or paths that the function needs, rather than granting access to the entire bucket. Use more specific resource ARNs in the IAM policy.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### AWS-GENAI-IDP-THREAT-004: Missing Dead Letter Queue for Lambda Function

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `HITLStatusUpdateFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-755

#### Issue
The HITLStatusUpdateFunction does not have a Dead Letter Queue configured, which could lead to silent failures and loss of document processing events.

#### Attack Vector
Not a direct attack vector, but could be exploited as part of a denial of service attack if an attacker can cause the function to fail repeatedly.

#### Potential Impact
Failed processing events would be lost without notification, potentially leading to documents being stalled in processing pipelines and business process disruption.

#### Remediation
Add a Dead Letter Queue (SQS or SNS) to capture failed invocations and enable proper handling of failed document processing attempts.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html#dlq

---

### AWS-GENAI-IDP-THREAT-005: Insufficient Monitoring for Critical Document Processing Function

**STRIDE Category:** Repudiation  
**Affected Resource:** `InvokeBDAFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
While logging is configured, there are no specific CloudWatch Alarms or monitoring for error rates, throttling, or critical failures in this core document processing function.

#### Attack Vector
Attacks targeting the document processing pipeline might go undetected for extended periods without proper monitoring and alerting.

#### Potential Impact
Delayed detection of attacks or failures in the document processing workflow, potentially allowing data loss or corruption without timely intervention.

#### Remediation
Add CloudWatch Alarms for critical metrics such as error rates, duration, throttling events, and invocation counts. Configure alerting to notify operations personnel of potential issues.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html

---

### AWS-GENAI-IDP-THREAT-006: Missing Condition Checks for DynamoDB Operations

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAMetadataTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-367

#### Issue
The functions that interact with BDAMetadataTable have full CRUD permissions without conditional checks or version controls, which could allow for unintended modifications or race conditions.

#### Attack Vector
An attacker who compromises a Lambda function could modify metadata records without proper validation, potentially manipulating the document processing flow.

#### Potential Impact
Data integrity issues in the metadata table could lead to incorrect processing of documents, bypassing controls, or manipulation of processing results.

#### Remediation
Implement DynamoDB condition expressions in application code to ensure proper version checking. Consider implementing a change history mechanism for critical metadata changes.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ConditionExpressions.html

---

### AWS-GENAI-IDP-THREAT-008: Missing Throttling Controls for Bedrock API Calls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
The SummarizationFunction makes calls to Bedrock APIs without explicit throttling or rate limiting, potentially leading to API throttling and service disruption during high load scenarios.

#### Attack Vector
An attacker could flood the system with document processing requests, causing Bedrock API throttling and disrupting the entire document processing pipeline.

#### Potential Impact
Service degradation or outage of document processing capabilities, leading to business process disruption and potential SLA violations.

#### Remediation
Implement client-side throttling, backoff mechanisms, and concurrency controls for Bedrock API calls. Consider implementing a queue-based architecture to smooth out request spikes.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/quotas.html

---

### AWS-GENAI-IDP-THREAT-010: Missing Input Validation for Document Processing

**STRIDE Category:** Tampering  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
The template doesn't show explicit input validation mechanisms for documents being processed, potentially allowing malformed or malicious documents to be processed by the system.

#### Attack Vector
An attacker could submit specially crafted documents designed to exploit vulnerabilities in the document processing pipeline or downstream systems.

#### Potential Impact
Potential for code injection, system crashes, or other unexpected behaviors in the document processing pipeline.

#### Remediation
Implement comprehensive input validation for all incoming documents, including file type validation, size limits, content scanning, and structural validation before processing.

**References:**
- https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html

---

## Low Severity Threats

### AWS-GENAI-IDP-THREAT-001: Excessive Logging for State Machine Executions

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-532

#### Issue
The State Machine is configured with 'IncludeExecutionData' set to true and 'Level' set to ALL. This may log sensitive document data processed by the workflow, potentially exposing confidential information in CloudWatch logs.

#### Attack Vector
An attacker with access to CloudWatch logs could view sensitive document data that was processed through the state machine.

#### Potential Impact
Potential exposure of sensitive information contained in processed documents to anyone with CloudWatch logs access permissions.

#### Remediation
Consider reducing the logging level to ERROR or other appropriate level for production use. Set 'IncludeExecutionData' to false unless the full execution data is required for debugging.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-logs.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-1-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-54  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **8** medium, and **0** low severity findings.

## Priority Actions

### 2. Use AWS Secrets Manager or Parameter Store for sensitive values instead of environment variables. Enable AWS Lambda environment variable encryption. Review logging practices to ensure environment variables are not being logged.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-001  
**Business Impact:** Potential exposure of configuration values or other sensitive information that could be used to further compromise the system.

### 2. Scope down the CloudWatch PutMetricData permissions to specific metric namespaces used by the function, rather than using a wildcard resource.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-002  
**Business Impact:** Potential for metric manipulation, misleading monitoring data, and possible denial of service through metric flooding.

### 2. Set 'IncludeExecutionData: false' unless full execution data logging is specifically required. Implement data filtering to redact sensitive information before it's passed between states.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-004  
**Business Impact:** Exposure of potentially sensitive document data, including any personally identifiable information (PII) that might be contained in processed documents.

### 2. Restrict S3 write permissions to specific prefixes or paths within the bucket that the function actually needs to access. Consider using dynamic policy conditions to limit access based on request context.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-006  
**Business Impact:** Data integrity issues, potential for serving malicious content to downstream consumers, or overwriting legitimate processing results.

### 2. Add input validation as the first step in the state machine workflow. Implement schema validation for all inputs and between state transitions. Consider implementing a 'validator' Lambda function at the beginning of the workflow.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-008  
**Business Impact:** Processing inconsistencies, potential for injection attacks in downstream systems, or workflow errors leading to service disruption.

### 2. Implement source validation for all inputs. Add input sanitization before sending to Bedrock models. Consider restricting Bedrock permissions to specific model IDs rather than using wildcards. Implement guardrails for all model interactions.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-009  
**Business Impact:** Potential for prompt injection attacks, model manipulation, or generation of harmful content through the AI processing pipeline.

### 3. Consider implementing provisioned capacity with auto-scaling for more predictable performance. Set up CloudWatch alarms to detect and respond to unusual traffic patterns.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-003  
**Business Impact:** Service disruption, performance degradation, or unexpectedly high AWS costs.

### 3. Implement a dead letter queue monitoring and cleanup process. Consider implementing message sanitization before messages are sent to the DLQ. Set up alerts for messages arriving in the DLQ to ensure they are promptly addressed.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-005  
**Business Impact:** Potential exposure of document contents, extracted data, or system configuration information.

### 3. Configure reserved or provisioned concurrency for critical Lambda functions. Implement throttling at the API level. Set up monitoring and alerts for unusual invocation patterns.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-007  
**Business Impact:** Service disruption for other Lambda functions in the account, processing delays, and potential failure of document processing workflows.

### 3. Enhance logging for HITL processes to capture reviewer identity, timestamp, and specific changes made. Consider implementing approval workflows for sensitive documents or changes above certain thresholds.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-010  
**Business Impact:** Inability to fully audit human review actions, potential compliance issues for regulated industries, and difficulty investigating security incidents.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-002: Overly Permissive CloudWatch PutMetricData Permission

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `InvokeBDAFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
The InvokeBDAFunction has permission to call cloudwatch:PutMetricData on all resources ('*'), which grants broader permissions than necessary. This violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could use these permissions to create misleading metrics or potentially cause CloudWatch throttling issues.

#### Potential Impact
Potential for metric manipulation, misleading monitoring data, and possible denial of service through metric flooding.

#### Remediation
Scope down the CloudWatch PutMetricData permissions to specific metric namespaces used by the function, rather than using a wildcard resource.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/iam-access-control-overview-cw.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-006: Overly Permissive S3 Write Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `HITLProcessLambdaRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
HITLProcessLambdaRole has broad write permissions (s3:PutObject) to the entire output bucket, allowing it to write to any location within the bucket.

#### Attack Vector
If the Lambda function is compromised, an attacker could overwrite existing files or add malicious content to the output bucket.

#### Potential Impact
Data integrity issues, potential for serving malicious content to downstream consumers, or overwriting legitimate processing results.

#### Remediation
Restrict S3 write permissions to specific prefixes or paths within the bucket that the function actually needs to access. Consider using dynamic policy conditions to limit access based on request context.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-001: Environment Variables May Contain Sensitive Information

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Lambda::Function)  
**CWE ID:** CWE-527

#### Issue
Lambda functions contain environment variables that could potentially store sensitive information. While there's no evidence of secrets in the current environment variables, they could be added in the future and might be exposed through function configuration or logs.

#### Attack Vector
An attacker with Lambda read permissions could view environment variables. Additionally, if logging is verbose, environment variables might be inadvertently logged.

#### Potential Impact
Potential exposure of configuration values or other sensitive information that could be used to further compromise the system.

#### Remediation
Use AWS Secrets Manager or Parameter Store for sensitive values instead of environment variables. Enable AWS Lambda environment variable encryption. Review logging practices to ensure environment variables are not being logged.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html#configuration-envvars-encryption

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-003: DynamoDB Table Missing Auto-Scaling Configuration

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAMetadataTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-400

#### Issue
The BDAMetadataTable is using PAY_PER_REQUEST billing mode without any capacity planning or auto-scaling configuration. This could lead to throttling during high demand or unexpected costs.

#### Attack Vector
An attacker could potentially cause a denial of service or excessive billing by generating high volumes of requests to the table.

#### Potential Impact
Service disruption, performance degradation, or unexpectedly high AWS costs.

#### Remediation
Consider implementing provisioned capacity with auto-scaling for more predictable performance. Set up CloudWatch alarms to detect and respond to unusual traffic patterns.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/AutoScaling.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-004: State Machine Logging Exposes Execution Data

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-532

#### Issue
The DocumentProcessingStateMachine has logging configured with 'IncludeExecutionData: true', which means all input and output data for each state transition is logged. This could potentially include sensitive information processed by the workflow.

#### Attack Vector
An attacker with access to CloudWatch logs could extract sensitive information from document processing tasks.

#### Potential Impact
Exposure of potentially sensitive document data, including any personally identifiable information (PII) that might be contained in processed documents.

#### Remediation
Set 'IncludeExecutionData: false' unless full execution data logging is specifically required. Implement data filtering to redact sensitive information before it's passed between states.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-logs.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-005: DLQ Messages Could Contain Sensitive Information

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `BDACompletionFunctionDLQ` (AWS::SQS::Queue)  
**CWE ID:** CWE-200

#### Issue
The BDACompletionFunctionDLQ may store failed messages that contain sensitive document processing information. If these messages aren't properly secured or monitored, they could lead to information disclosure.

#### Attack Vector
An attacker with SQS access could read failed processing messages containing sensitive document content or extraction results.

#### Potential Impact
Potential exposure of document contents, extracted data, or system configuration information.

#### Remediation
Implement a dead letter queue monitoring and cleanup process. Consider implementing message sanitization before messages are sent to the DLQ. Set up alerts for messages arriving in the DLQ to ensure they are promptly addressed.

**References:**
- https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-007: Missing Concurrency Controls on Lambda Functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
Lambda functions in this template don't have reserved or provisioned concurrency settings, which means they could consume all available account concurrency during high load or in case of recursive invocation.

#### Attack Vector
An attacker could trigger excessive function invocations, potentially exhausting the account's Lambda concurrency limit and affecting other functions.

#### Potential Impact
Service disruption for other Lambda functions in the account, processing delays, and potential failure of document processing workflows.

#### Remediation
Configure reserved or provisioned concurrency for critical Lambda functions. Implement throttling at the API level. Set up monitoring and alerts for unusual invocation patterns.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-008: State Machine Input Validation Missing

**STRIDE Category:** Tampering  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-20

#### Issue
The state machine doesn't appear to have explicit input validation, potentially allowing malformed or malicious inputs to flow through the workflow.

#### Attack Vector
An attacker could inject unexpected data formats or values that might be processed differently by different components, potentially causing unexpected behavior.

#### Potential Impact
Processing inconsistencies, potential for injection attacks in downstream systems, or workflow errors leading to service disruption.

#### Remediation
Add input validation as the first step in the state machine workflow. Implement schema validation for all inputs and between state transitions. Consider implementing a 'validator' Lambda function at the beginning of the workflow.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/concepts-input-output-filtering.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-009: Bedrock Model Access Without Source Validation

**STRIDE Category:** Spoofing  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-345

#### Issue
The SummarizationFunction has permissions to invoke any Bedrock model without restrictions, and there's no apparent validation of input sources before processing with AI models.

#### Attack Vector
An attacker who gains access to input channels could potentially submit manipulated documents or prompts designed to extract sensitive information or produce harmful outputs from AI models.

#### Potential Impact
Potential for prompt injection attacks, model manipulation, or generation of harmful content through the AI processing pipeline.

#### Remediation
Implement source validation for all inputs. Add input sanitization before sending to Bedrock models. Consider restricting Bedrock permissions to specific model IDs rather than using wildcards. Implement guardrails for all model interactions.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-iam.html

---

### AWS-GENAI-IDP-ACCELERATOR-RESOURCES-PATTERN1-THREAT-010: Incomplete Audit Trail for Human Review Actions

**STRIDE Category:** Repudiation  
**Affected Resource:** `HITLEventRule` (AWS::Events::Rule)  
**CWE ID:** CWE-778

#### Issue
The Human-In-The-Loop (HITL) process captures completion events but may not capture sufficient details about who performed the review and what specific changes they made.

#### Attack Vector
A malicious reviewer could make unauthorized changes to documents without sufficient traceability.

#### Potential Impact
Inability to fully audit human review actions, potential compliance issues for regulated industries, and difficulty investigating security incidents.

#### Remediation
Enhance logging for HITL processes to capture reviewer identity, timestamp, and specific changes made. Consider implementing approval workflows for sensitive documents or changes above certain thresholds.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/a2i-permissions-security.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-2-.aws-sam-build-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-22  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **6** medium, and **2** low severity findings.

## Priority Actions

### 1. Ensure the ConfigurationDefaultS3Uri points to a properly secured S3 bucket with appropriate access controls, encryption, and logging. Audit the configuration files to ensure they don't contain sensitive credentials or information.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-009  
**Business Impact:** Exposure of internal system design, prompt engineering, or other sensitive configurations that could facilitate further attacks.

### 1. Implement robust input validation and sanitization, utilize Bedrock guardrails more broadly across all LLM interactions, and add content filtering before sending data to LLM models.

**Effort:** High  
**Related Threats:** PATTERN2-THREAT-010  
**Business Impact:** Potential for data leakage, system manipulation, or generation of misleading or harmful content through the LLM.

### 2. Implement AWS Signer and Code Signing for Lambda functions to ensure code integrity during deployment.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-002  
**Business Impact:** Execution of unauthorized code leading to potential data exfiltration, resource misuse, or further system compromise.

### 2. Restrict the 'bedrock:InvokeModel' permission to only the specific models required by each function, rather than using the wildcard pattern for all foundation models.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-003  
**Business Impact:** Potential for cost escalation, unauthorized model use, and violation of least privilege principles.

### 2. While Textract does not support resource-level permissions for these actions, implement additional controls such as strict input validation and request origin verification within the Lambda function code.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-006  
**Business Impact:** Potential unauthorized access to document content from other sources, cost impact through excess API usage.

### 2. Set appropriate reserved and/or maximum concurrent execution limits for each Lambda function based on expected traffic patterns and criticality.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-008  
**Business Impact:** Potential service disruption, resource exhaustion, or unexpected billing charges from uncontrolled scaling.

### 3. Enable environment variable encryption for Lambda functions using the KmsKeyArn property, referencing the existing CustomerManagedEncryptionKeyArn.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-001  
**Business Impact:** Exposure of configuration details that could aid in further attacks or reveal implementation details.

### 3. Implement IAM permissions that restrict dashboard access to only authorized personnel and ensure log groups filter sensitive information before display in dashboards.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-004  
**Business Impact:** Unauthorized visibility into system operations, error patterns, and potentially sensitive data included in logs or metrics.

### 3. While CloudWatch does not support resource-level permissions for PutMetricData, implement additional controls like strict metric namespace prefixing in code and monitoring for unexpected metric publications.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-007  
**Business Impact:** Potential for metric pollution, false alarms, or masking of actual issues by publishing misleading operational data.

### 4. Enhance logging by adding additional context metadata and ensuring cross-reference capabilities with CloudTrail and other logging sources.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-005  
**Business Impact:** Limited ability to perform forensic analysis in case of a security incident or to detect unusual patterns of behavior.



## Detailed Threat Analysis

## High Severity Threats

### PATTERN2-THREAT-009: Potential Sensitive Data Exposure in Configuration Default Values

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UpdateDefaultConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-200

#### Issue
The UpdateDefaultConfig custom resource imports configuration from an S3 URI that could contain sensitive information such as prompts, API keys, or system configurations.

#### Attack Vector
An attacker with access to the configuration bucket could exfiltrate sensitive configuration data or modify it to influence system behavior.

#### Potential Impact
Exposure of internal system design, prompt engineering, or other sensitive configurations that could facilitate further attacks.

#### Remediation
Ensure the ConfigurationDefaultS3Uri points to a properly secured S3 bucket with appropriate access controls, encryption, and logging. Audit the configuration files to ensure they don't contain sensitive credentials or information.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html

---

### PATTERN2-THREAT-010: LLM Prompt Injection Risk in Model Interactions

**STRIDE Category:** Tampering  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-74

#### Issue
Functions that interact with Bedrock LLMs may be susceptible to prompt injection attacks if input validation is insufficient, as they process documents from potentially untrusted sources.

#### Attack Vector
An attacker could craft documents with content designed to manipulate the LLM prompts, potentially causing unexpected behavior, information leakage, or manipulated outputs.

#### Potential Impact
Potential for data leakage, system manipulation, or generation of misleading or harmful content through the LLM.

#### Remediation
Implement robust input validation and sanitization, utilize Bedrock guardrails more broadly across all LLM interactions, and add content filtering before sending data to LLM models.

**References:**
- https://owasp.org/www-project-top-10-for-large-language-model-applications/

---

## Medium Severity Threats

### PATTERN2-THREAT-002: Lambda Code Integrity Not Validated

**STRIDE Category:** Tampering  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-494

#### Issue
Lambda functions do not implement code signing or deployment validation, allowing potential code tampering during deployment.

#### Attack Vector
An attacker with appropriate IAM permissions could replace Lambda function code with malicious versions.

#### Potential Impact
Execution of unauthorized code leading to potential data exfiltration, resource misuse, or further system compromise.

#### Remediation
Implement AWS Signer and Code Signing for Lambda functions to ensure code integrity during deployment.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-codesigning.html

---

### PATTERN2-THREAT-003: Overly Permissive Bedrock Model Invocation Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction Policies, ExtractionFunction Policies, ClassificationFunction Policies` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
Lambda functions have permissions to invoke any foundation model in Bedrock with 'bedrock:InvokeModel' on 'arn:aws:bedrock:*::foundation-model/*' which is broader than necessary.

#### Attack Vector
If a Lambda function is compromised, an attacker could leverage these broad permissions to access models they shouldn't, potentially causing unexpected costs or accessing sensitive capabilities.

#### Potential Impact
Potential for cost escalation, unauthorized model use, and violation of least privilege principles.

#### Remediation
Restrict the 'bedrock:InvokeModel' permission to only the specific models required by each function, rather than using the wildcard pattern for all foundation models.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_service-with-iam.html

---

### PATTERN2-THREAT-004: CloudWatch Dashboard Could Expose Sensitive Operational Data

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-200

#### Issue
The CloudWatch Dashboard may display operational metrics and logs that contain sensitive information without access controls explicitly defined.

#### Attack Vector
Users with CloudWatch dashboard access could view potentially sensitive operational data or error messages that might reveal implementation details.

#### Potential Impact
Unauthorized visibility into system operations, error patterns, and potentially sensitive data included in logs or metrics.

#### Remediation
Implement IAM permissions that restrict dashboard access to only authorized personnel and ensure log groups filter sensitive information before display in dashboards.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards_Permissions_Admin.html

---

### PATTERN2-THREAT-006: Overly Broad Textract API Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction Policies` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has permissions to call textract:DetectDocumentText and textract:AnalyzeDocument on all resources ('*') which violates least privilege principle.

#### Attack Vector
If the Lambda function is compromised, an attacker could use these permissions to analyze documents from any source within AWS Textract.

#### Potential Impact
Potential unauthorized access to document content from other sources, cost impact through excess API usage.

#### Remediation
While Textract does not support resource-level permissions for these actions, implement additional controls such as strict input validation and request origin verification within the Lambda function code.

**References:**
- https://docs.aws.amazon.com/textract/latest/dg/security_iam_service-with-iam.html

---

### PATTERN2-THREAT-007: CloudWatch PutMetricData Permission Without Resource Constraints

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `Multiple Lambda Function Policies` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
Multiple Lambda functions have the ability to put metrics to any CloudWatch namespace with 'cloudwatch:PutMetricData' on resource '*'.

#### Attack Vector
If compromised, a Lambda function could be used to publish misleading metrics to any CloudWatch namespace, potentially triggering automated responses or confusing monitoring systems.

#### Potential Impact
Potential for metric pollution, false alarms, or masking of actual issues by publishing misleading operational data.

#### Remediation
While CloudWatch does not support resource-level permissions for PutMetricData, implement additional controls like strict metric namespace prefixing in code and monitoring for unexpected metric publications.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/iam-cw-condition-keys-namespace.html

---

### PATTERN2-THREAT-008: Missing Concurrent Execution Limits on Lambda Functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-400

#### Issue
Lambda functions do not have reserved or maximum concurrent execution limits defined, which could lead to resource exhaustion or unexpected scaling behavior.

#### Attack Vector
A flood of requests, either malicious or legitimate, could cause functions to scale excessively, potentially impacting other systems or incurring unexpected costs.

#### Potential Impact
Potential service disruption, resource exhaustion, or unexpected billing charges from uncontrolled scaling.

#### Remediation
Set appropriate reserved and/or maximum concurrent execution limits for each Lambda function based on expected traffic patterns and criticality.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

## Low Severity Threats

### PATTERN2-THREAT-001: Lambda Function Environment Variables Not Encrypted

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-256

#### Issue
Lambda function environment variables are not explicitly encrypted with AWS KMS, potentially exposing sensitive configuration information if function details are accessible.

#### Attack Vector
An attacker with permissions to view Lambda function configuration could view environment variables that might contain sensitive configuration data.

#### Potential Impact
Exposure of configuration details that could aid in further attacks or reveal implementation details.

#### Remediation
Enable environment variable encryption for Lambda functions using the KmsKeyArn property, referencing the existing CustomerManagedEncryptionKeyArn.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html#configuration-envvars-encryption

---

### PATTERN2-THREAT-005: State Machine Logging Could Be More Comprehensive

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-778

#### Issue
While the state machine has logging enabled with 'Level: ALL', it may not be capturing full context for security auditing purposes.

#### Attack Vector
An attacker performing malicious actions might not be fully traceable through the current logging configuration.

#### Potential Impact
Limited ability to perform forensic analysis in case of a security incident or to detect unusual patterns of behavior.

#### Remediation
Enhance logging by adding additional context metadata and ensuring cross-reference capabilities with CloudTrail and other logging sources.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cw-logs.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-2-.aws-sam-packaged


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-42  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **8** medium, and **0** low severity findings.

## Priority Actions

### 1. Implement robust data filtering and sanitization before sending content to AI models. Use guardrails consistently across all Bedrock interactions (currently only conditionally applied). Consider implementing prompt templates that explicitly define what data can be included.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-008  
**Business Impact:** Disclosure of sensitive business data, PII, or confidential information to third-party AI model providers.

### 1. Implement strong input validation for all configuration updates. Create a configuration approval process. Consider implementing a change detection mechanism that alerts on suspicious configuration changes.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-009  
**Business Impact:** System compromise, data exfiltration, or manipulation of document processing results.

### 2. Implement log scrubbing/filtering mechanisms in Lambda functions to sanitize sensitive data before logging. Consider implementing a centralized logging middleware that handles sanitization consistently.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-001  
**Business Impact:** Unauthorized disclosure of PII or sensitive business data, potentially leading to regulatory compliance violations.

### 2. Review each Lambda function and restrict S3 permissions to only those actions necessary for its operation (e.g., GetObject, PutObject). Avoid using S3CrudPolicy and create more granular policies.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-002  
**Business Impact:** Unauthorized modification or deletion of document data, potentially leading to data loss or tampering.

### 2. Implement dependency scanning in the CI/CD pipeline. Use Amazon CodeGuru or similar tools to scan Lambda code for vulnerabilities. Consider using Lambda layers for vetted, shared libraries.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-004  
**Business Impact:** Unauthorized access to sensitive document data or potential system compromise.

### 3. Restrict Bedrock model invocation permissions to only the specific models and regions required for each function. Replace wildcard (*) resources with explicit ARNs for the required models.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-003  
**Business Impact:** Potential for excessive usage costs, unexpected model behavior, or data processing in unintended regions.

### 3. Implement checksums or digital signatures for documents at each processing stage. Validate integrity before processing. Consider storing hash values in the tracking table to detect modifications.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-005  
**Business Impact:** Incorrect document classification, extraction of manipulated data, or processing of unauthorized content.

### 3. Implement comprehensive audit logging that includes the identity of requesters, document metadata, and processing results. Store audit logs in a tamper-evident system. Consider implementing AWS CloudTrail for API activity logging.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-006  
**Business Impact:** Lack of accountability for document processing activities, difficulty in forensic analysis after a security incident.

### 3. Configure appropriate reserved and maximum concurrency limits for each Lambda function based on expected usage patterns. Implement throttling or queuing mechanisms for document processing requests during high load.

**Effort:** Low  
**Related Threats:** PATTERN2-THREAT-007  
**Business Impact:** Processing delays, failures due to throttling, or potential downstream resource exhaustion.

### 3. While Textract doesn't support resource-level permissions for these operations, implement additional controls such as request validation, monitoring unusual usage patterns, and setting up AWS Budgets alerts for unexpected costs.

**Effort:** Medium  
**Related Threats:** PATTERN2-THREAT-010  
**Business Impact:** Unauthorized use of AWS services, potential cost implications, and processing of unauthorized documents.



## Detailed Threat Analysis

## High Severity Threats

### PATTERN2-THREAT-008: Potential data leakage through Bedrock model prompts

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-200

#### Issue
Document content is sent to external AI models via Bedrock without clear controls on what data can be included in prompts. Sensitive information could be inadvertently included in prompts sent to foundation models.

#### Attack Vector
Sensitive data from documents could be sent as part of prompts to external AI models, potentially being stored, used for model training, or leaked through model responses.

#### Potential Impact
Disclosure of sensitive business data, PII, or confidential information to third-party AI model providers.

#### Remediation
Implement robust data filtering and sanitization before sending content to AI models. Use guardrails consistently across all Bedrock interactions (currently only conditionally applied). Consider implementing prompt templates that explicitly define what data can be included.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails.html

---

### PATTERN2-THREAT-009: Configuration tampering risk via custom resources

**STRIDE Category:** Tampering  
**Affected Resource:** `UpdateSchemaConfig, UpdateDefaultConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-642

#### Issue
Custom resources are used to update configuration, but there are no explicit validation controls to prevent malicious configuration changes that could alter system behavior.

#### Attack Vector
An attacker with access to the configuration could inject malicious prompts, redirect data flow, or manipulate extraction logic by modifying configuration values.

#### Potential Impact
System compromise, data exfiltration, or manipulation of document processing results.

#### Remediation
Implement strong input validation for all configuration updates. Create a configuration approval process. Consider implementing a change detection mechanism that alerts on suspicious configuration changes.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-lambda-function-code-cfnresponsemodule.html

---

## Medium Severity Threats

### PATTERN2-THREAT-001: Sensitive data may be logged without proper sanitization

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunctionLogGroup, ClassificationFunctionLogGroup, ExtractionFunctionLogGroup, AssessmentFunctionLogGroup, ProcessResultsFunctionLogGroup, SummarizationFunctionLogGroup, StateMachineLogGroup` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-532

#### Issue
Lambda functions processing document content may log sensitive information that gets stored in CloudWatch Logs. While logs are encrypted with a customer-managed KMS key, there's no explicit mechanism to sanitize or filter out PII or sensitive data before logging.

#### Attack Vector
An attacker with access to CloudWatch Logs or the KMS key could potentially view sensitive document data that was inadvertently logged during processing.

#### Potential Impact
Unauthorized disclosure of PII or sensitive business data, potentially leading to regulatory compliance violations.

#### Remediation
Implement log scrubbing/filtering mechanisms in Lambda functions to sanitize sensitive data before logging. Consider implementing a centralized logging middleware that handles sanitization consistently.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/nodejs-logging.html

---

### PATTERN2-THREAT-002: Overly permissive S3 permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
Several Lambda functions have full CRUD permissions (S3CrudPolicy) to buckets when they may only need read or write permissions. This violates the principle of least privilege.

#### Attack Vector
If a Lambda function is compromised, an attacker could potentially delete or overwrite important data in S3 buckets.

#### Potential Impact
Unauthorized modification or deletion of document data, potentially leading to data loss or tampering.

#### Remediation
Review each Lambda function and restrict S3 permissions to only those actions necessary for its operation (e.g., GetObject, PutObject). Avoid using S3CrudPolicy and create more granular policies.

**References:**
- https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-policy-templates.html

---

### PATTERN2-THREAT-003: Overly permissive Bedrock model invocation permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
Lambda functions have permissions to invoke any foundation model in Amazon Bedrock across all regions (arn:aws:bedrock:*::foundation-model/*), rather than restricting to specific models needed.

#### Attack Vector
If a Lambda function is compromised, an attacker could potentially use more expensive models or invoke models in different regions, leading to unexpected costs or data exfiltration.

#### Potential Impact
Potential for excessive usage costs, unexpected model behavior, or data processing in unintended regions.

#### Remediation
Restrict Bedrock model invocation permissions to only the specific models and regions required for each function. Replace wildcard (*) resources with explicit ARNs for the required models.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security-iam.html

---

### PATTERN2-THREAT-004: Potential data exfiltration via third-party dependencies

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-1104

#### Issue
Lambda functions may use external dependencies that could be compromised or contain vulnerabilities. There's no explicit mechanism for scanning or validating dependencies before deployment.

#### Attack Vector
An attacker could exploit a vulnerable third-party package used by one of the Lambda functions to exfiltrate document data or gain unauthorized access.

#### Potential Impact
Unauthorized access to sensitive document data or potential system compromise.

#### Remediation
Implement dependency scanning in the CI/CD pipeline. Use Amazon CodeGuru or similar tools to scan Lambda code for vulnerabilities. Consider using Lambda layers for vetted, shared libraries.

**References:**
- https://docs.aws.amazon.com/codeguru/latest/reviewer-ug/welcome.html

---

### PATTERN2-THREAT-005: No integrity validation for document processing pipeline

**STRIDE Category:** Tampering  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-345

#### Issue
The document processing workflow doesn't appear to implement integrity checks to ensure documents haven't been tampered with between processing stages.

#### Attack Vector
An attacker with partial access to the system could potentially modify document content or metadata between processing stages, leading to incorrect extraction results or data manipulation.

#### Potential Impact
Incorrect document classification, extraction of manipulated data, or processing of unauthorized content.

#### Remediation
Implement checksums or digital signatures for documents at each processing stage. Validate integrity before processing. Consider storing hash values in the tracking table to detect modifications.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingMetadata.html

---

### PATTERN2-THREAT-006: Insufficient audit trail for document processing lifecycle

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::StepFunctions::StateMachine)  
**CWE ID:** CWE-778

#### Issue
While the state machine logs execution data, there's no comprehensive audit trail that tracks who initiated document processing, what changes were made, and what extraction results were produced.

#### Attack Vector
Without proper audit trails, an insider or attacker who gains access could process unauthorized documents or modify extraction results without accountability.

#### Potential Impact
Lack of accountability for document processing activities, difficulty in forensic analysis after a security incident.

#### Remediation
Implement comprehensive audit logging that includes the identity of requesters, document metadata, and processing results. Store audit logs in a tamper-evident system. Consider implementing AWS CloudTrail for API activity logging.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudtrail.html

---

### PATTERN2-THREAT-007: No concurrency limits on Lambda functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-400

#### Issue
Lambda functions don't have reserved or maximum concurrency limits configured, potentially allowing resource exhaustion or throttling during high load.

#### Attack Vector
An attacker could trigger multiple large document processing jobs simultaneously, causing the system to exhaust resources or hit service quotas, resulting in denial of service for legitimate requests.

#### Potential Impact
Processing delays, failures due to throttling, or potential downstream resource exhaustion.

#### Remediation
Configure appropriate reserved and maximum concurrency limits for each Lambda function based on expected usage patterns. Implement throttling or queuing mechanisms for document processing requests during high load.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### PATTERN2-THREAT-010: Overly permissive Textract permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has permissions to call Textract APIs (DetectDocumentText, AnalyzeDocument) on all resources without restrictions, violating the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could use Textract services to process unauthorized documents or perform actions at the expense of the account owner.

#### Potential Impact
Unauthorized use of AWS services, potential cost implications, and processing of unauthorized documents.

#### Remediation
While Textract doesn't support resource-level permissions for these operations, implement additional controls such as request validation, monitoring unusual usage patterns, and setting up AWS Budgets alerts for unexpected costs.

**References:**
- https://docs.aws.amazon.com/textract/latest/dg/security_iam_service-with-iam.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-2-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-11  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **0** high, **7** medium, and **3** low severity findings.

## Priority Actions

### 2. Ensure guardrails are always configured by making the BedrockGuardrailId and BedrockGuardrailVersion parameters required rather than optional, or implement additional validation logic to ensure guardrails are properly configured before allowing document processing.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-001  
**Business Impact:** Potential exposure of sensitive information from processed documents, generation of harmful content, or information leakage through model responses.

### 2. Implement comprehensive input validation in all Lambda functions to validate document formats, sizes, content types, and processing parameters before performing operations. Ensure that all input sources are properly sanitized and validated.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-002  
**Business Impact:** Potential security bypass, data manipulation, or denial of service in document processing pipeline.

### 2. Restrict Bedrock model access to only the specific models required for each function's operation. Replace wildcard resources with explicit ARNs for each approved model.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-003  
**Business Impact:** Potential for unauthorized model usage, increased costs, or access to models with different security properties than intended for the application.

### 2. Implement comprehensive audit logging for all AI operations, including model invocations, inputs (with appropriate PII redaction), outputs, and decision points. Store these logs securely with appropriate retention periods.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-004  
**Business Impact:** Difficulty in detecting, investigating, and responding to security incidents or compliance violations involving AI processing.

### 2. Implement comprehensive validation, integrity checking, and change auditing for all configuration updates. Consider adding approval workflows for critical configuration changes and integrity verification mechanisms.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-007  
**Business Impact:** Potential manipulation of AI processing parameters, security controls, or workflow logic, leading to security bypasses or unexpected system behavior.

### 2. Implement proper authentication and authorization checks within Lambda functions before executing GraphQL mutations. Consider implementing request signing or other mechanisms to verify the authenticity of mutation requests.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-009  
**Business Impact:** Unauthorized data manipulation, status changes, or system state modifications through GraphQL mutations.

### 3. Implement appropriate concurrency controls for Lambda functions, including reserved concurrency to prevent resource exhaustion. Consider implementing request throttling at the API layer and monitoring for unusual traffic patterns.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-005  
**Business Impact:** Service disruption for legitimate users, processing delays, or complete denial of service under attack conditions.

### 3. While resource-level permissions aren't supported for Textract, implement additional application-level controls to ensure the function only processes appropriate documents. Consider implementing request validation, access logging, and monitoring for unusual Textract usage patterns.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-008  
**Business Impact:** Potential unauthorized use of Textract services, leading to increased costs or processing of unintended documents.

### 3. Implement log sanitization mechanisms to redact or mask sensitive information before logging. Consider implementing log review procedures and additional access controls for log data.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-010  
**Business Impact:** Exposure of sensitive information from processed documents, potentially including PII or confidential business information.

### 4. Ensure CloudWatch dashboards are only accessible to authorized personnel through appropriate IAM policies. Consider implementing additional access controls and audit logging for dashboard access.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-PATTERN-2-THREAT-006  
**Business Impact:** Exposure of operational patterns and potential intelligence gathering for more targeted attacks.



## Detailed Threat Analysis

## Medium Severity Threats

### AWS-GENAI-IDP-PATTERN-2-THREAT-001: Potential sensitive data exposure via insufficient guardrail configuration

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-200

#### Issue
The template conditionally applies Bedrock guardrails for GenAI operations based on provided parameters. If guardrails are not configured (empty GuardrailId and GuardrailVersion), the LLM operations could potentially expose sensitive information from documents or produce unsafe outputs.

#### Attack Vector
If guardrails aren't configured, an attacker could potentially craft inputs that cause the LLM to expose sensitive information from processed documents or produce harmful content.

#### Potential Impact
Potential exposure of sensitive information from processed documents, generation of harmful content, or information leakage through model responses.

#### Remediation
Ensure guardrails are always configured by making the BedrockGuardrailId and BedrockGuardrailVersion parameters required rather than optional, or implement additional validation logic to ensure guardrails are properly configured before allowing document processing.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails.html

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-002: Missing input validation for document processing

**STRIDE Category:** Tampering  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-20

#### Issue
The Lambda functions don't appear to implement comprehensive input validation for incoming documents or parameters. This could allow maliciously crafted inputs to potentially bypass security controls or cause unexpected behavior.

#### Attack Vector
An attacker could submit specially crafted documents or inputs designed to bypass validation checks, manipulate AI models, or cause unexpected behavior in the processing pipeline.

#### Potential Impact
Potential security bypass, data manipulation, or denial of service in document processing pipeline.

#### Remediation
Implement comprehensive input validation in all Lambda functions to validate document formats, sizes, content types, and processing parameters before performing operations. Ensure that all input sources are properly sanitized and validated.

**References:**
- https://owasp.org/API-Security/editions/2023/en/0xa3-broken-object-property-level-authorization/

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-003: Overly permissive Bedrock model access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction Policies` (AWS::IAM::Policy)  
**CWE ID:** CWE-272

#### Issue
The IAM policies for Lambda functions grant broad access to all Bedrock foundation models using wildcard resources (`arn:aws:bedrock:*::foundation-model/*`). This violates the principle of least privilege and could allow unintended model access.

#### Attack Vector
If a Lambda function is compromised, an attacker could potentially invoke any Bedrock model, including those that might have higher costs or different security characteristics than intended.

#### Potential Impact
Potential for unauthorized model usage, increased costs, or access to models with different security properties than intended for the application.

#### Remediation
Restrict Bedrock model access to only the specific models required for each function's operation. Replace wildcard resources with explicit ARNs for each approved model.

**References:**
- https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/sec_permissions_least_privileges.html

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-004: Insufficient audit logging for AI operations

**STRIDE Category:** Repudiation  
**Affected Resource:** `All Lambda Functions` (AWS::Lambda::Function)  
**CWE ID:** CWE-778

#### Issue
While CloudWatch logging is implemented, there appears to be no specific audit logging for critical AI operations such as model invocations, classification decisions, or extraction results. This could make it difficult to trace actions or investigate security incidents.

#### Attack Vector
Without comprehensive audit logs, an attacker could potentially perform malicious activities through the AI system without leaving sufficient evidence trails.

#### Potential Impact
Difficulty in detecting, investigating, and responding to security incidents or compliance violations involving AI processing.

#### Remediation
Implement comprehensive audit logging for all AI operations, including model invocations, inputs (with appropriate PII redaction), outputs, and decision points. Store these logs securely with appropriate retention periods.

**References:**
- https://www.nist.gov/itl/ai-risk-management-framework

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-005: Missing concurrency controls and throttling protection

**STRIDE Category:** Denial of Service  
**Affected Resource:** `All Lambda Functions` (AWS::Lambda::Function)  
**CWE ID:** CWE-400

#### Issue
The Lambda functions do not have reserved concurrency or provisioned concurrency settings, which could lead to resource exhaustion under heavy load or during DoS attacks.

#### Attack Vector
An attacker could flood the system with document processing requests, potentially exhausting Lambda concurrency limits and causing legitimate requests to be throttled.

#### Potential Impact
Service disruption for legitimate users, processing delays, or complete denial of service under attack conditions.

#### Remediation
Implement appropriate concurrency controls for Lambda functions, including reserved concurrency to prevent resource exhaustion. Consider implementing request throttling at the API layer and monitoring for unusual traffic patterns.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-007: Potential insecure handling of configuration data

**STRIDE Category:** Tampering  
**Affected Resource:** `UpdateDefaultConfig, UpdateSchemaConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-642

#### Issue
The template uses CustomResources to update configuration data without clear validation or integrity checks. This could potentially allow tampering with configuration settings if the UpdateConfigurationFunction is compromised.

#### Attack Vector
If the UpdateConfigurationFunction has vulnerabilities or is compromised, an attacker could potentially manipulate configuration data, affecting document processing security or functionality.

#### Potential Impact
Potential manipulation of AI processing parameters, security controls, or workflow logic, leading to security bypasses or unexpected system behavior.

#### Remediation
Implement comprehensive validation, integrity checking, and change auditing for all configuration updates. Consider adding approval workflows for critical configuration changes and integrity verification mechanisms.

**References:**
- https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/sec_change_management_secure_ci_cd.html

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-009: Potential unauthorized AppSync API access

**STRIDE Category:** Spoofing  
**Affected Resource:** `All Lambda Functions with AppSync Access` (AWS::Lambda::Function)  
**CWE ID:** CWE-306

#### Issue
Lambda functions have broad permissions to invoke AppSync GraphQL Mutation operations. Without proper request authentication and authorization within the functions, this could potentially allow unauthorized mutations.

#### Attack Vector
If a Lambda function is compromised, an attacker could potentially execute unauthorized GraphQL mutations, potentially manipulating document status or other data.

#### Potential Impact
Unauthorized data manipulation, status changes, or system state modifications through GraphQL mutations.

#### Remediation
Implement proper authentication and authorization checks within Lambda functions before executing GraphQL mutations. Consider implementing request signing or other mechanisms to verify the authenticity of mutation requests.

**References:**
- https://owasp.org/API-Security/editions/2023/en/0xa2-broken-authentication/

---

## Low Severity Threats

### AWS-GENAI-IDP-PATTERN-2-THREAT-006: Potential exposure of processing metrics in CloudWatch dashboard

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-668

#### Issue
The CloudWatch dashboard could potentially expose sensitive information about document processing patterns, volume, and performance characteristics. Without proper dashboard access controls, this information could be visible to unauthorized users.

#### Attack Vector
An attacker with access to the AWS console but without need-to-know for this specific application could view the dashboard and gain insights into processing patterns, document volumes, or potential system weaknesses.

#### Potential Impact
Exposure of operational patterns and potential intelligence gathering for more targeted attacks.

#### Remediation
Ensure CloudWatch dashboards are only accessible to authorized personnel through appropriate IAM policies. Consider implementing additional access controls and audit logging for dashboard access.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards_Permissions.html

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-008: Overly permissive Textract permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has broad permissions to Textract APIs with a wildcard resource ('*') since Textract doesn't support resource-level permissions. While unavoidable due to AWS service limitations, this still represents a deviation from least privilege principles.

#### Attack Vector
If the OCRFunction is compromised, an attacker could potentially use its permissions to perform Textract operations on any documents accessible to the function, not just those intended for processing.

#### Potential Impact
Potential unauthorized use of Textract services, leading to increased costs or processing of unintended documents.

#### Remediation
While resource-level permissions aren't supported for Textract, implement additional application-level controls to ensure the function only processes appropriate documents. Consider implementing request validation, access logging, and monitoring for unusual Textract usage patterns.

**References:**
- https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/sec_permissions_least_privileges.html

---

### AWS-GENAI-IDP-PATTERN-2-THREAT-010: Potential sensitive data exposure in logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All LogGroups` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-532

#### Issue
While logs are encrypted with a customer-managed KMS key, there's no explicit control to prevent sensitive data from being logged in CloudWatch. Processing document text might inadvertently log PII or other sensitive information.

#### Attack Vector
An attacker with access to CloudWatch logs could potentially extract sensitive information that was inadvertently logged during document processing.

#### Potential Impact
Exposure of sensitive information from processed documents, potentially including PII or confidential business information.

#### Remediation
Implement log sanitization mechanisms to redact or mask sensitive information before logging. Consider implementing log review procedures and additional access controls for log data.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-3-.aws-sam-build-SAGEMAKERCLASSIFIERSTACK-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-31  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **8** security threats. The analysis reveals **0** critical, **3** high, **5** medium, and **0** low severity findings.

## Priority Actions

### 1. Add KmsKeyId property to the EndpointConfig resource to enable encryption for the SageMaker endpoint. Note that there's a suppressed cfn_nag rule W1200 mentioning KMS key not being supported for NVMe instance storage - ensure your selected instance type supports volume encryption.

**Effort:** Low  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-001  
**Business Impact:** Unauthorized access to model data, prediction inputs/outputs, or other sensitive information processed by the endpoint.

### 1. Replace the AmazonSageMakerFullAccess managed policy with specific inline policies that grant only the permissions needed for the endpoint's operation (such as sagemaker:InvokeEndpoint and specific S3 access).

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-003  
**Business Impact:** Potential unauthorized access to other SageMaker resources, models, and data across the AWS account.

### 1. Use the full image URI with a digest hash (@sha256:...) instead of relying only on the tag to ensure image immutability and prevent tampering.

**Effort:** Low  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-005  
**Business Impact:** Execution of unauthorized code within the SageMaker container, potentially leading to model theft or data exfiltration.

### 2. Enable data capture for the endpoint by adding DataCaptureConfig to the EndpointConfig resource, specifying CaptureOptions for both 'Input' and 'Output' data with appropriate DestinationS3Uri and KmsKeyId for encryption.

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-002  
**Business Impact:** Inability to detect unauthorized access, verify compliance with regulations, or investigate security incidents related to model predictions.

### 2. Add the EnableNetworkIsolation property set to true on the AWS::SageMaker::Model resource to prevent the container from making external network calls.

**Effort:** Low  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-004  
**Business Impact:** Potential data leakage, model theft, or execution of unauthorized code within the SageMaker container.

### 2. Add CloudWatch Alarms for key metrics such as Invocations, InvocationsPerInstance, ModelLatency, and Errors. Configure appropriate thresholds and notification actions.

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-007  
**Business Impact:** Delayed response to security incidents, unauthorized access, or model performance issues.

### 2. Restrict S3 access to only the specific paths needed for model operation by limiting the resources in the IAM policy to specific prefixes rather than granting access to the entire bucket.

**Effort:** Low  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-008  
**Business Impact:** Unauthorized access to sensitive data stored in the same S3 bucket but unrelated to the SageMaker model's operation.

### 3. Review and adjust the auto-scaling parameters based on workload patterns. Consider reducing ScaleInCooldown, increasing ScaleOutCooldown for faster scaling, and setting appropriate TargetInvocationsPerInstance based on model performance characteristics.

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-006  
**Business Impact:** Service degradation or outage for legitimate users during traffic spikes or targeted DoS attacks.



## Detailed Threat Analysis

## High Severity Threats

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-001: Missing Encryption for SageMaker Endpoint Storage

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UDOPEndpointConfig` (AWS::SageMaker::EndpointConfig)  
**CWE ID:** CWE-311

#### Issue
The SageMaker endpoint configuration doesn't enforce encryption of data stored on instance volumes. This may expose sensitive model data and temporary processing data at rest.

#### Attack Vector
An attacker with access to the underlying storage infrastructure could potentially extract sensitive information from unencrypted instance volumes.

#### Potential Impact
Unauthorized access to model data, prediction inputs/outputs, or other sensitive information processed by the endpoint.

#### Remediation
Add KmsKeyId property to the EndpointConfig resource to enable encryption for the SageMaker endpoint. Note that there's a suppressed cfn_nag rule W1200 mentioning KMS key not being supported for NVMe instance storage - ensure your selected instance type supports volume encryption.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/API_CreateEndpointConfig.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-003: Overly Permissive IAM Role

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `UDOPExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The execution role has the AmazonSageMakerFullAccess managed policy attached, which grants excessive permissions beyond what's needed for model inference.

#### Attack Vector
If the SageMaker endpoint is compromised, an attacker could leverage the overly permissive role to access or manipulate other SageMaker resources in the account.

#### Potential Impact
Potential unauthorized access to other SageMaker resources, models, and data across the AWS account.

#### Remediation
Replace the AmazonSageMakerFullAccess managed policy with specific inline policies that grant only the permissions needed for the endpoint's operation (such as sagemaker:InvokeEndpoint and specific S3 access).

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-005: No Image Digest Pinning for Container Image

**STRIDE Category:** Tampering  
**Affected Resource:** `UDOPModel` (AWS::SageMaker::Model)  
**CWE ID:** CWE-345

#### Issue
The container image for the model is specified without a digest hash, using only a tag (2.1.0-gpu-py310), which could allow for image tampering.

#### Attack Vector
If an attacker gains access to the ECR repository or can manipulate DNS, they could potentially serve a malicious container image with the same tag.

#### Potential Impact
Execution of unauthorized code within the SageMaker container, potentially leading to model theft or data exfiltration.

#### Remediation
Use the full image URI with a digest hash (@sha256:...) instead of relying only on the tag to ensure image immutability and prevent tampering.

**References:**
- https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-digests.html

---

## Medium Severity Threats

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-002: Missing Data Capture and Logging Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `UDOPEndpoint` (AWS::SageMaker::Endpoint)  
**CWE ID:** CWE-778

#### Issue
The SageMaker endpoint lacks data capture configuration for inputs and outputs. Without logging prediction requests and responses, there's no audit trail for model usage and predictions.

#### Attack Vector
Without proper logging, malicious use of the endpoint cannot be traced, and there's no way to audit compliance or investigate incidents.

#### Potential Impact
Inability to detect unauthorized access, verify compliance with regulations, or investigate security incidents related to model predictions.

#### Remediation
Enable data capture for the endpoint by adding DataCaptureConfig to the EndpointConfig resource, specifying CaptureOptions for both 'Input' and 'Output' data with appropriate DestinationS3Uri and KmsKeyId for encryption.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-data-capture.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-004: Missing Network Isolation for SageMaker Model

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UDOPModel` (AWS::SageMaker::Model)  
**CWE ID:** CWE-668

#### Issue
The SageMaker model does not enable network isolation, which means the container can make external network calls during inference.

#### Attack Vector
A compromised container could exfiltrate sensitive data to external endpoints or download unauthorized code during inference.

#### Potential Impact
Potential data leakage, model theft, or execution of unauthorized code within the SageMaker container.

#### Remediation
Add the EnableNetworkIsolation property set to true on the AWS::SageMaker::Model resource to prevent the container from making external network calls.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/model-isolated.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-006: Suboptimal Auto-scaling Configuration

**STRIDE Category:** Denial of Service  
**Affected Resource:** `ScalingPolicy` (AWS::ApplicationAutoScaling::ScalingPolicy)  
**CWE ID:** CWE-400

#### Issue
The auto-scaling configuration may not be optimal to handle burst traffic scenarios with a relatively high ScaleInCooldown (300s) and potentially low TargetInvocationsPerInstance default value.

#### Attack Vector
An attacker could perform a denial of service by overwhelming the endpoint with requests before it can scale out sufficiently.

#### Potential Impact
Service degradation or outage for legitimate users during traffic spikes or targeted DoS attacks.

#### Remediation
Review and adjust the auto-scaling parameters based on workload patterns. Consider reducing ScaleInCooldown, increasing ScaleOutCooldown for faster scaling, and setting appropriate TargetInvocationsPerInstance based on model performance characteristics.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/endpoint-auto-scaling.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-007: Missing Monitoring and Alerting Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `Stack` (AWS::CloudFormation::Stack)  
**CWE ID:** CWE-778

#### Issue
The template does not define CloudWatch alarms or monitoring for the SageMaker endpoint, making it difficult to detect and respond to suspicious activity or performance issues.

#### Attack Vector
Security incidents or performance degradation may go unnoticed without proper monitoring and alerting.

#### Potential Impact
Delayed response to security incidents, unauthorized access, or model performance issues.

#### Remediation
Add CloudWatch Alarms for key metrics such as Invocations, InvocationsPerInstance, ModelLatency, and Errors. Configure appropriate thresholds and notification actions.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/monitoring-cloudwatch.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-UDOP-THREAT-008: Over-permissive S3 Access

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UDOPExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-732

#### Issue
The IAM role policy for S3 access grants read permissions to the entire S3 bucket specified in the S3Bucket parameter, rather than restricting access to only the necessary paths.

#### Attack Vector
If the SageMaker endpoint is compromised, an attacker could access any object in the specified S3 bucket, potentially accessing sensitive data unrelated to the model.

#### Potential Impact
Unauthorized access to sensitive data stored in the same S3 bucket but unrelated to the SageMaker model's operation.

#### Remediation
Restrict S3 access to only the specific paths needed for model operation by limiting the resources in the IAM policy to specific prefixes rather than granting access to the entire bucket.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-3-.aws-sam-build-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-10  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **8** security threats. The analysis reveals **0** critical, **0** high, **3** medium, and **5** low severity findings.

## Priority Actions

### 2. Restrict Textract permissions to only the specific operations needed. While Textract doesn't support resource-level permissions currently, consider implementing detective controls like CloudTrail monitoring for unusual Textract usage patterns.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-001  
**Business Impact:** Unauthorized access to documents processed through Textract, potentially leading to data leakage of sensitive information from documents outside the intended scope.

### 2. Restrict Bedrock invocation permissions to only the specific models required for the application's functionality, rather than allowing access to all foundation models.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-002  
**Business Impact:** Unauthorized access to Bedrock models beyond what's required for the application, potentially leading to cost escalation or misuse of AI capabilities.

### 2. Implement log scrubbing mechanisms to redact sensitive information before logging. Configure appropriate log levels to minimize detailed content logging in production. Implement strict access controls on CloudWatch Log groups and consider using log filters to mask potentially sensitive information.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-008  
**Business Impact:** Unintended disclosure of sensitive information, personally identifiable information (PII), or confidential business data that might be present in the processed documents.

### 3. Set a minimum acceptable value for LogRetentionDays parameter with a constraint in the template to ensure logs are kept long enough for security investigations and compliance requirements (typically 90+ days).

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-003  
**Business Impact:** Reduced ability to investigate security incidents or compliance violations if logs are retained for an insufficient period.

### 3. Set 'IncludeExecutionData: false' unless there is a specific requirement to log execution data. If execution data logging is necessary, ensure appropriate access controls on the log group and consider implementing log filters to redact sensitive information.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-004  
**Business Impact:** Potential exposure of sensitive information that might be included in state machine execution data.

### 3. Configure appropriate reserved and/or provisioned concurrency limits for each Lambda function based on expected usage patterns. This helps ensure the functions have the resources they need while preventing them from consuming all available account concurrency.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-005  
**Business Impact:** Potential denial of service for other applications in the same AWS account if Lambda concurrency is exhausted.

### 3. Ensure the Lambda functions behind these custom resources implement comprehensive logging for all configuration changes, including the identity of the requester, the specific changes made, and timestamps.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-007  
**Business Impact:** Difficulty tracking who made configuration changes and what specific changes were made, potentially impacting compliance and incident investigation capabilities.

### 4. Implement strict IAM permissions for accessing the CloudWatch Dashboard. Consider creating separate dashboards with different levels of detail for different user roles, restricting sensitive metrics to those with operational needs.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-006  
**Business Impact:** Potential disclosure of operational patterns and metrics that could aid in planning more targeted attacks or reveal business-sensitive information about processing volumes.



## Detailed Threat Analysis

## Medium Severity Threats

### PATTERN3-THREAT-001: Overly permissive Textract permissions

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OCRFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-250

#### Issue
The OCRFunction has permissions to call textract:DetectDocumentText and textract:AnalyzeDocument on all resources ('*'). This grants broader access than necessary and violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could use these permissions to access and analyze documents that should be out of scope for this application.

#### Potential Impact
Unauthorized access to documents processed through Textract, potentially leading to data leakage of sensitive information from documents outside the intended scope.

#### Remediation
Restrict Textract permissions to only the specific operations needed. While Textract doesn't support resource-level permissions currently, consider implementing detective controls like CloudTrail monitoring for unusual Textract usage patterns.

**References:**
- https://docs.aws.amazon.com/textract/latest/dg/security_iam_service-with-iam.html

---

### PATTERN3-THREAT-002: Broad Bedrock model invocation permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `ExtractionFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-250

#### Issue
The ExtractionFunction has permissions to invoke any foundation model ('arn:aws:bedrock:*::foundation-model/*') and inference profile. This grants broader access than necessary and violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could use these permissions to access and invoke any Bedrock model, potentially circumventing intended usage patterns or incurring unexpected costs.

#### Potential Impact
Unauthorized access to Bedrock models beyond what's required for the application, potentially leading to cost escalation or misuse of AI capabilities.

#### Remediation
Restrict Bedrock invocation permissions to only the specific models required for the application's functionality, rather than allowing access to all foundation models.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_service-with-iam.html

---

### PATTERN3-THREAT-008: Potential exposure of sensitive information in logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `AssessmentFunction, ExtractionFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-532

#### Issue
Functions handling document content, extraction, and summarization might log sensitive information contained in the processed documents, potentially exposing PII or confidential data in CloudWatch Logs.

#### Attack Vector
Anyone with access to CloudWatch Logs could potentially view sensitive document contents that might be included in log messages for debugging purposes.

#### Potential Impact
Unintended disclosure of sensitive information, personally identifiable information (PII), or confidential business data that might be present in the processed documents.

#### Remediation
Implement log scrubbing mechanisms to redact sensitive information before logging. Configure appropriate log levels to minimize detailed content logging in production. Implement strict access controls on CloudWatch Log groups and consider using log filters to mask potentially sensitive information.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---

## Low Severity Threats

### PATTERN3-THREAT-003: Log retention policy could be improved

**STRIDE Category:** Repudiation  
**Affected Resource:** `StateMachineLogGroup` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-778

#### Issue
While the template includes log retention configuration for all log groups, the retention period is parameterized without enforcing minimum secure values. Short retention periods could impact investigation capabilities.

#### Attack Vector
Attackers who gain unauthorized access might attempt to cover their tracks, and with short log retention periods, their actions might be automatically deleted before detection.

#### Potential Impact
Reduced ability to investigate security incidents or compliance violations if logs are retained for an insufficient period.

#### Remediation
Set a minimum acceptable value for LogRetentionDays parameter with a constraint in the template to ensure logs are kept long enough for security investigations and compliance requirements (typically 90+ days).

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html

---

### PATTERN3-THREAT-004: State machine execution history potentially visible to other users

**STRIDE Category:** Tampering  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-532

#### Issue
The state machine is configured with 'IncludeExecutionData: true' which means execution data is included in the execution history and potentially visible to users with access to the log group.

#### Attack Vector
Users with access to CloudWatch Logs could potentially view sensitive information processed by the state machine if it handles confidential data.

#### Potential Impact
Potential exposure of sensitive information that might be included in state machine execution data.

#### Remediation
Set 'IncludeExecutionData: false' unless there is a specific requirement to log execution data. If execution data logging is necessary, ensure appropriate access controls on the log group and consider implementing log filters to redact sensitive information.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-log-level.html

---

### PATTERN3-THREAT-005: No concurrency limits configured for Lambda functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-400

#### Issue
Lambda functions in the template don't have concurrency limits configured, potentially allowing them to consume all available account concurrency during high load or in case of recursive invocation bugs.

#### Attack Vector
An attacker might trigger multiple simultaneous invocations of these functions, potentially causing resource exhaustion for other Lambda functions in the same AWS account.

#### Potential Impact
Potential denial of service for other applications in the same AWS account if Lambda concurrency is exhausted.

#### Remediation
Configure appropriate reserved and/or provisioned concurrency limits for each Lambda function based on expected usage patterns. This helps ensure the functions have the resources they need while preventing them from consuming all available account concurrency.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### PATTERN3-THREAT-006: CloudWatch Dashboard may expose sensitive operational metrics

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-200

#### Issue
The CloudWatch Dashboard could potentially expose sensitive operational data about the application, including processing rates, error patterns, and resource utilization, to anyone with dashboard access permissions.

#### Attack Vector
Users with dashboard access could gain insights into application behavior, processing volumes, and potential weaknesses without having direct access to the application itself.

#### Potential Impact
Potential disclosure of operational patterns and metrics that could aid in planning more targeted attacks or reveal business-sensitive information about processing volumes.

#### Remediation
Implement strict IAM permissions for accessing the CloudWatch Dashboard. Consider creating separate dashboards with different levels of detail for different user roles, restricting sensitive metrics to those with operational needs.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Dashboard-Access-Control.html

---

### PATTERN3-THREAT-007: Custom resources might lack proper logging for configuration changes

**STRIDE Category:** Repudiation  
**Affected Resource:** `UpdateSchemaConfig, UpdateDefaultConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-778

#### Issue
The template uses custom resources for configuration updates but doesn't explicitly define logging for these operations. This could lead to a lack of audit trail for configuration changes.

#### Attack Vector
An attacker with sufficient permissions could modify configurations through these custom resources without leaving adequate logs of their actions.

#### Potential Impact
Difficulty tracking who made configuration changes and what specific changes were made, potentially impacting compliance and incident investigation capabilities.

#### Remediation
Ensure the Lambda functions behind these custom resources implement comprehensive logging for all configuration changes, including the identity of the requester, the specific changes made, and timestamps.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-3-.aws-sam-packaged


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-17  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **4** high, **6** medium, and **0** low severity findings.

## Priority Actions

### 1. Implement more granular IAM policies by limiting S3 access to specific paths/prefixes needed by each function. For Bedrock, specify only the exact models needed by each function rather than allowing all foundation models. Also consider using resource-based conditions to further restrict access.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-001  
**Business Impact:** Unauthorized data access, potential data breaches, excessive AWS costs from unauthorized model usage, and potential violation of data protection regulations.

### 1. Move sensitive configuration data to secure parameter storage like AWS Systems Manager Parameter Store or AWS Secrets Manager, and reference them in CloudFormation. Use KMS encryption for all sensitive configuration values.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-006  
**Business Impact:** Exposure of intellectual property, business logic, or prompt engineering that gives competitive advantage. Could enable attackers to craft inputs that manipulate model outputs.

### 1. Implement strict validation of all configuration changes against a well-defined schema. Add integrity checks and approval workflows for configuration changes. Consider implementing versioning for configurations with rollback capabilities.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-007  
**Business Impact:** System compromise, data exfiltration, or injection of malicious behavior into the document processing pipeline.

### 1. Implement data minimization techniques to ensure only necessary information is sent to AI models. Add PII detection and redaction before sending data to external services. Consider using private endpoints for Bedrock access. Use the guardrail features consistently across all functions.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-010  
**Business Impact:** Unauthorized disclosure of sensitive or regulated information to third-party AI services, potential regulatory compliance violations, and data privacy concerns.

### 2. Set 'IncludeExecutionData: false' in the Step Functions logging configuration to prevent sensitive data from being logged. Implement data minimization in the workflow by ensuring that sensitive information is not passed between state machine steps unless absolutely necessary.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-002  
**Business Impact:** Potential exposure of confidential information from processed documents, which could lead to data breaches and regulatory violations.

### 2. Implement log sanitization in all Lambda functions to redact or mask sensitive data before logging. Set appropriate log levels for production (WARN or ERROR rather than DEBUG or INFO). Consider implementing a centralized logging solution with PII detection and redaction capabilities.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-003  
**Business Impact:** Unauthorized exposure of confidential information, potential compliance violations, and increased risk of data breaches.

### 2. Implement comprehensive input validation for all document inputs. Add file type verification, size limits, content scanning, and sanitization before processing. Consider integrating with a malware scanning solution for uploaded documents.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-004  
**Business Impact:** Potential denial of service through resource exhaustion, code injection if vulnerabilities exist in processing libraries, or data corruption.

### 2. Implement proper service-to-service authentication using IAM roles with request signing. Consider implementing API keys or JWT tokens for GraphQL API access with appropriate authorization checks.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-008  
**Business Impact:** Unauthorized data manipulation, injection of false data into the processing pipeline, or exfiltration of sensitive information from internal services.

### 3. Implement reserved concurrency for critical Lambda functions. Set up appropriate throttling and rate limiting at the API level. Consider implementing a queue-based architecture for handling high volumes of document processing requests.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-005  
**Business Impact:** Service unavailability, excessive AWS costs, degraded performance for legitimate users, and potential failure to meet SLAs.

### 3. Implement strict access controls on CloudWatch dashboards. Review dashboard content to ensure it doesn't reveal sensitive information. Consider creating separate dashboards for different user roles with appropriate access controls.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-ACCELERATOR-THREAT-009  
**Business Impact:** Information disclosure that provides attackers with insights into system behavior and potential attack vectors. Could reveal business-sensitive information about document processing volumes.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-001: Overly Permissive IAM Policies for Lambda Functions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
Multiple Lambda functions have overly broad permissions such as S3 CRUD permissions on entire buckets and Bedrock access to all foundation models, which violates the principle of least privilege. This creates unnecessary access paths and increases the attack surface.

#### Attack Vector
If one of the Lambda functions is compromised (e.g., through code injection or dependency vulnerabilities), an attacker could leverage the broad permissions to access, modify, or delete data across multiple buckets, or use expensive Bedrock models to run unauthorized workloads.

#### Potential Impact
Unauthorized data access, potential data breaches, excessive AWS costs from unauthorized model usage, and potential violation of data protection regulations.

#### Remediation
Implement more granular IAM policies by limiting S3 access to specific paths/prefixes needed by each function. For Bedrock, specify only the exact models needed by each function rather than allowing all foundation models. Also consider using resource-based conditions to further restrict access.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-006: Sensitive Configuration Data in CloudFormation

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UpdateSchemaConfig, UpdateDefaultConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-200

#### Issue
The template contains extensive configuration details including system prompts and task prompts for AI models directly in CloudFormation. These could contain sensitive information or reveal internal business logic that should not be visible in infrastructure code.

#### Attack Vector
An attacker with access to CloudFormation templates or stack history could extract sensitive prompts or business logic that could be used to understand or manipulate the document processing system.

#### Potential Impact
Exposure of intellectual property, business logic, or prompt engineering that gives competitive advantage. Could enable attackers to craft inputs that manipulate model outputs.

#### Remediation
Move sensitive configuration data to secure parameter storage like AWS Systems Manager Parameter Store or AWS Secrets Manager, and reference them in CloudFormation. Use KMS encryption for all sensitive configuration values.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/dynamic-references.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-007: No Validation of Schema Configuration Updates

**STRIDE Category:** Tampering  
**Affected Resource:** `UpdateSchemaConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-915

#### Issue
The system uses custom resources to update configuration schemas but doesn't appear to implement validation of configuration changes. This could lead to injection of malicious configuration that affects the behavior of document processing functions.

#### Attack Vector
An attacker with access to the configuration update mechanism could inject malicious configuration data that could alter system behavior, extract information, or create security vulnerabilities.

#### Potential Impact
System compromise, data exfiltration, or injection of malicious behavior into the document processing pipeline.

#### Remediation
Implement strict validation of all configuration changes against a well-defined schema. Add integrity checks and approval workflows for configuration changes. Consider implementing versioning for configurations with rollback capabilities.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-010: Potential Data Leakage to External AI Models

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All Lambda Functions with Bedrock Access` (AWS::Serverless::Function)  
**CWE ID:** CWE-200

#### Issue
Lambda functions that interact with Amazon Bedrock or other LLM services could potentially send sensitive document data to these services without proper controls for data minimization or filtering.

#### Attack Vector
Sensitive information from processed documents could be included in prompts sent to external AI services, where it might be used for model training or retained in logs.

#### Potential Impact
Unauthorized disclosure of sensitive or regulated information to third-party AI services, potential regulatory compliance violations, and data privacy concerns.

#### Remediation
Implement data minimization techniques to ensure only necessary information is sent to AI models. Add PII detection and redaction before sending data to external services. Consider using private endpoints for Bedrock access. Use the guardrail features consistently across all functions.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-ACCELERATOR-THREAT-002: Execution History Could Expose Sensitive Data

**STRIDE Category:** Repudiation  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-532

#### Issue
The Step Functions state machine is configured with 'IncludeExecutionData: true', which means that potentially sensitive document data could be included in the execution history and logs, creating a risk of sensitive information disclosure.

#### Attack Vector
An attacker with access to the CloudWatch logs or Step Functions execution history could extract sensitive information from processed documents without directly accessing the source data.

#### Potential Impact
Potential exposure of confidential information from processed documents, which could lead to data breaches and regulatory violations.

#### Remediation
Set 'IncludeExecutionData: false' in the Step Functions logging configuration to prevent sensitive data from being logged. Implement data minimization in the workflow by ensuring that sensitive information is not passed between state machine steps unless absolutely necessary.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-logs.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-003: Possible Sensitive Data Exposure in Lambda Logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-532

#### Issue
Lambda functions processing document data may log sensitive information as part of their execution, especially when running at DEBUG or INFO log levels. There's no evidence of log filtering or redaction mechanisms for PII or sensitive content.

#### Attack Vector
An attacker with access to CloudWatch logs could extract sensitive information from log entries without needing direct access to the data stores.

#### Potential Impact
Unauthorized exposure of confidential information, potential compliance violations, and increased risk of data breaches.

#### Remediation
Implement log sanitization in all Lambda functions to redact or mask sensitive data before logging. Set appropriate log levels for production (WARN or ERROR rather than DEBUG or INFO). Consider implementing a centralized logging solution with PII detection and redaction capabilities.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/logging-using-cloudwatch-logs.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-004: No Input Validation for Document Processing

**STRIDE Category:** Tampering  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
There's no evidence of input validation or sanitization for incoming documents before processing. This could lead to processing of malicious files or unexpected content that might compromise the system.

#### Attack Vector
An attacker could upload specially crafted documents designed to exploit vulnerabilities in the document processing libraries or cause the system to behave unexpectedly.

#### Potential Impact
Potential denial of service through resource exhaustion, code injection if vulnerabilities exist in processing libraries, or data corruption.

#### Remediation
Implement comprehensive input validation for all document inputs. Add file type verification, size limits, content scanning, and sanitization before processing. Consider integrating with a malware scanning solution for uploaded documents.

**References:**
- https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-005: No Resource Throttling or Quotas

**STRIDE Category:** Denial of Service  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
The template lacks defined concurrency limits, quotas, or rate limiting for Lambda functions. This makes the system vulnerable to resource exhaustion attacks or unintentional DoS during high traffic periods.

#### Attack Vector
An attacker could trigger many simultaneous document processing requests, potentially causing resource exhaustion, increased costs, or service disruption.

#### Potential Impact
Service unavailability, excessive AWS costs, degraded performance for legitimate users, and potential failure to meet SLAs.

#### Remediation
Implement reserved concurrency for critical Lambda functions. Set up appropriate throttling and rate limiting at the API level. Consider implementing a queue-based architecture for handling high volumes of document processing requests.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-008: No Authentication for Internal API Calls

**STRIDE Category:** Spoofing  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-306

#### Issue
The template shows Lambda functions making calls to AppSync GraphQL APIs but does not clearly define or enforce authentication between these internal services.

#### Attack Vector
If an attacker gains access to execute code within the environment, they could potentially make unauthorized calls to internal APIs without proper authentication checks.

#### Potential Impact
Unauthorized data manipulation, injection of false data into the processing pipeline, or exfiltration of sensitive information from internal services.

#### Remediation
Implement proper service-to-service authentication using IAM roles with request signing. Consider implementing API keys or JWT tokens for GraphQL API access with appropriate authorization checks.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security-authz.html

---

### AWS-GENAI-IDP-ACCELERATOR-THREAT-009: Sensitive Information in CloudWatch Dashboard

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-200

#### Issue
The CloudWatch dashboard could potentially expose sensitive operational data and metrics about the document processing system, including processing volumes, error rates, and performance characteristics.

#### Attack Vector
An attacker with access to CloudWatch could gather intelligence about system behavior, identify potential vulnerabilities, or monitor for specific patterns that might indicate high-value document processing.

#### Potential Impact
Information disclosure that provides attackers with insights into system behavior and potential attack vectors. Could reveal business-sensitive information about document processing volumes.

#### Remediation
Implement strict access controls on CloudWatch dashboards. Review dashboard content to ensure it doesn't reveal sensitive information. Consider creating separate dashboards for different user roles with appropriate access controls.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards_Sharing.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-3-sagemaker_classifier_endpoint


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-24  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **7** security threats. The analysis reveals **0** critical, **1** high, **5** medium, and **1** low severity findings.

## Priority Actions

### 1. Replace the AmazonSageMakerFullAccess managed policy with a custom IAM policy that includes only the specific permissions needed for model inference. Specifically, restrict permissions to the minimum required for the model endpoint to function.

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-THREAT-003  
**Business Impact:** Potential unauthorized access to other SageMaker resources, violation of least privilege principle, and increased blast radius in case of compromise.

### 2. Enable KMS encryption for the SageMaker EndpointConfig by adding the KmsKeyId property with the CustomerManagedEncryptionKeyArn parameter. If NVMe instance storage is required, evaluate the use of instance types that support KMS encryption.

**Effort:** Low  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-THREAT-001  
**Business Impact:** Potential exposure of sensitive data processed by the model, which could include proprietary or regulated information.

### 2. Enable NetworkIsolation property on the SageMaker Model resource. If external network access is required, use VpcConfig to restrict network traffic through a controlled VPC environment with appropriate security groups.

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-THREAT-002  
**Business Impact:** Potential data exfiltration or unauthorized communication from the inference container.

### 2. Enable CloudWatch logging for the SageMaker endpoint by configuring the EndpointConfig with appropriate logging levels. Consider implementing CloudTrail for API call logging and setting up CloudWatch alarms for suspicious activities.

**Effort:** Low  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-THREAT-004  
**Business Impact:** Reduced ability to detect and investigate potential security incidents, compliance issues due to lack of audit trails.

### 2. Implement model artifact integrity verification by using S3 Object Lock with legal hold or retention periods, versioning, and consider implementing checksums or digital signatures for the model artifacts. Verify these signatures during the deployment process.

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-THREAT-006  
**Business Impact:** Deployment of modified or malicious model code, potentially leading to incorrect predictions, data leakage, or other malicious behavior.

### 3. Review and adjust the MaxInstanceCount based on expected traffic patterns and stress testing. Consider implementing additional protection mechanisms like API Gateway with throttling or AWS WAF if the endpoint is publicly accessible.

**Effort:** Medium  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-THREAT-005  
**Business Impact:** Potential service degradation or unavailability during peak loads or in case of a DoS attack.

### 3. Review environment variables for sensitive information. Consider using AWS Systems Manager Parameter Store with KMS encryption for sensitive configuration values and accessing them securely from within the container. Ensure proper IAM restrictions on who can describe SageMaker resources.

**Effort:** Low  
**Related Threats:** SAGEMAKER-INFERENCE-ENDPOINT-THREAT-007  
**Business Impact:** Potential exposure of configuration details that could aid in further attacks or reveal sensitive operational information.



## Detailed Threat Analysis

## High Severity Threats

### SAGEMAKER-INFERENCE-ENDPOINT-THREAT-003: Overly Permissive IAM Role

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `UDOPExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The UDOPExecutionRole has the AmazonSageMakerFullAccess managed policy attached, which grants excessive permissions beyond what is required for model inference.

#### Attack Vector
If the execution role credentials are compromised or if there's a vulnerability in the application, an attacker could leverage these excessive permissions to access other SageMaker resources or perform unauthorized actions.

#### Potential Impact
Potential unauthorized access to other SageMaker resources, violation of least privilege principle, and increased blast radius in case of compromise.

#### Remediation
Replace the AmazonSageMakerFullAccess managed policy with a custom IAM policy that includes only the specific permissions needed for model inference. Specifically, restrict permissions to the minimum required for the model endpoint to function.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/security_iam_id-based-policy-examples.html

---

## Medium Severity Threats

### SAGEMAKER-INFERENCE-ENDPOINT-THREAT-001: Missing KMS Encryption for SageMaker Endpoint

**STRIDE Category:** Tampering  
**Affected Resource:** `UDOPEndpointConfig` (AWS::SageMaker::EndpointConfig)  
**CWE ID:** CWE-311

#### Issue
The SageMaker EndpointConfig is deployed without KMS encryption, as indicated by the suppression of the W1200 rule. This could leave data processed by the endpoint vulnerable to unauthorized access if the underlying storage is compromised.

#### Attack Vector
An attacker with access to the underlying storage could potentially access unencrypted data processed by the SageMaker endpoint.

#### Potential Impact
Potential exposure of sensitive data processed by the model, which could include proprietary or regulated information.

#### Remediation
Enable KMS encryption for the SageMaker EndpointConfig by adding the KmsKeyId property with the CustomerManagedEncryptionKeyArn parameter. If NVMe instance storage is required, evaluate the use of instance types that support KMS encryption.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/encryption-at-rest.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-THREAT-002: Container Network Access Not Restricted

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UDOPModel` (AWS::SageMaker::Model)  
**CWE ID:** CWE-668

#### Issue
The SageMaker model container has network access to S3 (as indicated by the commented checkov skip), but no explicit network isolation configuration is specified. This could allow the container to make unintended outbound connections.

#### Attack Vector
If the model or container is compromised, an attacker could exfiltrate data via outbound network connections to destinations other than required AWS services.

#### Potential Impact
Potential data exfiltration or unauthorized communication from the inference container.

#### Remediation
Enable NetworkIsolation property on the SageMaker Model resource. If external network access is required, use VpcConfig to restrict network traffic through a controlled VPC environment with appropriate security groups.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/network-isolation.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-THREAT-004: Missing Monitoring and Logging Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `UDOPEndpoint` (AWS::SageMaker::Endpoint)  
**CWE ID:** CWE-778

#### Issue
The template does not define any CloudWatch logging configuration for the SageMaker endpoint, which limits audit capability and visibility into model inference activities.

#### Attack Vector
Without proper logging, unauthorized access or misuse of the endpoint might go undetected, and there would be limited forensic evidence in case of a security incident.

#### Potential Impact
Reduced ability to detect and investigate potential security incidents, compliance issues due to lack of audit trails.

#### Remediation
Enable CloudWatch logging for the SageMaker endpoint by configuring the EndpointConfig with appropriate logging levels. Consider implementing CloudTrail for API call logging and setting up CloudWatch alarms for suspicious activities.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/logging-cloudwatch.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-THREAT-006: No Integrity Verification for Model Artifacts

**STRIDE Category:** Tampering  
**Affected Resource:** `UDOPModel` (AWS::SageMaker::Model)  
**CWE ID:** CWE-354

#### Issue
There is no mechanism to verify the integrity of the model artifacts loaded from S3. Without integrity checks, there's a risk that the model artifacts could be tampered with between upload and deployment.

#### Attack Vector
An attacker with write access to the S3 bucket could potentially modify the model artifacts, resulting in a compromised model being deployed.

#### Potential Impact
Deployment of modified or malicious model code, potentially leading to incorrect predictions, data leakage, or other malicious behavior.

#### Remediation
Implement model artifact integrity verification by using S3 Object Lock with legal hold or retention periods, versioning, and consider implementing checksums or digital signatures for the model artifacts. Verify these signatures during the deployment process.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html

---

### SAGEMAKER-INFERENCE-ENDPOINT-THREAT-007: Environment Variables Containing Sensitive Information

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `UDOPModel` (AWS::SageMaker::Model)  
**CWE ID:** CWE-214

#### Issue
The model container environment variables are defined in the template and might be exposed via various SageMaker APIs or logs. Some of these could potentially contain sensitive information.

#### Attack Vector
An attacker with read access to the SageMaker environment could potentially view these environment variables through describe APIs or logs.

#### Potential Impact
Potential exposure of configuration details that could aid in further attacks or reveal sensitive operational information.

#### Remediation
Review environment variables for sensitive information. Consider using AWS Systems Manager Parameter Store with KMS encryption for sensitive configuration values and accessing them securely from within the container. Ensure proper IAM restrictions on who can describe SageMaker resources.

**References:**
- https://docs.aws.amazon.com/systems-manager/latest/userguide/integration-ps-secretsmanager.html

---

## Low Severity Threats

### SAGEMAKER-INFERENCE-ENDPOINT-THREAT-005: Potential Scaling Limitation Under High Load

**STRIDE Category:** Denial of Service  
**Affected Resource:** `ScalingPolicy` (AWS::ApplicationAutoScaling::ScalingPolicy)  
**CWE ID:** CWE-400

#### Issue
While auto-scaling is configured, there's a potential risk of service degradation if the model experiences traffic that exceeds the maximum instance count or if scaling cannot keep up with sudden traffic spikes due to the configured cooldown periods.

#### Attack Vector
An attacker could potentially overwhelm the endpoint with a large number of requests that exceed the scaling capacity or exploit the cooldown periods to cause service delays.

#### Potential Impact
Potential service degradation or unavailability during peak loads or in case of a DoS attack.

#### Remediation
Review and adjust the MaxInstanceCount based on expected traffic patterns and stress testing. Consider implementing additional protection mechanisms like API Gateway with throttling or AWS WAF if the endpoint is publicly accessible.

**References:**
- https://docs.aws.amazon.com/sagemaker/latest/dg/endpoint-auto-scaling.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# patterns-pattern-3-template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-17  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **11** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **2** low severity findings.

## Priority Actions

### 1. Restrict Bedrock model access to only the specific models required by each function. Replace the wildcard with specific model ARNs like `arn:aws:bedrock:region::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0`.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-001  
**Business Impact:** Unauthorized model usage, potential cost implications, ability to bypass intended service restrictions.

### 1. Implement robust input sanitization for all content sent to LLMs. Use Bedrock guardrails consistently across all functions that access LLMs. Add a prompt security layer that validates and sanitizes inputs before they reach the model.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-011  
**Business Impact:** Data leakage, prompt injection attacks, generation of misleading or harmful content, or manipulation of document processing results.

### 2. Ensure all S3 buckets have default encryption enabled with the KMS key referenced in CustomerManagedEncryptionKeyArn parameter. If buckets are created in another template, verify encryption is applied there.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-002  
**Business Impact:** Potential exposure of sensitive document data, extraction results, or configuration information.

### 2. Implement robust input validation in all Lambda functions. Validate document formats, sizes, content types, and parameters before processing. Consider using AWS Lambda Layers to share common validation libraries across functions.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-004  
**Business Impact:** Potential for data corruption, system crashes, or bypass of processing controls.

### 2. Restrict Textract permissions to only the specific APIs needed (DetectDocumentText and AnalyzeDocument). While Textract doesn't support resource-level permissions, condition keys can be used to add constraints based on request parameters.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-007  
**Business Impact:** Potential unauthorized access to document data, increased AWS costs from unintended API usage.

### 2. Configure DLQs (SQS or SNS) for all Lambda functions to capture and handle failed executions. Implement automated monitoring and alerting for DLQ messages.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-010  
**Business Impact:** Silent failures, lost documents, incomplete processing workflows, and reduced system reliability.

### 3. Implement AWS X-Ray tracing for all Lambda functions and the Step Functions state machine. Add the X-Ray active tracing configuration to each Lambda function and include a tracing policy.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-003  
**Business Impact:** Reduced ability to detect, investigate, and respond to security incidents. Difficulty in tracking document flow through the system.

### 3. Implement reserved concurrency limits for all Lambda functions based on expected usage patterns. Consider setting provisioned concurrency for critical functions to ensure consistent performance.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-005  
**Business Impact:** Service degradation, increased latency, potential system unavailability, or throttling of other critical services.

### 3. Use AWS Systems Manager Parameter Store or AWS Secrets Manager for sensitive configuration values instead of environment variables. For any values that must remain in environment variables, ensure they are encrypted.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-006  
**Business Impact:** Information disclosure that could facilitate further attacks against the system.

### 3. Create CloudWatch Alarms for security-relevant metrics such as access denied events, unusual API call patterns, high error rates, or unexpected spikes in resource usage. Configure notifications to appropriate security personnel.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-008  
**Business Impact:** Delayed incident response, increased dwell time for attackers, potentially larger impact from security incidents.



## Detailed Threat Analysis

## High Severity Threats

### PATTERN3-THREAT-001: Overly Permissive Bedrock Model Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `Multiple Lambda Policies` (AWS::IAM::Policy)  
**CWE ID:** CWE-284

#### Issue
Lambda functions have permissions to invoke any Bedrock foundation model using a wildcard resource policy (`arn:aws:bedrock:*::foundation-model/*`). This creates an unnecessarily broad permission scope.

#### Attack Vector
An attacker who compromises a Lambda function could invoke any Bedrock model, potentially bypassing intended restrictions and accessing more powerful or costly models than intended.

#### Potential Impact
Unauthorized model usage, potential cost implications, ability to bypass intended service restrictions.

#### Remediation
Restrict Bedrock model access to only the specific models required by each function. Replace the wildcard with specific model ARNs like `arn:aws:bedrock:region::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0`.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_service-with-iam.html

---

### PATTERN3-THREAT-011: Missing Data Protection Controls for LLM Prompts

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All Lambda Functions with Bedrock Access` (AWS::Serverless::Function)  
**CWE ID:** CWE-74

#### Issue
The Lambda functions that interact with Bedrock models don't implement proper prompt injection protections or data sanitization. This could lead to prompt injection attacks or unintended data disclosure to LLMs.

#### Attack Vector
An attacker could craft documents with malicious content designed to manipulate LLM prompts, potentially extracting sensitive information from the system or causing the model to generate harmful outputs.

#### Potential Impact
Data leakage, prompt injection attacks, generation of misleading or harmful content, or manipulation of document processing results.

#### Remediation
Implement robust input sanitization for all content sent to LLMs. Use Bedrock guardrails consistently across all functions that access LLMs. Add a prompt security layer that validates and sanitizes inputs before they reach the model.

**References:**
- https://owasp.org/www-project-top-10-for-large-language-model-applications/

---

## Medium Severity Threats

### PATTERN3-THREAT-002: Missing S3 Bucket Encryption Configuration

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Multiple S3 Buckets` (AWS::S3::Bucket)  
**CWE ID:** CWE-311

#### Issue
S3 buckets referenced as parameters (InputBucket, ConfigurationBucket, OutputBucket, WorkingBucket) do not have explicit server-side encryption defined in this template. While encryption keys are passed as parameters, the template doesn't enforce bucket encryption.

#### Attack Vector
If the referenced buckets are not properly encrypted elsewhere, sensitive data stored in these buckets could be accessed in plaintext if the bucket is compromised.

#### Potential Impact
Potential exposure of sensitive document data, extraction results, or configuration information.

#### Remediation
Ensure all S3 buckets have default encryption enabled with the KMS key referenced in CustomerManagedEncryptionKeyArn parameter. If buckets are created in another template, verify encryption is applied there.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-encryption.html

---

### PATTERN3-THREAT-003: Insufficient Request Tracing

**STRIDE Category:** Repudiation  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
The Lambda functions handle document processing in a workflow, but there's no consistent request tracing mechanism implemented. While logging is configured, there's no distributed tracing solution to track requests across services.

#### Attack Vector
Without proper tracing, it would be difficult to reconstruct attack paths or understand the sequence of events during a security incident investigation.

#### Potential Impact
Reduced ability to detect, investigate, and respond to security incidents. Difficulty in tracking document flow through the system.

#### Remediation
Implement AWS X-Ray tracing for all Lambda functions and the Step Functions state machine. Add the X-Ray active tracing configuration to each Lambda function and include a tracing policy.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/services-xray.html

---

### PATTERN3-THREAT-004: Missing Input Validation

**STRIDE Category:** Tampering  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
The template creates Lambda functions for document processing but doesn't include any indication of input validation mechanisms. Without proper validation, the functions may process malicious or malformed inputs.

#### Attack Vector
An attacker could submit specially crafted documents or manipulated inputs to trigger errors, cause unexpected behavior, or potentially execute code injection attacks.

#### Potential Impact
Potential for data corruption, system crashes, or bypass of processing controls.

#### Remediation
Implement robust input validation in all Lambda functions. Validate document formats, sizes, content types, and parameters before processing. Consider using AWS Lambda Layers to share common validation libraries across functions.

**References:**
- https://owasp.org/www-project-api-security/

---

### PATTERN3-THREAT-005: Missing Lambda Concurrency Controls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
None of the Lambda functions have reserved concurrency limits defined, which could lead to resource exhaustion under heavy load or during a DoS attack.

#### Attack Vector
An attacker could trigger many concurrent Lambda invocations, potentially exhausting account quotas and impacting other functions or services in the same AWS account.

#### Potential Impact
Service degradation, increased latency, potential system unavailability, or throttling of other critical services.

#### Remediation
Implement reserved concurrency limits for all Lambda functions based on expected usage patterns. Consider setting provisioned concurrency for critical functions to ensure consistent performance.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### PATTERN3-THREAT-006: Sensitive Data in Environment Variables

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-527

#### Issue
Lambda functions use environment variables for configuration, including API URLs and feature flags. While not directly exposing credentials, these values could provide attackers with information about the system architecture.

#### Attack Vector
If a function is compromised, an attacker could access environment variables to gain information about the overall system configuration and other connected services.

#### Potential Impact
Information disclosure that could facilitate further attacks against the system.

#### Remediation
Use AWS Systems Manager Parameter Store or AWS Secrets Manager for sensitive configuration values instead of environment variables. For any values that must remain in environment variables, ensure they are encrypted.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/security-dataprotection.html

---

### PATTERN3-THREAT-007: Overly Permissive Textract Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has permissions to use any Textract API on any resource ('*') which violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these broad Textract permissions to analyze documents outside the intended scope or use additional Textract features not required by the application.

#### Potential Impact
Potential unauthorized access to document data, increased AWS costs from unintended API usage.

#### Remediation
Restrict Textract permissions to only the specific APIs needed (DetectDocumentText and AnalyzeDocument). While Textract doesn't support resource-level permissions, condition keys can be used to add constraints based on request parameters.

**References:**
- https://docs.aws.amazon.com/textract/latest/dg/security_iam_service-with-iam.html

---

### PATTERN3-THREAT-010: Missing Dead Letter Queue Configuration

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-755

#### Issue
The Lambda functions do not have Dead Letter Queues (DLQs) configured to capture failed executions. Failed processing could lead to lost documents or incomplete workflows without proper notification.

#### Attack Vector
An attacker could exploit input validation flaws to cause Lambda failures that go unnoticed, potentially leading to loss of document processing capabilities or incomplete processing of critical documents.

#### Potential Impact
Silent failures, lost documents, incomplete processing workflows, and reduced system reliability.

#### Remediation
Configure DLQs (SQS or SNS) for all Lambda functions to capture and handle failed executions. Implement automated monitoring and alerting for DLQ messages.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html#dlq

---

## Low Severity Threats

### PATTERN3-THREAT-008: Missing Alarm Configuration for Security Events

**STRIDE Category:** Repudiation  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-778

#### Issue
While a CloudWatch dashboard is created for monitoring system performance, there are no alarm configurations for security-related events or anomalies. This limits the ability to detect and respond to potential security incidents.

#### Attack Vector
Security incidents might go undetected or be noticed too late if there are no automated alerts for suspicious patterns or events.

#### Potential Impact
Delayed incident response, increased dwell time for attackers, potentially larger impact from security incidents.

#### Remediation
Create CloudWatch Alarms for security-relevant metrics such as access denied events, unusual API call patterns, high error rates, or unexpected spikes in resource usage. Configure notifications to appropriate security personnel.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html

---

### PATTERN3-THREAT-009: No State Machine Input Validation

**STRIDE Category:** Tampering  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-20

#### Issue
The State Machine workflow processes input documents but lacks input validation steps at the beginning of the workflow to verify input format and content.

#### Attack Vector
An attacker could submit malformed or malicious input data to the state machine that might bypass application-level validations in downstream components.

#### Potential Impact
Potential processing of invalid or malicious documents, which could lead to unexpected behavior, errors, or security issues in downstream processing.

#### Remediation
Add an initial validation step in the state machine workflow that performs basic validation of the input structure and format before proceeding with document processing.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/concepts-input-output-filtering.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# scripts-sdlc-cfn-codepipeline-s3


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-35  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **8** security threats. The analysis reveals **0** critical, **2** high, **4** medium, and **2** low severity findings.

## Priority Actions

### 1. Replace the ReadOnlyAccess managed policy with a custom policy that grants only the specific read permissions required for the deployment process. Remove unnecessary service permissions that aren't needed for the deployment workflow.

**Effort:** Medium  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-001  
**Business Impact:** Unauthorized access to sensitive information across the entire AWS account, potentially exposing configuration details, secrets, and infrastructure layout.

### 2. Scope down the logs permissions to specific log groups using a more restrictive resource pattern like 'arn:aws:logs:*:*:log-group:/aws/codebuild/*'.

**Effort:** Low  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-002  
**Business Impact:** Potential for log pollution, denial of service via resource exhaustion, or hiding malicious activity within legitimate logging infrastructure.

### 2. Restrict the sts:AssumeRole permission to only specific roles that need to be assumed during the deployment process using explicit ARNs instead of wildcards.

**Effort:** Low  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-005  
**Business Impact:** Potential for privilege escalation and unauthorized access to resources outside the intended scope of the deployment pipeline.

### 3. Explicitly configure server-side encryption using SSE-KMS with a customer-managed KMS key and specify a strong encryption algorithm.

**Effort:** Low  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-003  
**Business Impact:** Potential exposure of sensitive code or configuration data if the bucket is compromised or if S3 permissions are accidentally modified.

### 3. Enable access logging for the ArtifactBucket by configuring the LoggingConfiguration property to send logs to a separate, secure logging bucket.

**Effort:** Low  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-004  
**Business Impact:** Loss of audit trail for security investigations, compliance violations, and inability to detect unauthorized access to deployment assets.

### 3. Implement stricter code review processes, use VPC isolation for CodeBuild projects, and consider implementing automated security scanning of build scripts before execution.

**Effort:** Medium  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-006  
**Business Impact:** Execution of unauthorized code within the AWS account context, potentially leading to data exfiltration or resource manipulation.

### 4. Implement log filtering to mask sensitive values, review build scripts to ensure they don't output sensitive data, and set appropriate CloudWatch Logs retention periods.

**Effort:** Medium  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-007  
**Business Impact:** Exposure of sensitive information that could aid in further attacks or lead to unauthorized access to systems.

### 5. Configure lifecycle policies on the ArtifactBucket to automatically expire and delete artifacts after an appropriate retention period.

**Effort:** Low  
**Related Threats:** IDP-SDLC-DEPLOY-PIPELINE-THREAT-008  
**Business Impact:** Storage resource exhaustion, increased costs, and potential pipeline failures due to storage issues.



## Detailed Threat Analysis

## High Severity Threats

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-001: Overly Permissive IAM Role

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `CodeBuildRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The CodeBuildRole has the AWS ReadOnlyAccess managed policy attached, which provides unnecessary broad read access across all AWS services, violating the principle of least privilege.

#### Attack Vector
If the CodeBuild execution environment is compromised, an attacker could leverage these excessive permissions to enumerate all resources across the AWS account, facilitating further attack planning.

#### Potential Impact
Unauthorized access to sensitive information across the entire AWS account, potentially exposing configuration details, secrets, and infrastructure layout.

#### Remediation
Replace the ReadOnlyAccess managed policy with a custom policy that grants only the specific read permissions required for the deployment process. Remove unnecessary service permissions that aren't needed for the deployment workflow.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-002: Overly Permissive CloudWatch Logs Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `CodeBuildLogsPolicy` (AWS::IAM::Policy)  
**CWE ID:** CWE-732

#### Issue
The CodeBuildLogsPolicy grants unlimited permissions to create logs with a wildcard resource ('*'), allowing the role to create and write logs for any service or resource in the account.

#### Attack Vector
An attacker who compromises the CodeBuild environment could create excessive log groups or streams, potentially causing resource exhaustion or using logs as a persistence mechanism.

#### Potential Impact
Potential for log pollution, denial of service via resource exhaustion, or hiding malicious activity within legitimate logging infrastructure.

#### Remediation
Scope down the logs permissions to specific log groups using a more restrictive resource pattern like 'arn:aws:logs:*:*:log-group:/aws/codebuild/*'.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/iam-access-control-overview-for-cloudwatch-logs.html

---

## Medium Severity Threats

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-003: Missing Server-Side Encryption Configuration

**STRIDE Category:** Tampering  
**Affected Resource:** `ArtifactBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-311

#### Issue
The ArtifactBucket does not explicitly configure server-side encryption, relying instead on default S3 encryption as noted in the metadata comments. This may not meet organizational security requirements for sensitive deployment artifacts.

#### Attack Vector
If S3 default encryption is disabled at the account level or set to an insufficient encryption algorithm, sensitive deployment artifacts could be stored without proper encryption.

#### Potential Impact
Potential exposure of sensitive code or configuration data if the bucket is compromised or if S3 permissions are accidentally modified.

#### Remediation
Explicitly configure server-side encryption using SSE-KMS with a customer-managed KMS key and specify a strong encryption algorithm.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-encryption.html

---

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-004: Missing S3 Access Logging

**STRIDE Category:** Repudiation  
**Affected Resource:** `ArtifactBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-778

#### Issue
The ArtifactBucket has access logging explicitly disabled via a cfn_nag rule suppression. Even for temporary deployment artifacts, access logging is important for security auditing and forensics.

#### Attack Vector
Without access logging, unauthorized access to deployment artifacts or modifications to pipeline code cannot be properly tracked and audited.

#### Potential Impact
Loss of audit trail for security investigations, compliance violations, and inability to detect unauthorized access to deployment assets.

#### Remediation
Enable access logging for the ArtifactBucket by configuring the LoggingConfiguration property to send logs to a separate, secure logging bucket.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/ServerLogs.html

---

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-005: Unrestricted AssumeRole Permission

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `CodeBuildRole` (AWS::IAM::Role)  
**CWE ID:** CWE-269

#### Issue
The CodeBuildRole policy includes 'sts:AssumeRole' permission with a wildcard resource ('*'), allowing the role to assume any role in the account or potentially in other accounts.

#### Attack Vector
An attacker who compromises the CodeBuild environment could attempt to assume other roles with higher privileges within the AWS account.

#### Potential Impact
Potential for privilege escalation and unauthorized access to resources outside the intended scope of the deployment pipeline.

#### Remediation
Restrict the sts:AssumeRole permission to only specific roles that need to be assumed during the deployment process using explicit ARNs instead of wildcards.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_permissions-to-switch.html

---

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-006: Insecure Build Environment Configuration

**STRIDE Category:** Tampering  
**Affected Resource:** `IdkInstallCodeBuild` (AWS::CodeBuild::Project)  
**CWE ID:** CWE-94

#### Issue
The CodeBuild project uses a standard build environment without specific security hardening and executes scripts with access to AWS credentials that could potentially contain malicious code.

#### Attack Vector
If the source code repository is compromised or contains malicious scripts, these could execute with the CodeBuild role permissions during the build process.

#### Potential Impact
Execution of unauthorized code within the AWS account context, potentially leading to data exfiltration or resource manipulation.

#### Remediation
Implement stricter code review processes, use VPC isolation for CodeBuild projects, and consider implementing automated security scanning of build scripts before execution.

**References:**
- https://docs.aws.amazon.com/codebuild/latest/userguide/vpc-support.html

---

## Low Severity Threats

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-007: Potential Sensitive Data Exposure in Build Logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `IdkInstallCodeBuild` (AWS::CodeBuild::Project)  
**CWE ID:** CWE-532

#### Issue
The buildspec includes commands that may output sensitive information (such as environment variables or configuration data) to build logs which are retained and potentially accessible to users with CloudWatch Logs access.

#### Attack Vector
An authorized user with CloudWatch Logs access could retrieve sensitive information from build logs that may include credentials, configuration details, or other sensitive data.

#### Potential Impact
Exposure of sensitive information that could aid in further attacks or lead to unauthorized access to systems.

#### Remediation
Implement log filtering to mask sensitive values, review build scripts to ensure they don't output sensitive data, and set appropriate CloudWatch Logs retention periods.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---

### IDP-SDLC-DEPLOY-PIPELINE-THREAT-008: Missing Lifecycle Policies for Artifact Management

**STRIDE Category:** Denial of Service  
**Affected Resource:** `ArtifactBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-400

#### Issue
The ArtifactBucket does not have lifecycle policies configured to manage the retention and expiration of build artifacts, potentially leading to storage exhaustion over time.

#### Attack Vector
An attacker could intentionally trigger numerous pipeline executions to fill the artifact bucket, potentially causing service disruption or increased costs.

#### Potential Impact
Storage resource exhaustion, increased costs, and potential pipeline failures due to storage issues.

#### Remediation
Configure lifecycle policies on the ArtifactBucket to automatically expire and delete artifacts after an appropriate retention period.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# scripts-sdlc-cfn-credential-vendor


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-16  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **6** security threats. The analysis reveals **0** critical, **0** high, **4** medium, and **2** low severity findings.

## Priority Actions

### 2. Add condition keys to the S3 PutObject policy requiring server-side encryption and object integrity checking. Consider also implementing versioning on the S3 bucket to track changes and enable rollbacks.

**Effort:** Low  
**Related Threats:** GITLAB-ROLE-AND-PERMISSIONS-THREAT-001  
**Business Impact:** Unauthorized code deployment could lead to infrastructure compromise, data breaches, or service disruption.

### 2. Consider implementing additional conditions in the trust policy, such as requiring specific source IP ranges, adding an external ID requirement, or implementing a multi-factor authentication requirement for sensitive operations.

**Effort:** Low  
**Related Threats:** GITLAB-ROLE-AND-PERMISSIONS-THREAT-003  
**Business Impact:** Unauthorized access to AWS resources including the ability to deploy code and access pipeline information.

### 2. Implement S3 Object Lock, versioning, and require integrity checking via checksums. Consider adding a code scanning or validation step in the pipeline before deployment.

**Effort:** Medium  
**Related Threats:** GITLAB-ROLE-AND-PERMISSIONS-THREAT-006  
**Business Impact:** Execution of unauthorized or malicious code in the AWS environment, potentially leading to data breaches or service disruption.

### 3. Implement CloudTrail logging specifically for actions performed by this role. Consider adding a policy to prevent actions that would disable or modify logging configurations. Additionally, implement CloudWatch alarms for suspicious activities.

**Effort:** Medium  
**Related Threats:** GITLAB-ROLE-AND-PERMISSIONS-THREAT-002  
**Business Impact:** Reduced ability to detect, investigate, and respond to security incidents involving the GitLab integration.

### 4. Scope down the CloudWatch Logs permissions to specific log groups related to the GitLab integration's CodeBuild and CodePipeline resources rather than allowing access to all log groups in the account.

**Effort:** Low  
**Related Threats:** GITLAB-ROLE-AND-PERMISSIONS-THREAT-004  
**Business Impact:** Potential exposure of sensitive information from logs of unrelated services or applications.

### 4. Scope the ListPipelines permission to specific pipelines related to the GitLab project, or consider removing it if not absolutely necessary for the integration's functionality.

**Effort:** Low  
**Related Threats:** GITLAB-ROLE-AND-PERMISSIONS-THREAT-005  
**Business Impact:** Increased attack surface through information leakage about CI/CD processes and infrastructure deployment patterns.



## Detailed Threat Analysis

## Medium Severity Threats

### GITLAB-ROLE-AND-PERMISSIONS-THREAT-001: Overly Permissive S3 Resource Definition

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `GitLabRole` (AWS::IAM::Role)  
**CWE ID:** CWE-284

#### Issue
The S3 PutObject permission is limited to a specific object path, but doesn't include any condition keys for object-level encryption or verification, which could allow unauthorized modifications to the deployment code.

#### Attack Vector
If a malicious actor gains access to the GitLab role credentials, they could replace the deployment code with malicious code without requiring encryption or integrity validation.

#### Potential Impact
Unauthorized code deployment could lead to infrastructure compromise, data breaches, or service disruption.

#### Remediation
Add condition keys to the S3 PutObject policy requiring server-side encryption and object integrity checking. Consider also implementing versioning on the S3 bucket to track changes and enable rollbacks.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingServerSideEncryption.html

---

### GITLAB-ROLE-AND-PERMISSIONS-THREAT-002: Insufficient Logging for GitLab Role Actions

**STRIDE Category:** Repudiation  
**Affected Resource:** `GitLabRole` (AWS::IAM::Role)  
**CWE ID:** CWE-778

#### Issue
The template doesn't include permissions or configurations for comprehensive logging of actions performed by the GitLab role, limiting accountability and audit capabilities.

#### Attack Vector
An attacker using compromised credentials could perform malicious actions that might go undetected or be difficult to attribute to a specific actor.

#### Potential Impact
Reduced ability to detect, investigate, and respond to security incidents involving the GitLab integration.

#### Remediation
Implement CloudTrail logging specifically for actions performed by this role. Consider adding a policy to prevent actions that would disable or modify logging configurations. Additionally, implement CloudWatch alarms for suspicious activities.

**References:**
- https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html

---

### GITLAB-ROLE-AND-PERMISSIONS-THREAT-003: Potential for Cross-Account Role Assumption Abuse

**STRIDE Category:** Spoofing  
**Affected Resource:** `GitLabRole` (AWS::IAM::Role)  
**CWE ID:** CWE-306

#### Issue
The role trust policy relies primarily on GitLab Group and Project tags for authorization. While this provides some protection, additional safeguards could strengthen the authentication mechanism.

#### Attack Vector
If the trusted external account (979517299116) is compromised, attackers might be able to forge or manipulate the required tags to assume this role.

#### Potential Impact
Unauthorized access to AWS resources including the ability to deploy code and access pipeline information.

#### Remediation
Consider implementing additional conditions in the trust policy, such as requiring specific source IP ranges, adding an external ID requirement, or implementing a multi-factor authentication requirement for sensitive operations.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html

---

### GITLAB-ROLE-AND-PERMISSIONS-THREAT-006: No Integrity Verification for Deployed Code

**STRIDE Category:** Tampering  
**Affected Resource:** `GitLabRole` (AWS::IAM::Role)  
**CWE ID:** CWE-345

#### Issue
The CloudFormation template doesn't implement any integrity checking mechanisms for the code being deployed via S3, allowing potentially tampered code to be introduced into the pipeline.

#### Attack Vector
An attacker who compromises the GitLab system could upload malicious code that would be automatically processed by downstream systems without integrity verification.

#### Potential Impact
Execution of unauthorized or malicious code in the AWS environment, potentially leading to data breaches or service disruption.

#### Remediation
Implement S3 Object Lock, versioning, and require integrity checking via checksums. Consider adding a code scanning or validation step in the pipeline before deployment.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html

---

## Low Severity Threats

### GITLAB-ROLE-AND-PERMISSIONS-THREAT-004: Broad CloudWatch Logs Access

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `GitLabRole` (AWS::IAM::Role)  
**CWE ID:** CWE-200

#### Issue
The policy allows access to describe log groups and streams and get log events for all CloudWatch logs in the account, which could expose sensitive information beyond what's needed for pipeline monitoring.

#### Attack Vector
An attacker with access to this role could view log data from various services across the AWS account, potentially exposing sensitive information or application secrets logged by other systems.

#### Potential Impact
Potential exposure of sensitive information from logs of unrelated services or applications.

#### Remediation
Scope down the CloudWatch Logs permissions to specific log groups related to the GitLab integration's CodeBuild and CodePipeline resources rather than allowing access to all log groups in the account.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/iam-access-control-overview-for-logs.html

---

### GITLAB-ROLE-AND-PERMISSIONS-THREAT-005: Overly Broad CodePipeline List Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `GitLabRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The role has permission to list all pipelines in the account, beyond what might be necessary for the specific GitLab integration.

#### Attack Vector
An attacker with access to the role could enumerate all pipelines in the account, potentially gathering information about deployment patterns and infrastructure that could be used for further attacks.

#### Potential Impact
Increased attack surface through information leakage about CI/CD processes and infrastructure deployment patterns.

#### Remediation
Scope the ListPipelines permission to specific pipelines related to the GitLab project, or consider removing it if not absolutely necessary for the integration's functionality.

**References:**
- https://docs.aws.amazon.com/codepipeline/latest/userguide/security-iam-id-based-access-control.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# scripts-sdlc-cfn-s3-sourcecode


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-04  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **5** security threats. The analysis reveals **0** critical, **0** high, **3** medium, and **2** low severity findings.

## Priority Actions

### 2. Enable server access logging on the S3 bucket and direct logs to a secure, dedicated logging bucket.

**Effort:** Low  
**Related Threats:** S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-002  
**Business Impact:** Inability to detect or investigate unauthorized access to deployment artifacts.

### 2. Implement a restrictive bucket policy that explicitly limits access to only the required IAM roles or principals needed for the deployment process.

**Effort:** Low  
**Related Threats:** S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-003  
**Business Impact:** Potential unauthorized access to deployment code which may contain sensitive information such as configuration details or security implementations.

### 2. Remove default values that contain placeholder text and ensure that parameters are explicitly provided during stack creation with appropriate values.

**Effort:** Low  
**Related Threats:** S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-005  
**Business Impact:** Predictable resource names may make it easier for attackers to identify and target specific resources in your environment.

### 3. Implement a lifecycle policy on the bucket to automatically expire and delete objects after they are no longer needed for deployment.

**Effort:** Low  
**Related Threats:** S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-001  
**Business Impact:** Storage of unnecessary data increases costs and potential exposure of outdated artifacts with security vulnerabilities.

### 3. Consider implementing S3 Object Lock in compliance mode to prevent modification of deployment artifacts once they've been uploaded and validated.

**Effort:** Medium  
**Related Threats:** S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-004  
**Business Impact:** Could allow injection of unauthorized changes into deployment packages, leading to deployment of compromised resources.



## Detailed Threat Analysis

## Medium Severity Threats

### S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-002: Missing access logging configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `InitialInstallBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-778

#### Issue
The S3 bucket does not have access logging enabled, which hinders audit capabilities and makes it difficult to track who accessed deployment artifacts.

#### Attack Vector
An attacker who gains access to the bucket could exfiltrate sensitive deployment code without leaving an audit trail.

#### Potential Impact
Inability to detect or investigate unauthorized access to deployment artifacts.

#### Remediation
Enable server access logging on the S3 bucket and direct logs to a secure, dedicated logging bucket.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/ServerLogs.html

---

### S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-003: No resource policy restricting access to the S3 bucket

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `InitialInstallBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-732

#### Issue
The S3 bucket lacks a bucket policy to explicitly restrict access, relying solely on default permissions which could allow broad access within the AWS account.

#### Attack Vector
Any principal with S3 permissions in the AWS account could potentially access sensitive deployment artifacts.

#### Potential Impact
Potential unauthorized access to deployment code which may contain sensitive information such as configuration details or security implementations.

#### Remediation
Implement a restrictive bucket policy that explicitly limits access to only the required IAM roles or principals needed for the deployment process.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-policies.html

---

### S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-005: Default parameter value contains placeholder text

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `InitialInstallBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-798

#### Issue
The default bucket name parameter contains placeholder text ('YOUR_AWS_ACCOUNT-YOUR_REGION') which could lead to insecure implementations if not properly replaced during deployment.

#### Attack Vector
If deployments occur without proper parameter values, buckets could be created with predictable naming conventions that make them easier to target.

#### Potential Impact
Predictable resource names may make it easier for attackers to identify and target specific resources in your environment.

#### Remediation
Remove default values that contain placeholder text and ensure that parameters are explicitly provided during stack creation with appropriate values.

**References:**
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html

---

## Low Severity Threats

### S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-001: Missing lifecycle configuration for deployment bucket

**STRIDE Category:** Tampering  
**Affected Resource:** `InitialInstallBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-693

#### Issue
The S3 bucket does not have a lifecycle configuration defined, which could lead to indefinite retention of temporary deployment artifacts and unnecessary storage costs.

#### Attack Vector
While not directly exploitable, the accumulation of old deployment artifacts increases the attack surface over time as outdated code may contain known vulnerabilities.

#### Potential Impact
Storage of unnecessary data increases costs and potential exposure of outdated artifacts with security vulnerabilities.

#### Remediation
Implement a lifecycle policy on the bucket to automatically expire and delete objects after they are no longer needed for deployment.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html

---

### S3_BUCKET_FOR_INITIAL_DEPLOYMENT-THREAT-004: Missing S3 object lock configuration

**STRIDE Category:** Tampering  
**Affected Resource:** `InitialInstallBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-642

#### Issue
The deployment bucket does not implement S3 Object Lock, which could allow the modification or deletion of critical deployment artifacts by authorized users.

#### Attack Vector
A compromised account with S3 write permissions could tamper with deployment artifacts, potentially injecting malicious code.

#### Potential Impact
Could allow injection of unauthorized changes into deployment packages, leading to deployment of compromised resources.

#### Remediation
Consider implementing S3 Object Lock in compliance mode to prevent modification of deployment artifacts once they've been uploaded and validated.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# scripts-sdlc-cfn-sdlc-iam-role


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-24  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **7** security threats. The analysis reveals **0** critical, **3** high, **4** medium, and **0** low severity findings.

## Priority Actions

### 1. 1. Scope down IAM permissions to specific resources using ARN patterns instead of wildcard resources.
2. Implement condition keys to restrict permissions (e.g., aws:PrincipalArn, aws:SourceIp).
3. Remove high-risk permissions like IAM user management that aren't needed for SDLC activities.
4. Consider using AWS permission boundaries to limit maximum permissions.

**Effort:** Medium  
**Related Threats:** SDLC-ROLE-THREAT-001  
**Business Impact:** Complete account compromise, persistent backdoors, and ability to bypass existing security controls and detection mechanisms.

### 1. 1. Apply strict conditions in the trust policy using aws:SourceArn and aws:SourceAccount.
2. Separate roles by service for granular permission control.
3. Use externalId requirements where applicable.
4. Regularly audit and rotate credentials.

**Effort:** Low  
**Related Threats:** SDLC-ROLE-THREAT-002  
**Business Impact:** Unauthorized access to AWS resources with powerful permissions, allowing potential data exfiltration, resource manipulation, or further privilege escalation.

### 1. 1. Replace PowerUserAccess with more granular, service-specific policies.
2. Implement permission boundaries to restrict maximum permissions.
3. Create separate roles for different SDLC stages with decreasing privilege levels.
4. Implement just-in-time access with temporary credential issuance.

**Effort:** High  
**Related Threats:** SDLC-ROLE-THREAT-003  
**Business Impact:** Potential for complete account takeover, data breaches, and deployment of malicious resources that could affect production environments.

### 2. 1. Ensure CloudTrail is enabled with multi-region logging and log file validation.
2. Set up CloudWatch alarms for critical IAM actions.
3. Configure AWS Config to monitor policy changes.
4. Consider integrating with Security Hub and GuardDuty.

**Effort:** Medium  
**Related Threats:** SDLC-ROLE-THREAT-004  
**Business Impact:** Inability to detect security incidents, account compromise, or policy violations in a timely manner, and challenges in forensic investigation after a security incident.

### 2. 1. Implement a separate admin role for IAM management functions.
2. Use SCPs to prevent modification of security-critical roles and policies.
3. Implement strong detective controls for IAM policy changes.
4. Apply conditions to prevent self-modification of roles.

**Effort:** Medium  
**Related Threats:** SDLC-ROLE-THREAT-005  
**Business Impact:** Security controls could be subverted, leading to privilege escalation, persistent unauthorized access, or removal of security guardrails.

### 2. 1. Implement resource-specific ARNs in policy statements.
2. Add condition keys to protect critical resources.
3. Consider implementing resource tagging strategies and tag-based conditions.
4. Create separate policies for creation vs. deletion operations.

**Effort:** Medium  
**Related Threats:** SDLC-ROLE-THREAT-006  
**Business Impact:** Service disruption, broken deployments, authentication failures, and significant operational downtime while IAM resources are recreated.

### 3. 1. Limit list and get permissions to only necessary resources.
2. Implement condition keys to restrict when these permissions can be used.
3. Consider implementing session policies for temporary access.

**Effort:** Low  
**Related Threats:** SDLC-ROLE-THREAT-007  
**Business Impact:** Exposure of security configuration and potential targeting of specific IAM entities for further attacks, including social engineering or targeted privilege escalation.



## Detailed Threat Analysis

## High Severity Threats

### SDLC-ROLE-THREAT-001: Overly Permissive IAM Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `LimitedIAMAccessPolicy` (AWS::IAM::ManagedPolicy)  
**CWE ID:** CWE-272

#### Issue
The LimitedIAMAccessPolicy grants broad IAM permissions with wildcard resources (*), allowing actions that can be used to escalate privileges or create backdoor access paths.

#### Attack Vector
An attacker who compromises the BuilderRole could create or modify IAM entities with elevated permissions, attach policies to users/groups/roles, or create service-linked roles that persist after the initial compromise.

#### Potential Impact
Complete account compromise, persistent backdoors, and ability to bypass existing security controls and detection mechanisms.

#### Remediation
1. Scope down IAM permissions to specific resources using ARN patterns instead of wildcard resources.
2. Implement condition keys to restrict permissions (e.g., aws:PrincipalArn, aws:SourceIp).
3. Remove high-risk permissions like IAM user management that aren't needed for SDLC activities.
4. Consider using AWS permission boundaries to limit maximum permissions.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html

---

### SDLC-ROLE-THREAT-002: Excessive Service Principals in Trust Policy

**STRIDE Category:** Spoofing  
**Affected Resource:** `BuilderRole` (AWS::IAM::Role)  
**CWE ID:** CWE-284

#### Issue
The BuilderRole trust policy allows multiple service principals (ec2, codebuild, cloudformation) to assume the role without conditions, increasing the attack surface for role assumption.

#### Attack Vector
If any of these services are compromised or misconfigured, an attacker could assume the BuilderRole, gaining extensive permissions provided by PowerUserAccess and the LimitedIAMAccessPolicy.

#### Potential Impact
Unauthorized access to AWS resources with powerful permissions, allowing potential data exfiltration, resource manipulation, or further privilege escalation.

#### Remediation
1. Apply strict conditions in the trust policy using aws:SourceArn and aws:SourceAccount.
2. Separate roles by service for granular permission control.
3. Use externalId requirements where applicable.
4. Regularly audit and rotate credentials.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition.html

---

### SDLC-ROLE-THREAT-003: PowerUserAccess Combined with IAM Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `BuilderRole` (AWS::IAM::Role)  
**CWE ID:** CWE-269

#### Issue
The BuilderRole combines PowerUserAccess with extensive IAM permissions, creating a role that has near-administrative capabilities without proper isolation or guardrails.

#### Attack Vector
An attacker who gains access to this role could leverage the combined permissions to create persistent access, modify security controls, and access sensitive data across multiple AWS services.

#### Potential Impact
Potential for complete account takeover, data breaches, and deployment of malicious resources that could affect production environments.

#### Remediation
1. Replace PowerUserAccess with more granular, service-specific policies.
2. Implement permission boundaries to restrict maximum permissions.
3. Create separate roles for different SDLC stages with decreasing privilege levels.
4. Implement just-in-time access with temporary credential issuance.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

## Medium Severity Threats

### SDLC-ROLE-THREAT-004: Missing Logging and Monitoring Requirements

**STRIDE Category:** Repudiation  
**Affected Resource:** `BuilderRole` (AWS::IAM::Role)  
**CWE ID:** CWE-778

#### Issue
The template does not include or enforce requirements for CloudTrail, CloudWatch, or other logging and monitoring mechanisms for tracking actions performed by the BuilderRole.

#### Attack Vector
An attacker who compromises this role could perform malicious actions without being detected, making incident investigation difficult or impossible.

#### Potential Impact
Inability to detect security incidents, account compromise, or policy violations in a timely manner, and challenges in forensic investigation after a security incident.

#### Remediation
1. Ensure CloudTrail is enabled with multi-region logging and log file validation.
2. Set up CloudWatch alarms for critical IAM actions.
3. Configure AWS Config to monitor policy changes.
4. Consider integrating with Security Hub and GuardDuty.

**References:**
- https://docs.aws.amazon.com/cloudtrail/latest/userguide/best-practices-security.html

---

### SDLC-ROLE-THREAT-005: Role Allows Self-Modification

**STRIDE Category:** Tampering  
**Affected Resource:** `BuilderRole` (AWS::IAM::Role)  
**CWE ID:** CWE-281

#### Issue
The BuilderRole permissions allow for modification of IAM policies and roles, potentially including itself, which could be used to expand permissions beyond intended scope.

#### Attack Vector
An authorized user or compromised process could modify the role to grant additional permissions, remove restrictions, or create backdoor access paths.

#### Potential Impact
Security controls could be subverted, leading to privilege escalation, persistent unauthorized access, or removal of security guardrails.

#### Remediation
1. Implement a separate admin role for IAM management functions.
2. Use SCPs to prevent modification of security-critical roles and policies.
3. Implement strong detective controls for IAM policy changes.
4. Apply conditions to prevent self-modification of roles.

**References:**
- https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps.html

---

### SDLC-ROLE-THREAT-006: Missing Resource Access Controls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `LimitedIAMAccessPolicy` (AWS::IAM::ManagedPolicy)  
**CWE ID:** CWE-732

#### Issue
The policy grants delete permissions for critical IAM resources without resource-specific constraints, which could lead to accidental or malicious removal of essential roles or policies.

#### Attack Vector
An attacker or misconfigured automation tool could delete critical IAM roles, instance profiles, or policies, disrupting application services and CI/CD workflows.

#### Potential Impact
Service disruption, broken deployments, authentication failures, and significant operational downtime while IAM resources are recreated.

#### Remediation
1. Implement resource-specific ARNs in policy statements.
2. Add condition keys to protect critical resources.
3. Consider implementing resource tagging strategies and tag-based conditions.
4. Create separate policies for creation vs. deletion operations.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/access_controlling.html

---

### SDLC-ROLE-THREAT-007: Excessive List and Get Permissions

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `LimitedIAMAccessPolicy` (AWS::IAM::ManagedPolicy)  
**CWE ID:** CWE-200

#### Issue
The policy grants broad list and get permissions (iam:List*, iam:Get*) across all IAM resources, which could expose sensitive IAM configuration information.

#### Attack Vector
An attacker with access to the role could enumerate all IAM users, roles, policies, and their relationships to map the security posture and identify privilege escalation paths.

#### Potential Impact
Exposure of security configuration and potential targeting of specific IAM entities for further attacks, including social engineering or targeted privilege escalation.

#### Remediation
1. Limit list and get permissions to only necessary resources.
2. Implement condition keys to restrict when these permissions can be used.
3. Consider implementing session policies for temporary access.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

# template


**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-28  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **15** security threats. The analysis reveals **0** critical, **2** high, **10** medium, and **3** low severity findings.

## Priority Actions

### 1. Restrict the IAM policy to only allow actions on specific resources by replacing the '*' wildcard with ARNs of the specific Cognito user pool and SageMaker workteam resources needed.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-006  
**Business Impact:** Potential for unauthorized modifications to authentication configurations or SageMaker workteams across the entire AWS account.

### 1. Add a policy statement to all SQS queues that denies any action when the secure transport condition is not met, similar to what is done for the DocumentQueueDLQPolicy but consistently for all queues.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-010  
**Business Impact:** Potential exposure of sensitive information contained in queue messages during transit.

### 2. Enable MFA for the Cognito User Pool by configuring MfaConfiguration to 'ON' or 'OPTIONAL', and consider requiring MFA for sensitive operations.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-002  
**Business Impact:** Increased risk of unauthorized account access and potential exposure of sensitive information or unauthorized actions.

### 2. Scope down the CloudWatch Logs permissions to specific log groups and restrict the actions to only those that are required (e.g., CreateLogGroup, CreateLogStream, PutLogEvents) rather than using the '*' wildcard.

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-003  
**Business Impact:** Potential for unauthorized access to sensitive log data, tampering with audit trails, or deletion of important logging information.

### 2. Enable AWS WAF by configuring appropriate IP restrictions through the WAFAllowedIPv4Ranges parameter or implement a comprehensive WAF ruleset to protect against common web vulnerabilities.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-009  
**Business Impact:** Increased vulnerability to common web application attacks that could lead to data theft, unauthorized access, or service disruption.

### 2. Configure reserved concurrency for critical Lambda functions to ensure they always have capacity to run, and consider adding provisioned concurrency for functions with predictable traffic patterns.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-012  
**Business Impact:** Potential service disruption if a high-volume Lambda function consumes all available concurrency, affecting the availability of other functions in the account.

### 2. Restrict the IAM policy to only allow actions on specific SageMaker resources by replacing the '*' wildcard with ARNs of the specific resources needed.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-013  
**Business Impact:** Potential for unauthorized access to SageMaker resources, disruption of machine learning workloads, or exposure of sensitive data in SageMaker environments.

### 2. Implement content filtering or redaction mechanisms before documents are indexed in the knowledge base, and consider adding data classification checks to prevent sensitive documents from being indexed.

**Effort:** High  
**Related Threats:** GENAI-IDP-THREAT-014  
**Business Impact:** Potential unintended disclosure of sensitive information contained in processed documents, which could lead to data breaches or compliance violations.

### 3. Consider using a custom SSL certificate via AWS Certificate Manager and configuring a custom domain name for the CloudFront distribution.

**Effort:** Medium  
**Related Threats:** GENAI-IDP-THREAT-001  
**Business Impact:** Reduced trust from users who may question the authenticity of the site when seeing the CloudFront domain rather than a branded domain.

### 3. Add a bucket policy condition to deny PutObject requests that don't include appropriate encryption headers (x-amz-server-side-encryption).

**Effort:** Low  
**Related Threats:** GENAI-IDP-THREAT-004  
**Business Impact:** Risk of unencrypted sensitive data being stored, which could violate data protection requirements or compliance standards.



## Detailed Threat Analysis

## High Severity Threats

### GENAI-IDP-THREAT-006: Overly Permissive IAM Role for Cognito and SageMaker

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `CognitoClientUpdaterRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The CognitoClientUpdaterRole has permissions to perform actions on any Cognito and SageMaker resource ('*') rather than being scoped to specific resources. This violates the principle of least privilege.

#### Attack Vector
If this role is compromised, an attacker could potentially modify any Cognito user pool or SageMaker workteam in the account, enabling unauthorized access or disruption of services.

#### Potential Impact
Potential for unauthorized modifications to authentication configurations or SageMaker workteams across the entire AWS account.

#### Remediation
Restrict the IAM policy to only allow actions on specific resources by replacing the '*' wildcard with ARNs of the specific Cognito user pool and SageMaker workteam resources needed.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-010: Missing SQS Queue Policy to Enforce Encrypted Transport

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DocumentQueue, DocumentQueueDLQ, QueueSenderDLQ, WorkflowTrackerDLQ, EvaluationFunctionDLQ` (AWS::SQS::Queue)  
**CWE ID:** CWE-319

#### Issue
While the SQS queues have server-side encryption enabled with KMS, some queues are missing policies to enforce encrypted transport (SSL/TLS), potentially allowing unencrypted connections.

#### Attack Vector
An attacker with network access could potentially intercept queue messages sent over unencrypted connections, compromising the confidentiality of the data.

#### Potential Impact
Potential exposure of sensitive information contained in queue messages during transit.

#### Remediation
Add a policy statement to all SQS queues that denies any action when the secure transport condition is not met, similar to what is done for the DocumentQueueDLQPolicy but consistently for all queues.

**References:**
- https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-security-best-practices.html

---

## Medium Severity Threats

### GENAI-IDP-THREAT-001: CloudFront Distribution Using Default Certificate

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `CloudFrontDistribution` (AWS::CloudFront::Distribution)  
**CWE ID:** CWE-295

#### Issue
The CloudFront distribution is using the default CloudFront certificate (CloudFrontDefaultCertificate: true) rather than a custom certificate. While this provides HTTPS, it doesn't validate the specific domain ownership to users.

#### Attack Vector
An attacker could potentially create a similar-looking domain and phish users by exploiting their trust in the AWS domain.

#### Potential Impact
Reduced trust from users who may question the authenticity of the site when seeing the CloudFront domain rather than a branded domain.

#### Remediation
Consider using a custom SSL certificate via AWS Certificate Manager and configuring a custom domain name for the CloudFront distribution.

**References:**
- https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https.html

---

### GENAI-IDP-THREAT-002: No MFA Requirement for Cognito User Pool

**STRIDE Category:** Authentication  
**Affected Resource:** `UserPool` (AWS::Cognito::UserPool)  
**CWE ID:** CWE-308

#### Issue
The Cognito User Pool is configured without requiring multi-factor authentication (MFA), which leaves user accounts more vulnerable to credential-based attacks.

#### Attack Vector
An attacker who obtains a user's credentials through phishing or other means could gain complete access to the account without the additional security layer that MFA provides.

#### Potential Impact
Increased risk of unauthorized account access and potential exposure of sensitive information or unauthorized actions.

#### Remediation
Enable MFA for the Cognito User Pool by configuring MfaConfiguration to 'ON' or 'OPTIONAL', and consider requiring MFA for sensitive operations.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html

---

### GENAI-IDP-THREAT-003: Overly Permissive CloudWatch Logs IAM Policy

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `StartUICodeBuildExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The StartUICodeBuildExecutionRole has overly broad permissions for CloudWatch Logs actions ('logs:*') on all resources ('*'). This violates the principle of least privilege.

#### Attack Vector
If this role is compromised, an attacker could read, modify or delete any CloudWatch Logs in the account, potentially hiding their activities or accessing sensitive information in logs.

#### Potential Impact
Potential for unauthorized access to sensitive log data, tampering with audit trails, or deletion of important logging information.

#### Remediation
Scope down the CloudWatch Logs permissions to specific log groups and restrict the actions to only those that are required (e.g., CreateLogGroup, CreateLogStream, PutLogEvents) rather than using the '*' wildcard.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/iam-identity-based-access-control-cwl.html

---

### GENAI-IDP-THREAT-004: Missing Bucket Policy to Enforce Object Encryption

**STRIDE Category:** Tampering  
**Affected Resource:** `LoggingBucketPolicy` (AWS::S3::BucketPolicy)  
**CWE ID:** CWE-311

#### Issue
While the LoggingBucket has server-side encryption enabled, the bucket policy does not enforce encryption for object uploads. This could allow unencrypted objects to be uploaded to the bucket.

#### Attack Vector
An authenticated user with upload permissions could potentially upload unencrypted sensitive data to the bucket, bypassing the encryption requirements.

#### Potential Impact
Risk of unencrypted sensitive data being stored, which could violate data protection requirements or compliance standards.

#### Remediation
Add a bucket policy condition to deny PutObject requests that don't include appropriate encryption headers (x-amz-server-side-encryption).

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-policies-examples-encryption.html

---

### GENAI-IDP-THREAT-005: Inconsistent CloudWatch Logs Encryption

**STRIDE Category:** Repudiation  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Lambda::Function)  
**CWE ID:** CWE-311

#### Issue
While many Lambda function log groups are configured with KMS encryption, some log groups do not have explicit KMS encryption configuration. This inconsistency could lead to some logs being stored without proper encryption.

#### Attack Vector
An attacker with access to unencrypted logs could potentially access sensitive information or manipulate log data without detection.

#### Potential Impact
Potential exposure of sensitive information in logs and inability to definitively prove the integrity of log data, affecting non-repudiation capabilities.

#### Remediation
Ensure all Lambda function log groups are consistently encrypted with the CustomerManagedEncryptionKey by explicitly configuring KmsKeyId for every LogGroup resource.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/encrypt-log-data-kms.html

---

### GENAI-IDP-THREAT-009: CloudFront Web Application Without WAF Protection

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `CloudFrontDistribution` (AWS::CloudFront::Distribution)  
**CWE ID:** CWE-1021

#### Issue
The CloudFront distribution does not have AWS WAF configured by default (the WAFAllowedIPv4Ranges parameter defaults to '0.0.0.0/0', which disables WAF). This leaves the web application vulnerable to common web application attacks.

#### Attack Vector
Attackers could perform SQL injection, cross-site scripting (XSS), or other common web attacks against the application without the protection that AWS WAF would provide.

#### Potential Impact
Increased vulnerability to common web application attacks that could lead to data theft, unauthorized access, or service disruption.

#### Remediation
Enable AWS WAF by configuring appropriate IP restrictions through the WAFAllowedIPv4Ranges parameter or implement a comprehensive WAF ruleset to protect against common web vulnerabilities.

**References:**
- https://docs.aws.amazon.com/waf/latest/developerguide/cloudfront-features.html

---

### GENAI-IDP-THREAT-011: Inconsistent Lambda Function Log Retention Periods

**STRIDE Category:** Repudiation  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
Some Lambda functions have explicitly configured log retention periods, while others rely on default settings. This inconsistency could lead to premature deletion of important log data or unnecessary storage costs.

#### Attack Vector
A malicious actor's activities might not be traceable if logs are deleted before security investigations can take place due to short retention periods.

#### Potential Impact
Potential loss of important audit trail information, making security investigations and compliance verification more difficult.

#### Remediation
Ensure all Lambda function log groups have consistent retention periods based on organizational security and compliance requirements by explicitly setting RetentionInDays for every LogGroup resource.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html

---

### GENAI-IDP-THREAT-012: Lambda Functions Without Reserved Concurrency

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Lambda::Function)  
**CWE ID:** CWE-400

#### Issue
Most Lambda functions in the template do not have reserved concurrency configured, which could lead to resource exhaustion if one function consumes all available Lambda concurrency in the AWS account.

#### Attack Vector
A sudden spike in requests to one function could consume all available concurrency, preventing other Lambda functions from executing and causing a denial of service for other parts of the application.

#### Potential Impact
Potential service disruption if a high-volume Lambda function consumes all available concurrency, affecting the availability of other functions in the account.

#### Remediation
Configure reserved concurrency for critical Lambda functions to ensure they always have capacity to run, and consider adding provisioned concurrency for functions with predictable traffic patterns.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### GENAI-IDP-THREAT-013: Overly Permissive IAM Policy for SageMaker Operations

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `A2IHumanTaskUILambdaRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The A2IHumanTaskUILambdaRole has broad permissions for SageMaker operations on all resources ('*') rather than being limited to specific resources.

#### Attack Vector
If this role is compromised, an attacker could potentially create, modify, or delete any SageMaker resource in the account.

#### Potential Impact
Potential for unauthorized access to SageMaker resources, disruption of machine learning workloads, or exposure of sensitive data in SageMaker environments.

#### Remediation
Restrict the IAM policy to only allow actions on specific SageMaker resources by replacing the '*' wildcard with ARNs of the specific resources needed.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### GENAI-IDP-THREAT-014: Potential Sensitive Data Exposure Through Knowledge Base

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DOCUMENTBEDROCKKB` (AWS::Bedrock::KnowledgeBase)  
**CWE ID:** CWE-200

#### Issue
The template creates a Bedrock Knowledge Base (DOCUMENTBEDROCKKB) that processes documents from the OutputBucket, but there are no explicit controls to prevent sensitive information from being indexed and potentially exposed through knowledge base queries.

#### Attack Vector
An authorized user could potentially query the knowledge base to extract sensitive information that was not intended to be exposed through the knowledge base interface.

#### Potential Impact
Potential unintended disclosure of sensitive information contained in processed documents, which could lead to data breaches or compliance violations.

#### Remediation
Implement content filtering or redaction mechanisms before documents are indexed in the knowledge base, and consider adding data classification checks to prevent sensitive documents from being indexed.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base.html

---

## Low Severity Threats

### GENAI-IDP-THREAT-007: Missing Request Limiting for AppSync API

**STRIDE Category:** Denial of Service  
**Affected Resource:** `GraphQLApi` (AWS::AppSync::GraphQLApi)  
**CWE ID:** CWE-770

#### Issue
The AppSync GraphQL API does not have explicit request throttling or rate limiting configured, which could make it vulnerable to abuse or denial of service attacks.

#### Attack Vector
An attacker could make a large number of API requests to exhaust resources or increase costs, potentially affecting availability for legitimate users.

#### Potential Impact
Potential for service degradation, increased costs, or resource exhaustion leading to denial of service for legitimate users.

#### Remediation
Configure appropriate request throttling limits for the AppSync API using AWS WAF rate-based rules or AppSync's QueryDepthLimit and ResolverQueryLimit settings.

**References:**
- https://docs.aws.amazon.com/appsync/latest/devguide/security-authorization.html

---

### GENAI-IDP-THREAT-008: Short Token Validity Period for Cognito User Pool

**STRIDE Category:** Spoofing  
**Affected Resource:** `UserPoolClient` (AWS::Cognito::UserPoolClient)  
**CWE ID:** CWE-613

#### Issue
The UserPoolClient has a very short token validity period (IdTokenValidity and AccessTokenValidity set to 1), which could lead to frequent re-authentication and potentially encourage insecure practices like token caching.

#### Attack Vector
Frequent token expiration might lead developers to implement insecure token handling practices, such as client-side caching of credentials, making the application more susceptible to session hijacking.

#### Potential Impact
Potential for reduced security if developers implement workarounds for the frequent token expiration, or poor user experience due to frequent re-authentication requirements.

#### Remediation
Consider increasing the token validity period to a more reasonable value (e.g., 60 minutes for access tokens) while implementing proper token refresh mechanisms and secure token storage practices.

**References:**
- https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-with-identity-providers.html

---

### GENAI-IDP-THREAT-015: WebUI Bucket Missing Object Lock Configuration

**STRIDE Category:** Tampering  
**Affected Resource:** `WebUIBucket` (AWS::S3::Bucket)  
**CWE ID:** CWE-434

#### Issue
The WebUIBucket, which hosts the web application static content, does not have Object Lock enabled, potentially allowing unauthorized modifications to the web application files if access controls are compromised.

#### Attack Vector
An attacker who gains access to the bucket could modify web application files to inject malicious code that would be served to users.

#### Potential Impact
Potential for serving modified or malicious web content to users if the bucket access controls are compromised.

#### Remediation
Consider enabling Object Lock on the WebUIBucket in compliance mode with a retention period that matches deployment cycles to prevent unauthorized modifications between legitimate deployments.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*

