# CloudFormation Threat Model Report

**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-55  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **1** low severity findings.

## Priority Actions

### 1. Implement strict input validation and sanitization for all document content before sending to LLMs. Use guardrails and implement prompt engineering best practices to reduce the risk of injection attacks.

**Effort:** High  
**Related Threats:** AWS-GENAI-IDP-THREAT-007  
**Business Impact:** Successful prompt injection could lead to data leakage, incorrect document processing, or manipulation of the document classification/extraction process.

### 1. Make guardrails mandatory for production deployments. Implement a default guardrail with appropriate security controls if custom guardrails aren't specified.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-009  
**Business Impact:** Potential data leakage, PII exposure, or manipulation of the document processing workflow through crafted inputs.

### 2. Review the log queries in the dashboard to ensure they filter out sensitive information. Consider implementing log field redaction for sensitive data using CloudWatch Logs pattern filtering.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-002  
**Business Impact:** Unauthorized exposure of document contents or metadata to users with dashboard access but who shouldn't have access to document content.

### 2. Restrict S3 access to specific prefixes or paths that the function needs, rather than granting access to the entire bucket. Use more specific resource ARNs in the IAM policy.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-THREAT-003  
**Business Impact:** Unauthorized access to sensitive documents stored in S3 buckets, violating the principle of least privilege.

### 2. Add CloudWatch Alarms for critical metrics such as error rates, duration, throttling events, and invocation counts. Configure alerting to notify operations personnel of potential issues.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-005  
**Business Impact:** Delayed detection of attacks or failures in the document processing workflow, potentially allowing data loss or corruption without timely intervention.

### 2. Implement DynamoDB condition expressions in application code to ensure proper version checking. Consider implementing a change history mechanism for critical metadata changes.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-006  
**Business Impact:** Data integrity issues in the metadata table could lead to incorrect processing of documents, bypassing controls, or manipulation of processing results.

### 2. Implement client-side throttling, backoff mechanisms, and concurrency controls for Bedrock API calls. Consider implementing a queue-based architecture to smooth out request spikes.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-008  
**Business Impact:** Service degradation or outage of document processing capabilities, leading to business process disruption and potential SLA violations.

### 2. Implement comprehensive input validation for all incoming documents, including file type validation, size limits, content scanning, and structural validation before processing.

**Effort:** Medium  
**Related Threats:** AWS-GENAI-IDP-THREAT-010  
**Business Impact:** Potential for code injection, system crashes, or other unexpected behaviors in the document processing pipeline.

### 3. Consider reducing the logging level to ERROR or other appropriate level for production use. Set 'IncludeExecutionData' to false unless the full execution data is required for debugging.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-THREAT-001  
**Business Impact:** Potential exposure of sensitive information contained in processed documents to anyone with CloudWatch logs access permissions.

### 3. Add a Dead Letter Queue (SQS or SNS) to capture failed invocations and enable proper handling of failed document processing attempts.

**Effort:** Low  
**Related Threats:** AWS-GENAI-IDP-THREAT-004  
**Business Impact:** Failed processing events would be lost without notification, potentially leading to documents being stalled in processing pipelines and business process disruption.



## Detailed Threat Analysis

## High Severity Threats

### AWS-GENAI-IDP-THREAT-007: Potential LLM Prompt Injection Risk

**STRIDE Category:** Spoofing  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-74

#### Issue
The ProcessResultsFunction appears to process input documents and send them to LLMs via Bedrock. Without proper input sanitization, this creates a risk of prompt injection attacks where malicious content in documents could manipulate the LLM behavior.

#### Attack Vector
An attacker could submit documents with specially crafted content that overrides or manipulates prompt instructions, potentially causing the LLM to execute unwanted actions or expose information.

#### Potential Impact
Successful prompt injection could lead to data leakage, incorrect document processing, or manipulation of the document classification/extraction process.

#### Remediation
Implement strict input validation and sanitization for all document content before sending to LLMs. Use guardrails and implement prompt engineering best practices to reduce the risk of injection attacks.

**References:**
- https://owasp.org/www-project-top-10-for-large-language-model-applications/

---

### AWS-GENAI-IDP-THREAT-009: Optional Guardrail Configuration for LLM Interactions

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-284

#### Issue
The BedrockGuardrailId and BedrockGuardrailVersion parameters are optional, allowing deployment without guardrails for LLM interactions. This could lead to data leakage or other LLM vulnerabilities if not properly configured.

#### Attack Vector
Without guardrails, an attacker could craft documents with content designed to extract information, bypass restrictions, or cause other unintended behaviors from the LLM.

#### Potential Impact
Potential data leakage, PII exposure, or manipulation of the document processing workflow through crafted inputs.

#### Remediation
Make guardrails mandatory for production deployments. Implement a default guardrail with appropriate security controls if custom guardrails aren't specified.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails.html

---

## Medium Severity Threats

### AWS-GENAI-IDP-THREAT-002: Potential Sensitive Data Exposure in CloudWatch Dashboards

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-209

#### Issue
The CloudWatch dashboard includes log widgets that display error messages and request data. These logs might contain sensitive information from processed documents that could be visible to anyone with dashboard access.

#### Attack Vector
An attacker with access to the CloudWatch dashboard could view potentially sensitive document information in error logs or request data.

#### Potential Impact
Unauthorized exposure of document contents or metadata to users with dashboard access but who shouldn't have access to document content.

#### Remediation
Review the log queries in the dashboard to ensure they filter out sensitive information. Consider implementing log field redaction for sensitive data using CloudWatch Logs pattern filtering.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---

### AWS-GENAI-IDP-THREAT-003: Overly Permissive S3 Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `HITLProcessLambdaRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The HITLProcessLambdaRole has GetObject permissions on the entire input and working buckets, which may provide excessive access beyond what's needed for the specific function.

#### Attack Vector
If the Lambda function is compromised, an attacker could access all objects in the input and working buckets, potentially exposing sensitive documents beyond the scope of what the function needs.

#### Potential Impact
Unauthorized access to sensitive documents stored in S3 buckets, violating the principle of least privilege.

#### Remediation
Restrict S3 access to specific prefixes or paths that the function needs, rather than granting access to the entire bucket. Use more specific resource ARNs in the IAM policy.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### AWS-GENAI-IDP-THREAT-004: Missing Dead Letter Queue for Lambda Function

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `HITLStatusUpdateFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-755

#### Issue
The HITLStatusUpdateFunction does not have a Dead Letter Queue configured, which could lead to silent failures and loss of document processing events.

#### Attack Vector
Not a direct attack vector, but could be exploited as part of a denial of service attack if an attacker can cause the function to fail repeatedly.

#### Potential Impact
Failed processing events would be lost without notification, potentially leading to documents being stalled in processing pipelines and business process disruption.

#### Remediation
Add a Dead Letter Queue (SQS or SNS) to capture failed invocations and enable proper handling of failed document processing attempts.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html#dlq

---

### AWS-GENAI-IDP-THREAT-005: Insufficient Monitoring for Critical Document Processing Function

**STRIDE Category:** Repudiation  
**Affected Resource:** `InvokeBDAFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
While logging is configured, there are no specific CloudWatch Alarms or monitoring for error rates, throttling, or critical failures in this core document processing function.

#### Attack Vector
Attacks targeting the document processing pipeline might go undetected for extended periods without proper monitoring and alerting.

#### Potential Impact
Delayed detection of attacks or failures in the document processing workflow, potentially allowing data loss or corruption without timely intervention.

#### Remediation
Add CloudWatch Alarms for critical metrics such as error rates, duration, throttling events, and invocation counts. Configure alerting to notify operations personnel of potential issues.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html

---

### AWS-GENAI-IDP-THREAT-006: Missing Condition Checks for DynamoDB Operations

**STRIDE Category:** Tampering  
**Affected Resource:** `BDAMetadataTable` (AWS::DynamoDB::Table)  
**CWE ID:** CWE-367

#### Issue
The functions that interact with BDAMetadataTable have full CRUD permissions without conditional checks or version controls, which could allow for unintended modifications or race conditions.

#### Attack Vector
An attacker who compromises a Lambda function could modify metadata records without proper validation, potentially manipulating the document processing flow.

#### Potential Impact
Data integrity issues in the metadata table could lead to incorrect processing of documents, bypassing controls, or manipulation of processing results.

#### Remediation
Implement DynamoDB condition expressions in application code to ensure proper version checking. Consider implementing a change history mechanism for critical metadata changes.

**References:**
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ConditionExpressions.html

---

### AWS-GENAI-IDP-THREAT-008: Missing Throttling Controls for Bedrock API Calls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
The SummarizationFunction makes calls to Bedrock APIs without explicit throttling or rate limiting, potentially leading to API throttling and service disruption during high load scenarios.

#### Attack Vector
An attacker could flood the system with document processing requests, causing Bedrock API throttling and disrupting the entire document processing pipeline.

#### Potential Impact
Service degradation or outage of document processing capabilities, leading to business process disruption and potential SLA violations.

#### Remediation
Implement client-side throttling, backoff mechanisms, and concurrency controls for Bedrock API calls. Consider implementing a queue-based architecture to smooth out request spikes.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/quotas.html

---

### AWS-GENAI-IDP-THREAT-010: Missing Input Validation for Document Processing

**STRIDE Category:** Tampering  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
The template doesn't show explicit input validation mechanisms for documents being processed, potentially allowing malformed or malicious documents to be processed by the system.

#### Attack Vector
An attacker could submit specially crafted documents designed to exploit vulnerabilities in the document processing pipeline or downstream systems.

#### Potential Impact
Potential for code injection, system crashes, or other unexpected behaviors in the document processing pipeline.

#### Remediation
Implement comprehensive input validation for all incoming documents, including file type validation, size limits, content scanning, and structural validation before processing.

**References:**
- https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html

---

## Low Severity Threats

### AWS-GENAI-IDP-THREAT-001: Excessive Logging for State Machine Executions

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-532

#### Issue
The State Machine is configured with 'IncludeExecutionData' set to true and 'Level' set to ALL. This may log sensitive document data processed by the workflow, potentially exposing confidential information in CloudWatch logs.

#### Attack Vector
An attacker with access to CloudWatch logs could view sensitive document data that was processed through the state machine.

#### Potential Impact
Potential exposure of sensitive information contained in processed documents to anyone with CloudWatch logs access permissions.

#### Remediation
Consider reducing the logging level to ERROR or other appropriate level for production use. Set 'IncludeExecutionData' to false unless the full execution data is required for debugging.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-logs.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*