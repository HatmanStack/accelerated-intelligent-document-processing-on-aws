# CloudFormation Threat Model Report

**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-02  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **10** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **1** low severity findings.

## Priority Actions

### 1. Set IncludeExecutionData to false for the state machine logging configuration, and implement specific, controlled logging at the individual Lambda function level with proper data filtering.

**Effort:** Low  
**Related Threats:** PATTERN2-SUBSET-THREAT-001  
**Business Impact:** Unauthorized exposure of sensitive document data which could lead to data leakage, privacy violations, or regulatory non-compliance.

### 1. Restrict Textract permissions to only those APIs actually needed (DetectDocumentText and AnalyzeDocument) and implement resource-based constraints where possible.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-002  
**Business Impact:** Potential for privilege escalation, allowing attackers to perform unauthorized Textract operations on any document in the account.

### 2. Restrict Bedrock permissions to only the specific models needed by each function. Replace 'arn:aws:bedrock:*::foundation-model/*' with specific model ARNs.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-003  
**Business Impact:** Potential for unauthorized access to sensitive AI models, excessive cost generation, or using more powerful models for data extraction than intended.

### 2. Implement prefix-based access controls for S3 buckets, giving each Lambda function access only to the specific prefixes (folders) it needs to operate.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-004  
**Business Impact:** Data integrity issues, potential for denial of service by removing working files, or insertion of malicious content into the document processing pipeline.

### 2. Set appropriate maximum concurrency limits for each Lambda function to prevent resource exhaustion, and consider implementing throttling at the workflow entry point.

**Effort:** Low  
**Related Threats:** PATTERN2-SUBSET-THREAT-007  
**Business Impact:** Potential denial of service for other applications sharing the same AWS account, or excessive costs from unbounded Lambda execution.

### 2. Store sensitive configuration in AWS Secrets Manager or Parameter Store with encryption, and retrieve them at runtime. Consider implementing environment variable encryption for Lambda.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-008  
**Business Impact:** Exposure of internal system architecture, API endpoints, and configuration that could facilitate further attacks.

### 2. Ensure the UpdateConfigurationFunction implements strict input validation for all schema inputs and handles them as data, not executable code.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-009  
**Business Impact:** Potential execution of unauthorized code within the context of the custom resource's Lambda function.

### 3. Add a constraint to the LogRetentionDays parameter with a minimum value that meets compliance requirements, and ensure a reasonable default value is set.

**Effort:** Low  
**Related Threats:** PATTERN2-SUBSET-THREAT-005  
**Business Impact:** Potential loss of audit trails, hampering incident investigation and creating compliance violations for required log retention periods.

### 3. Implement proper IAM restrictions for dashboard access and ensure error logs shown in the dashboard don't include sensitive document content.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-006  
**Business Impact:** Unauthorized exposure of document content, processing metadata, or system configuration that could aid in further attacks.

### 3. Implement checksums or digital signatures for intermediate processing artifacts and validate them before finalizing results.

**Effort:** Medium  
**Related Threats:** PATTERN2-SUBSET-THREAT-010  
**Business Impact:** Tampering with document processing results could lead to incorrect data extraction, potentially impacting business decisions based on this data.



## Detailed Threat Analysis

## High Severity Threats

### PATTERN2-SUBSET-THREAT-002: Overly Permissive IAM Policies in OCR Lambda Function

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has a policy statement that grants permissions to all Textract APIs with a wildcard resource ('*'). This violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these permissions to access Textract services across all regions and accounts where the credentials are valid.

#### Potential Impact
Potential for privilege escalation, allowing attackers to perform unauthorized Textract operations on any document in the account.

#### Remediation
Restrict Textract permissions to only those APIs actually needed (DetectDocumentText and AnalyzeDocument) and implement resource-based constraints where possible.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### PATTERN2-SUBSET-THREAT-008: Potential Data Leakage in Lambda Environment Variables

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-527

#### Issue
Multiple Lambda functions contain sensitive configuration parameters in environment variables, including API URLs and service configurations that could be exposed if the Lambda runtime is compromised.

#### Attack Vector
An attacker who can execute code in the Lambda environment (through dependency injection or similar) could access environment variables containing sensitive configuration data.

#### Potential Impact
Exposure of internal system architecture, API endpoints, and configuration that could facilitate further attacks.

#### Remediation
Store sensitive configuration in AWS Secrets Manager or Parameter Store with encryption, and retrieve them at runtime. Consider implementing environment variable encryption for Lambda.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html#configuration-envvars-encryption

---

## Medium Severity Threats

### PATTERN2-SUBSET-THREAT-001: Sensitive Document Data Exposure Through State Machine Execution History

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-200

#### Issue
The DocumentProcessingStateMachine has logging configured with IncludeExecutionData set to true, which logs all input/output data. This may include sensitive information from processed documents.

#### Attack Vector
An attacker with access to CloudWatch logs could view potentially sensitive document content that was passed between steps in the workflow.

#### Potential Impact
Unauthorized exposure of sensitive document data which could lead to data leakage, privacy violations, or regulatory non-compliance.

#### Remediation
Set IncludeExecutionData to false for the state machine logging configuration, and implement specific, controlled logging at the individual Lambda function level with proper data filtering.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/cloudwatch-log-level.html

---

### PATTERN2-SUBSET-THREAT-003: Excessive Bedrock Model Access Across Lambda Functions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
Multiple Lambda functions (OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, SummarizationFunction) have broad access to all Bedrock foundation models and inference profiles through wildcard resources.

#### Attack Vector
If any of these functions were compromised, an attacker could potentially use credentials to access any Bedrock model available in the account, possibly incurring high costs or accessing more powerful models than intended.

#### Potential Impact
Potential for unauthorized access to sensitive AI models, excessive cost generation, or using more powerful models for data extraction than intended.

#### Remediation
Restrict Bedrock permissions to only the specific models needed by each function. Replace 'arn:aws:bedrock:*::foundation-model/*' with specific model ARNs.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### PATTERN2-SUBSET-THREAT-004: Cross-Lambda Bucket Access Without Resource Isolation

**STRIDE Category:** Tampering  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-284

#### Issue
Multiple Lambda functions have full read/write access to the same S3 buckets (WorkingBucket, OutputBucket) without proper resource-level isolation, which could allow one compromised function to tamper with data from other functions.

#### Attack Vector
A compromised Lambda could modify or delete files created by other Lambdas in the workflow, potentially corrupting document processing results.

#### Potential Impact
Data integrity issues, potential for denial of service by removing working files, or insertion of malicious content into the document processing pipeline.

#### Remediation
Implement prefix-based access controls for S3 buckets, giving each Lambda function access only to the specific prefixes (folders) it needs to operate.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_s3_rw-bucket-prefix.html

---

### PATTERN2-SUBSET-THREAT-005: Insufficient CloudWatch Logs Retention Configuration

**STRIDE Category:** Repudiation  
**Affected Resource:** `Multiple Log Groups` (AWS::Logs::LogGroup)  
**CWE ID:** CWE-778

#### Issue
While CloudWatch log groups are configured with a retention period via the LogRetentionDays parameter, there's no validation or default setting to ensure compliance with data retention requirements.

#### Attack Vector
An attacker who gains access to CloudFormation could set a very short retention period, causing logs to be deleted quickly and eliminating evidence of malicious activity.

#### Potential Impact
Potential loss of audit trails, hampering incident investigation and creating compliance violations for required log retention periods.

#### Remediation
Add a constraint to the LogRetentionDays parameter with a minimum value that meets compliance requirements, and ensure a reasonable default value is set.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html

---

### PATTERN2-SUBSET-THREAT-006: Sensitive Information Exposure in CloudWatch Dashboard

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-200

#### Issue
The CloudWatch Dashboard may display error logs containing sensitive information from document processing, and lacks access controls to restrict who can view this dashboard.

#### Attack Vector
Users with CloudWatch access could view the dashboard and see potentially sensitive information from document errors or processing details.

#### Potential Impact
Unauthorized exposure of document content, processing metadata, or system configuration that could aid in further attacks.

#### Remediation
Implement proper IAM restrictions for dashboard access and ensure error logs shown in the dashboard don't include sensitive document content.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch-dashboard-access-control.html

---

### PATTERN2-SUBSET-THREAT-007: Missing Concurrency Limits on Document Processing Lambda Functions

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
Lambda functions in the document processing workflow don't have reserved or maximum concurrency settings, which could lead to resource exhaustion under high load.

#### Attack Vector
An attacker could submit a large number of documents for processing simultaneously, causing the system to consume all available Lambda concurrency in the account.

#### Potential Impact
Potential denial of service for other applications sharing the same AWS account, or excessive costs from unbounded Lambda execution.

#### Remediation
Set appropriate maximum concurrency limits for each Lambda function to prevent resource exhaustion, and consider implementing throttling at the workflow entry point.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### PATTERN2-SUBSET-THREAT-009: Potential Code Injection in Custom Resource Configuration

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `UpdateSchemaConfig` (AWS::CloudFormation::CustomResource)  
**CWE ID:** CWE-94

#### Issue
The UpdateSchemaConfig custom resource contains complex JSON schema definitions that are processed by a custom resource. This could potentially be vulnerable to code injection if not properly validated.

#### Attack Vector
An attacker with access to CloudFormation could attempt to inject malicious code or commands into the schema definitions that might be evaluated during template processing.

#### Potential Impact
Potential execution of unauthorized code within the context of the custom resource's Lambda function.

#### Remediation
Ensure the UpdateConfigurationFunction implements strict input validation for all schema inputs and handles them as data, not executable code.

**References:**
- https://owasp.org/www-community/attacks/Code_Injection

---

## Low Severity Threats

### PATTERN2-SUBSET-THREAT-010: Missing Integrity Validation in Document Processing Results

**STRIDE Category:** Tampering  
**Affected Resource:** `ProcessResultsFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-354

#### Issue
The ProcessResultsFunction doesn't appear to include mechanisms to validate the integrity of processed document data before storing final results.

#### Attack Vector
An attacker who gains access to the working S3 bucket could potentially modify intermediate processing results before they're finalized.

#### Potential Impact
Tampering with document processing results could lead to incorrect data extraction, potentially impacting business decisions based on this data.

#### Remediation
Implement checksums or digital signatures for intermediate processing artifacts and validate them before finalizing results.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*