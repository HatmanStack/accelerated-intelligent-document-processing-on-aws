# CloudFormation Threat Model Report

**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-07-51  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **11** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **2** low severity findings.

## Priority Actions

### 1. Restrict S3 permissions to specific buckets required for the application functionality. Update the S3 resource scope from 'arn:aws:s3:::*' to the specific buckets needed.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-001  
**Business Impact:** Potential unauthorized access to all S3 buckets in the account, resulting in data loss, modification, or exfiltration beyond the scope needed for the application.

### 1. Restrict access to the OpenSearch Serverless collection to specific VPC endpoints, IP ranges, or AWS services instead of allowing public access. Set 'AllowFromPublic: false' and implement a more restrictive access policy.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-003  
**Business Impact:** Potential unauthorized access to indexed data, including sensitive information stored in the knowledge base.

### 2. Scope down permissions to specific OpenSearch Serverless collections and actions required for the application functionality. Replace wildcard resource patterns with specific ARNs.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-002  
**Business Impact:** Potential for unauthorized creation or modification of OpenSearch Serverless resources leading to data exposure or service disruption.

### 2. Use a customer-managed KMS key for encrypting the OpenSearch Serverless collection to gain better control and auditability. Update the encryption policy to specify a customer-managed KMS key ARN instead of using AWS owned keys.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-004  
**Business Impact:** Reduced control over data encryption and inability to implement custom key management strategies (rotation, revocation) for sensitive data.

### 2. Enable CloudTrail data events for Bedrock services and implement additional application-level logging for all knowledge base interactions. Consider implementing an audit solution that captures all interactions with the knowledge base.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-005  
**Business Impact:** Inability to detect, investigate, or respond to suspicious activities or unauthorized access to the knowledge base.

### 2. Restrict the bedrock:InvokeModel permission to only the specific embedding model being used (pEmbedModel parameter) rather than allowing access to all foundation models.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-006  
**Business Impact:** Potential for unauthorized usage of any Bedrock model, leading to increased costs or potential data leakage through carefully crafted prompts.

### 2. Enable versioning on the S3 bucket used as a data source. While the template uses an existing bucket, it should either validate that versioning is enabled or provide guidance to enable it.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-008  
**Business Impact:** Potential for undetected tampering with knowledge base source data, leading to misinformation or data loss without a recovery path.

### 3. Implement a more conservative rate limit for the web crawler and consider implementing progressive back-off strategies. Evaluate the actual needs of the application and reduce the rate limit to a more reasonable value.

**Effort:** Low  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-007  
**Business Impact:** Target websites might block the crawler's IP address, resulting in incomplete data collection and potential service disruption for both the crawler and target websites.

### 3. Use code signing for Lambda functions to ensure the integrity of the deployed code. Additionally, ensure the S3 bucket has appropriate access controls and versioning enabled.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-009  
**Business Impact:** Potential execution of unauthorized code with the permissions of the Lambda function's role.

### 3. Implement log filtering for sensitive information and ensure CloudWatch Logs are encrypted. Consider using AWS Secrets Manager for storing sensitive configuration values.

**Effort:** Medium  
**Related Threats:** BEDROCKKNOWLEDGEBASE-THREAT-010  
**Business Impact:** Potential disclosure of sensitive configuration information that could aid in targeting the knowledge base infrastructure.



## Detailed Threat Analysis

## High Severity Threats

### BEDROCKKNOWLEDGEBASE-THREAT-001: Overly permissive IAM permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has overly broad permissions for S3 access, allowing actions like PutObject*, GetObject*, and DeleteObject* on all S3 buckets in the account ('arn:aws:s3:::*') rather than limiting to specific buckets needed for the application.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these permissions to access, modify, or delete objects in any S3 bucket in the account.

#### Potential Impact
Potential unauthorized access to all S3 buckets in the account, resulting in data loss, modification, or exfiltration beyond the scope needed for the application.

#### Remediation
Restrict S3 permissions to specific buckets required for the application functionality. Update the S3 resource scope from 'arn:aws:s3:::*' to the specific buckets needed.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCKKNOWLEDGEBASE-THREAT-003: Public access enabled for OpenSearch Serverless collection

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `OSSNetworkPolicy` (AWS::OpenSearchServerless::NetworkPolicy)  
**CWE ID:** CWE-284

#### Issue
The OpenSearch Serverless network policy allows public access to both the collection and its dashboard with 'AllowFromPublic: true', creating potential exposure of sensitive data.

#### Attack Vector
Unauthorized users from the internet could potentially access the OpenSearch collection or dashboard if authentication mechanisms are compromised or misconfigured.

#### Potential Impact
Potential unauthorized access to indexed data, including sensitive information stored in the knowledge base.

#### Remediation
Restrict access to the OpenSearch Serverless collection to specific VPC endpoints, IP ranges, or AWS services instead of allowing public access. Set 'AllowFromPublic: false' and implement a more restrictive access policy.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-network.html

---

## Medium Severity Threats

### BEDROCKKNOWLEDGEBASE-THREAT-002: Broad permissions for OpenSearch Serverless actions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OpenSearchLambdaExecutionRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The OpenSearchLambdaExecutionRole has broad permissions for OpenSearch Serverless administration actions (create, list, update policies) on all resources (*) rather than being limited to specific collections.

#### Attack Vector
If the Lambda function is compromised, an attacker could create or modify OpenSearch collections and security policies across the account.

#### Potential Impact
Potential for unauthorized creation or modification of OpenSearch Serverless resources leading to data exposure or service disruption.

#### Remediation
Scope down permissions to specific OpenSearch Serverless collections and actions required for the application functionality. Replace wildcard resource patterns with specific ARNs.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCKKNOWLEDGEBASE-THREAT-004: Default encryption with AWS owned keys

**STRIDE Category:** Tampering  
**Affected Resource:** `OSSCollection` (AWS::OpenSearchServerless::Collection)  
**CWE ID:** CWE-321

#### Issue
The OpenSearch Serverless collection uses AWS owned keys for encryption (AWSOwnedKey: true) rather than customer managed keys, reducing control over encryption and key rotation.

#### Attack Vector
In case of a compromise of AWS managed keys, the customer has no visibility or control over the encryption and cannot immediately revoke access.

#### Potential Impact
Reduced control over data encryption and inability to implement custom key management strategies (rotation, revocation) for sensitive data.

#### Remediation
Use a customer-managed KMS key for encrypting the OpenSearch Serverless collection to gain better control and auditability. Update the encryption policy to specify a customer-managed KMS key ARN instead of using AWS owned keys.

**References:**
- https://docs.aws.amazon.com/opensearch-service/latest/developerguide/serverless-encryption.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-005: Insufficient logging for Bedrock Knowledge Base access

**STRIDE Category:** Repudiation  
**Affected Resource:** `KnowledgeBase` (AWS::Bedrock::KnowledgeBase)  
**CWE ID:** CWE-778

#### Issue
No CloudTrail logs or custom logging is explicitly configured to monitor access and usage patterns of the Bedrock Knowledge Base, limiting auditability and investigation capabilities.

#### Attack Vector
Unauthorized access or abuse of the Knowledge Base might go undetected without proper logging and monitoring.

#### Potential Impact
Inability to detect, investigate, or respond to suspicious activities or unauthorized access to the knowledge base.

#### Remediation
Enable CloudTrail data events for Bedrock services and implement additional application-level logging for all knowledge base interactions. Consider implementing an audit solution that captures all interactions with the knowledge base.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/monitoring.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-006: Broad permission to invoke any Bedrock foundation model

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `KnowledgeBaseServiceRole` (AWS::IAM::Role)  
**CWE ID:** CWE-272

#### Issue
The KnowledgeBaseServiceRole has permission to invoke any foundation model in Bedrock (bedrock:InvokeModel on arn:aws:bedrock:${AWS::Region}::foundation-model/*) rather than being limited to specific required models.

#### Attack Vector
If the service role is compromised, an attacker could invoke any Bedrock model, potentially leading to unexpected costs or data leakage through prompt engineering.

#### Potential Impact
Potential for unauthorized usage of any Bedrock model, leading to increased costs or potential data leakage through carefully crafted prompts.

#### Remediation
Restrict the bedrock:InvokeModel permission to only the specific embedding model being used (pEmbedModel parameter) rather than allowing access to all foundation models.

**References:**
- https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

---

### BEDROCKKNOWLEDGEBASE-THREAT-007: Web crawler rate limit potentially too high

**STRIDE Category:** Denial of Service  
**Affected Resource:** `WebDataSource` (AWS::Bedrock::DataSource)  
**CWE ID:** CWE-770

#### Issue
The web crawler is configured with a rate limit of 300 requests, which could potentially cause excessive load on target websites leading to IP blocking or service disruption.

#### Attack Vector
The crawler could unintentionally create a denial of service condition on target websites by sending too many requests in a short period.

#### Potential Impact
Target websites might block the crawler's IP address, resulting in incomplete data collection and potential service disruption for both the crawler and target websites.

#### Remediation
Implement a more conservative rate limit for the web crawler and consider implementing progressive back-off strategies. Evaluate the actual needs of the application and reduce the rate limit to a more reasonable value.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-crawling.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-008: Lack of versioning for S3 data source

**STRIDE Category:** Tampering  
**Affected Resource:** `S3DataSource` (AWS::Bedrock::DataSource)  
**CWE ID:** CWE-693

#### Issue
The template does not ensure versioning is enabled on the S3 bucket used as a data source, creating risk of data tampering without an audit trail or recovery mechanism.

#### Attack Vector
An attacker with access to the S3 bucket could modify or delete source documents without any ability to recover previous versions or detect changes.

#### Potential Impact
Potential for undetected tampering with knowledge base source data, leading to misinformation or data loss without a recovery path.

#### Remediation
Enable versioning on the S3 bucket used as a data source. While the template uses an existing bucket, it should either validate that versioning is enabled or provide guidance to enable it.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-010: Sensitive information in custom resource properties

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `InvokeCreateOSSIndexLambdaFunction` (Custom::InvokeCreateOSSIndexLambdaFunction)  
**CWE ID:** CWE-532

#### Issue
The custom resource properties include sensitive information like collection endpoints and embedding model IDs that might be logged in CloudWatch Logs without appropriate protection.

#### Attack Vector
An attacker with access to CloudWatch Logs could potentially extract sensitive configuration details that could be used to target the OpenSearch collection.

#### Potential Impact
Potential disclosure of sensitive configuration information that could aid in targeting the knowledge base infrastructure.

#### Remediation
Implement log filtering for sensitive information and ensure CloudWatch Logs are encrypted. Consider using AWS Secrets Manager for storing sensitive configuration values.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/encrypt-log-data-kms.html

---

## Low Severity Threats

### BEDROCKKNOWLEDGEBASE-THREAT-009: Lambda function using hardcoded S3 code location

**STRIDE Category:** Spoofing  
**Affected Resource:** `CreateOSSIndexLambdaFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-494

#### Issue
The Lambda function uses a hardcoded S3 bucket and path for the code, which could be redirected or spoofed if the S3 object is replaced.

#### Attack Vector
If an attacker gains access to the S3 bucket containing the Lambda code, they could replace the code with malicious content that would be executed with the Lambda's permissions.

#### Potential Impact
Potential execution of unauthorized code with the permissions of the Lambda function's role.

#### Remediation
Use code signing for Lambda functions to ensure the integrity of the deployed code. Additionally, ensure the S3 bucket has appropriate access controls and versioning enabled.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-codesigning.html

---

### BEDROCKKNOWLEDGEBASE-THREAT-011: Potential URL information disclosure in logs

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `GetSeedUrlsFunction` (AWS::Lambda::Function)  
**CWE ID:** CWE-532

#### Issue
The GetSeedUrlsFunction logs the entire event object with 'logger.info(event)', which may include sensitive URLs in CloudWatch Logs that could reveal internal systems or crawling targets.

#### Attack Vector
An attacker with access to CloudWatch Logs could gather information about what websites and internal systems are being crawled, potentially using this for reconnaissance.

#### Potential Impact
Disclosure of targeted URLs and crawling patterns that could reveal business intelligence or crawling strategy.

#### Remediation
Implement selective logging that avoids recording the full URLs or sensitive parameters. Filter or mask sensitive parts of URLs before logging.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/mask-sensitive-log-data.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*