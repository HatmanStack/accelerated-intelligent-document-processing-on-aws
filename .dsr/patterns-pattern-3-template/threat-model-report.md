# CloudFormation Threat Model Report

**Template:** `threat-model.md`  
**Analysis Date:** 2025-08-19_17-08-17  
**Generated By:** CloudFormation Threat Modeling Tool  

## Executive Summary

This threat model analysis identified **11** security threats. The analysis reveals **0** critical, **2** high, **7** medium, and **2** low severity findings.

## Priority Actions

### 1. Restrict Bedrock model access to only the specific models required by each function. Replace the wildcard with specific model ARNs like `arn:aws:bedrock:region::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0`.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-001  
**Business Impact:** Unauthorized model usage, potential cost implications, ability to bypass intended service restrictions.

### 1. Implement robust input sanitization for all content sent to LLMs. Use Bedrock guardrails consistently across all functions that access LLMs. Add a prompt security layer that validates and sanitizes inputs before they reach the model.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-011  
**Business Impact:** Data leakage, prompt injection attacks, generation of misleading or harmful content, or manipulation of document processing results.

### 2. Ensure all S3 buckets have default encryption enabled with the KMS key referenced in CustomerManagedEncryptionKeyArn parameter. If buckets are created in another template, verify encryption is applied there.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-002  
**Business Impact:** Potential exposure of sensitive document data, extraction results, or configuration information.

### 2. Implement robust input validation in all Lambda functions. Validate document formats, sizes, content types, and parameters before processing. Consider using AWS Lambda Layers to share common validation libraries across functions.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-004  
**Business Impact:** Potential for data corruption, system crashes, or bypass of processing controls.

### 2. Restrict Textract permissions to only the specific APIs needed (DetectDocumentText and AnalyzeDocument). While Textract doesn't support resource-level permissions, condition keys can be used to add constraints based on request parameters.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-007  
**Business Impact:** Potential unauthorized access to document data, increased AWS costs from unintended API usage.

### 2. Configure DLQs (SQS or SNS) for all Lambda functions to capture and handle failed executions. Implement automated monitoring and alerting for DLQ messages.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-010  
**Business Impact:** Silent failures, lost documents, incomplete processing workflows, and reduced system reliability.

### 3. Implement AWS X-Ray tracing for all Lambda functions and the Step Functions state machine. Add the X-Ray active tracing configuration to each Lambda function and include a tracing policy.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-003  
**Business Impact:** Reduced ability to detect, investigate, and respond to security incidents. Difficulty in tracking document flow through the system.

### 3. Implement reserved concurrency limits for all Lambda functions based on expected usage patterns. Consider setting provisioned concurrency for critical functions to ensure consistent performance.

**Effort:** Low  
**Related Threats:** PATTERN3-THREAT-005  
**Business Impact:** Service degradation, increased latency, potential system unavailability, or throttling of other critical services.

### 3. Use AWS Systems Manager Parameter Store or AWS Secrets Manager for sensitive configuration values instead of environment variables. For any values that must remain in environment variables, ensure they are encrypted.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-006  
**Business Impact:** Information disclosure that could facilitate further attacks against the system.

### 3. Create CloudWatch Alarms for security-relevant metrics such as access denied events, unusual API call patterns, high error rates, or unexpected spikes in resource usage. Configure notifications to appropriate security personnel.

**Effort:** Medium  
**Related Threats:** PATTERN3-THREAT-008  
**Business Impact:** Delayed incident response, increased dwell time for attackers, potentially larger impact from security incidents.



## Detailed Threat Analysis

## High Severity Threats

### PATTERN3-THREAT-001: Overly Permissive Bedrock Model Access

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `Multiple Lambda Policies` (AWS::IAM::Policy)  
**CWE ID:** CWE-284

#### Issue
Lambda functions have permissions to invoke any Bedrock foundation model using a wildcard resource policy (`arn:aws:bedrock:*::foundation-model/*`). This creates an unnecessarily broad permission scope.

#### Attack Vector
An attacker who compromises a Lambda function could invoke any Bedrock model, potentially bypassing intended restrictions and accessing more powerful or costly models than intended.

#### Potential Impact
Unauthorized model usage, potential cost implications, ability to bypass intended service restrictions.

#### Remediation
Restrict Bedrock model access to only the specific models required by each function. Replace the wildcard with specific model ARNs like `arn:aws:bedrock:region::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0`.

**References:**
- https://docs.aws.amazon.com/bedrock/latest/userguide/security_iam_service-with-iam.html

---

### PATTERN3-THREAT-011: Missing Data Protection Controls for LLM Prompts

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All Lambda Functions with Bedrock Access` (AWS::Serverless::Function)  
**CWE ID:** CWE-74

#### Issue
The Lambda functions that interact with Bedrock models don't implement proper prompt injection protections or data sanitization. This could lead to prompt injection attacks or unintended data disclosure to LLMs.

#### Attack Vector
An attacker could craft documents with malicious content designed to manipulate LLM prompts, potentially extracting sensitive information from the system or causing the model to generate harmful outputs.

#### Potential Impact
Data leakage, prompt injection attacks, generation of misleading or harmful content, or manipulation of document processing results.

#### Remediation
Implement robust input sanitization for all content sent to LLMs. Use Bedrock guardrails consistently across all functions that access LLMs. Add a prompt security layer that validates and sanitizes inputs before they reach the model.

**References:**
- https://owasp.org/www-project-top-10-for-large-language-model-applications/

---

## Medium Severity Threats

### PATTERN3-THREAT-002: Missing S3 Bucket Encryption Configuration

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `Multiple S3 Buckets` (AWS::S3::Bucket)  
**CWE ID:** CWE-311

#### Issue
S3 buckets referenced as parameters (InputBucket, ConfigurationBucket, OutputBucket, WorkingBucket) do not have explicit server-side encryption defined in this template. While encryption keys are passed as parameters, the template doesn't enforce bucket encryption.

#### Attack Vector
If the referenced buckets are not properly encrypted elsewhere, sensitive data stored in these buckets could be accessed in plaintext if the bucket is compromised.

#### Potential Impact
Potential exposure of sensitive document data, extraction results, or configuration information.

#### Remediation
Ensure all S3 buckets have default encryption enabled with the KMS key referenced in CustomerManagedEncryptionKeyArn parameter. If buckets are created in another template, verify encryption is applied there.

**References:**
- https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-encryption.html

---

### PATTERN3-THREAT-003: Insufficient Request Tracing

**STRIDE Category:** Repudiation  
**Affected Resource:** `OCRFunction, ClassificationFunction, ExtractionFunction, AssessmentFunction, ProcessResultsFunction, SummarizationFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-778

#### Issue
The Lambda functions handle document processing in a workflow, but there's no consistent request tracing mechanism implemented. While logging is configured, there's no distributed tracing solution to track requests across services.

#### Attack Vector
Without proper tracing, it would be difficult to reconstruct attack paths or understand the sequence of events during a security incident investigation.

#### Potential Impact
Reduced ability to detect, investigate, and respond to security incidents. Difficulty in tracking document flow through the system.

#### Remediation
Implement AWS X-Ray tracing for all Lambda functions and the Step Functions state machine. Add the X-Ray active tracing configuration to each Lambda function and include a tracing policy.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/services-xray.html

---

### PATTERN3-THREAT-004: Missing Input Validation

**STRIDE Category:** Tampering  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-20

#### Issue
The template creates Lambda functions for document processing but doesn't include any indication of input validation mechanisms. Without proper validation, the functions may process malicious or malformed inputs.

#### Attack Vector
An attacker could submit specially crafted documents or manipulated inputs to trigger errors, cause unexpected behavior, or potentially execute code injection attacks.

#### Potential Impact
Potential for data corruption, system crashes, or bypass of processing controls.

#### Remediation
Implement robust input validation in all Lambda functions. Validate document formats, sizes, content types, and parameters before processing. Consider using AWS Lambda Layers to share common validation libraries across functions.

**References:**
- https://owasp.org/www-project-api-security/

---

### PATTERN3-THREAT-005: Missing Lambda Concurrency Controls

**STRIDE Category:** Denial of Service  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-770

#### Issue
None of the Lambda functions have reserved concurrency limits defined, which could lead to resource exhaustion under heavy load or during a DoS attack.

#### Attack Vector
An attacker could trigger many concurrent Lambda invocations, potentially exhausting account quotas and impacting other functions or services in the same AWS account.

#### Potential Impact
Service degradation, increased latency, potential system unavailability, or throttling of other critical services.

#### Remediation
Implement reserved concurrency limits for all Lambda functions based on expected usage patterns. Consider setting provisioned concurrency for critical functions to ensure consistent performance.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html

---

### PATTERN3-THREAT-006: Sensitive Data in Environment Variables

**STRIDE Category:** Information Disclosure  
**Affected Resource:** `All Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-527

#### Issue
Lambda functions use environment variables for configuration, including API URLs and feature flags. While not directly exposing credentials, these values could provide attackers with information about the system architecture.

#### Attack Vector
If a function is compromised, an attacker could access environment variables to gain information about the overall system configuration and other connected services.

#### Potential Impact
Information disclosure that could facilitate further attacks against the system.

#### Remediation
Use AWS Systems Manager Parameter Store or AWS Secrets Manager for sensitive configuration values instead of environment variables. For any values that must remain in environment variables, ensure they are encrypted.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/security-dataprotection.html

---

### PATTERN3-THREAT-007: Overly Permissive Textract Permissions

**STRIDE Category:** Elevation of Privilege  
**Affected Resource:** `OCRFunction` (AWS::Serverless::Function)  
**CWE ID:** CWE-272

#### Issue
The OCRFunction has permissions to use any Textract API on any resource ('*') which violates the principle of least privilege.

#### Attack Vector
If the Lambda function is compromised, an attacker could leverage these broad Textract permissions to analyze documents outside the intended scope or use additional Textract features not required by the application.

#### Potential Impact
Potential unauthorized access to document data, increased AWS costs from unintended API usage.

#### Remediation
Restrict Textract permissions to only the specific APIs needed (DetectDocumentText and AnalyzeDocument). While Textract doesn't support resource-level permissions, condition keys can be used to add constraints based on request parameters.

**References:**
- https://docs.aws.amazon.com/textract/latest/dg/security_iam_service-with-iam.html

---

### PATTERN3-THREAT-010: Missing Dead Letter Queue Configuration

**STRIDE Category:** Denial of Service  
**Affected Resource:** `Multiple Lambda Functions` (AWS::Serverless::Function)  
**CWE ID:** CWE-755

#### Issue
The Lambda functions do not have Dead Letter Queues (DLQs) configured to capture failed executions. Failed processing could lead to lost documents or incomplete workflows without proper notification.

#### Attack Vector
An attacker could exploit input validation flaws to cause Lambda failures that go unnoticed, potentially leading to loss of document processing capabilities or incomplete processing of critical documents.

#### Potential Impact
Silent failures, lost documents, incomplete processing workflows, and reduced system reliability.

#### Remediation
Configure DLQs (SQS or SNS) for all Lambda functions to capture and handle failed executions. Implement automated monitoring and alerting for DLQ messages.

**References:**
- https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html#dlq

---

## Low Severity Threats

### PATTERN3-THREAT-008: Missing Alarm Configuration for Security Events

**STRIDE Category:** Repudiation  
**Affected Resource:** `Dashboard` (AWS::CloudWatch::Dashboard)  
**CWE ID:** CWE-778

#### Issue
While a CloudWatch dashboard is created for monitoring system performance, there are no alarm configurations for security-related events or anomalies. This limits the ability to detect and respond to potential security incidents.

#### Attack Vector
Security incidents might go undetected or be noticed too late if there are no automated alerts for suspicious patterns or events.

#### Potential Impact
Delayed incident response, increased dwell time for attackers, potentially larger impact from security incidents.

#### Remediation
Create CloudWatch Alarms for security-relevant metrics such as access denied events, unusual API call patterns, high error rates, or unexpected spikes in resource usage. Configure notifications to appropriate security personnel.

**References:**
- https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html

---

### PATTERN3-THREAT-009: No State Machine Input Validation

**STRIDE Category:** Tampering  
**Affected Resource:** `DocumentProcessingStateMachine` (AWS::Serverless::StateMachine)  
**CWE ID:** CWE-20

#### Issue
The State Machine workflow processes input documents but lacks input validation steps at the beginning of the workflow to verify input format and content.

#### Attack Vector
An attacker could submit malformed or malicious input data to the state machine that might bypass application-level validations in downstream components.

#### Potential Impact
Potential processing of invalid or malicious documents, which could lead to unexpected behavior, errors, or security issues in downstream processing.

#### Remediation
Add an initial validation step in the state machine workflow that performs basic validation of the input structure and format before proceeding with document processing.

**References:**
- https://docs.aws.amazon.com/step-functions/latest/dg/concepts-input-output-filtering.html

---



---

*This report was generated automatically using STRIDE threat modeling methodology.*