# Copyright Â© Amazon.com and Affiliates: This deliverable is considered Developed Content as defined in the AWS Service Terms and the SOW between the parties.

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Document processing pipeline with Textract and Bedrock

Parameters:

  MaxConcurrentWorkflows:
    Type: Number
    Default: 800
    Description: Maximum number of concurrent workflow executions allowed
    MinValue: 1

  ErrorThreshold:
    Type: Number
    Default: 1
    Description: Number of workflow errors that triggers an alert (per 5 minutes)
    MinValue: 1

  ExecutionTimeThresholdMs:
    Type: Number
    Default: 30000
    Description: Maximum acceptable execution time in milliseconds before alerting (default 30000 = 30 seconds)
    MinValue: 1000

  LogRetentionDays:
    Type: Number
    Default: 30
    Description: Number of days to retain CloudWatch logs
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]

  ExtractionModel:
    Type: String
    Default: 'us.anthropic.claude-3-5-sonnet-20241022-v2:0'
    AllowedValues:
      - 'us.anthropic.claude-3-5-sonnet-20241022-v2:0'
      - 'us.amazon.nova-pro-v1:0'
    Description: Bedrock Model ID to use for Extraction

  ExtractionPrompts:
    Type: String
    Default: 'OCR Text + Page Images'
    AllowedValues:
      - 'OCR Text Only'
      - 'OCR Text + Page Images'
    Description: Choose whether to attach page image data along with OCR text, in extraction prompts 

Conditions:
  IsOCRTextOnly: !Equals [!Ref ExtractionPrompts, "OCR Text Only"]

Resources:
  InputBucket:
    Type: AWS::S3::Bucket
    Properties:
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  OutputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  ExecutionTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: object_key
          AttributeType: S
      KeySchema:
        - AttributeName: object_key
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
  
  ConcurrencyTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: counter_id
          AttributeType: S
      KeySchema:
        - AttributeName: counter_id
          KeyType: HASH

  InitializeConcurrencyTableLambda:
   Type: AWS::Serverless::Function
   Properties:
     Handler: index.handler
     Runtime: python3.11
     Timeout: 30
     InlineCode: |
      import boto3
      import cfnresponse
      import logging
      from botocore.exceptions import ClientError
      import os

      # Initialize logging
      logger = logging.getLogger()
      logger.setLevel(logging.INFO)

      # DynamoDB resource
      dynamodb = boto3.resource('dynamodb')
      CONCURRENCY_TABLE = os.environ.get('CONCURRENCY_TABLE')
      concurrency_table = dynamodb.Table(CONCURRENCY_TABLE)

      COUNTER_ID = "workflow_counter"

      def handler(event, context):
          logger.info(f"Event received: {event}")
          try:
              # Handle CloudFormation CREATE events
              if event['RequestType'] == 'Create':
                  concurrency_table.put_item(
                      Item={
                          'counter_id': COUNTER_ID,
                          'active_count': 0
                      },
                      ConditionExpression='attribute_not_exists(counter_id)'
                  )
                  logger.info("Counter initialized")

              elif event['RequestType'] == 'Delete':
                  # Handle CloudFormation DELETE events
                  concurrency_table.delete_item(
                      Key={
                          'counter_id': COUNTER_ID
                      }
                  )
                  logger.info("Counter deleted")

              # Send a success response to CloudFormation
              cfnresponse.send(event, context, cfnresponse.SUCCESS, {})

          except ClientError as e:
              logger.error(f"Error in DynamoDB operation: {e}")
              # Send a failure response to CloudFormation
              cfnresponse.send(event, context, cfnresponse.FAILED, {"Error": str(e)})
              raise

          except Exception as e:
              logger.error(f"Unexpected error: {e}")
              # Send a failure response to CloudFormation
              cfnresponse.send(event, context, cfnresponse.FAILED, {"Error": str(e)})
              raise
     LoggingConfig:
      LogGroup: !Ref QueueProcessorLogGroup
     Environment:
      Variables:
        CONCURRENCY_TABLE: !Ref ConcurrencyTable
     Policies:
      - DynamoDBCrudPolicy:
          TableName: !Ref ConcurrencyTable

  InitializeConcurrencyTableCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt InitializeConcurrencyTableLambda.Arn
      TableName: !Ref ConcurrencyTable

  DocumentQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 30
      MessageRetentionPeriod: 86400

  QueueSender:
   Type: AWS::Serverless::Function 
   Properties:
     CodeUri: src/queue_sender/
     Handler: index.handler
     Runtime: python3.11
     Timeout: 30
     LoggingConfig:
       LogGroup: !Ref QueueSenderLogGroup
     Environment:
       Variables:
         QUEUE_URL: !Ref DocumentQueue
         TRACKING_TABLE: !Ref ExecutionTable
     Policies:
       - SQSSendMessagePolicy:
           QueueName: !GetAtt DocumentQueue.QueueName
       - DynamoDBCrudPolicy:
           TableName: !Ref ExecutionTable
     Events:
        S3Event:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              source:
                - aws.s3
              detail-type:
                - "Object Created"
              detail:
                bucket:
                  name:
                    - !Ref InputBucket

  QueueSenderLogGroup:
   Type: AWS::Logs::LogGroup
   Properties:
     LogGroupName: !Sub "/${AWS::StackName}/lambda/queue-sender" 
     RetentionInDays: !Ref LogRetentionDays

  QueueProcessor:
   Type: AWS::Serverless::Function
   Properties:
     CodeUri: src/queue_processor/
     Handler: index.handler
     Runtime: python3.11
     Timeout: 30
     LoggingConfig:
       LogGroup: !Ref QueueProcessorLogGroup
     Environment:
       Variables:
         STATE_MACHINE_ARN: !Ref DocumentProcessingStateMachine
         TRACKING_TABLE: !Ref ExecutionTable
         CONCURRENCY_TABLE: !Ref ConcurrencyTable
         MAX_CONCURRENT: !Ref MaxConcurrentWorkflows
     Policies:
       - SQSPollerPolicy:
           QueueName: !GetAtt DocumentQueue.QueueName
       - StepFunctionsExecutionPolicy:
           StateMachineName: !GetAtt DocumentProcessingStateMachine.Name
       - DynamoDBCrudPolicy:
           TableName: !Ref ExecutionTable
       - DynamoDBCrudPolicy:
           TableName: !Ref ConcurrencyTable
     Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt DocumentQueue.Arn
            BatchSize: 50  # Process up to 50 messages at once
            MaximumBatchingWindowInSeconds: 1  # Wait max 1 second to fill batch
            FunctionResponseTypes: 
              - ReportBatchItemFailures

  QueueProcessorLogGroup:
   Type: AWS::Logs::LogGroup
   Properties:
     LogGroupName: !Sub "/${AWS::StackName}/lambda/queue-processor"
     RetentionInDays: !Ref LogRetentionDays

  WorkflowTracker:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/workflow_tracker/
      Handler: index.handler
      Runtime: python3.11
      Timeout: 30
      LoggingConfig:
        LogGroup: !Ref WorkflowTrackerLogGroup
      Environment:
        Variables:
          TRACKING_TABLE: !Ref ExecutionTable
          CONCURRENCY_TABLE: !Ref ConcurrencyTable
          METRIC_NAMESPACE: !Ref AWS::StackName
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ExecutionTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConcurrencyTable
        - Statement:
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricData
              Resource: "*"

  WorkflowTrackerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/${AWS::StackName}/lambda/workflow-tracker"
      RetentionInDays: !Ref LogRetentionDays

  WorkflowStateChangeRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.states
        detail-type:
          - Step Functions Execution Status Change
        detail:
          stateMachineArn:
            - !Ref DocumentProcessingStateMachine
          status:
            - FAILED
            - TIMED_OUT
            - ABORTED
            - SUCCEEDED
      State: ENABLED
      Targets:
        - Arn: !GetAtt WorkflowTracker.Arn
          Id: TrackWorkflowCompletion
          RetryPolicy:
            MaximumRetryAttempts: 3

  WorkflowTrackerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WorkflowTracker
      Principal: events.amazonaws.com
      SourceArn: !GetAtt WorkflowStateChangeRule.Arn

  TextractFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/textract_function/
      Handler: index.handler
      Runtime: python3.11
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          METRIC_NAMESPACE: !Ref AWS::StackName
      LoggingConfig:
        LogGroup: !Ref TextractFunctionLogGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - TextractPolicy:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: textract:DetectDocumentText
                Resource: '*'
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - Statement:
          - Effect: Allow
            Action: cloudwatch:PutMetricData
            Resource: '*'
  
  TextractFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/${AWS::StackName}/lambda/textract"
      RetentionInDays: !Ref LogRetentionDays
  
  BedrockFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/bedrock_function/
      Handler: index.handler
      Runtime: python3.11
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          EXTRACTION_MODEL_ID: !Ref ExtractionModel
          METRIC_NAMESPACE: !Ref AWS::StackName
          OCR_TEXT_ONLY: !If [IsOCRTextOnly, true, false]
      LoggingConfig:
        LogGroup: !Ref BedrockFunctionLogGroup
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action: bedrock:InvokeModel
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action: cloudwatch:PutMetricData
          Resource: '*'
      - S3CrudPolicy:
          BucketName: !Ref OutputBucket
      - S3ReadPolicy:
          BucketName: !Ref InputBucket

  BedrockFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/${AWS::StackName}/lambda/bedrock"
      RetentionInDays: !Ref LogRetentionDays

  DocumentProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/workflow.asl.json
      DefinitionSubstitutions:
        TextractFunctionArn: !GetAtt TextractFunction.Arn
        BedrockFunctionArn: !GetAtt BedrockFunction.Arn
        OutputBucket: !Ref OutputBucket
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref TextractFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref BedrockFunction
        - CloudWatchLogsFullAccess

  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}/workflow"  # required prefix
      RetentionInDays: !Ref LogRetentionDays

  AlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: Workflow Alerts

  WorkflowErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub "Alert when workflow errors exceed ${ErrorThreshold} in 5 minutes"
      MetricName: ExecutionsFailedCount
      Namespace: AWS/States
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: !Ref ErrorThreshold
      ComparisonOperator: GreaterThanOrEqualToThreshold 
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref DocumentProcessingStateMachine
      AlarmActions:
        - !Ref AlertsTopic

  SlowExecutionsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub "Alert when average execution time exceeds ${ExecutionTimeThresholdMs} milliseconds"
      MetricName: ExecutionTime
      Namespace: AWS/States
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: !Ref ExecutionTimeThresholdMs
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref DocumentProcessingStateMachine
      AlarmActions:
        - !Ref AlertsTopic

  DashboardWorkflow:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${AWS::StackName}-${AWS::Region}"
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "QueueLatencyMilliseconds", {"stat": "Average"}],
                  [".", "QueueLatencyMilliseconds", {"stat": "p90"}],
                  [".", "QueueLatencyMilliseconds", {"stat": "Maximum"}]
                ],
                "region": "${AWS::Region}",
                "title": "Queue Latency",
                "period": 300,
                "view": "timeSeries",
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                }
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "WorkflowLatencyMilliseconds", {"stat": "Average"}],
                  [".", "WorkflowLatencyMilliseconds", {"stat": "p90"}],
                  [".", "WorkflowLatencyMilliseconds", {"stat": "Maximum"}]
                ],
                "region": "${AWS::Region}",
                "title": "Workflow Latency",
                "period": 300,
                "view": "timeSeries",
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                }
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "TotalLatencyMilliseconds", {"stat": "Average"}],
                  [".", "TotalLatencyMilliseconds", {"stat": "p90"}],
                  [".", "TotalLatencyMilliseconds", {"stat": "Maximum"}]
                ],
                "region": "${AWS::Region}",
                "title": "Total Processing Latency",
                "period": 300,
                "view": "timeSeries",
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/SQS", "NumberOfMessagesReceived", "QueueName", "${DocumentQueue.QueueName}"],
                  [".", "NumberOfMessagesDeleted", ".", "."]
                ],
                "region": "${AWS::Region}",
                "title": "SQS Queue Metrics (per Minute)",
                "period": 60,
                "stat": "Sum",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/States", "ExecutionsStarted", "StateMachineArn", "${DocumentProcessingStateMachine}"],
                  [".", "ExecutionsSucceeded", ".", "."],
                  [".", "ExecutionsFailed", ".", "."]
                ],
                "region": "${AWS::Region}",
                "title": "Workflow Executions (per Minute)",
                "period": 60,
                "stat": "Sum",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${TextractFunction}"]
                ],
                "region": "${AWS::Region}",
                "title": "Textract Function Duration",
                "period": 300,
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                },
                "stat": "Average",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${BedrockFunction}"]
                ],
                "region": "${AWS::Region}",
                "title": "Bedrock Function Duration",
                "period": 300,
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                },
                "stat": "Average",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 18,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "InputDocuments", {"stat": "Sum", "period": 60}]
                ],
                "region": "${AWS::Region}",
                "title": "Input Documents (per Minute)",
                "period": 60,
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 18,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "InputDocumentPages", {"stat": "Sum", "period": 60}]
                ],
                "region": "${AWS::Region}",
                "title": "Input Document Pages (per Minute)",
                "period": 60,
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 24,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "InputTokens", {"stat": "Sum", "period": 60}]
                ],
                "region": "${AWS::Region}",
                "title": "Input Tokens (per Minute)",
                "period": 60,
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 24,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "OutputTokens", {"stat": "Sum", "period": 60}]
                ],
                "region": "${AWS::Region}",
                "title": "Output Tokens (per Minute)",
                "period": 60,
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 24,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "TotalTokens", {"stat": "Sum", "period": 60}]
                ],
                "region": "${AWS::Region}",
                "title": "Total Tokens (per Minute)",
                "period": 60,
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 30,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "BedrockRequestsTotal", {"stat": "Sum"}],
                  [".", "BedrockRequestsSucceeded", {"stat": "Sum"}],
                  [".", "BedrockRequestsFailed", {"stat": "Sum"}]
                ],
                "region": "${AWS::Region}",
                "title": "Bedrock Request Status (per Minute)",
                "period": 60,
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 30,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "BedrockThrottles", {"stat": "Sum"}],
                  [".", "BedrockRetrySuccess", {"stat": "Sum"}],
                  [".", "BedrockMaxRetriesExceeded", {"stat": "Sum"}]
                ],
                "region": "${AWS::Region}",
                "title": "Bedrock Retries (per Minute)",
                "period": 60,
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 30,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${AWS::StackName}", "BedrockRequestLatency", {"stat": "Average"}],
                  [".", "BedrockRequestLatency", {"stat": "p90"}],
                  [".", "BedrockRequestLatency", {"stat": "Maximum"}],
                  [".", "BedrockTotalLatency", {"stat": "Average"}],
                  [".", "BedrockTotalLatency", {"stat": "p90"}],
                  [".", "BedrockTotalLatency", {"stat": "Maximum"}]
                ],
                "region": "${AWS::Region}",
                "title": "Bedrock Latency - per request, and total (including backoff/retries)",
                "period": 300,
                "view": "timeSeries",
                "stacked": false,
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                }
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 36,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${TextractFunctionLogGroup}' | fields @timestamp, @logStream, @message | filter @message like /ERROR/ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Textract Lambda Errors",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 36,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${BedrockFunctionLogGroup}' | fields @timestamp, @logStream, @message | filter @message like /ERROR/ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Bedrock Lambda Errors",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 42,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${TextractFunctionLogGroup}' | filter @type = \"REPORT\" | fields @timestamp, @logStream, @billedDuration, @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs} | sort by @billedDuration desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Textract Lambda Long Running Invocations",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 42,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${BedrockFunctionLogGroup}' | filter @type = \"REPORT\" | fields @timestamp, @logStream, @billedDuration, @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs} | sort by @billedDuration desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Bedrock Lambda Long Running Invocations",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 48,
              "width": 24,
              "height": 6,
              "properties": {
                "query": "SOURCE '${StateMachineLogGroup}' | fields @timestamp, @message | filter @message like /ExecutionFailed/ or @message like /TimedOut/ | parse @message /execution: (?<execution_arn>[^ ]*)/ | parse @message /error: (?<error>[^\"]*)/| sort @timestamp desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Step Functions Executions Failed",
                "view": "table"
              }
            }
          ]
        }

  LookupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lookup_function/
      Handler: index.handler
      Runtime: python3.11
      Timeout: 30
      LoggingConfig:
        LogGroup: !Ref LookupFunctionLogGroup
      Environment:
        Variables:
          TRACKING_TABLE: !Ref ExecutionTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ExecutionTable
        - Statement:
            - Effect: Allow
              Action:
                - states:DescribeExecution
                - states:GetExecutionHistory
              Resource: 
                - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:execution:${DocumentProcessingStateMachine.Name}*"

  LookupFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/${AWS::StackName}/lambda/lookup"
      RetentionInDays: !Ref LogRetentionDays

Outputs:
  S3InputBucketName:
    Description: Input S3 bucket name
    Value: !Ref InputBucket
  S3InputBucketConsoleURL:
    Description: Input S3 bucket console URL
    Value: !Sub https://s3.console.aws.amazon.com/s3/buckets/${InputBucket}
  S3OutputBucketName:
    Description: Output S3 bucket name
    Value: !Ref OutputBucket
  S3OutputBucketConsoleURL:
    Description: Output S3 bucket console URL
    Value: !Sub https://s3.console.aws.amazon.com/s3/buckets/${OutputBucket}
  StateMachineConsoleURL:
    Description: State machine console URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/states/home?region=${AWS::Region}#/statemachines/view/${DocumentProcessingStateMachine}
  CWDashboardConsoleURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${DashboardWorkflow}
  SNSAlertsTopicARN:
    Description: SNS Topic ARN for alerts
    Value: !Ref AlertsTopic
  SNSAlertsTopicConsoleURL:
    Description: SNS Topic console URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/sns/v3/home?region=${AWS::Region}#/topic/${AlertsTopic}
  DynamoDBExecutionTableConsoleURL:
    Description: DynamoDB table console URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/dynamodbv2/home?region=${AWS::Region}#item-explorer?maximize=true&operation=QUERY&table=${ExecutionTable}
  DynamoDBConcurrencyTableConsoleURL:
    Description: DynamoDB table console URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/dynamodbv2/home?region=${AWS::Region}#item-explorer?maximize=true&operation=QUERY&table=${ConcurrencyTable}
  LambdaLookupFunctionName:
    Description: Name of the Lookup function
    Value: !Ref LookupFunction
  LambdaLookupFunctionConsoleURL:
    Description: Lambda function console URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/lambda/home?region=${AWS::Region}#/functions/${LookupFunction}
  SQSDocumentQueueConsoleURL:
    Description: SQS Queue console URL
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/sqs/v2/home?region=${AWS::Region}#/queues/${DocumentQueue}


