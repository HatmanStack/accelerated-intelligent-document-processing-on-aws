# Copyright Â© Amazon.com and Affiliates: This deliverable is considered Developed Content as defined in the AWS Service Terms and the SOW between the parties.

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS GenAI IDP Accelerator - resources for IDP Pattern 2

Parameters:

  StackName:
    Type: String

  InputBucket:
    Type: String

  OutputBucket:
    Type: String

  CustomerManagedEncryptionKeyArn:
    Type: String

  LogRetentionDays:
    Type: Number
  
  ExecutionTimeThresholdMs:
    Type: Number
    Default: 30000

  ClassificationModel:
    Type: String
    Default: 'us.amazon.nova-pro-v1:0'

  ExtractionModel:
    Type: String
    Default: 'us.amazon.nova-pro-v1:0'

  CustomClassificationModelARN:
    Type: String
    Default: ''

  CustomExtractionModelARN:
    Type: String
    Default: ''

  UpdateConfigurationFunctionArn:
    Type: String

  ConfigurationTable:
    Type: String


Resources:

  # JSON Schema which defines the structure of the pattern configuration settings
  # used by the UI to allow the configuration to be inspected and customized.
  UpdateSchemaConfig:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !Ref UpdateConfigurationFunctionArn
      Schema:
        type: object
        required:
          - info
          - classes
          - classification
          - extraction
        properties:
          info:
            type: string
            description: Description of the configuration section
          classes:
            type: list
            format: header
            itemLabel: Class
            columnsLayout: true
            columns: 2
            containerFormat: section
            sectionLabel: Document Classes
            order: 1
            description: List of classes to be extracted from the document
            items:
              type: object
              required:
                - name
                - description
                - attributes
              properties:
                name:
                  type: string
                  description: Class name
                description:
                  type: string
                  description: Class description
                attributes:
                  type: list
                  description: List of attributes for this class
                  items:
                    type: object
                    required:
                      - name
                      - description
                    properties:
                      name:
                        type: string
                        description: Attribute name
                      description:
                        type: string
                        description: Attribute description
                      aliases:
                        type: list
                        description: Attribute aliases
                        items:
                          type: string
                          description: Attribute alias
          classification:
            type: object
            format: section
            sectionLabel: Classification Configuration
            order: 2
            required:
              - model
              - temperature
              - top_k
              - system_prompt
              - task_prompt
            properties:
              model:
                type: string
                description: Model identifier
              temperature:
                type: number
                minimum: 0
                maximum: 1
                description: Sampling temperature
              top_k:
                type: integer
                minimum: 1
                description: Top K parameter for sampling
              system_prompt:
                type: string
                description: System prompt
              task_prompt:
                type: string
                description: Task prompt - include parameter {DOCUMENT_TEXT}
          extraction:
            type: object
            format: section
            sectionLabel: Extraction Configuration
            order: 3
            required:
              - model
              - temperature
              - top_k
              - system_prompt
              - task_prompt
            properties:
              model:
                type: string
                description: Model identifier
              temperature:
                type: number
                minimum: 0
                maximum: 1
                description: Sampling temperature
              top_k:
                type: integer
                minimum: 1
                description: Top K parameter for sampling
              system_prompt:
                type: string
                description: System prompt
              task_prompt:
                type: string
                description: Task prompt - include parameters {DOCUMENT_CLASS} and {DOCUMENT_TEXT}
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  UpdateDefaultConfig:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !Ref UpdateConfigurationFunctionArn
      Default:
        info: Default inference settings for classification and extraction
        classes:
          - name: letter
            description: A formal written message that is typically sent from one person to another
            attributes:
              - name: sender_name
                description: The name of the person or entity sending the letter
                aliases:
                  - from
                  - sender
                  - authored by
                  - written by
              - name: sender_address
                description: The physical address of the sender
                aliases:
                  - address
                  - location
                  - from address
              - name: recipient_name
                description: The name of the person or entity receiving the letter
                aliases:
                  - to
                  - recipient
                  - addressee
              - name: recipient_address
                description: The physical address where the letter is to be delivered
                aliases:
                  - to address
                  - delivery address
              - name: date
                description: The date when the letter was written
                aliases:
                  - date
                  - written on
                  - dated
              - name: subject
                description: The topic or main point of the letter
                aliases:
                  - subject
                  - "re:"
                  - regarding
              - name: letter_type
                description: The category or classification of the letter
                aliases:
                  - type
                  - category
              - name: signature
                description: The handwritten name or mark of the sender
                aliases:
                  - signed by
                  - signature
              - name: cc
                description: People who receive a copy of the letter in addition to the main recipient
                aliases:
                  - cc
                  - carbon copy
                  - copy to
              - name: reference_number
                description: An identifying number or code associated with the letter
                aliases:
                  - ref
                  - reference
                  - our ref
          
          - name: form
            description: A document with blank spaces for filling in information
            attributes:
              - name: form_type
                description: The category or purpose of the form
                aliases:
                  - form name
                  - document type
                  - form category
              - name: form_id
                description: The unique identifier for the form
                aliases:
                  - form number
                  - id
                  - reference number
              - name: submission_date
                description: The date when the form was submitted
                aliases:
                  - date
                  - submitted on
                  - filed on
              - name: submitter_name
                description: The name of the person who submitted the form
                aliases:
                  - name
                  - submitted by
                  - filed by
              - name: submitter_id
                description: An identification number for the person submitting the form
                aliases:
                  - id number
                  - identification
                  - reference
              - name: approval_status
                description: The current state of approval for the form
                aliases:
                  - status
                  - approved
                  - pending
              - name: processed_by
                description: The name of the person or department that processed the form
                aliases:
                  - processor
                  - handled by
                  - approved by
              - name: processing_date
                description: The date when the form was processed
                aliases:
                  - processed on
                  - completion date
              - name: department
                description: The organizational unit responsible for the form
                aliases:
                  - dept
                  - department
                  - division
              - name: comments
                description: Additional notes or remarks about the form
                aliases:
                  - notes
                  - remarks
                  - comments
          
          - name: invoice
            description: A commercial document issued by a seller to a buyer relating to a sale
            attributes:
              - name: invoice_number
                description: The unique identifier for the invoice
                aliases:
                  - invoice no
                  - "invoice #"
                  - bill number
              - name: invoice_date
                description: The date when the invoice was issued
                aliases:
                  - date
                  - invoice date
                  - billing date
              - name: due_date
                description: The date by which payment must be made
                aliases:
                  - due date
                  - payment due
                  - payable by
              - name: vendor_name
                description: The name of the business providing goods or services
                aliases:
                  - vendor
                  - seller
                  - supplier
              - name: vendor_address
                description: The physical location of the vendor
                aliases:
                  - address
                  - location
                  - business address
              - name: customer_name
                description: The name of the person or entity being billed
                aliases:
                  - customer
                  - buyer
                  - bill to
              - name: customer_address
                description: The address where the invoice is sent or goods are delivered
                aliases:
                  - billing address
                  - ship to
              - name: items
                description: Descriptions of the products or services provided
                aliases:
                  - description
                  - item details
                  - products
              - name: quantities
                description: The number of each item provided
                aliases:
                  - qty
                  - quantity
                  - amount
              - name: unit_prices
                description: The cost per unit of each item
                aliases:
                  - price
                  - rate
                  - unit cost
              - name: subtotal
                description: The sum of all items before tax and other charges
                aliases:
                  - subtotal
                  - net amount
              - name: tax
                description: The amount of tax charged on the invoice
                aliases:
                  - tax
                  - vat
                  - gst
              - name: total_amount
                description: The final amount to be paid including all charges
                aliases:
                  - total
                  - grand total
                  - amount due
              - name: payment_terms
                description: The conditions under which payment should be made
                aliases:
                  - terms
                  - payment terms
                  - conditions
              - name: po_number
                description: The purchase order reference number
                aliases:
                  - po
                  - purchase order
                  - order reference
          
          - name: resume
            description: A document summarizing a person's background, skills, and qualifications
            attributes:
              - name: full_name
                description: The complete name of the job applicant
                aliases:
                  - name
                  - applicant name
              - name: contact_info
                description: The phone number, email, and address of the applicant
                aliases:
                  - contact
                  - phone
                  - email
                  - address
              - name: objective
                description: A statement outlining the applicant's career goals
                aliases:
                  - objective
                  - summary
                  - profile
              - name: education
                description: The academic history and qualifications of the applicant
                aliases:
                  - education
                  - academic background
                  - qualifications
              - name: experience
                description: The work history and previous roles of the applicant
                aliases:
                  - experience
                  - work history
                  - employment
              - name: skills
                description: The abilities and competencies of the applicant
                aliases:
                  - skills
                  - competencies
                  - expertise
              - name: certifications
                description: Professional credentials and qualifications
                aliases:
                  - certifications
                  - certificates
                  - credentials
              - name: languages
                description: Languages known and level of proficiency
                aliases:
                  - languages
                  - language proficiency
              - name: references
                description: People who can vouch for the applicant's abilities
                aliases:
                  - references
                  - referees
              - name: achievements
                description: Notable accomplishments and recognition
                aliases:
                  - achievements
                  - accomplishments
                  - awards
          
          - name: scientific_publication
            description: A formally published document presenting scientific research findings
            attributes:
              - name: title
                description: The name of the scientific paper
                aliases:
                  - title
                  - paper title
                  - article title
              - name: authors
                description: The researchers who conducted the study and wrote the paper
                aliases:
                  - authors
                  - contributors
                  - researchers
              - name: abstract
                description: A brief summary of the paper's content
                aliases:
                  - abstract
                  - summary
              - name: keywords
                description: Terms that represent the core topics of the paper
                aliases:
                  - keywords
                  - key terms
              - name: publication_date
                description: The date when the paper was published
                aliases:
                  - published
                  - publication date
              - name: journal_name
                description: The name of the journal where the paper was published
                aliases:
                  - journal
                  - publication
              - name: volume
                description: The volume number of the journal
                aliases:
                  - volume
                  - vol
              - name: issue
                description: The issue number of the journal
                aliases:
                  - issue
                  - no
              - name: pages
                description: The page range of the paper in the journal
                aliases:
                  - pages
                  - pp
              - name: doi
                description: The Digital Object Identifier for the paper
                aliases:
                  - doi
                  - digital object identifier
              - name: funding
                description: Financial support received for the research
                aliases:
                  - funding
                  - grants
                  - financial support
              - name: corresponding_author
                description: The author responsible for communication regarding the paper
                aliases:
                  - corresponding author
                  - contact author
              - name: institutions
                description: The organizations with which the authors are affiliated
                aliases:
                  - affiliations
                  - institutions
          
          - name: memo
            description: A brief written message used for internal communication within an organization
            attributes:
              - name: memo_date
                description: The date when the memo was written
                aliases:
                  - date
                  - memo date
              - name: from
                description: The person or department that wrote the memo
                aliases:
                  - from
                  - sender
                  - author
              - name: to
                description: The intended recipient of the memo
                aliases:
                  - to
                  - recipient
                  - addressee
              - name: subject
                description: The topic of the memo
                aliases:
                  - subject
                  - "re:"
                  - regarding
              - name: memo_type
                description: The category or classification of the memo
                aliases:
                  - type
                  - category
              - name: priority
                description: The urgency level of the memo
                aliases:
                  - priority
                  - urgency
              - name: distribution_list
                description: Additional people who receive copies of the memo
                aliases:
                  - distribution
                  - cc
                  - copy
              - name: reference_number
                description: An identifying number or code for the memo
                aliases:
                  - reference
                  - ref no
              - name: department
                description: The organizational unit issuing the memo
                aliases:
                  - department
                  - dept
                  - division
              - name: action_required
                description: Steps that should be taken in response to the memo
                aliases:
                  - action
                  - response needed
                  - next steps
          
          - name: advertisement
            description: A public notice promoting a product, service, or event
            attributes:
              - name: product_name
                description: The name of the item or service being advertised
                aliases:
                  - product
                  - item
                  - service
              - name: brand
                description: The company or manufacturer of the product
                aliases:
                  - brand
                  - company
                  - manufacturer
              - name: price
                description: The cost of the product or service
                aliases:
                  - price
                  - cost
                  - special offer
              - name: promotion_details
                description: Information about special deals or discounts
                aliases:
                  - promotion
                  - offer
                  - deal
              - name: validity_period
                description: The timeframe during which the offer is valid
                aliases:
                  - valid until
                  - offer ends
                  - expires
              - name: contact_info
                description: How to reach the advertiser
                aliases:
                  - contact
                  - call
                  - visit
              - name: features
                description: Notable qualities or benefits of the product
                aliases:
                  - features
                  - benefits
                  - highlights
              - name: terms_conditions
                description: Legal constraints or limitations of the offer
                aliases:
                  - terms
                  - conditions
                  - restrictions
              - name: call_to_action
                description: What the advertisement encourages the reader to do
                aliases:
                  - call now
                  - visit today
                  - order now
              - name: disclaimer
                description: Legal statements limiting liability or making clarifications
                aliases:
                  - disclaimer
                  - terms apply
                  - conditions apply
          
          - name: email
            description: An electronic message sent from one person to another over a computer network
            attributes:
              - name: from_address
                description: The email address of the sender
                aliases:
                  - from
                  - sender
                  - sent by
              - name: to_address
                description: The email address of the primary recipient
                aliases:
                  - to
                  - recipient
                  - sent to
              - name: cc_address
                description: Email addresses of additional recipients who receive copies
                aliases:
                  - cc
                  - carbon copy
              - name: bcc_address
                description: Email addresses of hidden recipients
                aliases:
                  - bcc
                  - blind copy
              - name: subject
                description: The topic of the email
                aliases:
                  - subject
                  - "re:"
                  - regarding
              - name: date_sent
                description: The date and time when the email was sent
                aliases:
                  - date
                  - sent on
                  - received
              - name: attachments
                description: Files included with the email
                aliases:
                  - attached
                  - attachment
                  - enclosed
              - name: priority
                description: The urgency level of the email
                aliases:
                  - priority
                  - importance
              - name: thread_id
                description: An identifier for the email conversation
                aliases:
                  - thread
                  - conversation
              - name: message_id
                description: A unique identifier for the specific email
                aliases:
                  - message id
                  - email id
          
          - name: questionnaire
            description: A set of written questions designed to collect information from respondents
            attributes:
              - name: form_title
                description: The name or title of the questionnaire
                aliases:
                  - title
                  - survey name
                  - questionnaire name
              - name: respondent_info
                description: Information about the person completing the questionnaire
                aliases:
                  - respondent
                  - participant
                  - name
              - name: submission_date
                description: The date when the questionnaire was completed
                aliases:
                  - date
                  - completed on
                  - submitted
              - name: section_headers
                description: Titles for different segments of the questionnaire
                aliases:
                  - section
                  - part
                  - segment
              - name: question_types
                description: The format of questions (multiple choice, free text, etc.)
                aliases:
                  - type
                  - question format
                  - response format
              - name: response_options
                description: Possible answers for multiple-choice questions
                aliases:
                  - options
                  - choices
                  - answers
              - name: required_fields
                description: Questions that must be answered to complete the questionnaire
                aliases:
                  - required
                  - mandatory
                  - must answer
              - name: instructions
                description: Guidance on how to complete the questionnaire
                aliases:
                  - instructions
                  - directions
                  - guidelines
              - name: survey_id
                description: A unique identifier for the questionnaire
                aliases:
                  - survey id
                  - reference number
                  - form id
              - name: completion_status
                description: Whether the questionnaire has been fully completed
                aliases:
                  - status
                  - completion
                  - progress
          
          - name: specification
            description: A detailed description of technical requirements or characteristics
            attributes:
              - name: product_name
                description: The name of the item being specified
                aliases:
                  - product
                  - item
                  - model
              - name: version
                description: The iteration or release number
                aliases:
                  - version
                  - revision
                  - release
              - name: technical_details
                description: Specific characteristics and capabilities
                aliases:
                  - specifications
                  - tech specs
                  - details
              - name: requirements
                description: Necessary conditions or resources
                aliases:
                  - requirements
                  - prerequisites
                  - needed
              - name: compatibility
                description: What the product can work with
                aliases:
                  - compatible with
                  - works with
                  - supports
              - name: dimensions
                description: Physical measurements of the product
                aliases:
                  - dimensions
                  - size
                  - measurements
              - name: materials
                description: What the product is made from
                aliases:
                  - materials
                  - composition
                  - made from
              - name: standards
                description: Industry guidelines or certifications met
                aliases:
                  - standards
                  - certifications
                  - compliance
              - name: revision_history
                description: Record of changes to the specification
                aliases:
                  - revisions
                  - changes
                  - updates
              - name: approval_info
                description: Details about who has validated the specification
                aliases:
                  - approved by
                  - certified by
                  - validated
          
          - name: generic
            description: A general document type that doesn't fit into other specific categories
            attributes:
              - name: document_type
                description: The classification or category of the document
                aliases:
                  - type
                  - category
                  - class
              - name: document_date
                description: The date when the document was created
                aliases:
                  - date
                  - created on
                  - issued on
              - name: document_id
                description: A unique identifier for the document
                aliases:
                  - id
                  - reference
                  - number
              - name: title
                description: The name or heading of the document
                aliases:
                  - title
                  - heading
                  - subject
              - name: author
                description: The person who created the document
                aliases:
                  - author
                  - creator
                  - sender
              - name: recipient
                description: The person for whom the document is intended
                aliases:
                  - recipient
                  - to
                  - addressee
              - name: content_summary
                description: A brief description of the document's contents
                aliases:
                  - summary
                  - abstract
                  - overview
              - name: status
                description: The current state of the document
                aliases:
                  - status
                  - state
                  - condition
              - name: department
                description: The organizational unit associated with the document
                aliases:
                  - department
                  - dept
                  - division
              - name: comments
                description: Additional notes or remarks about the document
                aliases:
                  - notes
                  - remarks
                  - comments
        classification:
          model: !Ref ClassificationModel
          temperature: 0
          top_k: 200
          system_prompt: |
            You are a document classification system that analyzes business documents, forms, and publications. Your sole task is to classify documents into RVL-CDIP dataset categories based on their visual layout and textual content. You must:

            1. Output only a JSON object containing a single "class" field with the classification label
            2. Use exactly one of the predefined categories, using the exact spelling and case provided
            3. Never include explanations, reasoning, or additional text in your response
            4. Respond with nothing but the JSON containing the classification

            Example correct response:
            {"class": "letter"}
          task_prompt: |
            Classify this document into exactly one of these RVL-CDIP categories:

            letter
            form
            email
            handwritten
            advertisement
            scientific_report
            scientific_publication
            specification
            file_folder
            news_article
            budget
            invoice
            presentation
            questionnaire
            resume
            memo

            Respond only with a JSON object containing the class label. For example: {{"class": "letter"}}

            <document_ocr_data>
            {DOCUMENT_TEXT}
            </document_ocr_data>
        extraction:
          model: !Ref ExtractionModel
          temperature: 0
          top_k: 200
          system_prompt: |
            You are a document assistant. Respond only with JSON. Never make up data, only provide data found in the document being provided.
          task_prompt: |
            <background>
            You are an expert in business document analysis and information extraction. You can understand and extract key information from various types of business documents including letters, memos, financial documents, scientific papers, news articles, advertisements, emails, forms, handwritten notes, invoices, purchase orders, questionnaires, resumes, scientific publications, and specifications.
            A business document serves multiple purposes:
            Communication of information between parties
            Record keeping of business transactions or decisions
            Legal documentation of agreements or requirements
            Historical archival of business activities
            Reference material for future use
            Each document type has its own structure, purpose, and key information elements that need to be extracted.
            </background>
            <document_class>
            {DOCUMENT_CLASS}
            </document_class>
            <document_ocr_data>
            {DOCUMENT_TEXT}
            </document_ocr_data>
            <task>
            Your task is to take the unstructured text provided and convert it into a well-organized table format using JSON. Identify the main entities, attributes, or categories mentioned in the text based on the document class and use them as keys in the JSON object. Then, extract the relevant information from the text and populate the corresponding values in the JSON object. 
            Guidelines:
            Ensure that the data is accurately represented and properly formatted within the JSON structure
            Include double quotes around all keys and values
            Do not make up data - only extract information explicitly found in the document
            Do not use /n for new lines, use a space instead
            If a field is not found or if unsure, return null
            All dates should be in MM/DD/YYYY format
            Do not perform calculations or summations unless totals are explicitly given
            If an alias is not found in the document, return null
            Here are the attributes you should extract based on the document class:
            <attributes>

            }
            </attributes>
            </task>
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  OCRFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not require VPC access as it only interacts with AWS services via AWS APIs"
          - id: W92
            reason: "Function does not require concurrent execution limits as it is designed to scale based on demand"
          - id: W11
            reason: "Textract DetectDocumentText API and Cloudwatch APIs do not support resource-level permissions"
    # checkov:skip=CKV_AWS_116: "DLQ not required for this function as StepFunctions will handle retries"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      CodeUri: src/ocr_function/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 4096
      Environment:
        Variables:
          METRIC_NAMESPACE: !Ref StackName
          MAX_WORKERS: 20
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      LoggingConfig:
        LogGroup: !Ref OCRFunctionLogGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
          - Effect: Allow
            Action: cloudwatch:PutMetricData
            Resource: '*'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !Ref CustomerManagedEncryptionKeyArn
          # Textract APIs require '*' as they don't support resource-level permissions
          - Effect: Allow
            Action: textract:DetectDocumentText
            Resource: '*'

  
  OCRFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      LogGroupName: !Sub "/${AWS::StackName}/lambda/OCRFunction"
      RetentionInDays: !Ref LogRetentionDays

  ClassificationFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "Cloudwatch does not support resource-level permissions"
          - id: W89
            reason: "This Lambda function does not require VPC access as it only interacts with AWS services via AWS APIs"
          - id: W92
            reason: "Function does not require concurrent execution limits as it is designed to scale based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for this function as StepFunctions will handle retries"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      CodeUri: src/classification_function/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 4096
      Environment:
        Variables:
          METRIC_NAMESPACE: !Ref StackName
          MAX_WORKERS: 20
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      LoggingConfig:
        LogGroup: !Ref ClassificationFunctionLogGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
          - Effect: Allow
            Action: cloudwatch:PutMetricData
            Resource: '*'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !Ref CustomerManagedEncryptionKeyArn
          - Effect: Allow
            Action: bedrock:InvokeModel
            Resource: 
                - !Sub "arn:aws:bedrock:*::foundation-model/*"
                - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"
  
  ClassificationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      LogGroupName: !Sub "/${AWS::StackName}/lambda/ClassificationFunction"
      RetentionInDays: !Ref LogRetentionDays
  
  ExtractionFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not require VPC access as it only interacts with AWS services via AWS APIs"
          - id: W92
            reason: "Function does not require concurrent execution limits as it is designed to scale based on demand"
          - id: W11
            reason: "Cloudwatch does not support resource-level permissions, and Bedrock should support any enabled Bedrock model_id or inference profile"
    # checkov:skip=CKV_AWS_116: "DLQ not required for this function as StepFunctions will handle retries"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      CodeUri: src/extraction_function/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          METRIC_NAMESPACE: !Ref StackName
          CONFIGURATION_TABLE_NAME: !Ref ConfigurationTable
      LoggingConfig:
        LogGroup: !Ref ExtractionFunctionLogGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref ConfigurationTable
        - Statement:
          - Effect: Allow
            Action: cloudwatch:PutMetricData
            Resource: '*'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !Ref CustomerManagedEncryptionKeyArn
          - Effect: Allow
            Action: bedrock:InvokeModel
            Resource: 
                - !Sub "arn:aws:bedrock:*::foundation-model/*"
                - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/*"

  ExtractionFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      LogGroupName: !Sub "/${AWS::StackName}/lambda/ExtractionFunction"
      RetentionInDays: !Ref LogRetentionDays

  ProcessResultsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "Cloudwatch does not support resource-level permissions"
          - id: W89
            reason: "This Lambda function does not require VPC access as it only interacts with AWS services via AWS APIs"
          - id: W92
            reason: "Function does not require concurrent execution limits as it is designed to scale based on demand"
    # checkov:skip=CKV_AWS_116: "DLQ not required for this function as StepFunctions will handle retries"
    # checkov:skip=CKV_AWS_173: "Environment variables do not contain sensitive data - only configuration values like feature flags and non-sensitive settings"
    # checkov:skip=CKV_AWS_117: "Function does not require VPC access as it only interacts with AWS services via APIs"
    # checkov:skip=CKV_AWS_115: "Function does not require reserved concurrency as it scales based on demand"
    Properties:
      CodeUri: src/processresults_function/
      Handler: index.handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 4096
      Environment:
        Variables:
          METRIC_NAMESPACE: !Ref StackName
      LoggingConfig:
        LogGroup: !Ref ProcessResultsFunctionLogGroup
      Policies:
        - AWSLambdaBasicExecutionRole
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - S3CrudPolicy:
            BucketName: !Ref OutputBucket
        - Statement:
          - Effect: Allow
            Action: cloudwatch:PutMetricData
            Resource: '*'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !Ref CustomerManagedEncryptionKeyArn

  ProcessResultsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      LogGroupName: !Sub "/${AWS::StackName}/lambda/ProcessResultsFunction"
      RetentionInDays: !Ref LogRetentionDays

  DocumentProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "${StackName}-DocumentProcessingWorkflow"
      DefinitionUri: statemachine/workflow.asl.json
      DefinitionSubstitutions:
        OCRFunctionArn: !GetAtt OCRFunction.Arn
        ClassificationFunctionArn: !GetAtt ClassificationFunction.Arn
        ExtractionFunctionArn: !GetAtt ExtractionFunction.Arn
        ProcessResultsLambdaArn: !GetAtt ProcessResultsFunction.Arn
        OutputBucket: !Ref OutputBucket
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup: !GetAtt StateMachineLogGroup.Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref OCRFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ClassificationFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ExtractionFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ProcessResultsFunction
        - CloudWatchLogsFullAccess

  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: !Ref CustomerManagedEncryptionKeyArn
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}/workflow"  # required prefix
      RetentionInDays: !Ref LogRetentionDays

  Dashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${AWS::StackName}-${AWS::Region}-Pattern1-Subset"
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/PERIOD(m1)*60", "label": "Documents per Minute"}],
                  ["${StackName}", "InputDocuments", {"id": "m1", "stat": "Sum", "visible": false}]
                ],
                "region": "${AWS::Region}",
                "title": "Input Documents (per Minute)",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "Count per Minute"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/PERIOD(m1)*60", "label": "Pages per Minute"}],
                  ["${StackName}", "InputDocumentPages", {"id": "m1", "stat": "Sum", "visible": false}]
                ],
                "region": "${AWS::Region}",
                "title": "Input Document Pages (per Minute)",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "Count per Minute"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [],
                "region": "${AWS::Region}",
                "title": "Blank",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "N/A"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/PERIOD(m1)*60", "label": "Tokens per Minute"}],
                  ["${StackName}", "InputTokens", {"id": "m1", "stat": "Sum", "visible": false}]
                ],
                "region": "${AWS::Region}",
                "title": "Input Tokens (per Minute)",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "Count per Minute"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/PERIOD(m1)*60", "label": "Tokens per Minute"}],
                  ["${StackName}", "OutputTokens", {"id": "m1", "stat": "Sum", "visible": false}]
                ],
                "region": "${AWS::Region}",
                "title": "Output Tokens (per Minute)",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "Count per Minute"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/PERIOD(m1)*60", "label": "Tokens per Minute"}],
                  ["${StackName}", "TotalTokens", {"id": "m1", "stat": "Sum", "visible": false}]
                ],
                "region": "${AWS::Region}",
                "title": "Total Tokens (per Minute)",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "Count per Minute"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/PERIOD(m1)*60", "label": "Total per Minute"}],
                  [{"expression": "m2/PERIOD(m2)*60", "label": "Succeeded per Minute"}],
                  [{"expression": "m3/PERIOD(m3)*60", "label": "Failed per Minute"}],
                  ["${StackName}", "BedrockRequestsTotal", {"id": "m1", "stat": "Sum", "visible": false}],
                  [".", "BedrockRequestsSucceeded", {"id": "m2", "stat": "Sum", "visible": false}],
                  [".", "BedrockRequestsFailed", {"id": "m3", "stat": "Sum", "visible": false}]
                ],
                "region": "${AWS::Region}",
                "title": "Bedrock Request Status (per Minute)",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "Count per Minute"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/PERIOD(m1)*60", "label": "Throttles per Minute"}],
                  [{"expression": "m2/PERIOD(m2)*60", "label": "Retry Success per Minute"}],
                  [{"expression": "m3/PERIOD(m3)*60", "label": "Max Retries Exceeded per Minute"}],
                  ["${StackName}", "BedrockThrottles", {"id": "m1", "stat": "Sum", "visible": false}],
                  [".", "BedrockRetrySuccess", {"id": "m2", "stat": "Sum", "visible": false}],
                  [".", "BedrockMaxRetriesExceeded", {"id": "m3", "stat": "Sum", "visible": false}]
                ],
                "region": "${AWS::Region}",
                "title": "Bedrock Retries (per Minute)",
                "view": "timeSeries",
                "period": 60,
                "yAxis": {
                  "left": {
                    "label": "Count per Minute"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["${StackName}", "BedrockRequestLatency", {"stat": "Average"}],
                  [".", "BedrockRequestLatency", {"stat": "p90"}],
                  [".", "BedrockRequestLatency", {"stat": "Maximum"}],
                  [".", "BedrockTotalLatency", {"stat": "Average"}],
                  [".", "BedrockTotalLatency", {"stat": "p90"}],
                  [".", "BedrockTotalLatency", {"stat": "Maximum"}]
                ],
                "region": "${AWS::Region}",
                "title": "Bedrock Latency - per request, and total (including backoff/retries)",
                "period": 300,
                "view": "timeSeries",
                "stacked": false,
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${OCRFunction}"]
                ],
                "region": "${AWS::Region}",
                "title": "OCR Function Duration",
                "period": 300,
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                },
                "stat": "Average",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${ClassificationFunction}"]
                ],
                "region": "${AWS::Region}",
                "title": "Classification Function Duration",
                "period": 300,
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                },
                "stat": "Average",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 18,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${ExtractionFunction}"]
                ],
                "region": "${AWS::Region}",
                "title": "Extraction Function Duration",
                "period": 300,
                "annotations": {
                  "horizontal": [{
                    "value": ${ExecutionTimeThresholdMs},
                    "label": "Threshold (${ExecutionTimeThresholdMs}ms)",
                    "color": "#ff0000"
                  }]
                },
                "stat": "Average",
                "view": "timeSeries"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 24,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${OCRFunctionLogGroup}' | filter @type = \"REPORT\" | fields @timestamp, @logStream, @billedDuration, @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs} | sort by @billedDuration desc | limit 20",
                "region": "${AWS::Region}",
                "title": "OCR Lambda Long Running Invocations",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 24,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${OCRFunctionLogGroup}' | fields @timestamp, @logStream, @message | filter @message like /ERROR/ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit 20",
                "region": "${AWS::Region}",
                "title": "OCR Lambda Errors",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 30,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${ClassificationFunctionLogGroup}' | filter @type = \"REPORT\" | fields @timestamp, @logStream, @billedDuration, @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs} | sort by @billedDuration desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Classification Lambda Long Running Invocations",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 30,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${ClassificationFunctionLogGroup}' | fields @timestamp, @logStream, @message | filter @message like /ERROR/ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Classification Lambda Errors",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 36,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${ExtractionFunctionLogGroup}' | filter @type = \"REPORT\" | fields @timestamp, @logStream, @billedDuration, @maxMemoryUsed/1024/1024 as memoryUsedMB | filter @billedDuration > ${ExecutionTimeThresholdMs} | sort by @billedDuration desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Extraction Lambda Long Running Invocations",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 36,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${ExtractionFunctionLogGroup}' | fields @timestamp, @logStream, @message | filter @message like /ERROR/ or @message like /Task timed out/ | parse @message /RequestId: (?<requestId>[^ ]*)/ | sort @timestamp desc | limit 20",
                "region": "${AWS::Region}",
                "title": "Extraction Lambda Errors",
                "view": "table"
              }
            }

          ]
        }

Outputs:

  # Outputs required by main template

  StateMachineName:
    Description: Step Functions State machine Name
    Value: !GetAtt DocumentProcessingStateMachine.Name

  StateMachineArn:
    Description: Step Functions State machine ARN
    Value: !GetAtt DocumentProcessingStateMachine.Arn
  
  StateMachineLogGroup:
    Description: Step Functions State machine LogGroup
    Value: !Ref StateMachineLogGroup

  DashboardName:
    Description: Name of the Pattern 1 CloudWatch Dashboard
    Value: !Ref Dashboard

  DashboardArn:
    Description: ARN of the Pattern 1 CloudWatch Dashboard
    Value: !Sub "arn:aws:cloudwatch::${AWS::AccountId}:dashboard/${Dashboard}"

